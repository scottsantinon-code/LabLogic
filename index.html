<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#f5f5f7">
  <meta name="author" content="Critical Condition">
  <meta name="description" content="Laboratory investigation interpreter for healthcare professionals">
  <title>LabLogic</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@500,700,800,900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f5f7;
      --card: #FFFFFF;
      --label: #1d1d1f;
      --label2: #424245;
      --label3: #86868b;
      --label4: #d2d2d7;
      --sep: rgba(0,0,0,0.08);
      --accent: #8B5CF6;
      --accent-light: rgba(139,92,246,0.08);
      --accent-border: rgba(139,92,246,0.2);
      --red: #FF453A;
      --orange: #ff9f0a;
      --green: #30D158;
      --radius: 16px;
      --radius-sm: 14px;
      --radius-xs: 10px;
      --shadow: 0 1px 3px rgba(0,0,0,0.04), 0 8px 24px rgba(0,0,0,0.06);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04), 0 2px 8px rgba(0,0,0,0.03);
      --nav-bg: rgba(245,245,247,0.92);
      --font: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      --font-heading: 'Satoshi', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #1d1d1f;
        --card: #2c2c2e;
        --label: #f5f5f7;
        --label2: #e8e8ed;
        --label3: #86868b;
        --label4: #424245;
        --sep: rgba(255,255,255,0.08);
        --accent-light: rgba(139,92,246,0.15);
        --accent-border: rgba(139,92,246,0.3);
        --shadow: 0 1px 3px rgba(0,0,0,0.2), 0 8px 24px rgba(0,0,0,0.3);
        --shadow-sm: 0 1px 2px rgba(0,0,0,0.15), 0 2px 8px rgba(0,0,0,0.15);
        --nav-bg: rgba(29,29,31,0.92);
      }
      body { background: #000000; }
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font); background: var(--bg); color: var(--label); }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
      20%, 40%, 60%, 80% { transform: translateX(8px); }
    }

    .app-container {
      max-width: 430px;
      margin: 0 auto;
      min-height: 100dvh;
      background: var(--bg);
      box-shadow: 0 0 40px rgba(0,0,0,0.1);
      position: relative;
      overflow-x: hidden;
    }

    .screen-content {
      padding: 0 20px 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script>
    const { useState, useEffect, useRef } = React;
    const e = React.createElement;

    // Auto-advance hook for ChoiceButton-only screens
    // Fixed: Prevents race condition by clearing existing timer and nulling ref after callback
    function useAutoAdvance() {
      const timerRef = useRef(null);
      const clearAutoAdvance = () => {
        if (timerRef.current) {
          clearTimeout(timerRef.current);
          timerRef.current = null;
        }
      };
      const scheduleAdvance = (callback, hasWarning = false) => {
        if (timerRef.current) clearTimeout(timerRef.current);
        timerRef.current = setTimeout(() => {
          timerRef.current = null;
          callback();
        }, hasWarning ? 800 : 300);
      };
      useEffect(() => () => clearAutoAdvance(), []);
      return { scheduleAdvance, clearAutoAdvance };
    }

    // Module data
    const modules = [
      { id: "hypona", name: "Hyponatraemia", icon: "sodium" },
      { id: "tft", name: "Thyroid Function", icon: "thyroid" },
      { id: "iron", name: "Iron Studies", icon: "iron" },
      { id: "coag", name: "Coagulation", icon: "coag" }
    ];

    // Reusable style constants for screen titles and subtitles
    const STYLES = {
      screenTitle: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', fontFamily: 'var(--font-heading)', marginBottom: '8px' },
      screenSubtitle: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' }
    };

    // Module icons (simplified SVG paths)
    const moduleIcons = {
      sodium: e('svg', { width: 24, height: 24, viewBox: '0 0 512 512', fill: 'white' },
        e('path', { d: 'm136.969 378.554c.373.055.743.082 1.11.082 3.654 0 6.856-2.676 7.409-6.4l24.638-166.031c1.151-.314 2.294-.613 3.411-.877 21.552-5.088 45.835-4.384 70.225 2.04 6.13 1.614 12.182 3.484 18.589 5.464 17.195 5.314 34.934 10.796 53.62 10.796 1.434 0 2.874-.032 4.319-.1 8.062-.374 15.894-2.093 23.393-5.119l3.081 20.761c.607 4.097 4.423 6.921 8.52 6.318 4.098-.608 6.926-4.422 6.318-8.52l-12.299-82.884c5.305-3.338 8.848-9.229 8.848-15.945v-69.005c0-10.391-8.454-18.844-18.845-18.844h-1.846c-3.69-28.333-27.964-50.29-57.287-50.29h-48.347c-29.322 0-53.597 21.957-57.287 50.29h-1.846c-10.391 0-18.845 8.454-18.845 18.844v69.005c0 6.717 3.543 12.607 8.848 15.945l-32.046 215.949c-.607 4.098 2.222 7.912 6.319 8.521zm182.626-170.009c-17.67.821-35.532-4.703-52.815-10.044-6.273-1.939-12.762-3.943-19.197-5.639-25.867-6.812-51.761-7.709-75.081-2.658l4.93-33.22h157.138l6.83 46.026c-6.946 3.309-14.256 5.184-21.805 5.535zm-87.768-193.545h48.347c21.037 0 38.576 15.258 42.132 35.29h-132.61c3.554-20.032 21.094-35.29 42.131-35.29zm-62.978 54.134c0-2.12 1.725-3.844 3.845-3.844h8.843 148.927 8.843c2.12 0 3.845 1.725 3.845 3.844v69.005c0 2.12-1.725 3.844-3.845 3.844h-166.613c-2.12 0-3.845-1.725-3.845-3.844z' }),
        e('path', { d: 'm395.699 466.735-28.486-191.955c-.607-4.097-4.423-6.924-8.52-6.318-4.098.608-6.926 4.422-6.318 8.52l28.485 191.955c1.046 7.046-1.022 14.181-5.676 19.575-4.652 5.394-11.406 8.488-18.53 8.488h-201.31c-7.123 0-13.877-3.094-18.529-8.487-4.653-5.395-6.722-12.529-5.676-19.576l8.902-59.994c.607-4.098-2.221-7.912-6.318-8.52-4.09-.604-7.911 2.22-8.52 6.318l-8.902 59.994c-1.687 11.366 1.65 22.875 9.155 31.575 7.504 8.701 18.398 13.69 29.888 13.69h201.311c11.49 0 22.385-4.99 29.889-13.69 7.504-8.701 10.841-20.209 9.155-31.575z' }),
        e('path', { d: 'm200.884 267.889-22.133 169.253c-.537 4.107 2.356 7.872 6.464 8.409.33.043.658.064.982.064 3.709 0 6.933-2.751 7.427-6.528l22.133-169.253c.537-4.107-2.356-7.872-6.464-8.409-4.109-.541-7.872 2.357-8.409 6.464z' }),
        e('path', { d: 'm256 261.362c-4.143 0-7.5 3.358-7.5 7.5v169.253c0 4.142 3.357 7.5 7.5 7.5s7.5-3.358 7.5-7.5v-169.253c0-4.142-3.358-7.5-7.5-7.5z' }),
        e('path', { d: 'm302.707 261.425c-4.107.537-7.001 4.302-6.464 8.409l22.132 169.253c.494 3.777 3.718 6.528 7.427 6.528.324 0 .652-.021.982-.064 4.107-.537 7.001-4.302 6.464-8.409l-22.132-169.253c-.537-4.107-4.3-7.005-8.409-6.464z' })
      ),
      thyroid: e('svg', { width: 24, height: 24, viewBox: '0 0 128 128', fill: 'white' },
        e('path', { d: 'm90.048 116.284c-3.564 0-6.317-1.572-8.88-4.857-2.517-1.206-4.137-4.567-4.6-7.318-.437-2.619.087-4.812 1.44-6.078.839-1.538.3-3.87-1.319-5.634a7.136 7.136 0 0 0 -8.24-1.474c-1.664.752-7.24.752-8.9 0a7.136 7.136 0 0 0 -8.24 1.473c-1.623 1.765-2.159 4.1-1.32 5.635 1.353 1.266 1.877 3.459 1.44 6.078-.459 2.751-2.079 6.112-4.6 7.318-3.986 5.107-8.429 6.074-15.667 3.43-2.646-.165-7.87-1.68-10.316-6.458a8.247 8.247 0 0 0 -2.148-2.644c-6.198-5.055-9.773-11.017-10.325-17.24a7.705 7.705 0 0 0 -.729-2.7c-3.914-8.043-5.044-14.944-3.798-23.08a8.311 8.311 0 0 0 .031-2.566c-.552-3.569-1.477-12.659 1.842-20.069a9.3 9.3 0 0 0 .742-3c.685-7.439 7.272-14.951 14.1-16.078 8.947-1.482 12.083 3.334 13.967 8.237a5.745 5.745 0 0 0 1.606 2.282 14.659 14.659 0 0 1 5.129 8.031 5.513 5.513 0 0 0 1.423 2.6 44.406 44.406 0 0 1 6.506 8.585c.61.96 1.265 1.989 2.01 3.119 2.519 3.815 6.467 5.517 12.8 5.517s10.281-1.7 12.8-5.517c.745-1.13 1.4-2.159 2.01-3.119a44.406 44.406 0 0 1 6.506-8.585 5.515 5.515 0 0 0 1.423-2.6 14.652 14.652 0 0 1 5.129-8.031 5.755 5.755 0 0 0 1.606-2.283c1.884-4.9 5.016-9.721 13.967-8.237 6.826 1.127 13.413 8.639 14.1 16.078a9.284 9.284 0 0 0 .742 3c3.321 7.416 2.394 16.509 1.842 20.074a8.317 8.317 0 0 0 .031 2.567c1.251 8.136.116 15.037-3.8 23.076a7.705 7.705 0 0 0 -.729 2.7c-.552 6.223-4.124 12.185-10.328 17.24a8.24 8.24 0 0 0 -2.148 2.645c-2.446 4.777-7.67 6.292-10.316 6.457a20.07 20.07 0 0 1 -6.789 1.426zm-18.423-29.055a9.823 9.823 0 0 1 7.275 3.138c2.628 2.857 3.263 6.739 1.544 9.441a1.541 1.541 0 0 1 -.323.361c-.624.5-.856 1.857-.591 3.446.4 2.377 1.788 4.7 3.1 5.178a1.492 1.492 0 0 1 .687.508c3.283 4.37 6.367 5.015 12.69 2.664a1.471 1.471 0 0 1 .477-.094c1.939-.06 6.1-1.149 7.995-4.839a11.237 11.237 0 0 1 2.923-3.6c3.879-3.16 8.63-8.359 9.235-15.18a10.693 10.693 0 0 1 1.02-3.751c3.674-7.547 4.7-13.72 3.53-21.308a11.411 11.411 0 0 1 -.031-3.481c1.066-6.877.462-13.751-1.615-18.388a12.448 12.448 0 0 1 -.992-3.95c-.561-6.1-6.089-12.484-11.6-13.394-6.479-1.069-8.821 1.52-10.68 6.354a8.749 8.749 0 0 1 -2.447 3.48 11.573 11.573 0 0 0 -4.175 6.478 8.509 8.509 0 0 1 -2.219 4.01 41.48 41.48 0 0 0 -6.09 8.066c-.619.974-1.282 2.019-2.038 3.163-3.092 4.684-7.955 6.865-15.3 6.865s-12.212-2.181-15.3-6.865c-.756-1.144-1.419-2.189-2.038-3.163a41.48 41.48 0 0 0 -6.09-8.066 8.508 8.508 0 0 1 -2.219-4.011 11.576 11.576 0 0 0 -4.176-6.478 8.746 8.746 0 0 1 -2.446-3.479c-1.859-4.835-4.2-7.423-10.679-6.354-5.51.91-11.038 7.294-11.6 13.394a12.461 12.461 0 0 1 -.992 3.951c-2.08 4.633-2.684 11.507-1.618 18.384a11.411 11.411 0 0 1 -.031 3.481c-1.166 7.588-.144 13.761 3.53 21.308a10.693 10.693 0 0 1 1.02 3.751c.6 6.821 5.356 12.02 9.235 15.18a11.244 11.244 0 0 1 2.923 3.6c1.89 3.691 6.056 4.78 8 4.84a1.471 1.471 0 0 1 .477.094c6.322 2.351 9.406 1.7 12.69-2.664a1.492 1.492 0 0 1 .687-.508c1.313-.479 2.7-2.8 3.1-5.178.265-1.589.033-2.942-.591-3.446a1.541 1.541 0 0 1 -.323-.361c-1.719-2.7-1.084-6.584 1.544-9.442a10.132 10.132 0 0 1 11.684-2.178 16.866 16.866 0 0 0 6.435 0 10.711 10.711 0 0 1 4.403-.957z' })
      ),
      iron: e('svg', { width: 24, height: 24, viewBox: '0 0 512 512', fill: 'white' },
        e('path', { d: 'M400,8A104,104,0,1,0,504,112,104.121,104.121,0,0,0,400,8Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,400,200Z' }),
        e('path', { d: 'M276.875,163.631l-42.141-36.867A8,8,0,0,1,232,120.74V104h8a24.026,24.026,0,0,0,24-24V32A24.027,24.027,0,0,0,240,8H64A24.027,24.027,0,0,0,40,32V80a24.026,24.026,0,0,0,24,24h8V120.74a7.988,7.988,0,0,1-2.727,6.016L27.117,163.639A56,56,0,0,0,8,205.78V434.389a69.276,69.276,0,0,0,26.133,54.359,70.528,70.528,0,0,0,43.906,15.414h.188c36.945-.125,111.429-.156,148.211-.164A69.6,69.6,0,0,0,296,434.381V205.78A56.01,56.01,0,0,0,276.875,163.631ZM280,208V368H24V208ZM56,80V32a8.005,8.005,0,0,1,8-8H96V48a8,8,0,0,0,8,8h96a8,8,0,0,0,8-8V24h32a8.005,8.005,0,0,1,8,8V80a8.005,8.005,0,0,1-8,8H64A8.005,8.005,0,0,1,56,80Z' }),
        e('path', { d: 'M352,72v88h16V112h32V96H368V80h32V64H360A8,8,0,0,0,352,72Z' }),
        e('path', { d: 'M456,128a8,8,0,0,0,8-8v-4a28,28,0,0,0-56,0v20a24.026,24.026,0,0,0,24,24h8a24.026,24.026,0,0,0,24-24H448a8.005,8.005,0,0,1-8,8h-8a8.005,8.005,0,0,1-8-8v-8Zm-20-24a12.011,12.011,0,0,1,11.312,8H424.688A12.011,12.011,0,0,1,436,104Z' })
      ),
      coag: e('svg', { width: 24, height: 24, viewBox: '0 0 512 512', fill: 'white' },
        e('path', { d: 'm181.06 40.094c-41.331-53.354-109.181-53.344-150.504 0-65.194 84.156-18.374 228.14 75.252 228.14 93.582-.001 140.491-143.926 75.252-228.14zm-75.252 213.155c-49.932 0-90.554-53.416-90.554-119.072s40.622-119.073 90.554-119.073 90.554 53.416 90.554 119.072-40.622 119.073-90.554 119.073z' }),
        e('path', { d: 'm257.844 271.391c-105.609 13.41-174.312 148.326-108.108 214.531 66.316 66.312 201.138-2.63 214.531-108.109 8.499-66.942-39.48-114.929-106.423-106.422zm50.715 183.77c-74.45 74.45-180.64 43.598-168.904-48.829 8.12-63.956 70.977-120.941 133.24-120.941 84.536.001 104.634 100.8 35.664 169.77z' }),
        e('path', { d: 'm510.774 134.14c-4.017-31.637-20.038-62.87-45.111-87.943-47.492-47.491-124.391-65.193-169.419-20.166-20.194 20.194-29.053 49.13-24.946 81.477 4.017 31.637 20.038 62.87 45.111 87.943 47.618 47.616 124.48 65.103 169.42 20.166 20.194-20.193 29.053-49.129 24.945-81.477zm-35.54 70.881c-36.527 36.528-103.486 24.578-148.229-20.166-46.426-46.426-55.473-112.922-20.165-148.228 36.746-36.747 103.774-24.289 148.228 20.166 46.426 46.426 55.472 112.922 20.166 148.228z' })
      ),
      // Default fallback icon (simple circle with question mark)
      default: e('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'white' },
        e('circle', { cx: 12, cy: 12, r: 10, fill: 'none', stroke: 'white', strokeWidth: 2 }),
        e('text', { x: 12, y: 16, textAnchor: 'middle', fontSize: 12, fill: 'white' }, '?')
      )
    };

    // Reference ranges
    const REF = {
      TSH: { low: 0.4, high: 4.0, unit: "mU/L" },
      FT4: { low: 12, high: 22, unit: "pmol/L" },
      FT3: { low: 3.1, high: 6.8, unit: "pmol/L" }
    };

    // ========== REUSABLE COMPONENTS ==========

    // 1. FadeIn Wrapper
    function FadeIn({ delay = 0, children }) {
      const [visible, setVisible] = useState(false);
      useEffect(() => {
        const timer = setTimeout(() => setVisible(true), delay);
        return () => clearTimeout(timer);
      }, [delay]);
      return e('div', {
        style: {
          opacity: visible ? 1 : 0,
          transform: visible ? 'translateY(0)' : 'translateY(8px)',
          transition: 'opacity 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)'
        }
      }, children);
    }

    // 1b. ProgressBar (step dots - current step is elongated pill)
    function ProgressBar({ current, total, color = 'var(--accent)' }) {
      return e('div', {
        style: {
          display: 'flex',
          justifyContent: 'center',
          gap: '6px',
          marginBottom: '20px',
          padding: '4px 0'
        }
      },
        Array.from({ length: total }, (_, i) =>
          e('div', {
            key: i,
            style: {
              width: i === current ? '20px' : '8px',
              height: '8px',
              borderRadius: '4px',
              background: i <= current ? color : 'var(--sep)',
              opacity: i <= current ? 1 : 0.4,
              transition: 'all 0.25s ease'
            }
          })
        )
      );
    }

    // Helper: Render tag (neutral grey)
    function renderTag(tag, index) {
      return e('span', {
        key: index,
        style: {
          fontSize: '11px',
          fontWeight: 600,
          color: 'var(--label3)',
          background: 'rgba(142,142,147,0.12)',
          padding: '3px 8px',
          borderRadius: '6px'
        }
      }, tag);
    }

    // 2. NavBar
    function NavBar({ title, onBack, rightAction }) {
      return e('div', {
        style: {
          position: 'sticky',
          top: 0,
          zIndex: 100,
          background: 'var(--nav-bg, rgba(242,242,247,0.92))',
          backdropFilter: 'blur(20px) saturate(180%)',
          WebkitBackdropFilter: 'blur(20px) saturate(180%)',
          borderBottom: '0.5px solid rgba(60,60,67,0.1)',
          padding: '12px 16px',
          paddingTop: 'calc(12px + env(safe-area-inset-top))',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          minHeight: '44px'
        }
      },
        e('div', { style: { width: '80px' } },
          onBack && e('button', {
            onClick: onBack,
            style: {
              background: 'none',
              border: 'none',
              color: 'var(--accent)',
              fontSize: '16px',
              fontWeight: 500,
              fontFamily: 'var(--font)',
              cursor: 'pointer',
              padding: 0
            }
          }, 'â€¹ Back')
        ),
        e('div', {
          style: {
            position: 'absolute',
            left: '50%',
            transform: 'translateX(-50%)',
            fontSize: '17px',
            fontWeight: 700,
            letterSpacing: '-0.02em',
            color: 'var(--label)'
          }
        }, title),
        e('div', { style: { width: '80px', textAlign: 'right' } }, rightAction)
      );
    }

    // 3. ChoiceButton
    function ChoiceButton({ label, sublabel, selected, onClick, color = 'var(--accent)' }) {
      return e('button', {
        onClick: onClick,
        style: {
          width: '100%',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '16px 18px',
          background: selected ? `${color}10` : 'var(--card)',
          border: `2px solid ${selected ? color : 'var(--sep)'}`,
          borderRadius: '14px',
          marginBottom: '8px',
          cursor: 'pointer',
          transition: 'all 0.2s ease',
          textAlign: 'left',
          fontFamily: 'var(--font)'
        }
      },
        e('div', { style: { flex: 1 } },
          e('div', { style: { fontSize: '16px', fontWeight: 600, color: 'var(--label)' } }, label),
          sublabel && e('div', { style: { fontSize: '13px', color: 'var(--label3)', marginTop: '4px' } }, sublabel)
        ),
        e('div', {
          style: {
            width: '24px',
            height: '24px',
            borderRadius: '50%',
            border: `2px solid ${selected ? color : 'var(--label4)'}`,
            background: selected ? color : 'transparent',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            flexShrink: 0,
            marginLeft: '12px'
          }
        },
          selected && e('span', { style: { color: 'white', fontSize: '14px' } }, 'âœ“')
        )
      );
    }

    // 5. ValueInput
    function ValueInput({ label, unit, value, onChange, placeholder, hint }) {
      const hasValue = value && value.length > 0;
      return e('div', { style: { marginBottom: '16px' } },
        e('div', {
          style: {
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '8px'
          }
        },
          e('span', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)' } }, label),
          hint && e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, hint)
        ),
        e('div', {
          style: {
            display: 'flex',
            background: 'var(--card)',
            border: `1.5px solid ${hasValue ? 'var(--accent)' : 'var(--sep)'}`,
            borderRadius: '12px',
            overflow: 'hidden'
          }
        },
          e('input', {
            type: 'number',
            inputMode: 'decimal',
            value: value,
            onChange: (ev) => onChange(ev.target.value),
            placeholder: placeholder,
            style: {
              flex: 1,
              padding: '14px 16px',
              fontSize: '17px',
              fontWeight: 600,
              border: 'none',
              outline: 'none',
              background: 'transparent',
              fontFamily: 'var(--font)',
              color: 'var(--label)'
            }
          }),
          e('div', {
            style: {
              padding: '0 14px',
              fontSize: '13px',
              fontWeight: 600,
              color: 'var(--label3)',
              borderLeft: '1px solid var(--sep)',
              background: 'rgba(142,142,147,0.08)',
              display: 'flex',
              alignItems: 'center'
            }
          }, unit)
        )
      );
    }

    // 6. InfoPanel
    function InfoPanel({ title, children }) {
      const [isOpen, setIsOpen] = useState(false);
      return e('div', {
        style: {
          background: isOpen ? 'rgba(139,92,246,0.06)' : 'var(--card)',
          border: isOpen ? '1px solid rgba(139,92,246,0.15)' : '1px solid var(--sep)',
          borderRadius: '14px',
          marginBottom: '12px',
          overflow: 'hidden'
        }
      },
        e('button', {
          onClick: () => setIsOpen(!isOpen),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            gap: '10px',
            padding: '14px 16px',
            background: 'none',
            border: 'none',
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            textAlign: 'left'
          }
        },
          e('div', {
            style: {
              width: '26px',
              height: '26px',
              borderRadius: '50%',
              background: 'rgba(142,142,147,0.12)',
              color: 'var(--label3)',
              fontWeight: 700,
              fontSize: '14px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              flexShrink: 0
            }
          }, 'â“˜'),
          e('span', {
            style: { flex: 1, fontSize: '14px', fontWeight: 600, color: 'var(--label2)' }
          }, title),
          e('span', {
            style: {
              fontSize: '16px',
              color: 'var(--label3)',
              transform: isOpen ? 'rotate(90deg)' : 'rotate(0)',
              transition: 'transform 0.2s ease'
            }
          }, 'â€º')
        ),
        isOpen && e('div', {
          style: {
            borderTop: '1px solid rgba(139,92,246,0.15)',
            padding: '16px',
            fontSize: '13px',
            lineHeight: 1.65,
            color: 'var(--label2)',
            animation: 'fadeIn 0.2s ease'
          }
        }, children)
      );
    }

    // 7. Warning Banner
    function WarningBanner({ children, onContinue }) {
      // Gating warnings (with Continue) get stronger styling; informational warnings are softer
      const isGating = !!onContinue;
      return e('div', {
        style: {
          display: 'flex',
          flexDirection: 'column',
          padding: '14px 16px',
          background: isGating ? 'rgba(255,149,0,0.12)' : 'rgba(142,142,147,0.08)',
          border: isGating ? '1px solid rgba(255,149,0,0.3)' : '1px solid var(--sep)',
          borderRadius: '14px',
          marginBottom: '12px'
        }
      },
        e('div', { style: { display: 'flex', gap: '10px' } },
          e('span', { style: { fontSize: '16px', flexShrink: 0 } }, isGating ? 'âš ï¸' : 'â„¹ï¸'),
          e('div', {
            style: { fontSize: '13px', lineHeight: 1.55, color: isGating ? 'var(--orange)' : 'var(--label2)', fontWeight: 500 }
          }, children)
        ),
        onContinue && e('button', {
          onClick: onContinue,
          style: {
            alignSelf: 'flex-end',
            background: 'rgba(255,149,0,0.15)',
            border: '1px solid rgba(255,149,0,0.35)',
            borderRadius: '8px',
            color: 'var(--orange)',
            fontSize: '15px',
            fontWeight: 700,
            padding: '10px 16px',
            marginTop: '12px',
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            minHeight: '44px',
            display: 'flex',
            alignItems: 'center'
          }
        }, 'I understand â€” Continue â†’')
      );
    }

    // 8. BranchCard
    function BranchCard({ label, value, interpretation, color, useColor = false }) {
      const barColor = useColor && color ? color : 'var(--label4)';
      const valueColor = useColor && color ? color : 'var(--label)';
      return e('div', {
        style: {
          display: 'flex',
          borderRadius: '14px',
          overflow: 'hidden',
          border: '1px solid var(--sep)',
          background: 'var(--card)',
          marginBottom: '16px'
        }
      },
        e('div', {
          style: { width: '5px', background: barColor, flexShrink: 0 }
        }),
        e('div', { style: { flex: 1, padding: '14px 16px' } },
          e('div', {
            style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
          },
            e('span', { style: { fontSize: '13px', fontWeight: 600, color: 'var(--label3)' } }, label),
            e('span', { style: { fontSize: '17px', fontWeight: 700, color: valueColor } }, value)
          ),
          e('div', {
            style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)', marginTop: '4px' }
          }, interpretation)
        )
      );
    }

    // 8b. InputSummaryStrip (quiet breadcrumb summary of user inputs on results screens)
    function InputSummaryStrip({ items }) {
      return e('div', {
        style: { fontSize: '12px', color: 'var(--label3)', lineHeight: 1.5, marginBottom: '16px' }
      },
        items.map((item, i) => e(React.Fragment, { key: i },
          i > 0 && ' Â· ',
          e('span', null, item.label, ' '),
          e('span', { style: { fontWeight: 500, color: 'var(--label2)' } }, item.value)
        ))
      );
    }

    // 9. ResultCard
    function ResultCard({ title, subtitle, tags = [], severity, children, warning, onTap }) {
      const severityStyles = {
        likely: { color: '#8B5CF6', bg: 'rgba(139,92,246,0.08)', border: 'rgba(139,92,246,0.2)', label: 'LIKELY' },
        dangerous: { color: '#FF453A', bg: 'rgba(255,69,58,0.08)', border: 'rgba(255,69,58,0.2)', label: 'URGENT' },
        consider: { color: '#F59E0B', bg: 'rgba(245,158,11,0.08)', border: 'rgba(245,158,11,0.2)', label: 'CONSIDER' },
        rare: { color: '#8E8E93', bg: 'rgba(142,142,147,0.08)', border: 'rgba(142,142,147,0.2)', label: 'RARE' }
      };
      const sev = severityStyles[severity] || severityStyles.consider;

      return e('div', {
        style: {
          background: 'var(--card)',
          borderRadius: '16px',
          border: '1px solid var(--sep)',
          boxShadow: 'var(--shadow-sm)',
          padding: '18px 18px 16px',
          marginBottom: '10px'
        }
      },
        e('div', {
          style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }
        },
          e('div', { style: { flex: 1 } },
            e('div', {
              style: { fontSize: '16px', fontWeight: 700, letterSpacing: '-0.02em', color: 'var(--label)' }
            }, title),
            subtitle && e('div', {
              style: { fontSize: '13px', color: 'var(--label3)', marginTop: '3px' }
            }, subtitle)
          ),
          e('span', {
            style: {
              fontSize: '10px',
              fontWeight: 700,
              letterSpacing: '0.05em',
              color: sev.color,
              background: sev.bg,
              border: `1px solid ${sev.border}`,
              padding: '3px 8px',
              borderRadius: '6px',
              marginLeft: '10px'
            }
          }, sev.label)
        ),
        children && e('div', {
          style: { fontSize: '13.5px', lineHeight: 1.6, color: 'var(--label2)', marginTop: '6px' }
        }, children),
        warning && e('div', {
          style: {
            display: 'flex',
            gap: '10px',
            padding: '12px 14px',
            background: 'rgba(255,69,58,0.06)',
            border: '1px solid rgba(255,69,58,0.15)',
            borderRadius: '12px',
            marginTop: '12px'
          }
        },
          e('span', { style: { fontSize: '14px', flexShrink: 0 } }, 'âš ï¸'),
          e('div', {
            style: { fontSize: '12px', lineHeight: 1.5, fontWeight: 500 }
          }, warning)
        ),
        tags.length > 0 && e('div', {
          style: { display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '10px' }
        },
          tags.map((tag, i) => e('span', {
            key: i,
            style: {
              fontSize: '11px',
              fontWeight: 600,
              color: 'var(--label3)',
              background: 'rgba(142,142,147,0.12)',
              padding: '3px 8px',
              borderRadius: '6px'
            }
          }, tag))
        ),
        onTap && e('button', {
          onClick: onTap,
          style: {
            background: 'none',
            border: 'none',
            color: 'var(--accent)',
            fontSize: '13px',
            fontWeight: 600,
            marginTop: '12px',
            padding: 0,
            cursor: 'pointer',
            fontFamily: 'var(--font)'
          }
        }, 'View details â†’')
      );
    }

    // 10. PrimaryButton
    function PrimaryButton({ label, onClick, disabled, color = 'var(--accent)' }) {
      return e('button', {
        onClick: disabled ? undefined : onClick,
        disabled: disabled,
        style: {
          width: '100%',
          padding: '16px',
          borderRadius: '14px',
          fontSize: '17px',
          fontWeight: 700,
          letterSpacing: '-0.02em',
          background: disabled ? 'var(--label4)' : color,
          color: 'white',
          border: 'none',
          opacity: disabled ? 0.5 : 1,
          cursor: disabled ? 'default' : 'pointer',
          marginTop: '8px',
          fontFamily: 'var(--font)',
          transition: 'all 0.2s ease'
        }
      }, label);
    }

    // 11. DiffCard (Collapsible)
    function DiffCard({ title, description, color = 'var(--accent)' }) {
      const [isOpen, setIsOpen] = useState(false);
      return e('div', {
        style: {
          background: 'var(--card)',
          border: '1px solid var(--sep)',
          borderRadius: '10px',
          marginBottom: '6px',
          overflow: 'hidden'
        }
      },
        e('button', {
          onClick: () => setIsOpen(!isOpen),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '12px 14px',
            background: 'none',
            border: 'none',
            borderLeft: `4px solid ${color}`,
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            textAlign: 'left'
          }
        },
          e('span', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)' } }, title),
          e('span', {
            style: {
              fontSize: '14px',
              color: 'var(--label3)',
              transform: isOpen ? 'rotate(90deg)' : 'rotate(0)',
              transition: 'transform 0.2s ease'
            }
          }, 'â€º')
        ),
        e('div', {
          style: {
            maxHeight: isOpen ? '500px' : '0',
            overflow: 'hidden',
            transition: 'max-height 0.2s ease'
          }
        },
          e('div', {
            style: {
              borderTop: '1px solid var(--sep)',
              padding: '10px 14px',
              fontSize: '13px',
              lineHeight: 1.55,
              color: 'var(--label2)'
            }
          }, description)
        )
      );
    }

    // 12. DiffListItem (Expandable diagnosis card - replaces ResultCard on results screens)
    function DiffListItem({ title, tags = [], children, warning, infoPanel, defaultOpen = false }) {
      const [expanded, setExpanded] = useState(defaultOpen);

      return e('div', {
        style: {
          background: 'var(--card)',
          borderRadius: '14px',
          border: '1px solid var(--sep)',
          boxShadow: 'var(--shadow-sm)',
          marginBottom: '8px',
          overflow: 'hidden'
        }
      },
        // Header (always visible, clickable)
        e('button', {
          onClick: () => setExpanded(!expanded),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'flex-start',
            justifyContent: 'space-between',
            padding: '16px',
            background: 'none',
            border: 'none',
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            textAlign: 'left'
          }
        },
          e('div', { style: { flex: 1 } },
            e('div', {
              style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', letterSpacing: '-0.02em' }
            }, title),
            tags.length > 0 && e('div', {
              style: { display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '8px' }
            },
              tags.map((tag, i) => renderTag(tag, i))
            )
          ),
          e('span', {
            style: {
              fontSize: '16px',
              color: 'var(--label3)',
              marginLeft: '12px',
              marginTop: '2px',
              transform: expanded ? 'rotate(90deg)' : 'rotate(0)',
              transition: 'transform 0.2s ease'
            }
          }, 'â€º')
        ),

        // Expandable content
        e('div', {
          style: {
            maxHeight: expanded ? '2000px' : '0',
            overflow: 'hidden',
            transition: 'max-height 0.3s ease'
          }
        },
          e('div', { style: { padding: '0 16px 16px' } },
            // Description text
            children && e('div', {
              style: { fontSize: '13.5px', lineHeight: 1.6, color: 'var(--label2)', marginBottom: warning || infoPanel ? '12px' : '0' }
            }, children),

            // Warning (if provided)
            warning && e('div', {
              style: {
                display: 'flex',
                gap: '10px',
                padding: '12px 14px',
                background: 'rgba(255,69,58,0.06)',
                border: '1px solid rgba(255,69,58,0.15)',
                borderRadius: '12px',
                marginBottom: infoPanel ? '12px' : '0'
              }
            },
              e('span', { style: { fontSize: '14px', flexShrink: 0 } }, 'âš ï¸'),
              e('div', {
                style: { fontSize: '12px', lineHeight: 1.5, fontWeight: 500 }
              }, warning)
            ),

            // InfoPanel content (if provided)
            infoPanel
          )
        )
      );
    }

    // 12b. DiagnosisHeader (non-expandable section header for diagnosis groups)
    function DiagnosisHeader({ title, tags = [], description, warning, infoPanel }) {
      return e('div', { style: { marginBottom: '6px' } },
        e('div', {
          style: {
            padding: '14px 16px',
            background: 'rgba(142,142,147,0.06)',
            borderRadius: '14px',
            border: '1px solid var(--sep)'
          }
        },
          e('div', {
            style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', letterSpacing: '-0.02em' }
          }, title),
          tags.length > 0 && e('div', {
            style: { display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }
          },
            tags.map((tag, i) => renderTag(tag, i))
          ),
          description && e('div', {
            style: { fontSize: '13px', lineHeight: 1.55, color: 'var(--label2)', marginTop: '8px' }
          }, description),
          warning && e('div', {
            style: {
              display: 'flex',
              gap: '10px',
              padding: '10px 12px',
              background: 'rgba(255,69,58,0.06)',
              border: '1px solid rgba(255,69,58,0.15)',
              borderRadius: '10px',
              marginTop: '10px'
            }
          },
            e('span', { style: { fontSize: '14px', flexShrink: 0 } }, 'âš ï¸'),
            e('div', { style: { fontSize: '12px', lineHeight: 1.5, fontWeight: 500 } }, warning)
          ),
          infoPanel && e('div', { style: { marginTop: '10px' } }, infoPanel)
        )
      );
    }

    // 13. LearnMoreDivider
    function LearnMoreDivider() {
      return e('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          marginTop: '24px',
          marginBottom: '16px',
          gap: '12px'
        }
      },
        e('div', { style: { flex: 1, height: '1px', background: 'var(--sep)' } }),
        e('span', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label4)' } }, 'Learn more'),
        e('div', { style: { flex: 1, height: '1px', background: 'var(--sep)' } })
      );
    }

    // 14. SeverityBadge (inline below inputs)
    function SeverityBadge({ text, color }) {
      return e('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
          marginTop: '6px'
        }
      },
        e('div', {
          style: {
            width: '8px',
            height: '8px',
            borderRadius: '50%',
            background: color,
            flexShrink: 0
          }
        }),
        e('span', { style: { fontSize: '13px', fontWeight: 600, color: color } }, text)
      );
    }

    // 15. HomeButton (for NavBar)
    function HomeButton({ onClick }) {
      return e('button', {
        onClick: onClick,
        style: {
          background: 'none',
          border: 'none',
          padding: '8px',
          cursor: 'pointer',
          borderRadius: '8px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center'
        }
      },
        e('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'var(--label3)', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          e('path', { d: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z' }),
          e('polyline', { points: '9 22 9 12 15 12 15 22' })
        )
      );
    }

    // Na Correction Rate Calculator (collapsible, used on Hypona results screens)
    function NaCorrectionCalculator() {
      const [isOpen, setIsOpen] = useState(false);
      const [startNa, setStartNa] = useState('');
      const [latestNa, setLatestNa] = useState('');
      const [hoursElapsed, setHoursElapsed] = useState('');
      const [targetRate, setTargetRate] = useState(10);

      const calculateCorrection = () => {
        const start = parseFloat(startNa);
        const latest = parseFloat(latestNa);
        const hours = parseFloat(hoursElapsed);
        if (isNaN(start) || isNaN(latest) || isNaN(hours) || hours <= 0) return null;
        // Bounds checking for sodium values (physiologically plausible range: 100-180 mEq/L)
        if (start < 100 || start > 180 || latest < 100 || latest > 180) return null;
        // Reject negative hours
        if (hours < 0) return null;

        const naChange = latest - start;
        const ratePerHour = naChange / hours;
        const remainingHours = Math.max(0, 24 - hours);
        const remainingBudget = targetRate - naChange;

        return {
          naChange: naChange.toFixed(1),
          ratePerHour: ratePerHour.toFixed(2),
          remainingHours: remainingHours.toFixed(1),
          remainingBudget: remainingBudget.toFixed(1),
          exceeds: naChange > targetRate,
          beyondWindow: hours > 24
        };
      };

      const result = calculateCorrection();

      return e('div', { style: { marginBottom: '16px' } },
        // Collapsible header
        e('button', {
          onClick: () => setIsOpen(!isOpen),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '14px 16px',
            background: 'var(--card)',
            border: '1px solid var(--sep)',
            borderRadius: '14px',
            cursor: 'pointer',
            fontFamily: 'var(--font)'
          }
        },
          e('div', { style: { display: 'flex', alignItems: 'center', gap: '10px' } },
            e('div', {
              style: {
                width: '32px',
                height: '32px',
                borderRadius: '8px',
                background: 'linear-gradient(135deg, #5E5CE6 0%, #4B48B8 100%)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
              }
            }, e('span', { style: { fontSize: '11px', fontWeight: 800, color: 'white' } }, 'Na')),
            e('div', null,
              e('div', { style: { fontSize: '14px', fontWeight: 700, color: 'var(--label)' } }, 'Na Change and Rate'),
              e('div', { style: { fontSize: '12px', color: 'var(--label3)' } }, 'Calculate sodium change and rate over time')
            )
          ),
          e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, isOpen ? 'â–²' : 'â–¼')
        ),

        // Collapsible content
        isOpen && e('div', {
          style: { background: 'rgba(142,142,147,0.06)', borderRadius: '0 0 14px 14px', padding: '16px', marginTop: '-14px', paddingTop: '28px', border: '1px solid var(--sep)', borderTop: 'none' }
        },
          // Three ValueInputs
          e(ValueInput, { label: 'Starting Na', unit: 'mmol/L', value: startNa, onChange: setStartNa, placeholder: 'e.g. 118' }),
          e(ValueInput, { label: 'Latest Na', unit: 'mmol/L', value: latestNa, onChange: setLatestNa, placeholder: 'e.g. 122' }),
          e(ValueInput, { label: 'Hours since first Na', unit: 'hours', value: hoursElapsed, onChange: setHoursElapsed, placeholder: 'e.g. 8' }),

          // Results display
          result && e('div', null,
            // Na change and rate summary
            e('div', { style: { fontSize: '13px', color: 'var(--label)', marginBottom: '8px' } },
              `Na change: ${result.naChange > 0 ? '+' : ''}${result.naChange} mmol/L in ${hoursElapsed} hours`
            ),
            e('div', { style: { fontSize: '13px', color: 'var(--label)', marginBottom: '12px' } },
              `Rate: ${result.ratePerHour} mmol/L/hr`
            ),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '8px', fontStyle: 'italic' } },
              'This calculates change over time only. It does not define safe correction targets; consult local protocols.'
            )
          ),

          // ODS InfoPanel
          e(InfoPanel, { title: 'Osmotic Demyelination Syndrome (ODS)', collapsed: true },
            e('p', { style: { marginBottom: '8px' } }, 'ODS (formerly central pontine myelinolysis) is a serious complication of overly rapid sodium correction in chronic hyponatraemia.'),
            e('p', { style: { marginBottom: '8px' } }, 'The brain adapts to chronic hyponatraemia by losing organic osmolytes. Rapid correction causes water to shift out of brain cells, leading to demyelination.'),
            e('p', { style: { marginBottom: '8px', fontWeight: 600 } }, 'Higher risk patients:'),
            e('ul', { style: { margin: '0', paddingLeft: '18px', fontSize: '12px', lineHeight: '1.6' } },
              e('li', null, 'Chronic hyponatraemia (>48 hours or unknown duration)'),
              e('li', null, 'Severe hyponatraemia (<120 mmol/L)'),
              e('li', null, 'Hypokalaemia'),
              e('li', null, 'Malnutrition or alcoholism'),
              e('li', null, 'Advanced liver disease')
            )
          )
        )
      );
    }

    // ========== SCREENS ==========

    // Home Screen
    function HomeScreen({ onSelectModule }) {
      return e('div', null,
        // Header
        e('div', {
          style: {
            padding: '16px 24px',
            paddingTop: 'calc(16px + env(safe-area-inset-top))'
          }
        },
          e('div', {
            style: {
              fontSize: '32px',
              fontWeight: 800,
              letterSpacing: '-0.04em',
              fontFamily: 'var(--font-heading)',
              background: 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 50%, #8B5CF6 100%)',
              WebkitBackgroundClip: 'text',
              WebkitTextFillColor: 'transparent',
              backgroundClip: 'text'
            }
          }, 'LabLogic')
        ),

        // Module Cards
        e('div', { style: { padding: '0 20px' } },
          modules.map((mod, i) =>
            e(FadeIn, { key: mod.id, delay: 100 + i * 60 },
              e('button', {
                onClick: () => onSelectModule(mod.beta ? mod.id + '-gate' : mod.id),
                style: {
                  width: '100%',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '14px',
                  background: 'var(--card)',
                  borderRadius: '18px',
                  padding: '16px 18px',
                  border: '1px solid var(--sep)',
                  boxShadow: 'var(--shadow-sm)',
                  marginBottom: '10px',
                  cursor: 'pointer',
                  textAlign: 'left',
                  fontFamily: 'var(--font)',
                  transition: 'transform 0.2s ease',
                  position: 'relative'
                }
              },
                // Icon square
                e('div', {
                  style: {
                    width: '48px',
                    height: '48px',
                    borderRadius: '14px',
                    background: 'linear-gradient(135deg, var(--accent) 0%, #7C3AED 100%)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    boxShadow: '0 3px 10px rgba(139,92,246,0.2)',
                    flexShrink: 0
                  }
                }, moduleIcons[mod.icon] || moduleIcons.default || null),
                // Text
                e('div', { style: { flex: 1 } },
                  e('div', {
                    style: { fontSize: '16px', fontWeight: 700, letterSpacing: '-0.02em', color: 'var(--label)' }
                  }, mod.name)
                ),
                // Chevron
                e('span', { style: { color: 'var(--label4)', fontSize: '18px', flexShrink: 0 } }, 'â€º')
              )
            )
          )
        ),

        // Footer
        e('div', {
          style: { textAlign: 'center', padding: '24px 20px 12px', paddingBottom: 'calc(12px + env(safe-area-inset-bottom))' }
        },
          e('div', { style: { fontSize: '11px', color: 'var(--label3)', fontWeight: 600, marginBottom: '6px' } }, 'For healthcare professionals only'),
          e('div', { style: { fontSize: '11px', color: 'var(--label4)', lineHeight: '1.5' } }, 'Clinical decision support tool. Interpretation support only. Not a substitute for clinical judgement.'),
          e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '4px' } }, 'Verify reference ranges against your laboratory'),
          e('button', {
            onClick: () => onSelectModule('terms'),
            style: {
              background: 'none',
              border: 'none',
              color: 'var(--accent)',
              fontSize: '11px',
              fontWeight: 500,
              marginTop: '12px',
              cursor: 'pointer',
              fontFamily: 'var(--font)'
            }
          }, 'Terms of Use'),
          e('div', { style: { fontSize: '10px', color: 'var(--label4)', marginTop: '8px' } }, 'Â© 2026 Critical Condition')
        )
      );
    }

    // Placeholder Screen for non-TFT modules
    function PlaceholderScreen({ moduleId, onBack }) {
      const mod = modules.find(m => m.id === moduleId);
      return e('div', null,
        e(NavBar, { title: mod?.name || 'Module', onBack }),
        e('div', {
          style: {
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '80px 20px',
            textAlign: 'center'
          }
        },
          e('span', { style: { fontSize: '48px', marginBottom: '16px' } }, mod?.icon || 'ðŸ“‹'),
          e('div', { style: { fontSize: '20px', fontWeight: 700, color: 'var(--label)', marginBottom: '8px' } }, 'Coming Soon'),
          e('div', { style: { fontSize: '14px', color: 'var(--label3)' } }, mod?.desc || 'This module is under development')
        )
      );
    }

    // ========== TFT MODULE ==========

    function TFTModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const [acutelyUnwell, setAcutelyUnwell] = useState(null);
      // Consolidated related thyroid state to reduce re-renders
      const [tftState, setTftState] = useState({ tsh: null, ft4: null, ft3: null });
      // Convenience accessors
      const tshResult = tftState.tsh;
      const ft4Status = tftState.ft4;
      const ft3Status = tftState.ft3;
      const setTshResult = (val) => setTftState(prev => ({ ...prev, tsh: val }));
      const setFt4Status = (val) => setTftState(prev => ({ ...prev, ft4: val }));
      const setFt3Status = (val) => setTftState(prev => ({ ...prev, ft3: val }));

      // Auto-advance for ChoiceButton-only screens
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Dynamic screen count: 5 screens if TSH low (need fT3), else 4 screens
      const getTotalScreens = () => tshResult === 'low' ? 5 : 4;
      const getResultsScreen = () => tshResult === 'low' ? 4 : 3;

      const handleBack = () => {
        clearAutoAdvance();
        if (step === 0) {
          onBack();
        } else if (step === getResultsScreen()) {
          // From results, go back to fT3 (if TSH low) or fT4
          setStep(tshResult === 'low' ? 3 : 2);
        } else {
          setStep(step - 1);
        }
      };

      const goToStep = (newStep) => {
        document.activeElement.blur();
        setStep(newStep);
        if (containerRef.current) {
          containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
        }
      };

      const resetModule = () => {
        setStep(0);
        setAcutelyUnwell(null);
        setTftState({ tsh: null, ft4: null, ft3: null });
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
      };

      // Get TSH display values with explicit null/undefined handling
      const getTSHDisplay = () => {
        if (tshResult === null || tshResult === undefined) return { value: 'Not set', interpretation: '' };
        if (tshResult === 'low') return { value: 'Low (< 0.4)', interpretation: 'Suppressed' };
        if (tshResult === 'high') return { value: 'High (> 4.0)', interpretation: 'Elevated' };
        if (tshResult === 'normal') return { value: 'Normal (0.4â€“4.0)', interpretation: 'Within range' };
        return { value: 'Unknown', interpretation: '' };
      };

      const getFT4Display = () => {
        if (ft4Status === null || ft4Status === undefined) return { value: 'Not set', interp: '' };
        if (ft4Status === 'low') return { value: 'Low (< 12)', interp: 'Below range' };
        if (ft4Status === 'high') return { value: 'High (> 22)', interp: 'Above range' };
        if (ft4Status === 'normal') return { value: 'Normal (12â€“22)', interp: 'Within range' };
        return { value: 'Unknown', interp: '' };
      };

      const getFT3Display = () => {
        if (ft3Status === null || ft3Status === undefined) return { value: 'Not set', interp: '' };
        if (ft3Status === 'low') return { value: 'Low (< 3.1)', interp: 'Below range' };
        if (ft3Status === 'high') return { value: 'High (> 6.8)', interp: 'Above range' };
        if (ft3Status === 'normal') return { value: 'Normal (3.1â€“6.8)', interp: 'Within range' };
        return { value: 'Unknown', interp: '' };
      };

      // Main TFT flow
      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Thyroid Function', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens() }),

          // SCREEN 0: Is the patient acutely unwell? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'Is the patient acutely unwell?'),
            e('div', { style: STYLES.screenSubtitle }, 'This changes how we interpret the results'),
            e(ChoiceButton, {
              label: 'Yes - acutely unwell (eg, ICU)',
              selected: acutelyUnwell === true,
              onClick: () => {
                clearAutoAdvance();
                setAcutelyUnwell(true);
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'No - stable outpatient',
              selected: acutelyUnwell === false,
              onClick: () => {
                clearAutoAdvance();
                setAcutelyUnwell(false);
                scheduleAdvance(() => goToStep(1), false); // 300ms delay
              },
              color: 'var(--accent)'
            }),
            acutelyUnwell === true && e(WarningBanner, { onContinue: () => goToStep(1) },
              e('strong', null, 'Acute illness'), ' can cause transient changes in thyroid function tests (often low T3, sometimes low T4 and/or low-normal TSH). Interpret alongside the clinical context, medications, and prior results. Repeat testing once clinically stable can help confirm whether abnormalities persist.'
            ),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', textAlign: 'center', marginTop: '12px' } }, 'Reference ranges shown are typical adult examples. Always verify against your local laboratory reference ranges.')
          ),

          // SCREEN 1: What is the TSH? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'What is the TSH?'),
            e('div', { style: STYLES.screenSubtitle }, 'Normal: 0.4â€“4.0 mU/L'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 0.4 mU/L',
              selected: tshResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setTshResult('low');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'Normal  0.4â€“4.0 mU/L',
              selected: tshResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setTshResult('normal');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 4.0 mU/L',
              selected: tshResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setTshResult('high');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--accent)'
            }),
            e('div', {
              style: { fontSize: '12px', color: 'var(--label3)', marginTop: '12px', padding: '10px 12px', background: 'rgba(142,142,147,0.06)', borderRadius: '10px' }
            }, 'ðŸ’¡ In first trimester pregnancy, TSH as low as 0.1 can be physiological due to hCG cross-reactivity. Use trimester-specific reference ranges.')
          ),

          // SCREEN 2: What is the fT4? (ChoiceButtons, auto-advance)
          step === 2 && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'What is the fT4?'),
            e('div', { style: STYLES.screenSubtitle }, 'Normal: 12â€“22 pmol/L'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 12 pmol/L',
              selected: ft4Status === 'low',
              onClick: () => {
                clearAutoAdvance();
                setFt4Status('low');
                scheduleAdvance(() => goToStep(tshResult === 'low' ? 3 : getResultsScreen()), false);
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'Normal  12â€“22 pmol/L',
              selected: ft4Status === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setFt4Status('normal');
                scheduleAdvance(() => goToStep(tshResult === 'low' ? 3 : getResultsScreen()), false);
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 22 pmol/L',
              selected: ft4Status === 'high',
              onClick: () => {
                clearAutoAdvance();
                setFt4Status('high');
                scheduleAdvance(() => goToStep(tshResult === 'low' ? 3 : getResultsScreen()), false);
              },
              color: 'var(--accent)'
            })
          ),

          // SCREEN 3: What is the fT3? (only if TSH low, ChoiceButtons, auto-advance)
          step === 3 && tshResult === 'low' && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'What is the fT3?'),
            e('div', { style: STYLES.screenSubtitle }, 'Normal: 3.1â€“6.8 pmol/L'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 3.1 pmol/L',
              selected: ft3Status === 'low',
              onClick: () => {
                clearAutoAdvance();
                setFt3Status('low');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'Normal  3.1â€“6.8 pmol/L',
              selected: ft3Status === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setFt3Status('normal');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 6.8 pmol/L',
              selected: ft3Status === 'high',
              onClick: () => {
                clearAutoAdvance();
                setFt3Status('high');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--accent)'
            }),
            e('div', {
              style: { fontSize: '12px', color: 'var(--label3)', marginTop: '12px', padding: '10px 12px', background: 'rgba(142,142,147,0.06)', borderRadius: '10px' }
            }, 'ðŸ’¡ fT3 not available? If clinical suspicion of hyperthyroidism is high but fT4 is normal, consider requesting fT3 â€” about 5% of hyperthyroidism is T3-predominant.')
          ),

          // RESULTS SCREEN (step 3 if TSH not low, step 4 if TSH low)
          step === getResultsScreen() && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'Interpretation'),

            // Compact input summary
            e(InputSummaryStrip, { items: [
              { label: 'TSH', ...getTSHDisplay() },
              ft4Status && { label: 'fT4', ...getFT4Display() },
              ft3Status && tshResult === 'low' && { label: 'fT3', ...getFT3Display() }
            ].filter(Boolean) }),

            e('div', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label3)', letterSpacing: '0.03em', marginBottom: '10px' } }, 'Differential'),

            // TSH LOW pathways
            tshResult === 'low' && ft4Status === 'high' && e(DiffListItem, {
              title: 'Overt Hyperthyroidism',
              tags: ['Graves\'', 'Toxic MNG', 'Toxic adenoma']
            }, 'Thyrotoxicosis. Most commonly Graves\', toxic MNG, or toxic adenoma.'),

            tshResult === 'low' && ft4Status === 'normal' && ft3Status === 'high' && e(DiffListItem, {
              title: 'T3 Thyrotoxicosis',
              tags: ['~5% of hyperthyroidism', 'Early Graves\'', 'Toxic adenoma']
            }, 'About 5% of hyperthyroidism is T3-predominant. Consider early Graves\' or autonomous adenoma.'),

            tshResult === 'low' && ft4Status === 'normal' && (ft3Status === 'normal' || !ft3Status) && !(ft3Status === 'high') && e(DiffListItem, {
              title: 'Subclinical Hyperthyroidism',
              tags: ['May be transient', 'Arrhythmia association', 'Bone health association'],
              infoPanel: e(InfoPanel, { title: 'Subclinical Hyperthyroidism' },
                e('p', null, 'Clinical significance varies with the degree and persistence of TSH suppression and the clinical context (age, comorbidities, and likely cause). Persistent or more marked suppression has been associated in some studies with higher rates of atrial arrhythmias and reduced bone density. Mild suppression is common and may be transient. Confirm discordant results and consider potential confounders (acute illness, medications, assay interference).')
              )
            }, 'Suppressed TSH with normal free T4 and free T3. Can be transient (eg, intercurrent illness, medication effects, resolving thyroiditis). If persistent, observational data suggest associations with atrial arrhythmias and reduced bone density, particularly in higher-risk groups.'),

            tshResult === 'low' && ft4Status === 'low' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'Central Hypothyroidism',
                tags: ['Pituitary failure'],
                defaultOpen: true,
                warning: e(React.Fragment, null, e('strong', null, 'Safety note:'), ' central hypothyroidism can coexist with adrenal insufficiency and other pituitary hormone deficiencies. If pituitary disease is suspected, interpret TFTs in the broader pituitary context and seek senior or endocrine advice.'),
                infoPanel: e(InfoPanel, { title: 'Central Hypothyroidism â€” Why It Matters' },
                  e('p', { style: { marginBottom: '10px' } }, 'Low TSH + low fT4 = pituitary failure, not just thyroid disease.'),
                  e('p', null, 'Pituitary adenoma (mass effect) Â· Pituitary apoplexy Â· Post-surgical/radiation Â· Sheehan\'s syndrome Â· Infiltrative disease (sarcoid, haemochromatosis)')
                )
              }, 'Low or inappropriately normal TSH with low free T4 suggests central hypothyroidism in the right clinical context. Correlate with pituitary symptoms, medications, intercurrent illness, and prior results; specialist review is often required.'),
              e(DiffListItem, {
                title: 'Non-Thyroidal Illness (Recovery Phase)',
                tags: ['Sick euthyroid pattern', 'Transient', 'Context-dependent']
              }, 'During recovery from acute illness, transient discordant TFT patterns can occur (including a temporarily low or low-normal TSH with low free T4). If there has been recent acute illness, interpret cautiously and consider repeat testing once clinically stable before concluding persistent pituitary pathology.')
            ),

            // TSH HIGH pathways
            tshResult === 'high' && ft4Status === 'low' && e(DiffListItem, {
              title: 'Overt Hypothyroidism',
              tags: ['Hashimoto\'s', 'Post-thyroidectomy', 'Post-radioiodine']
            }, 'Primary hypothyroidism. Most commonly Hashimoto\'s â€” check TPO antibodies.'),

            tshResult === 'high' && ft4Status === 'normal' && e(DiffListItem, {
              title: 'Subclinical Hypothyroidism',
              tags: ['Common pattern', 'Autoimmune context', 'Persistence matters'],
              infoPanel: e(InfoPanel, { title: 'Subclinical hypothyroidism: interpretation notes' },
                e('p', null, 'Subclinical hypothyroidism is defined by elevated TSH with normal free T4. It can reflect early autoimmune thyroid disease, recovery from intercurrent illness, medication effects, or biological and analytical variation. Confirming persistence on repeat testing and assessing thyroid autoimmunity (where clinically relevant) can help with aetiology and risk of progression. Management approaches vary across guidelines and depend on patient factors; where uncertainty exists, follow local guidance and consider senior or endocrine input.')
              )
            }, 'Elevated TSH with normal free T4. Common finding that can be transient. Interpretation depends on persistence, degree of TSH elevation, symptoms, pregnancy status, and thyroid autoimmunity.'),

            tshResult === 'high' && ft4Status === 'high' && e(DiffListItem, {
              title: 'Assay Interference or TSH-oma',
              tags: ['Biotin interference', 'Heterophile antibodies', 'Refer endocrinology']
            }, 'Discordant result â€” TSH should be suppressed. Consider biotin interference, heterophile antibodies, or TSH-oma.'),

            // TSH NORMAL pathways
            tshResult === 'normal' && ft4Status === 'normal' && e(DiffListItem, {
              title: 'Euthyroid',
              tags: ['Normal thyroid function'],
              defaultOpen: true
            }, 'TSH and fT4 both normal. Symptoms unlikely to be thyroid-related.'),

            tshResult === 'normal' && ft4Status === 'low' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'Central Hypothyroidism',
                tags: ['Pituitary failure'],
                defaultOpen: true,
                warning: e(React.Fragment, null, e('strong', null, 'Safety note:'), ' central hypothyroidism can coexist with adrenal insufficiency and other pituitary hormone deficiencies. If pituitary disease is suspected, interpret TFTs in the broader pituitary context and seek senior or endocrine advice.'),
                infoPanel: e(InfoPanel, { title: 'Central Hypothyroidism â€” Why It Matters' },
                  e('p', { style: { marginBottom: '10px' } }, 'Normal or low TSH + low fT4 = pituitary failure, not primary thyroid disease.'),
                  e('p', null, 'Pituitary adenoma (mass effect) Â· Pituitary apoplexy Â· Post-surgical/radiation Â· Sheehan\'s syndrome Â· Infiltrative disease (sarcoid, haemochromatosis)')
                )
              }, 'Low or inappropriately normal TSH with low free T4 suggests central hypothyroidism in the right clinical context. Correlate with pituitary symptoms, medications, intercurrent illness, and prior results; specialist review is often required.'),
              e(DiffListItem, {
                title: 'Also Consider',
                tags: ['Alternative explanations']
              }, 'Recent levothyroxine dose change (TSH lags fT4 by several weeks) Â· Recovery from non-thyroidal illness Â· Assay interference (heterophile antibodies, biotin).')
            ),

            tshResult === 'normal' && ft4Status === 'high' && e(DiffListItem, {
              title: 'Assay Interference',
              tags: ['Biotin supplements', 'Heterophile antibodies', 'Recheck']
            }, 'Normal TSH with high free T4 is discordant. Common causes include assay interference (eg, biotin supplements) and interfering antibodies. If results are discordant with the clinical picture, confirm with repeat testing using an approach agreed with the laboratory (eg, repeat after withholding non-essential supplements, or test on a different platform).'),

            // Urgent pattern recognition - thyroid emergencies
            (tshResult === 'low' && ft4Status === 'high') && e('div', {
              style: { background: 'rgba(255,59,48,0.1)', border: '1px solid rgba(255,59,48,0.3)', borderRadius: '12px', padding: '12px', marginTop: '16px' }
            },
              e('div', { style: { fontSize: '13px', fontWeight: 700, marginBottom: '6px' } }, 'ðŸš¨ Urgent Pattern Recognition'),
              e('div', { style: { fontSize: '12px', color: 'var(--label)', lineHeight: '1.5' } },
                'If the patient has ', e('strong', null, 'fever, tachycardia out of proportion to fever, and altered mental status'), ' â€” consider thyroid storm. This is a clinical emergency requiring immediate escalation.'
              )
            ),

            (tshResult === 'high' && ft4Status === 'low') && e('div', {
              style: { background: 'rgba(255,59,48,0.1)', border: '1px solid rgba(255,59,48,0.3)', borderRadius: '12px', padding: '12px', marginTop: '16px' }
            },
              e('div', { style: { fontSize: '13px', fontWeight: 700, marginBottom: '6px' } }, 'ðŸš¨ Urgent Pattern Recognition'),
              e('div', { style: { fontSize: '12px', color: 'var(--label)', lineHeight: '1.5' } },
                'If the patient has ', e('strong', null, 'hypothermia, bradycardia, and altered consciousness'), ' â€” consider myxoedema coma. This is a clinical emergency requiring immediate escalation.'
              )
            ),

            // Further workup section - for hyperthyroidism
            (tshResult === 'low' && (ft4Status === 'high' || (ft4Status === 'normal' && ft3Status === 'high'))) && e('div', {
              style: { background: 'rgba(142,142,147,0.06)', borderRadius: '12px', padding: '12px', marginTop: '16px' }
            },
              e('div', { style: { fontSize: '13px', fontWeight: 700, marginBottom: '8px' } }, 'Further Workup to Clarify Cause'),
              e('div', { style: { fontSize: '12px', color: 'var(--label)', lineHeight: '1.6' } },
                e('div', null, 'â€¢ ', e('strong', null, 'TRAb'), ' â€” positive in Graves\' disease'),
                e('div', null, 'â€¢ ', e('strong', null, 'TPO antibodies'), ' â€” supports autoimmune aetiology'),
                e('div', null, 'â€¢ ', e('strong', null, 'Thyroid uptake scan'), ' â€” distinguishes high-uptake (Graves\', toxic nodule) from low-uptake (thyroiditis, exogenous) causes')
              )
            ),

            // Further workup section - for hypothyroidism
            (tshResult === 'high' && ft4Status === 'low') && e('div', {
              style: { background: 'rgba(142,142,147,0.06)', borderRadius: '12px', padding: '12px', marginTop: '16px' }
            },
              e('div', { style: { fontSize: '13px', fontWeight: 700, marginBottom: '8px' } }, 'Further Workup to Clarify Cause'),
              e('div', { style: { fontSize: '12px', color: 'var(--label)', lineHeight: '1.6' } },
                e('div', null, 'â€¢ ', e('strong', null, 'TPO antibodies'), ' â€” positive in Hashimoto\'s thyroiditis (most common cause)'),
                e('div', null, 'â€¢ Repeat TFTs after an interval if recent illness or uncertain chronicity')
              )
            ),

            e('div', { style: { marginTop: '20px' } },
              e(PrimaryButton, {
                label: 'New Analysis',
                color: 'var(--accent)',
                onClick: resetModule
              }),
              e('button', {
                onClick: onBack,
                style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
              }, 'â† All modules')
            ),

            e(LearnMoreDivider),

            // Causes of Hyperthyroidism InfoPanel (when hyperthyroid)
            (tshResult === 'low' && (ft4Status === 'high' || (ft4Status === 'normal' && ft3Status === 'high'))) && e(InfoPanel, { title: 'Causes of Hyperthyroidism', collapsed: true },
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'High uptake on thyroid scan (â†‘ synthesis):'),
              e('ul', { style: { marginLeft: '16px', marginBottom: '12px' } },
                e('li', null, 'Graves\' disease â€” diffuse uptake, TRAb positive'),
                e('li', null, 'Toxic multinodular goitre â€” patchy uptake'),
                e('li', null, 'Toxic adenoma â€” single hot nodule')
              ),
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'Low uptake on thyroid scan (preformed hormone release):'),
              e('ul', { style: { marginLeft: '16px', marginBottom: '12px' } },
                e('li', null, 'Thyroiditis (subacute, postpartum, silent)'),
                e('li', null, 'Exogenous thyroid hormone'),
                e('li', null, 'Iodine-induced (amiodarone, contrast)')
              ),
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'Key distinguishing features:'),
              e('ul', { style: { marginLeft: '16px' } },
                e('li', null, 'Graves\': eye signs, diffuse goitre, TRAb positive'),
                e('li', null, 'Thyroiditis: tender thyroid, self-limiting'),
                e('li', null, 'Amiodarone: Type 1 (synthesis) vs Type 2 (destructive)')
              )
            ),

            // Assay interference panel - only show when relevant
            ((tshResult === 'high' && ft4Status === 'high') || (tshResult === 'normal' && ft4Status === 'high')) && e(InfoPanel, { title: 'Assay Interference â€” the Hidden Trap' },
              e('p', { style: { marginBottom: '10px' } },
                e('strong', null, 'Biotin (Vitamin B7):'), ' High-dose biotin supplements (common in "hair and nails" products, also MS treatment) interfere with streptavidin-biotin immunoassays. Can cause falsely â†‘fT4, â†‘fT3, â†“TSH â€” mimicking hyperthyroidism.'
              ),
              e('p', { style: { marginBottom: '10px' } },
                e('strong', null, 'Heterophile antibodies:'), ' Antibodies that interfere with immunoassays. Can cause falsely high or low results. Suspect if discordant with clinical picture.'
              ),
              e('p', null,
                e('strong', null, 'Hook effect:'), ' Very high analyte concentrations can saturate assay and give falsely low/normal results. Rare but relevant in pregnancy and severe thyrotoxicosis.'
              )
            ),

            e(InfoPanel, { title: 'Drug-Induced Thyroid Dysfunction' },
              e('p', { style: { marginBottom: '10px' } }, 'These medications can alter thyroid function and/or interfere with thyroid tests. In patients taking them, periodic thyroid function monitoring is commonly recommended, but frequency varies by guideline and local protocol. Interpret results in clinical context.'),
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Amiodarone:'),
              e('p', { style: { marginBottom: '10px' } }, 'Can cause BOTH hypo- and hyperthyroidism. Hypothyroidism more common in iodine-replete populations (Australia). Type 1 thyrotoxicosis (excess synthesis) vs Type 2 (destructive thyroiditis) â€” distinction matters for interpretation.'),
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Lithium:'),
              e('p', { style: { marginBottom: '10px' } }, 'Causes hypothyroidism in up to 20% of patients. Concentrates in thyroid and inhibits hormone release.'),
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Other drugs:'),
              e('p', null, 'Immune checkpoint inhibitors (pembrolizumab, nivolumab) â†’ thyroiditis then hypothyroidism. Tyrosine kinase inhibitors â†’ hypothyroidism. Dopamine/glucocorticoids â†’ suppress TSH.')
            ),

            // Postpartum thyroiditis - show when hyperthyroid
            (tshResult === 'low' && (ft4Status === 'high' || (ft4Status === 'normal' && ft3Status === 'high'))) && e(InfoPanel, { title: 'Postpartum Thyroiditis' },
              e('p', { style: { marginBottom: '10px' } }, 'Affects 5â€“10% of women within 12 months of delivery. Autoimmune destructive process â€” often TPO antibody positive.'),
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Typical pattern:'),
              e('ul', { style: { marginLeft: '16px', marginBottom: '12px' } },
                e('li', null, 'Hyperthyroid phase (1â€“4 months postpartum) â€” preformed hormone release'),
                e('li', null, 'Hypothyroid phase (4â€“8 months postpartum) â€” gland recovery'),
                e('li', null, 'Usually self-resolves, but ~20% develop permanent hypothyroidism')
              ),
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Key interpretation points:'),
              e('ul', { style: { marginLeft: '16px' } },
                e('li', null, 'Low uptake on thyroid scan (distinguishes from Graves\')'),
                e('li', null, 'No eye signs (unlike Graves\')'),
                e('li', null, 'Often painless (unlike subacute thyroiditis)')
              )
            )
          )
        )
      );
    }

    // ========== HYPONATRAEMIA MODULE ==========

    function HyponatraemiaModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);

      // Auto-advance for ChoiceButton-only screens
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Serum Sodium (ValueInput)
      const [naValue, setNaValue] = useState('');

      // Screen 1: Chronicity (ChoiceButtons)
      const [chronicity, setChronicity] = useState(null);

      // Screen 2: Serum Osmolality (ChoiceButtons, branches)
      const [serumOsmResult, setSerumOsmResult] = useState(null);

      // Screen 2a: Glucose for corrected Na (if hyper-osmolar)
      const [glucose, setGlucose] = useState('');

      // Screen 3: Urine Osmolality (if hypotonic)
      const [urineOsmResult, setUrineOsmResult] = useState(null);

      // Screen 4: Urine Sodium (if hypotonic)
      const [urineNaResult, setUrineNaResult] = useState(null);

      // Determine path based on serum osmolality
      const isShortPath = serumOsmResult === 'normal' || serumOsmResult === 'high';
      const isHyperOsmolar = serumOsmResult === 'high';
      const isIsoOsmolar = serumOsmResult === 'normal';

      // Dynamic screen count:
      // Short path (iso/hyper): 0-Na, 1-Chronicity, 2-SerumOsm, 2a-Glucose(hyper only), 3-Results
      // Long path (hypotonic): 0-Na, 1-Chronicity, 2-SerumOsm, 3-UrineOsm, 4-UrineNa, 5-Results
      const getTotalScreens = () => {
        if (isIsoOsmolar) return 4; // Na, Chronicity, SerumOsm, Results
        if (isHyperOsmolar) return 5; // Na, Chronicity, SerumOsm, Glucose, Results
        return 6; // Na, Chronicity, SerumOsm, UrineOsm, UrineNa, Results
      };

      const getResultsScreen = () => {
        if (isIsoOsmolar) return 3;
        if (isHyperOsmolar) return 4;
        return 5;
      };

      const scrollToTop = () => {
        if (containerRef.current) {
          containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
        }
      };

      const goToStep = (newStep) => {
        document.activeElement.blur();
        setStep(newStep);
        scrollToTop();
      };

      const resetModule = () => {
        setStep(0);
        setNaValue('');
        setChronicity(null);
        setSerumOsmResult(null);
        setGlucose('');
        setUrineOsmResult(null);
        setUrineNaResult(null);
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
      };

      const handleBack = () => {
        clearAutoAdvance();
        if (step === 0) {
          onBack();
        } else if (step === getResultsScreen()) {
          // From results, go back to previous screen based on path
          if (isIsoOsmolar) goToStep(2);
          else if (isHyperOsmolar) goToStep(3); // glucose screen
          else goToStep(4); // urine na
        } else {
          goToStep(step - 1);
        }
      };

      // Severity assessment
      const getSeverity = () => {
        const na = parseFloat(naValue);
        if (isNaN(na)) return null;
        if (na > 130) return { color: 'var(--green)', interp: 'Mild â€” usually asymptomatic' };
        if (na >= 125) return { color: 'var(--orange)', interp: 'Moderate â€” confusion, nausea, headache likely' };
        if (na >= 120) return { color: 'var(--orange)', interp: 'Significant â€” high risk of symptoms' };
        return { color: 'var(--red)', interp: 'Severe â€” seizures, coma, cerebral oedema risk' };
      };

      // Corrected Na calculation (Katz formula)
      const getCorrectedNa = () => {
        const na = parseFloat(naValue);
        const glu = parseFloat(glucose);
        if (isNaN(na) || isNaN(glu) || glu <= 5.5) return null;
        return (na + 0.3 * (glu - 5.5)).toFixed(1);
      };

      // Na display for branch cards
      const getNaDisplay = () => {
        const severity = getSeverity();
        return {
          value: naValue ? `${naValue} mmol/L` : '',
          interpretation: severity?.interp || '',
          color: severity?.color || 'var(--accent)'
        };
      };

      // Display functions with explicit null/undefined handling
      const getSerumOsmDisplay = () => {
        if (serumOsmResult === null || serumOsmResult === undefined) return { value: 'Not set', interpretation: '' };
        if (serumOsmResult === 'low') return { value: 'Low (< 275)', interpretation: 'Hypotonic' };
        if (serumOsmResult === 'normal') return { value: 'Normal (275â€“295)', interpretation: 'Iso-osmolar' };
        if (serumOsmResult === 'high') return { value: 'High (> 295)', interpretation: 'Hyper-osmolar' };
        if (serumOsmResult === 'skip') return { value: 'Not available', interpretation: 'Assumed hypotonic', color: 'var(--label3)' };
        return { value: 'Unknown', interpretation: '' };
      };

      const getUrineOsmDisplay = () => {
        if (urineOsmResult === null || urineOsmResult === undefined) return { value: 'Not set', interpretation: '' };
        if (urineOsmResult === 'low') return { value: 'Low (< 100)', interpretation: 'Dilute â€” kidneys working' };
        if (urineOsmResult === 'high') return { value: 'High (> 100)', interpretation: 'Concentrated â€” ADH active' };
        return { value: 'Unknown', interpretation: '' };
      };

      const getUrineNaDisplay = () => {
        if (urineNaResult === null || urineNaResult === undefined) return { value: 'Not set', interpretation: '' };
        if (urineNaResult === 'low') return { value: 'Low (< 30)', interpretation: 'Retained â€” kidneys conserving' };
        if (urineNaResult === 'high') return { value: 'High (> 30)', interpretation: 'Wasted â€” sodium loss' };
        return { value: 'Unknown', interpretation: '' };
      };

      // Main flow
      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Hyponatraemia', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens() }),

          // SCREEN 0: Serum sodium (ValueInput, Next button)
          step === 0 && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'What is the serum sodium?'),
            e('div', { style: STYLES.screenSubtitle }, 'This determines the severity'),
            e(ValueInput, {
              label: 'Serum Sodium',
              unit: 'mmol/L',
              value: naValue,
              onChange: setNaValue,
              placeholder: '135 â€“ 145',
              hint: 'Normal: 135â€“145'
            }),
            getSeverity() && e(SeverityBadge, { text: getSeverity().interp, color: getSeverity().color }),
            e(PrimaryButton, {
              label: 'Next',
              disabled: !naValue,
              color: 'var(--accent)',
              onClick: () => goToStep(1)
            }),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', textAlign: 'center', marginTop: '12px' } }, 'Reference ranges shown are typical adult examples. Always verify against your local laboratory reference ranges.')
          ),

          // SCREEN 1: How quickly did this develop? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'How quickly did this develop?'),
            e('div', { style: STYLES.screenSubtitle }, 'If the duration is >48 hours or unknown, it is generally classified as chronic for risk stratification.'),
            e(ChoiceButton, {
              label: 'Acute  â€¹ 48 hours',
              sublabel: 'Less time for cerebral adaptation',
              selected: chronicity === 'acute',
              onClick: () => {
                clearAutoAdvance();
                setChronicity('acute');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'Chronic  â€º 48 hours',
              sublabel: 'Cerebral adaptation likely; rapid change can be harmful',
              selected: chronicity === 'chronic',
              onClick: () => {
                clearAutoAdvance();
                setChronicity('chronic');
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'Unknown',
              sublabel: 'If uncertain, classify as chronic (risk-averse)',
              selected: chronicity === 'unknown',
              onClick: () => {
                clearAutoAdvance();
                setChronicity('unknown');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--accent)'
            }),
            chronicity === 'chronic' && e(WarningBanner, { onContinue: () => goToStep(2) }, 'Brain has adapted. Rapid correction risks osmotic demyelination syndrome (ODS).')
          ),

          // SCREEN 2: Serum osmolality (ChoiceButtons, auto-advance, branches)
          step === 2 && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'Check serum osmolality'),
            e('div', { style: STYLES.screenSubtitle }, 'Determines whether this is true hyponatraemia'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 275 mOsm/kg',
              selected: serumOsmResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('low');
                scheduleAdvance(() => goToStep(3), false); // Continue to urine osm
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'Normal  275â€“295 mOsm/kg',
              selected: serumOsmResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('normal');
                scheduleAdvance(() => goToStep(3), false); // Go to iso-osmolar results
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 295 mOsm/kg',
              selected: serumOsmResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('high');
                scheduleAdvance(() => goToStep(3), false); // Go to glucose input
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'Not available',
              selected: serumOsmResult === 'skip',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('skip');
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--label3)'
            }),
            serumOsmResult === 'skip' && e(WarningBanner, { onContinue: () => goToStep(3) },
              'If glucose is significantly elevated (>15 mmol/L), serum osmolality may be high â€” check glucose before assuming hypotonic.'
            )
          ),

          // SCREEN 3: Path-dependent
          // If iso-osmolar â†’ Results
          step === 3 && isIsoOsmolar && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'Interpretation'),
            e('div', { style: STYLES.screenSubtitle }, 'Iso-osmolar hyponatraemia'),
            e(InputSummaryStrip, { items: [
              { label: 'Na', ...getNaDisplay() },
              { label: 'Serum Osm', ...getSerumOsmDisplay() }
            ] }),
            e('div', {
              style: { fontSize: '12px', color: 'var(--label3)', marginTop: '4px', marginBottom: '12px', padding: '10px 12px', background: 'rgba(142,142,147,0.06)', borderRadius: '10px' }
            }, 'ðŸ’¡ If iso-osmolar but clinical picture doesn\'t fit pseudohyponatraemia, consider adrenal insufficiency in the differential if the clinical picture is compatible.'),
            e(DiffListItem, {
              title: 'Pseudohyponatraemia',
              tags: ['Measurement artefact', 'Check Na on VBG'],
              defaultOpen: true,
              infoPanel: e(InfoPanel, { title: 'Tonicity vs Osmolality' },
                e('p', { style: { marginBottom: '10px' } }, 'Urea and ethanol contribute to measured osmolality but are ineffective osmoles (cross cell membranes freely).'),
                e('p', null, 'Tonicity = Osmolality âˆ’ Urea. If in doubt, calculate tonicity or check Na on VBG.')
              )
            }, 'Usually measurement error secondary to hyperlipidaemia or hyperproteinaemia. Check Na on VBG (direct ion-selective electrode).'),
            e('div', {
              style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center', lineHeight: '1.5' }
            }, 'If the clinical picture doesn\'t match the lab interpretation, re-examine the patient and repeat the tests.'),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', textAlign: 'center' } }, 'Reference ranges vary by laboratory. Verify against your local reference ranges.'),
            e(PrimaryButton, { label: 'New Analysis', onClick: resetModule }),
            e('button', {
              onClick: onBack,
              style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
            }, 'â† All modules')
          ),

          // If hyper-osmolar â†’ Glucose input screen
          step === 3 && isHyperOsmolar && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'Enter glucose'),
            e('div', { style: STYLES.screenSubtitle }, 'To calculate corrected sodium'),
            e(ValueInput, {
              label: 'Glucose',
              unit: 'mmol/L',
              value: glucose,
              onChange: setGlucose,
              placeholder: 'Enter value',
              hint: 'For corrected Na calculation'
            }),
            getCorrectedNa() && e(BranchCard, {
              label: 'Corrected Na',
              value: `${getCorrectedNa()} mmol/L`,
              interpretation: 'Predicted Na once glucose normalises',
              color: 'var(--accent)'
            }),
            e(PrimaryButton, {
              label: 'See Results',
              color: 'var(--accent)',
              onClick: () => goToStep(4)
            })
          ),

          // If hypotonic â†’ Urine Osmolality
          step === 3 && !isShortPath && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'What is the urine osmolality?'),
            e('div', { style: STYLES.screenSubtitle }, 'Is the kidney diluting appropriately?'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 100 mOsm/kg',
              selected: urineOsmResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setUrineOsmResult('low');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 100 mOsm/kg',
              selected: urineOsmResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setUrineOsmResult('high');
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--accent)'
            }),
            urineOsmResult === 'high' && e(WarningBanner, { onContinue: () => goToStep(4) }, 'Urinary biochemistry is confounded by diuretics, vasopressin, and DDAVP. Interpret with caution.')
          ),

          // SCREEN 4: Path-dependent
          // If hyper-osmolar â†’ Results
          step === 4 && isHyperOsmolar && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'Interpretation'),
            e('div', { style: STYLES.screenSubtitle }, 'Hyper-osmolar hyponatraemia'),
            e(InputSummaryStrip, { items: [
              { label: 'Na', ...getNaDisplay() },
              { label: 'Serum Osm', ...getSerumOsmDisplay() },
              getCorrectedNa() && { label: 'Corrected Na', value: `${getCorrectedNa()} mmol/L` }
            ].filter(Boolean) }),
            e(DiffListItem, {
              title: 'Hyper-osmolar Hyponatraemia',
              tags: ['Hyperglycaemia', 'Mannitol', 'IVIg'],
              defaultOpen: true,
              warning: 'Risk of cerebral oedema if BSL is corrected without commensurate rise in Na.'
            }, 'Dilutional effect â€” water drawn into intravascular space by osmotically active solutes.'),

            e('div', {
              style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center', lineHeight: '1.5' }
            }, 'If the clinical picture doesn\'t match the lab interpretation, re-examine the patient and repeat the tests.'),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', textAlign: 'center' } }, 'Reference ranges vary by laboratory. Verify against your local reference ranges.'),

            e(PrimaryButton, { label: 'New Analysis', onClick: resetModule }),
            e('button', {
              onClick: onBack,
              style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
            }, 'â† All modules')
          ),

          // If hypotonic â†’ Urine Sodium
          step === 4 && !isShortPath && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'What is the urine sodium?'),
            e('div', { style: STYLES.screenSubtitle }, 'Is the kidney conserving sodium?'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 30 mmol/L',
              selected: urineNaResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setUrineNaResult('low');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--accent)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 30 mmol/L',
              selected: urineNaResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setUrineNaResult('high');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--accent)'
            })
          ),

          // SCREEN 5: Hypotonic Results (full differential)
          step === 5 && !isShortPath && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'Interpretation'),
            e('div', { style: STYLES.screenSubtitle }, 'Hypotonic hyponatraemia'),

            // Compact input summary
            e(InputSummaryStrip, { items: [
              { label: 'Na', ...getNaDisplay() },
              { label: 'Serum Osm', ...getSerumOsmDisplay() },
              { label: 'Urine Osm', ...getUrineOsmDisplay() },
              { label: 'Urine Na', ...getUrineNaDisplay() }
            ] }),

            e('div', {
              style: { fontSize: '12px', fontWeight: 600, color: 'var(--label3)', letterSpacing: '0.03em', marginBottom: '10px' }
            }, 'Differential'),

            // PATH A: Low Urine Osm + Low Urine Na
            urineOsmResult === 'low' && urineNaResult === 'low' && e(React.Fragment, null,
              e(DiagnosisHeader, {
                title: 'Excess Water Intake',
                description: 'Kidneys are diluting maximally but water intake exceeds their capacity to defend tonicity.'
              }),
              e(DiffCard, { title: 'Excess IV fluid', description: 'Iatrogenic. Excess hypotonic fluid can contribute.' }),
              e(DiffCard, { title: 'Primary polydipsia', description: 'Psychiatric or medication-related. Water intake often >10L/day.' }),
              e(DiffCard, { title: 'Beer potomania', description: 'Very low solute diet limits renal free water excretion capacity.' }),
              e(DiffCard, { title: 'Reset osmostat', description: 'Stable mild hyponatraemia with intact water excretion (regulated around a lower set point).' })
            ),

            // PATH B: Low Urine Osm + High Urine Na
            urineOsmResult === 'low' && urineNaResult === 'high' && e(React.Fragment, null,
              e(DiagnosisHeader, {
                title: 'Renal Salt & Water Wasting',
                description: 'Kidneys are wasting both salt and water â€” unable to concentrate or conserve sodium.'
              }),
              e(DiffCard, { title: 'AKI (GFR <15)', description: 'Severely reduced GFR impairs all tubular function.' }),
              e(DiffCard, { title: 'Post-obstructive diuresis', description: 'After relief of urinary obstruction. Can be massive.' }),
              e(DiffCard, { title: 'Polyuric phase of ATN', description: 'Recovery phase of acute tubular necrosis.' })
            ),

            // PATH C: High Urine Osm + Low Urine Na
            urineOsmResult === 'high' && urineNaResult === 'low' && e(React.Fragment, null,
              e(DiagnosisHeader, {
                title: 'Hypovolaemia or Effective Hypovolaemia',
                description: 'Actual or effective volume depletion â†’ RAAS overactivation. The body is defending volume over tonicity â€” retaining water even at the expense of worsening hyponatraemia.',
                infoPanel: e(InfoPanel, { title: 'Volume over Tonicity' },
                  e('p', null, 'The baroreceptor reflex is a stronger stimulus for ADH release than the osmoreceptor reflex. When intravascular volume is low (or perceived as low â€” heart failure, liver failure), the body will retain water even at the expense of worsening hyponatraemia. This is because volume depletion kills faster than low sodium.')
                )
              }),
              e(DiffCard, { title: 'True hypovolaemia', description: 'Bleeding, GI losses, third-spacing. Look for tachycardia, orthostatic hypotension, poor skin turgor.' }),
              e(DiffCard, { title: 'Heart failure', description: 'Effective hypovolaemia despite total body fluid overload. Poor cardiac output â†’ RAAS activation.' }),
              e(DiffCard, { title: 'Liver failure / cirrhosis', description: 'Splanchnic vasodilation â†’ effective hypovolaemia. Ascites present.' }),
              e(DiffCard, { title: 'Nephrotic syndrome', description: 'Hypoalbuminaemia â†’ reduced oncotic pressure â†’ effective hypovolaemia.' })
            ),

            // PATH D: High Urine Osm + High Urine Na
            urineOsmResult === 'high' && urineNaResult === 'high' && e(React.Fragment, null,
              e(DiagnosisHeader, {
                title: 'Water Retention with Sodium Wasting',
                description: 'ADH is active (water retention) AND kidneys are wasting sodium. This is the broadest differential â€” clinical context is critical.'
              }),

              e(DiffListItem, {
                title: 'SIADH',
                warning: 'Adrenal insufficiency can mimic SIADH biochemistry; consider it in the differential when evaluating euvolaemic hyponatraemia.'
              }, 'Most common cause of euvolaemic hyponatraemia. Diagnosis of exclusion â€” ensure no adrenal insufficiency, hypothyroidism, or renal failure.'),

              e(DiffCard, { title: 'Adrenal insufficiency (Addison\'s, pan-hypopit)', description: 'Aldosterone deficiency â†’ Na wasting. Cortisol deficiency â†’ impaired free water excretion.' }),

              e(DiffCard, { title: 'Hypothyroidism', description: 'Mechanism unclear but well-recognised association. Check TFTs.' }),

              e(DiffCard, { title: 'Cerebral salt wasting', description: 'Polyuric (unlike SIADH which is oliguric). Related to â†‘BNP/ANP â†’ natriuresis â†’ hypovolaemia. Appropriate ADH secretion to compensate.' }),

              e(DiffCard, { title: 'Thiazide diuretic', description: 'Common and frequently overlooked. Thiazides impair diluting capacity in the distal tubule. Loop diuretics are LESS likely to cause hyponatraemia (they impair concentrating ability).' }),

              e(DiffCard, { title: 'AKI (GFR <15)', description: 'Impaired dilution and sodium handling.' }),

              e(DiffCard, { title: 'Post-obstructive diuresis / Polyuric ATN', description: 'Recovery phase â€” kidneys wasting everything.' }),

              e(InfoPanel, { title: 'SIADH vs Cerebral Salt Wasting â€” the Key Distinction' },
                e('p', { style: { marginBottom: '12px' } }, 'Both cause hyponatraemia with high urine osm and high urine Na. The critical difference is volume status:'),
                e('div', { style: { display: 'flex', gap: '8px', marginBottom: '12px' } },
                  e('div', { style: { flex: 1, background: 'rgba(142,142,147,0.06)', borderRadius: '10px', padding: '10px 12px' } },
                    e('strong', null, 'SIADH:'),
                    e('div', { style: { fontSize: '12px', marginTop: '4px' } }, 'Euvolaemic or mildly hypervolaemic. Oliguric (low urine output). Urine osm typically >300.')
                  ),
                  e('div', { style: { flex: 1, background: 'rgba(142,142,147,0.06)', borderRadius: '10px', padding: '10px 12px' } },
                    e('strong', null, 'CSW:'),
                    e('div', { style: { fontSize: '12px', marginTop: '4px' } }, 'Hypovolaemic. Polyuric (high urine output). Signs of volume depletion (tachycardia, orthostatic hypotension).')
                  )
                ),
                e('p', null, e('strong', null, 'Distinguishing these matters:'), ' management differs significantly and misdiagnosis can worsen outcomes.')
              )
            ),

            e(LearnMoreDivider),

            e(InfoPanel, { title: 'Osmotic Demyelination Syndrome (ODS)' },
              e('p', { style: { marginBottom: '8px' } }, 'ODS (formerly central pontine myelinolysis) is a serious complication of overly rapid sodium correction in chronic hyponatraemia.'),
              e('p', { style: { marginBottom: '8px' } }, 'The brain adapts to chronic hyponatraemia by losing organic osmolytes. Rapid correction causes water to shift out of brain cells, leading to demyelination.'),
              e('p', { style: { marginBottom: '8px', fontWeight: 600 } }, 'Higher risk patients:'),
              e('ul', { style: { margin: '0', paddingLeft: '18px', fontSize: '12px', lineHeight: '1.6' } },
                e('li', null, 'Chronic hyponatraemia (>48 hours or unknown duration)'),
                e('li', null, 'Severe hyponatraemia (<120 mmol/L)'),
                e('li', null, 'Hypokalaemia'),
                e('li', null, 'Malnutrition or alcoholism'),
                e('li', null, 'Advanced liver disease')
              )
            ),

            // Bottom buttons (for all result paths)
            e('div', { style: { marginTop: '20px' } },
              e(PrimaryButton, { label: 'New Analysis', onClick: resetModule }),
              e('button', {
                onClick: onBack,
                style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
              }, 'â† All modules')
            )
          )
        )
      );
    }

    // ========== IRON STUDIES MODULE ==========

    function IronModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Inflammation
      const [hasInflammation, setHasInflammation] = useState(null);
      // Screen 1: Clinical context
      const [clinicalContext, setClinicalContext] = useState(null);
      // Screen 2: Ferritin
      const [ferritinResult, setFerritinResult] = useState(null);
      // Screen 3: TSAT
      const [tsatResult, setTsatResult] = useState(null);

      const scrollToTop = () => {
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
      };

      const goToStep = (s) => { document.activeElement.blur(); setStep(s); scrollToTop(); };

      const resetModule = () => {
        setStep(0);
        setHasInflammation(null);
        setClinicalContext(null);
        setFerritinResult(null);
        setTsatResult(null);
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
      };

      const handleBack = () => {
        clearAutoAdvance();
        if (step === 0) onBack();
        else goToStep(step - 1);
      };

      const getTotalScreens = () => 5;

      const getInflammationDisplay = () => ({
        value: hasInflammation ? 'Present' : 'Absent',
        interpretation: hasInflammation ? 'Adjusted thresholds apply' : 'Standard thresholds'
      });

      const getFerritinDisplay = () => {
        const labels = { veryLow: '< 30 Âµg/L', lowNormal: '30â€“100 Âµg/L', normal: '100â€“300 Âµg/L', high: '300â€“1000 Âµg/L', veryHigh: '> 1000 Âµg/L' };
        const interps = { veryLow: 'Iron deficiency', lowNormal: 'Possible deficiency', normal: 'Stores adequate', high: 'Elevated', veryHigh: 'Urgent evaluation' };
        return { value: labels[ferritinResult] || '', interpretation: interps[ferritinResult] || '' };
      };

      const getTsatDisplay = () => {
        if (tsatResult === 'low') return { value: '< 16%', interpretation: 'Low â€” iron deficient erythropoiesis' };
        if (tsatResult === 'high') return { value: '> 45%', interpretation: 'High â€” iron overload' };
        return { value: '16â€“45%', interpretation: 'Normal' };
      };

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Iron Studies', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens() }),

          // SCREEN 0: Is the patient inflamed? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'Is the patient inflamed?'),
            e('div', { style: STYLES.screenSubtitle }, 'Check if CRP is elevated â€” inflammation changes ferritin thresholds'),
            e(ChoiceButton, {
              label: 'Yes â€” CRP elevated',
              selected: hasInflammation === true,
              onClick: () => {
                clearAutoAdvance();
                setHasInflammation(true);
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'No â€” stable outpatient',
              selected: hasInflammation === false,
              onClick: () => {
                clearAutoAdvance();
                setHasInflammation(false);
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--red)'
            }),
            hasInflammation === true && e(WarningBanner, { onContinue: () => goToStep(1) }, e('strong', null, 'Ferritin is an acute phase reactant.'), ' A "normal" ferritin does NOT exclude iron deficiency when CRP is elevated.'),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', textAlign: 'center', marginTop: '12px' } }, 'Reference ranges shown are typical adult examples. Always verify against your local laboratory reference ranges.')
          ),

          // SCREEN 1: CKD or heart failure? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'Does the patient have CKD or heart failure?'),
            e('div', { style: STYLES.screenSubtitle }, 'Different iron deficiency thresholds apply'),
            e(ChoiceButton, {
              label: 'CKD or haemodialysis',
              selected: clinicalContext === 'ckd',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('ckd');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Heart failure',
              selected: clinicalContext === 'heartFailure',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('heartFailure');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'None of the above',
              selected: clinicalContext === 'none',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('none');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--red)'
            })
          ),

          // SCREEN 2: Ferritin (ChoiceButtons, auto-advance)
          step === 2 && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'What is the ferritin (Âµg/L)?'),
            e('div', { style: STYLES.screenSubtitle }, 'The starting point â€” interpret with context'),
            e(ChoiceButton, {
              label: 'Very low  â€¹ 30 Âµg/L',
              selected: ferritinResult === 'veryLow',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('veryLow');
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Low-normal  30â€“100 Âµg/L',
              selected: ferritinResult === 'lowNormal',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('lowNormal');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Normal  100â€“300 Âµg/L',
              selected: ferritinResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('normal');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'High  300â€“1000 Âµg/L',
              selected: ferritinResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('high');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Very high  â€º 1000 Âµg/L',
              selected: ferritinResult === 'veryHigh',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('veryHigh');
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--red)'
            }),
            ferritinResult === 'veryLow' && e(WarningBanner, { onContinue: () => goToStep(3) }, e('strong', null, 'Diagnostic.'), ' Ferritin <30 Âµg/L indicates iron deficiency regardless of other values.'),
            ferritinResult === 'veryHigh' && e(WarningBanner, { onContinue: () => goToStep(3) }, e('strong', null, 'Urgent evaluation.'), ' Consider HLH, Still\'s disease, hepatic necrosis, massive iron overload.')
          ),

          // SCREEN 3: TSAT (ChoiceButtons, auto-advance)
          step === 3 && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'What is the TSAT?'),
            e('div', { style: STYLES.screenSubtitle }, 'Transferrin saturation (normal: 16â€“45%)'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 16%',
              selected: tsatResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setTsatResult('low');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Normal  16â€“45%',
              selected: tsatResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setTsatResult('normal');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 45%',
              selected: tsatResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setTsatResult('high');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--red)'
            })
          ),

          // SCREEN 4: Results
          step === 4 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: STYLES.screenTitle }, 'Interpretation'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } },
                (() => {
                  const ferr = { veryLow: 'Ferritin â†“â†“', lowNormal: 'Ferritin low-normal', normal: 'Ferritin normal', high: 'Ferritin â†‘', veryHigh: 'Ferritin â†‘â†‘' }[ferritinResult] || '';
                  const ts = { low: ' Â· TSAT â†“', normal: ' Â· TSAT normal', high: ' Â· TSAT â†‘' }[tsatResult] || '';
                  return ferr + ts;
                })()
              )
            ),
            e(InputSummaryStrip, { items: [
              { label: 'Inflammation', ...getInflammationDisplay() },
              { label: 'Ferritin', ...getFerritinDisplay() },
              { label: 'TSAT', ...getTsatDisplay() }
            ] }),

            e('div', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label3)', letterSpacing: '0.03em', marginBottom: '10px' } }, 'Differential'),

            // Pattern: Ferritin low/low-normal + TSAT low
            (ferritinResult === 'veryLow' || ferritinResult === 'lowNormal') && tsatResult === 'low' && e(DiffListItem, {
              title: 'Iron Deficiency',
              defaultOpen: true,
              infoPanel: clinicalContext === 'ckd' ? e(InfoPanel, { title: 'Iron Deficiency in CKD' },
                e('p', null, 'In CKD and other inflammatory states, ferritin can be elevated despite iron-restricted erythropoiesis. Different thresholds are sometimes used to define absolute versus functional iron deficiency in CKD. Interpret ferritin and transferrin saturation alongside inflammation markers and clinical context, and refer to local renal/haematology guidance for management.')
              ) : clinicalContext === 'heartFailure' ? e(InfoPanel, { title: 'Iron Deficiency in Heart Failure' },
                e('p', null, 'In heart failure, iron deficiency is common and definitions used in trials may differ from general population reference ranges. Interpretation in this context often considers ferritin and transferrin saturation together and should be aligned with local heart failure guidance.')
              ) : null
            }, 'Low ferritin + low TSAT confirms iron deficiency. Investigate the underlying cause.'),

            // Pattern: Ferritin normal + TSAT low (with inflammation)
            ferritinResult === 'normal' && tsatResult === 'low' && hasInflammation && e(DiffListItem, {
              title: 'Iron Deficiency Masked by Inflammation',
              infoPanel: e(InfoPanel, { title: 'The Hardest Call in Iron Studies' },
                e('p', { style: { marginBottom: '10px' } }, 'The patient has both iron deficiency AND active inflammation (e.g. RA, IBD, CKD, malignancy). Ferritin is elevated by inflammation â†’ looks \'normal\' even though stores are depleted. Transferrin is suppressed â†’ TIBC doesn\'t rise as expected. TSAT becomes the most reliable discriminator: if <20% with inflammation, iron deficiency is very likely even with ferritin 100â€“300.'),
                e('p', { style: { marginBottom: '10px' } }, e('strong', null, 'Soluble transferrin receptor (sTfR):'), ' Not affected by inflammation. â†‘ sTfR suggests true iron deficiency. sTfR/log ferritin ratio >2 strongly supports iron deficiency. Not universally available but very useful.'),
                e('p', null, 'When ferritin is low-normal and transferrin saturation is low, possibilities include early iron deficiency, inflammation-driven iron sequestration, mixed aetiology, or analytical variation. Trends over time, inflammatory markers, and the clinical scenario can help clarify the most likely explanation.')
              )
            }, 'The most common diagnostic trap â€” ferritin appears \'normal\' due to inflammation, but low TSAT reveals true deficiency.'),

            // Pattern: Ferritin normal + TSAT low (WITHOUT inflammation) = functional or early deficiency
            ferritinResult === 'normal' && tsatResult === 'low' && !hasInflammation && e(DiffListItem, {
              title: 'Functional Iron Deficiency',
              infoPanel: e(InfoPanel, { title: 'Functional Iron Deficiency' },
                e('p', { style: { marginBottom: '10px' } }, 'Iron stores are present (normal ferritin) but delivery to erythroid precursors is inadequate (low TSAT).'),
                e('p', { style: { marginBottom: '10px' } }, e('strong', null, 'Common in:'), ' CKD (especially on ESAs), chronic inflammation not reflected in CRP, high erythropoietic demand (haemolysis, bleeding).'),
                e('p', null, e('strong', null, 'Also consider:'), ' Early true iron deficiency â€” stores depleting but ferritin not yet fallen. Repeat testing in 4â€“6 weeks if clinical suspicion.')
              )
            }, 'Stores present but not mobilised effectively. Consider clinical context, likely cause of reduced stores (eg, blood loss, intake), and trend over time.'),

            // Pattern: Ferritin low-normal + TSAT normal = borderline stores
            ferritinResult === 'lowNormal' && tsatResult === 'normal' && e(DiffListItem, {
              title: 'Borderline Iron Stores'
            }, 'Ferritin 30â€“100 Âµg/L with normal TSAT suggests early depletion of stores not yet affecting erythropoiesis. Consider clinical context, likely cause of reduced stores (eg, blood loss, intake), and trend over time.'),

            // Pattern: Ferritin normal + TSAT normal (with inflammation)
            ferritinResult === 'normal' && tsatResult === 'normal' && hasInflammation && e(DiffListItem, {
              title: 'Anaemia of Chronic Disease'
            }, 'Inflammatory cytokines + hepcidin â†’ iron sequestered in macrophages, unavailable for erythropoiesis. Iron stores are adequate (normal ferritin) and iron supply is maintained (normal TSAT). Low serum iron with low transferrin is typical.'),

            // Pattern: Ferritin high + TSAT high
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'high' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'Iron Overload',
                defaultOpen: true
              }, 'True iron overload. Check HFE gene for hereditary haemochromatosis.'),
              e(DiffListItem, {
                title: 'Liver Disease'
              }, 'Damaged hepatocytes leak ferritin into serum. TSAT may be normal or elevated. Check LFTs. Liver disease + iron overload can coexist (e.g. haemochromatosis with cirrhosis).')
            ),

            // Pattern: Ferritin high + TSAT normal
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'normal' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'Acute Phase Response'
              }, 'Elevated ferritin with normal TSAT most likely reflects an acute phase response rather than true iron overload. Recheck when inflammation has resolved.'),
              e(DiffListItem, {
                title: 'Liver Disease'
              })
            ),

            // Pattern: Ferritin high + TSAT low
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'low' && e(DiffListItem, {
              title: 'Anaemia of Chronic Disease (severe)'
            }, 'High ferritin (inflammation) + low TSAT (no iron reaching marrow). Iron is present in stores but trapped by hepcidin-mediated sequestration.'),

            // Ferritin very high
            ferritinResult === 'veryHigh' && e(DiffListItem, {
              title: 'Urgent Evaluation Required',
              defaultOpen: true
            }, 'Consider HLH, adult-onset Still\'s disease, hepatic necrosis, or massive iron overload. Check triglycerides, fibrinogen, LDH.'),

            // Causes of iron deficiency
            (tsatResult === 'low' || ferritinResult === 'veryLow' || ferritinResult === 'lowNormal') && e(InfoPanel, { title: 'Causes of Iron Deficiency' },
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Blood loss:'),
              e('p', { style: { marginBottom: '10px' } }, 'GI (occult or overt) Â· Menstrual Â· Urinary (rare) Â· Blood donation Â· Surgical'),
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Reduced absorption:'),
              e('p', { style: { marginBottom: '10px' } }, 'Coeliac disease Â· Post-gastrectomy/bariatric Â· IBD Â· H. pylori Â· PPI/H2-blocker use'),
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Increased demand:'),
              e('p', { style: { marginBottom: '10px' } }, 'Pregnancy Â· Adolescent growth Â· ESA therapy Â· Chronic haemolysis'),
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Dietary insufficiency:'),
              e('p', null, 'Vegetarian/vegan diet Â· Elderly Â· Eating disorders')
            ),

            // Haemochromatosis detail
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'high' && e(InfoPanel, { title: 'Hereditary Haemochromatosis' },
              e('p', { style: { marginBottom: '10px' } }, e('strong', null, 'When to check HFE gene:'), ' TSAT >45% on two separate occasions warrants HFE genotyping.'),
              e('p', { style: { marginBottom: '10px' } }, e('strong', null, 'C282Y homozygosity:'), ' Diagnostic for hereditary haemochromatosis. ~30% penetrance â€” not all homozygotes develop clinical iron overload.'),
              e('p', { style: { marginBottom: '10px' } }, e('strong', null, 'C282Y/H63D compound heterozygotes:'), ' Lower risk of iron overload. Usually only significant if other liver insults present.'),
              e('p', null, e('strong', null, 'Family screening:'), ' First-degree relatives of confirmed cases should have iron studies and HFE genotyping.')
            ),

            e('div', { style: { marginTop: '20px' } },
              e(PrimaryButton, { label: 'New Analysis', onClick: resetModule }),
              e('button', {
                onClick: onBack,
                style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
              }, 'â† All modules')
            )
          )
        )
      );
    }


    // ========== COAGULATION MODULE ==========

    function CoagModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Pattern
      const [pattern, setPattern] = useState(null);
      // Optional lab inputs (collapsed on results)
      const [showLabs, setShowLabs] = useState(false);
      const [pt, setPt] = useState('');
      const [inr, setInr] = useState('');
      const [aptt, setAptt] = useState('');
      const [fibrinogen, setFibrinogen] = useState('');
      const [dDimer, setDDimer] = useState('');
      const [platelets, setPlatelets] = useState('');

      const getTotalScreens = () => 2;

      const scrollToTop = () => { if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' }); };
      const goToStep = (s) => { document.activeElement.blur(); setStep(s); scrollToTop(); };

      const resetModule = () => {
        setStep(0);
        setPattern(null);
        setShowLabs(false);
        setPt('');
        setInr('');
        setAptt('');
        setFibrinogen('');
        setDDimer('');
        setPlatelets('');
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
      };

      const handleBack = () => {
        clearAutoAdvance();
        if (step === 0) onBack();
        else goToStep(step - 1);
      };

      const isPtProlonged = pt && parseFloat(pt) > 13.5;
      const isApttProlonged = aptt && parseFloat(aptt) > 38;

      // ISTH DIC Score calculation with bounds validation
      const calcDICScore = () => {
        if (!platelets || !dDimer || !pt || !fibrinogen) return null;
        const plt = parseFloat(platelets);
        const dd = parseFloat(dDimer);
        const ptVal = parseFloat(pt);
        const fib = parseFloat(fibrinogen);
        // Reject negative or physiologically impossible values
        if (isNaN(plt) || isNaN(dd) || isNaN(ptVal) || isNaN(fib)) return null;
        if (plt < 0 || dd < 0 || ptVal < 0 || fib < 0) return null;
        // Sensible upper bounds (platelets > 1000, PT > 200, fibrinogen > 20 unlikely)
        if (plt > 1000 || ptVal > 200 || fib > 20 || dd > 100) return null;
        let score = 0;
        if (plt >= 100) score += 0; else if (plt >= 50) score += 1; else score += 2;
        if (dd <= 0.5) score += 0; else if (dd <= 5) score += 1; else score += 2;
        const ptProlongation = ptVal - 12;
        if (ptProlongation < 3) score += 0; else if (ptProlongation <= 6) score += 1; else score += 2;
        if (fib >= 1.0) score += 0; else score += 2;
        return score;
      };

      const getLabDisplay = (name, value, unit, normal) => {
        if (!value) return null;
        const v = parseFloat(value);
        let interp = 'Normal';
        if (name === 'PT' && v > 13.5) { interp = 'Prolonged'; }
        if (name === 'APTT' && v > 38) { interp = 'Prolonged'; }
        if (name === 'Fibrinogen' && v < 2.0) { interp = 'Low'; }
        if (name === 'Platelets' && v < 150) { interp = 'Low'; }
        if (name === 'D-dimer' && v > 0.5) { interp = 'Elevated'; }
        return { value: `${value} ${unit}`, interpretation: interp };
      };

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Coagulation', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens() }),

          // SCREEN 0: What pattern do you see? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: STYLES.screenTitle }, 'Which values are prolonged?'),
            e('div', { style: STYLES.screenSubtitle }, 'Check the PT and APTT on the coag panel'),
            e(ChoiceButton, {
              label: 'Isolated prolonged PT',
              sublabel: 'Extrinsic pathway',
              selected: pattern === 'A',
              onClick: () => {
                clearAutoAdvance();
                setPattern('A');
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'Isolated prolonged APTT',
              sublabel: 'Intrinsic pathway',
              selected: pattern === 'B',
              onClick: () => {
                clearAutoAdvance();
                setPattern('B');
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'Both PT and APTT prolonged',
              sublabel: 'Common pathway or global coagulopathy',
              selected: pattern === 'C',
              onClick: () => {
                clearAutoAdvance();
                setPattern('C');
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'Both normal',
              sublabel: 'Platelet or vascular cause if bleeding',
              selected: pattern === 'D',
              onClick: () => {
                clearAutoAdvance();
                setPattern('D');
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--green)'
            }),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', textAlign: 'center', marginTop: '12px' } }, 'Reference ranges shown are typical adult examples. Always verify against your local laboratory reference ranges.')
          ),

          // SCREEN 1: Results
          step === 1 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: STYLES.screenTitle }, 'Interpretation'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } },
                pattern === 'A' ? 'Isolated prolonged PT' : pattern === 'B' ? 'Isolated prolonged APTT' : pattern === 'C' ? 'Both PT and APTT prolonged' : 'Both normal'
              )
            ),
            e(InputSummaryStrip, { items: [
              { label: 'Pattern', value: pattern === 'A' ? 'PT â†‘' : pattern === 'B' ? 'APTT â†‘' : pattern === 'C' ? 'Both â†‘' : 'Both normal', color: pattern === 'C' ? 'var(--orange)' : 'var(--green)' }
            ] }),
            e('div', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label3)', letterSpacing: '0.03em', marginBottom: '10px' } }, 'Differential'),

            // Pattern A: Isolated prolonged PT
            pattern === 'A' && e(React.Fragment, null,
              e(DiffListItem, { title: 'Warfarin', tags: ['Most common', 'Therapeutic target context'] },
                'A supratherapeutic INR can explain an isolated prolonged PT in a patient taking warfarin. Interpret relative to the therapeutic target for the indication and the clinical bleeding context. Management (including reversal) should follow local anticoagulation guidance.'),
              e(DiffListItem, { title: 'Early Liver Disease', tags: ['Factor VII shortest half-life (~6h)', 'First to fall'] },
                'Factor VII has the shortest half-life (~6 hours) â€” PT rises before APTT in hepatic synthetic failure. Check albumin, bilirubin, and other LFTs.'),
              e(DiffListItem, { title: 'Vitamin K Deficiency', tags: ['Malabsorption', 'Malnutrition', 'Antibiotics', 'Obstructive jaundice'] },
                'Can cause an isolated prolonged PT/INR due to reduced vitamin K-dependent clotting factors. Interpretation is supported by clinical context (eg, malabsorption, poor intake, antibiotics) and correction of coagulation studies after vitamin K repletion if undertaken as part of standard care.'),
              e(DiffListItem, { title: 'DOAC (Rivaroxaban/Apixaban)', tags: ['Anti-Xa agents', 'Standard coag unreliable', 'Check anti-Xa level'] },
                'DOACs can prolong PT/APTT variably, and standard coagulation tests are not reliable measures of drug effect. Where available, drug-calibrated assays may help quantify anticoagulant effect. Management decisions depend on clinical urgency and should follow local protocols.'),
              e(DiffListItem, { title: 'Factor VII Deficiency', tags: ['Congenital', 'Only extrinsic factor'] },
                'The only factor unique to the extrinsic pathway. Congenital deficiency is rare but can present with mucocutaneous bleeding. Recombinant Factor VIIa (NovoSeven) available for severe bleeding.')
            ),

            // Pattern B: Isolated prolonged APTT
            pattern === 'B' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'Heparin',
                tags: ['Most common in hospital', 'UFH vs LMWH'],
                infoPanel: e(InfoPanel, { title: 'UFH vs LMWH' },
                  e('p', { style: { marginBottom: '10px' } }, 'UFH typically prolongs the APTT and can also affect thrombin time. Monitoring approach depends on local laboratory practice (APTT ratio versus anti-Xa).'),
                  e('p', { style: { marginBottom: '10px' } }, 'LMWH often has minimal effect on APTT; anti-Xa assays (when used) are more informative. Interpret results in context of timing of last dose and sample collection.'),
                  e('p', null, e('strong', null, 'Thrombin time (TT):'), ' Very sensitive to UFH â€” prolonged even with trace contamination. Normal TT excludes UFH effect.')
                )
              }, 'Most common cause in hospital. Check for heparin infusion, prophylactic LMWH, or heparin-coated line.'),
              e(DiffListItem, { title: 'Haemophilia A (Factor VIII â†“)', tags: ['X-linked', 'Severity correlates with level'] },
                'Confirm with appropriate factor and/or von Willebrand assays and interpret alongside bleeding history. Severity and management are specialist-led and vary by subtype and clinical context.'),
              e(DiffListItem, { title: 'Haemophilia B (Factor IX â†“)', tags: ['X-linked', 'Clinically identical to A'] },
                'Confirm with appropriate factor and/or von Willebrand assays and interpret alongside bleeding history. Severity and management are specialist-led and vary by subtype and clinical context.'),
              e(DiffListItem, { title: 'von Willebrand Disease', tags: ['Most common inherited bleeding disorder', 'vWF stabilises VIII'] },
                'Confirm with appropriate factor and/or von Willebrand assays and interpret alongside bleeding history. Severity and management are specialist-led and vary by subtype and clinical context.'),
              e(DiffListItem, { title: 'Factor XI Deficiency', tags: ['Ashkenazi Jewish', 'Variable bleeding risk'] },
                'Common in Ashkenazi Jewish populations. Bleeding risk poorly correlates with factor level.'),
              e(DiffListItem, {
                title: 'Factor XII Deficiency',
                tags: ['NO bleeding risk', 'APTT prolongation only']
              }, 'Factor XII deficiency can markedly prolong APTT but is not typically associated with clinical bleeding. Consider this when interpreting an isolated prolonged APTT with no bleeding history.'),
              e(DiffListItem, {
                title: 'Lupus Anticoagulant',
                tags: ['Antiphospholipid', 'PROTHROMBOTIC', 'Paradoxical']
              }, 'Prolongs APTT in vitro but is PROTHROMBOTIC in vivo â€” the clinical risk is clotting, not bleeding.'),
              e(DiffListItem, { title: 'Dabigatran', tags: ['Direct thrombin inhibitor', 'Check thrombin time'] },
                'Direct thrombin inhibitor. Normal thrombin time excludes significant dabigatran effect.'),
              e(DiffListItem, {
                title: 'Acquired Factor VIII Inhibitor',
                tags: ['Haematology EMERGENCY', 'Elderly', 'Does NOT correct on mixing'],
                defaultOpen: true,
                warning: 'Acquired haemophilia A â€” suspect in elderly patients with new spontaneous bruising/bleeding and dramatically prolonged APTT. ~20% mortality. Contact haematology immediately.'
              }, 'Autoantibody against Factor VIII. Characteristically elderly or postpartum. APTT does not correct on mixing study. Contact haematology immediately.'),
              e(InfoPanel, { title: 'The Mixing Study' },
                e('p', { style: { marginBottom: '8px' } }, 'When APTT is prolonged, mix 1:1 patient plasma with normal plasma:'),
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Corrects â†’ Factor deficiency.'), ' Normal plasma provides the missing factor.'),
                e('p', null, e('strong', null, 'Does not correct â†’ Inhibitor present.'), ' Immediate: lupus anticoagulant, heparin. Time-dependent (2h): acquired Factor VIII inhibitor (serious).', e('br'), 'If patient is on heparin, the mixing study is useless.')
              )
            ),

            // Pattern C: Both prolonged
            pattern === 'C' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'DIC',
                tags: ['Consumption', 'â†“Fibrinogen', 'â†“Platelets', 'â†‘D-dimer', 'Schistocytes'],
                defaultOpen: true
              }, 'Consumption of all factors + platelets. Check blood film for schistocytes.'),
              // Collapsible DIC Score Calculator
              e('button', {
                onClick: () => setShowLabs(!showLabs),
                style: { width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 16px', background: 'var(--card)', border: '1px solid var(--sep)', borderRadius: '12px', cursor: 'pointer', fontFamily: 'var(--font)', marginBottom: '12px' }
              },
                e('span', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)' } }, 'Calculate ISTH DIC Score'),
                e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, showLabs ? 'â–²' : 'â–¼')
              ),
              showLabs && e('div', { style: { background: 'rgba(142,142,147,0.08)', borderRadius: '14px', padding: '16px', marginBottom: '16px' } },
                e(ValueInput, { label: 'Platelets', unit: 'Ã—10â¹/L', value: platelets, onChange: setPlatelets, placeholder: '150â€“400' }),
                e(ValueInput, { label: 'D-dimer', unit: 'mg/L', value: dDimer, onChange: setDDimer, placeholder: '<0.5' }),
                e('div', { style: { fontSize: '10px', color: 'var(--label4)', marginTop: '-8px', marginBottom: '8px' } },
                  'Units vary: mg/L FEU, Âµg/mL, ng/mL. Confirm your lab\'s units and threshold.'
                ),
                e(ValueInput, { label: 'PT', unit: 'sec', value: pt, onChange: setPt, placeholder: '11â€“13.5' }),
                e(ValueInput, { label: 'Fibrinogen', unit: 'g/L', value: fibrinogen, onChange: setFibrinogen, placeholder: '2.0â€“4.0' }),
                calcDICScore() !== null && e(BranchCard, { label: 'ISTH DIC Score', value: `${calcDICScore()}/8`, interpretation: calcDICScore() >= 5 ? 'Compatible with overt DIC' : 'Not suggestive â€” repeat daily', color: calcDICScore() >= 5 ? 'var(--red)' : 'var(--orange)', useColor: true })
              ),
              e(DiffListItem, {
                title: 'Severe Liver Disease',
                tags: ['Impaired synthesis', 'Factor VIII normal/â†‘ (distinguishes from DIC)'],
                infoPanel: e(InfoPanel, { title: 'Liver vs DIC' },
                  e('p', { style: { marginBottom: '8px' } }, 'Both: prolonged PT + APTT, low fibrinogen, low platelets, elevated D-dimer.'),
                  e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Factor VIII is the key.'), ' Normal/high in liver disease (Factor VIII made by endothelium). Low in DIC (consumed).'),
                  e('p', null, 'Blood film: schistocytes = DIC. Target cells, acanthocytes = liver.')
                )
              }),
              e(DiffListItem, { title: 'Massive Transfusion / Dilution', tags: ['Dilution of factors + platelets'] },
                'After large-volume resuscitation and transfusion, dilutional coagulopathy can cause prolonged PT/APTT with low fibrinogen and thrombocytopenia. Interpret coagulation results in the clinical context and alongside transfusion history.'),
              e(DiffListItem, {
                title: 'TTP / HUS',
                tags: ['ADAMTS13', 'Schistocytes', 'Fibrinogen NORMAL', 'Haematology emergency'],
                warning: 'If thrombocytopenia, haemolysis (eg, schistocytes) and organ involvement are present, consider TTP in the differential. This is time-critical and requires urgent haematology involvement and local escalation pathways.'
              }, 'Microangiopathic haemolytic anaemia with thrombocytopenia. Key distinction from DIC: fibrinogen typically NORMAL.'),
              e(DiffListItem, { title: 'Vitamin K Deficiency (severe)', tags: ['All K-dependent factors'] },
                'Can cause an isolated prolonged PT/INR due to reduced vitamin K-dependent clotting factors. Interpretation is supported by clinical context (eg, malabsorption, poor intake, antibiotics) and correction of coagulation studies after vitamin K repletion if undertaken as part of standard care.'),
              e(DiffListItem, { title: 'Supratherapeutic Warfarin', tags: ['Therapeutic target context'] },
                'A supratherapeutic INR can explain an isolated prolonged PT in a patient taking warfarin. Interpret relative to the therapeutic target for the indication and the clinical bleeding context. Management (including reversal) should follow local anticoagulation guidance.'),
              e(DiffListItem, { title: 'Direct Thrombin Inhibitor (high dose)', tags: ['Dabigatran', 'Argatroban'] },
                'DOACs can prolong PT/APTT variably, and standard coagulation tests are not reliable measures of drug effect. Where available, drug-calibrated assays may help quantify anticoagulant effect. Management decisions depend on clinical urgency and should follow local protocols.'),
              e(DiffListItem, {
                title: 'Isolated Hypofibrinogenaemia',
                tags: ['Congenital', 'Acquired', 'L-asparaginase', 'Liver failure']
              }, 'Fibrinogen <1.5 g/L with preserved PT/APTT. Congenital or acquired (L-asparaginase, liver disease, massive transfusion).')
            ),

            // Pattern D: Both normal
            pattern === 'D' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'Antiplatelet Drug Effect',
                tags: ['Aspirin', 'Clopidogrel', 'Ticagrelor', 'Most common cause'],
                defaultOpen: true
              }, 'Most common cause of \'normal coags but bleeding\'. Always check medication history including OTC aspirin and NSAIDs.'),
              e(DiffListItem, {
                title: 'Thrombocytopenia or Platelet Dysfunction',
                tags: ['Check platelet count', 'Consider PFA-100', 'Uraemia']
              }, 'PT and APTT only test the coagulation cascade, not primary haemostasis. Check platelet count and function.'),
              e(DiffListItem, { title: 'Mild von Willebrand Disease', tags: ['May not prolong APTT', 'Check vWF antigen + activity'] },
                'Mild vWD may not prolong APTT. Always check vWF antigen, activity, and Factor VIII if suspected.'),
              e(DiffListItem, { title: 'Factor XIII Deficiency', tags: ['NOT detected by PT or APTT', 'Clot forms then falls apart', 'Urea clot lysis test'] },
                'Factor XIII cross-links fibrin after clot formation. Classic: delayed bleeding 24â€“48h post-surgery. Diagnose with urea clot lysis test.'),
              e(DiffListItem, { title: 'Vascular Cause', tags: ['Connective tissue disorder', 'Vasculitis', 'Scurvy'] },
                'Connective tissue disorders (EDS, Marfan), vasculitis, or scurvy. All have normal coagulation studies.')
            ),

            e(InfoPanel, { title: 'Is It the DOAC or a Real Problem?' },
              e('p', { style: { marginBottom: '10px' } }, 'DOACs confound standard coagulation tests. If the patient is on an anticoagulant and the coag is abnormal, determine whether it\'s the drug or a new problem:'),
              e('p', { style: { marginBottom: '10px' } },
                e('strong', null, 'Dabigatran (direct thrombin inhibitor):'), ' Prolongs APTT and thrombin time. Thrombin time is very sensitive â€” if normal, dabigatran effect is excluded. For quantification: dilute thrombin time (Hemoclot).'
              ),
              e('p', { style: { marginBottom: '10px' } },
                e('strong', null, 'Rivaroxaban / Apixaban (anti-Xa):'), ' May prolong PT (rivaroxaban > apixaban). Standard PT/APTT are unreliable for measuring effect. Use calibrated anti-Xa level.'
              ),
              e('p', null,
                e('strong', null, 'Warfarin:'), ' Prolongs PT/INR. If APTT is also very prolonged, consider supratherapeutic dosing or concomitant problem.'
              )
            ),

            e('div', { style: { marginTop: '20px' } },
              e(PrimaryButton, { label: 'New Analysis', onClick: resetModule }),
              e('button', {
                onClick: onBack,
                style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
              }, 'â† All modules')
            )
          )
        )
      );
    }

    // ========== DISCLAIMER POPUP ==========

    function DisclaimerPopup({ onAccept }) {
      const [hasChecked, setHasChecked] = useState(false);
      return e('div', {
        style: {
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          bottom: 0,
          background: 'rgba(0,0,0,0.7)',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          padding: '20px',
          zIndex: 10000
        }
      },
        e('div', {
          style: {
            background: 'var(--card)',
            borderRadius: '16px',
            padding: '24px',
            maxWidth: '340px',
            width: '100%',
            boxShadow: '0 20px 60px rgba(0,0,0,0.3)'
          }
        },
          e('div', { style: { textAlign: 'center', marginBottom: '16px' } },
            e('div', { style: { fontSize: '36px', marginBottom: '8px' } }, 'âš•ï¸'),
            e('h2', { style: { fontSize: '18px', fontWeight: '700', color: 'var(--label)', marginBottom: '4px' } }, 'For Healthcare Professionals')
          ),
          e('div', { style: { fontSize: '13px', lineHeight: '1.6', color: 'var(--label3)', marginBottom: '16px' } },
            e('p', { style: { marginBottom: '10px' } },
              'This app is an ',
              e('strong', { style: { color: 'var(--label)' } }, 'educational reference tool'),
              ' for qualified healthcare professionals.'
            ),
            e('p', null, 'Always verify against your local laboratory reference ranges. This tool is an interpretation aid only and does not provide treatment recommendations. It supports clinical judgement but does not replace it.')
          ),
          e('div', {
            onClick: () => setHasChecked(!hasChecked),
            style: {
              display: 'flex',
              alignItems: 'flex-start',
              gap: '10px',
              padding: '12px',
              background: hasChecked ? 'rgba(0,113,227,0.1)' : 'var(--sep)',
              border: hasChecked ? '1px solid var(--accent)' : '1px solid var(--sep)',
              borderRadius: '10px',
              cursor: 'pointer',
              marginBottom: '16px'
            }
          },
            e('div', {
              style: {
                width: '20px',
                height: '20px',
                borderRadius: '4px',
                border: hasChecked ? 'none' : '2px solid var(--label4)',
                background: hasChecked ? 'var(--accent)' : 'var(--card)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                flexShrink: 0,
                marginTop: '1px'
              }
            }, hasChecked && e('span', { style: { color: 'white', fontSize: '14px' } }, 'âœ“')),
            e('span', { style: { fontSize: '12px', lineHeight: '1.5', color: 'var(--label)' } },
              'I am a healthcare professional and accept the ',
              e('strong', null, 'Terms of Use')
            )
          ),
          e('button', {
            onClick: () => { if (hasChecked) onAccept(); },
            style: {
              width: '100%',
              padding: '14px',
              fontSize: '15px',
              fontWeight: '600',
              background: hasChecked ? 'var(--accent)' : 'var(--label4)',
              color: hasChecked ? 'white' : 'var(--label3)',
              border: 'none',
              borderRadius: '10px',
              cursor: hasChecked ? 'pointer' : 'default',
              fontFamily: 'var(--font)'
            }
          }, 'Continue'),
          e('p', { style: { textAlign: 'center', marginTop: '12px', fontSize: '11px', color: 'var(--label4)' } }, 'Full terms available in app')
        )
      );
    }

    // ========== FULL TERMS SCREEN ==========

    function FullTermsScreen({ onBack }) {
      const sectionStyle = { fontSize: '13px', fontWeight: '600', color: 'var(--label)', marginTop: '16px', marginBottom: '6px' };
      const paraStyle = { marginBottom: '12px', fontSize: '13px', lineHeight: '1.6', color: 'var(--label2)' };

      return e('div', { className: 'app-container' },
        e(NavBar, { title: 'Terms of Use', onBack }),
        e('div', { style: { padding: '16px 20px 40px' } },
          e('p', { style: { marginBottom: '12px', fontSize: '12px', color: 'var(--label3)' } },
            e('strong', null, 'Last Updated:'), ' February 2026'
          ),

          e('h3', { style: sectionStyle }, '1. NOT A MEDICAL DEVICE'),
          e('p', { style: paraStyle }, 'This application is NOT a medical device. It has not been cleared, approved, or certified by the TGA, FDA, or any regulatory body.'),

          e('h3', { style: sectionStyle }, '2. EDUCATIONAL PURPOSES ONLY'),
          e('p', { style: paraStyle }, 'This application is designed solely for educational and informational purposes as a learning tool for understanding laboratory investigations.'),

          e('h3', { style: sectionStyle }, '3. NOT MEDICAL ADVICE'),
          e('p', { style: paraStyle }, 'This application does NOT provide medical advice, diagnosis, or treatment. All clinical decisions must be made by qualified healthcare professionals.'),

          e('h3', { style: sectionStyle }, '4. NO DOCTOR-PATIENT RELATIONSHIP'),
          e('p', { style: paraStyle }, 'Use of this application does not create any professional healthcare relationship.'),

          e('h3', { style: sectionStyle }, '5. PROFESSIONAL RESPONSIBILITY'),
          e('p', { style: paraStyle }, 'Healthcare professionals remain solely responsible for all clinical decisions and must verify all information through primary sources and local laboratory reference ranges.'),

          e('h3', { style: sectionStyle }, '6. NO WARRANTY'),
          e('p', { style: paraStyle }, 'This application is provided "AS IS" without warranty of any kind. No representations are made regarding accuracy, reliability, or completeness.'),

          e('h3', { style: sectionStyle }, '7. LIMITATION OF LIABILITY'),
          e('p', { style: paraStyle }, 'To the fullest extent permitted by law, Critical Condition shall not be liable for any damages arising from use of this application.'),

          e('h3', { style: sectionStyle }, '8. ASSUMPTION OF RISK'),
          e('p', { style: paraStyle }, 'You assume full responsibility for any consequences arising from your use of this application.'),

          e('h3', { style: sectionStyle }, '9. INDEMNIFICATION'),
          e('p', { style: paraStyle }, 'You agree to indemnify and hold harmless Critical Condition from all claims arising from your use of this application.'),

          e('h3', { style: sectionStyle }, '10. EMERGENCY WARNING'),
          e('p', { style: { ...paraStyle, padding: '8px', background: 'rgba(255,69,58,0.1)', borderRadius: '6px' } },
            e('strong', null, 'DO NOT USE IN EMERGENCIES.'), ' Call emergency services (000/911/999/112) immediately.'
          ),

          e('h3', { style: sectionStyle }, '11. INTENDED AUDIENCE'),
          e('p', { style: paraStyle }, 'This application is intended for healthcare professionals and students as an educational reference only.'),

          e('h3', { style: sectionStyle }, '12. MODIFICATIONS'),
          e('p', { style: paraStyle }, 'These terms may be modified at any time. Continued use constitutes acceptance.'),

          e('h3', { style: sectionStyle }, '13. SEVERABILITY'),
          e('p', { style: paraStyle }, 'If any provision is found unenforceable, remaining provisions remain in effect.'),

          e('h3', { style: sectionStyle }, '14. PRIVACY POLICY'),
          e('div', { style: { marginBottom: '12px', padding: '10px', background: 'var(--sep)', borderRadius: '8px', fontSize: '12px', lineHeight: '1.6' } },
            e('p', null, e('strong', null, 'Data Collection:'), ' This application does not collect, store, transmit, or share any personal data or usage analytics.'),
            e('p', { style: { marginTop: '6px' } }, e('strong', null, 'Local Storage:'), ' All data is stored locally on your device only.'),
            e('p', { style: { marginTop: '6px' } }, e('strong', null, 'Network Access:'), ' This application functions entirely offline.')
          ),

          e('h3', { style: sectionStyle }, '15. GOVERNING LAW'),
          e('p', { style: paraStyle }, 'These terms shall be governed by and construed in accordance with the laws of Victoria, Australia. Any disputes shall be subject to the exclusive jurisdiction of the courts of Victoria, Australia.'),

          e('h3', { style: sectionStyle }, '16. ADVERSE EVENT REPORTING'),
          e('p', { style: paraStyle }, 'If you become aware of any error, malfunction, or adverse event associated with use of this application, please report it immediately to: hello@criticalcondition.com.au. Where required, Critical Condition will report serious incidents to the Therapeutic Goods Administration (TGA).'),

          e('h3', { style: sectionStyle }, '17. CONTACT'),
          e('p', { style: paraStyle }, 'For questions about these terms: hello@criticalcondition.com.au'),
          e('p', { style: paraStyle }, 'Website: www.criticalcondition.com.au'),

          e('h3', { style: sectionStyle }, 'OUR APPS'),
          e('p', { style: { marginBottom: '6px', fontSize: '12px', color: 'var(--label3)' } }, 'Critical Condition develops clinical decision support tools for healthcare professionals:'),
          e('p', { style: { marginBottom: '12px', fontSize: '12px', color: 'var(--label2)' } },
            e('strong', null, 'LabLogic'), ' â€“ Laboratory investigation interpreter', e('br'),
            e('strong', null, 'Blood Gas Pro'), ' â€“ ABG interpretation', e('br'),
            e('strong', null, 'CodeClock'), ' â€“ Cardiac arrest timing & management', e('br'),
            e('strong', null, 'IntubAid'), ' â€“ Airway management cognitive aid', e('br'),
            e('strong', null, 'METmate'), ' â€“ Deteriorating patient assessment'
          ),

          e('div', { style: { textAlign: 'center', padding: '16px', marginTop: '16px', borderTop: '1px solid var(--sep)' } },
            e('p', { style: { fontSize: '11px', color: 'var(--label4)' } }, 'Â© 2026 Critical Condition. All rights reserved.')
          )
        )
      );
    }

    // ========== MAIN APP ==========

    function App() {
      const [screen, setScreen] = useState('home');
      const [hasAcceptedDisclaimer, setHasAcceptedDisclaimer] = useState(() => {
        try {
          return localStorage.getItem('lablogic_disclaimer_accepted') === 'true';
        } catch (e) {
          return false;
        }
      });

      const handleAcceptDisclaimer = () => {
        try {
          localStorage.setItem('lablogic_disclaimer_accepted', 'true');
          localStorage.setItem('lablogic_disclaimer_date', new Date().toISOString());
        } catch (e) {
          // localStorage not available, continue anyway
        }
        setHasAcceptedDisclaimer(true);
      };

      // Show disclaimer if not accepted
      if (!hasAcceptedDisclaimer) {
        return e('div', { className: 'app-container' },
          e(DisclaimerPopup, { onAccept: handleAcceptDisclaimer })
        );
      }

      // Terms screen
      if (screen === 'terms') {
        return e(FullTermsScreen, { onBack: () => setScreen('home') });
      }

      if (screen === 'home') {
        return e('div', { className: 'app-container' },
          e(HomeScreen, { onSelectModule: setScreen })
        );
      }

      if (screen === 'tft') {
        return e(TFTModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'hypona') {
        return e(HyponatraemiaModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'iron') {
        return e(IronModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'coag') {
        return e(CoagModule, { onBack: () => setScreen('home') });
      }

      // Placeholder for other modules
      return e('div', { className: 'app-container' },
        e(PlaceholderScreen, { moduleId: screen, onBack: () => setScreen('home') })
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(e(App));
  </script>
</body>
</html>
