<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#F2F2F7">
  <title>LabLogic</title>
  <style>
    :root {
      --bg: #F2F2F7;
      --card: #FFFFFF;
      --label: #1C1C1E;
      --label2: #3A3A3C;
      --label3: #8E8E93;
      --label4: #C7C7CC;
      --sep: rgba(60,60,67,0.08);
      --blue: #0A84FF;
      --green: #30D158;
      --orange: #FF9F0A;
      --red: #FF453A;
      --purple: #AF52DE;
      --cyan: #64D2FF;
      --yellow: #FFD60A;
      --radius: 16px;
      --radius-sm: 14px;
      --radius-xs: 10px;
      --shadow: 0 1px 3px rgba(0,0,0,0.04), 0 8px 24px rgba(0,0,0,0.06);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04), 0 2px 8px rgba(0,0,0,0.03);
      --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font); background: #E5E5EA; color: var(--label); }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
      20%, 40%, 60%, 80% { transform: translateX(8px); }
    }

    .app-container {
      max-width: 430px;
      margin: 0 auto;
      min-height: 100dvh;
      background: var(--bg);
      box-shadow: 0 0 40px rgba(0,0,0,0.1);
      position: relative;
      overflow-x: hidden;
    }

    .screen-content {
      padding: 0 20px 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script>
    const { useState, useEffect, useRef } = React;
    const e = React.createElement;

    // Auto-advance hook for ChoiceButton-only screens
    function useAutoAdvance() {
      const timerRef = useRef(null);
      const clearAutoAdvance = () => {
        if (timerRef.current) {
          clearTimeout(timerRef.current);
          timerRef.current = null;
        }
      };
      const scheduleAdvance = (callback, hasWarning = false) => {
        clearAutoAdvance();
        timerRef.current = setTimeout(callback, hasWarning ? 800 : 300);
      };
      useEffect(() => () => clearAutoAdvance(), []);
      return { scheduleAdvance, clearAutoAdvance };
    }

    // Module data
    const modules = [
      { id: "hypona", name: "Hyponatraemia", icon: "ðŸ’§", color: "#0A84FF", gradient: "linear-gradient(135deg, #0A84FF 0%, #0055D4 100%)", desc: "Sodium workup algorithm", tag: "Naâº" },
      { id: "tft", name: "Thyroid Function", icon: "ðŸ¦‹", color: "#AF52DE", gradient: "linear-gradient(135deg, #AF52DE 0%, #8B3FC1 100%)", desc: "TSH-first interpretation", tag: "TFT" },
      { id: "iron", name: "Iron Studies", icon: "ðŸ©¸", color: "#FF453A", gradient: "linear-gradient(135deg, #FF453A 0%, #D42020 100%)", desc: "Pattern recognition with ferritin traps", tag: "Fe" },
      { id: "coag", name: "Coagulation", icon: "ðŸ”¬", color: "#30D158", gradient: "linear-gradient(135deg, #30D158 0%, #1FA840 100%)", desc: "PT / APTT pattern analysis", tag: "Coag" },
      { id: "aki", name: "Urine Biochem", icon: "âš—ï¸", color: "#64D2FF", gradient: "linear-gradient(135deg, #64D2FF 0%, #32B4E0 100%)", desc: "FENa & AKI workup", tag: "AKI", beta: true }
    ];

    // Reference ranges
    const REF = {
      TSH: { low: 0.4, high: 4.0, unit: "mU/L" },
      FT4: { low: 12, high: 22, unit: "pmol/L" },
      FT3: { low: 3.1, high: 6.8, unit: "pmol/L" }
    };

    // ========== REUSABLE COMPONENTS ==========

    // 1. FadeIn Wrapper
    function FadeIn({ delay = 0, children }) {
      const [visible, setVisible] = useState(false);
      useEffect(() => {
        const timer = setTimeout(() => setVisible(true), delay);
        return () => clearTimeout(timer);
      }, [delay]);
      return e('div', {
        style: {
          opacity: visible ? 1 : 0,
          transform: visible ? 'translateY(0)' : 'translateY(8px)',
          transition: 'opacity 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)'
        }
      }, children);
    }

    // 1b. ProgressBar (step dots - current step is elongated pill)
    function ProgressBar({ current, total, color = 'var(--blue)' }) {
      return e('div', {
        style: {
          display: 'flex',
          justifyContent: 'center',
          gap: '6px',
          marginBottom: '20px',
          padding: '4px 0'
        }
      },
        Array.from({ length: total }, (_, i) =>
          e('div', {
            key: i,
            style: {
              width: i === current ? '20px' : '8px',
              height: '8px',
              borderRadius: '4px',
              background: i <= current ? color : 'var(--sep)',
              opacity: i <= current ? 1 : 0.4,
              transition: 'all 0.25s ease'
            }
          })
        )
      );
    }

    // Helper: Render tag with action detection
    function renderTag(tag, index) {
      const actionVerbs = ['Check', 'Order', 'Send', 'Exclude', 'Consider', 'Confirm', 'Measure', 'Request', 'Evaluate', 'Assess', 'Verify'];
      const isAction = actionVerbs.some(v => tag.startsWith(v));
      return e('span', {
        key: index,
        style: {
          fontSize: '11px',
          fontWeight: 600,
          color: isAction ? 'var(--blue)' : 'var(--label3)',
          background: isAction ? 'rgba(0,122,255,0.1)' : 'rgba(142,142,147,0.12)',
          padding: '3px 8px',
          borderRadius: '6px'
        }
      }, tag);
    }

    // 2. NavBar
    function NavBar({ title, onBack, rightAction }) {
      return e('div', {
        style: {
          position: 'sticky',
          top: 0,
          zIndex: 100,
          background: 'rgba(242,242,247,0.92)',
          backdropFilter: 'blur(20px) saturate(180%)',
          WebkitBackdropFilter: 'blur(20px) saturate(180%)',
          borderBottom: '0.5px solid rgba(60,60,67,0.1)',
          padding: '12px 16px',
          paddingTop: 'calc(12px + env(safe-area-inset-top))',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          minHeight: '44px'
        }
      },
        e('div', { style: { width: '80px' } },
          onBack && e('button', {
            onClick: onBack,
            style: {
              background: 'none',
              border: 'none',
              color: 'var(--blue)',
              fontSize: '16px',
              fontWeight: 500,
              fontFamily: 'var(--font)',
              cursor: 'pointer',
              padding: 0
            }
          }, 'â€¹ Back')
        ),
        e('div', {
          style: {
            position: 'absolute',
            left: '50%',
            transform: 'translateX(-50%)',
            fontSize: '17px',
            fontWeight: 700,
            letterSpacing: '-0.02em',
            color: 'var(--label)'
          }
        }, title),
        e('div', { style: { width: '80px', textAlign: 'right' } }, rightAction)
      );
    }

    // 3. ChoiceButton
    function ChoiceButton({ label, sublabel, selected, onClick, color = 'var(--blue)' }) {
      return e('button', {
        onClick: onClick,
        style: {
          width: '100%',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '16px 18px',
          background: selected ? `${color}10` : 'var(--card)',
          border: `2px solid ${selected ? color : 'var(--sep)'}`,
          borderRadius: '14px',
          marginBottom: '8px',
          cursor: 'pointer',
          transition: 'all 0.2s ease',
          textAlign: 'left',
          fontFamily: 'var(--font)'
        }
      },
        e('div', { style: { flex: 1 } },
          e('div', { style: { fontSize: '16px', fontWeight: 600, color: 'var(--label)' } }, label),
          sublabel && e('div', { style: { fontSize: '13px', color: 'var(--label3)', marginTop: '4px' } }, sublabel)
        ),
        e('div', {
          style: {
            width: '24px',
            height: '24px',
            borderRadius: '50%',
            border: `2px solid ${selected ? color : 'var(--label4)'}`,
            background: selected ? color : 'transparent',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            flexShrink: 0,
            marginLeft: '12px'
          }
        },
          selected && e('span', { style: { color: 'white', fontSize: '14px' } }, 'âœ“')
        )
      );
    }

    // 5. ValueInput
    function ValueInput({ label, unit, value, onChange, placeholder, hint }) {
      const hasValue = value && value.length > 0;
      return e('div', { style: { marginBottom: '16px' } },
        e('div', {
          style: {
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '8px'
          }
        },
          e('span', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)' } }, label),
          hint && e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, hint)
        ),
        e('div', {
          style: {
            display: 'flex',
            background: 'var(--card)',
            border: `1.5px solid ${hasValue ? 'var(--blue)' : 'var(--sep)'}`,
            borderRadius: '12px',
            overflow: 'hidden'
          }
        },
          e('input', {
            type: 'number',
            inputMode: 'decimal',
            value: value,
            onChange: (ev) => onChange(ev.target.value),
            placeholder: placeholder,
            style: {
              flex: 1,
              padding: '14px 16px',
              fontSize: '17px',
              fontWeight: 600,
              border: 'none',
              outline: 'none',
              background: 'transparent',
              fontFamily: 'var(--font)',
              color: 'var(--label)'
            }
          }),
          e('div', {
            style: {
              padding: '0 14px',
              fontSize: '13px',
              fontWeight: 600,
              color: 'var(--label3)',
              borderLeft: '1px solid var(--sep)',
              background: 'rgba(142,142,147,0.08)',
              display: 'flex',
              alignItems: 'center'
            }
          }, unit)
        )
      );
    }

    // 6. InfoPanel
    function InfoPanel({ title, color = 'var(--blue)', children }) {
      const [isOpen, setIsOpen] = useState(false);
      return e('div', {
        style: {
          background: isOpen ? `${color}08` : 'var(--card)',
          border: `1px solid ${isOpen ? `${color}25` : 'var(--sep)'}`,
          borderRadius: '14px',
          marginBottom: '12px',
          overflow: 'hidden'
        }
      },
        e('button', {
          onClick: () => setIsOpen(!isOpen),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            gap: '10px',
            padding: '14px 16px',
            background: 'none',
            border: 'none',
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            textAlign: 'left'
          }
        },
          e('div', {
            style: {
              width: '26px',
              height: '26px',
              borderRadius: '50%',
              background: `${color}15`,
              color: color,
              fontWeight: 700,
              fontSize: '14px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              flexShrink: 0
            }
          }, 'â“˜'),
          e('span', {
            style: { flex: 1, fontSize: '14px', fontWeight: 600, color: 'var(--label2)' }
          }, title),
          e('span', {
            style: {
              fontSize: '16px',
              color: 'var(--label3)',
              transform: isOpen ? 'rotate(90deg)' : 'rotate(0)',
              transition: 'transform 0.2s ease'
            }
          }, 'â€º')
        ),
        isOpen && e('div', {
          style: {
            borderTop: `1px solid ${color}15`,
            padding: '16px',
            fontSize: '13px',
            lineHeight: 1.65,
            color: 'var(--label2)',
            animation: 'fadeIn 0.2s ease'
          }
        }, children)
      );
    }

    // 7. Warning Banner
    function WarningBanner({ children, onContinue }) {
      // Gating warnings (with Continue) get stronger styling; informational warnings are softer
      const isGating = !!onContinue;
      return e('div', {
        style: {
          display: 'flex',
          flexDirection: 'column',
          padding: '14px 16px',
          background: isGating ? 'rgba(255,149,0,0.08)' : 'rgba(142,142,147,0.06)',
          border: isGating ? '1px solid rgba(255,149,0,0.25)' : '1px solid var(--sep)',
          borderRadius: '14px',
          marginBottom: '12px'
        }
      },
        e('div', { style: { display: 'flex', gap: '10px' } },
          e('span', { style: { fontSize: '16px', flexShrink: 0 } }, isGating ? 'âš ï¸' : 'â„¹ï¸'),
          e('div', {
            style: { fontSize: '13px', lineHeight: 1.55, color: isGating ? '#995700' : 'var(--label2)', fontWeight: 500 }
          }, children)
        ),
        onContinue && e('button', {
          onClick: onContinue,
          style: {
            alignSelf: 'flex-end',
            background: 'rgba(255,149,0,0.12)',
            border: '1px solid rgba(255,149,0,0.25)',
            borderRadius: '8px',
            color: '#995700',
            fontSize: '15px',
            fontWeight: 700,
            padding: '10px 16px',
            marginTop: '12px',
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            minHeight: '44px',
            display: 'flex',
            alignItems: 'center'
          }
        }, 'I understand â€” Continue â†’')
      );
    }

    // 8. BranchCard
    function BranchCard({ label, value, interpretation, color = 'var(--blue)' }) {
      return e('div', {
        style: {
          display: 'flex',
          borderRadius: '14px',
          overflow: 'hidden',
          border: `1px solid ${color}25`,
          background: 'var(--card)',
          marginBottom: '16px'
        }
      },
        e('div', {
          style: { width: '5px', background: color, flexShrink: 0 }
        }),
        e('div', { style: { flex: 1, padding: '14px 16px' } },
          e('div', {
            style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
          },
            e('span', { style: { fontSize: '13px', fontWeight: 600, color: 'var(--label3)' } }, label),
            e('span', { style: { fontSize: '17px', fontWeight: 700, color: color } }, value)
          ),
          e('div', {
            style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)', marginTop: '4px' }
          }, interpretation)
        )
      );
    }

    // 8b. InputSummaryStrip (compact summary of user inputs on results screens)
    function InputSummaryStrip({ items }) {
      return e('div', {
        style: {
          background: 'var(--card)',
          borderRadius: '14px',
          border: '1px solid var(--sep)',
          padding: '14px 16px',
          marginBottom: '20px'
        }
      },
        e('div', {
          style: { display: 'flex', flexWrap: 'wrap', alignItems: 'center', gap: '4px 0' }
        },
          items.map((item, i) => e(React.Fragment, { key: i },
            i > 0 && e('span', { style: { color: 'var(--label3)', margin: '0 8px', fontSize: '12px' } }, 'Â·'),
            e('span', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label3)', marginRight: '4px' } }, item.label),
            e('span', { style: { fontSize: '14px', fontWeight: 700, color: item.color || 'var(--label)' } }, item.value)
          ))
        )
      );
    }

    // 9. ResultCard
    function ResultCard({ title, subtitle, tags = [], severity, children, warning, onTap }) {
      const severityStyles = {
        likely: { color: '#0A84FF', bg: 'rgba(10,132,255,0.08)', border: 'rgba(10,132,255,0.2)', label: 'LIKELY' },
        dangerous: { color: '#FF453A', bg: 'rgba(255,69,58,0.08)', border: 'rgba(255,69,58,0.2)', label: 'URGENT' },
        consider: { color: '#FF9F0A', bg: 'rgba(255,159,10,0.08)', border: 'rgba(255,159,10,0.2)', label: 'CONSIDER' },
        rare: { color: '#8E8E93', bg: 'rgba(142,142,147,0.08)', border: 'rgba(142,142,147,0.2)', label: 'RARE' }
      };
      const sev = severityStyles[severity] || severityStyles.consider;

      return e('div', {
        style: {
          background: 'var(--card)',
          borderRadius: '16px',
          border: '1px solid var(--sep)',
          boxShadow: 'var(--shadow-sm)',
          padding: '18px 18px 16px',
          marginBottom: '10px'
        }
      },
        e('div', {
          style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }
        },
          e('div', { style: { flex: 1 } },
            e('div', {
              style: { fontSize: '16px', fontWeight: 700, letterSpacing: '-0.02em', color: 'var(--label)' }
            }, title),
            subtitle && e('div', {
              style: { fontSize: '13px', color: 'var(--label3)', marginTop: '3px' }
            }, subtitle)
          ),
          e('span', {
            style: {
              fontSize: '10px',
              fontWeight: 700,
              letterSpacing: '0.05em',
              color: sev.color,
              background: sev.bg,
              border: `1px solid ${sev.border}`,
              padding: '3px 8px',
              borderRadius: '6px',
              marginLeft: '10px'
            }
          }, sev.label)
        ),
        children && e('div', {
          style: { fontSize: '13.5px', lineHeight: 1.6, color: 'var(--label2)', marginTop: '6px' }
        }, children),
        warning && e('div', {
          style: {
            display: 'flex',
            gap: '10px',
            padding: '12px 14px',
            background: 'rgba(255,69,58,0.06)',
            border: '1px solid rgba(255,69,58,0.15)',
            borderRadius: '12px',
            marginTop: '12px'
          }
        },
          e('span', { style: { fontSize: '14px', flexShrink: 0 } }, 'âš ï¸'),
          e('div', {
            style: { fontSize: '12px', lineHeight: 1.5, color: '#C41E10', fontWeight: 500 }
          }, warning)
        ),
        tags.length > 0 && e('div', {
          style: { display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '10px' }
        },
          tags.map((tag, i) => e('span', {
            key: i,
            style: {
              fontSize: '11px',
              fontWeight: 600,
              color: 'var(--label3)',
              background: 'rgba(142,142,147,0.12)',
              padding: '3px 8px',
              borderRadius: '6px'
            }
          }, tag))
        ),
        onTap && e('button', {
          onClick: onTap,
          style: {
            background: 'none',
            border: 'none',
            color: 'var(--blue)',
            fontSize: '13px',
            fontWeight: 600,
            marginTop: '12px',
            padding: 0,
            cursor: 'pointer',
            fontFamily: 'var(--font)'
          }
        }, 'View management â†’')
      );
    }

    // 10. PrimaryButton
    function PrimaryButton({ label, onClick, disabled, color = 'var(--blue)' }) {
      return e('button', {
        onClick: disabled ? undefined : onClick,
        disabled: disabled,
        style: {
          width: '100%',
          padding: '16px',
          borderRadius: '14px',
          fontSize: '17px',
          fontWeight: 700,
          letterSpacing: '-0.02em',
          background: disabled ? 'var(--label4)' : color,
          color: 'white',
          border: 'none',
          opacity: disabled ? 0.5 : 1,
          cursor: disabled ? 'default' : 'pointer',
          marginTop: '8px',
          fontFamily: 'var(--font)',
          transition: 'all 0.2s ease'
        }
      }, label);
    }

    // 11. DiffCard (Collapsible)
    function DiffCard({ title, description, color = 'var(--blue)' }) {
      const [isOpen, setIsOpen] = useState(false);
      return e('div', {
        style: {
          background: 'var(--card)',
          border: '1px solid var(--sep)',
          borderRadius: '10px',
          marginBottom: '6px',
          overflow: 'hidden'
        }
      },
        e('button', {
          onClick: () => setIsOpen(!isOpen),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '12px 14px',
            background: 'none',
            border: 'none',
            borderLeft: `4px solid ${color}`,
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            textAlign: 'left'
          }
        },
          e('span', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)' } }, title),
          e('span', {
            style: {
              fontSize: '14px',
              color: 'var(--label3)',
              transform: isOpen ? 'rotate(90deg)' : 'rotate(0)',
              transition: 'transform 0.2s ease'
            }
          }, 'â€º')
        ),
        e('div', {
          style: {
            maxHeight: isOpen ? '500px' : '0',
            overflow: 'hidden',
            transition: 'max-height 0.2s ease'
          }
        },
          e('div', {
            style: {
              borderTop: '1px solid var(--sep)',
              padding: '10px 14px',
              fontSize: '13px',
              lineHeight: 1.55,
              color: 'var(--label2)'
            }
          }, description)
        )
      );
    }

    // 12. DiffListItem (Expandable diagnosis card - replaces ResultCard on results screens)
    function DiffListItem({ title, tags = [], children, warning, infoPanel, defaultOpen = false }) {
      const [expanded, setExpanded] = useState(defaultOpen);

      return e('div', {
        style: {
          background: 'var(--card)',
          borderRadius: '14px',
          border: '1px solid var(--sep)',
          boxShadow: 'var(--shadow-sm)',
          marginBottom: '8px',
          overflow: 'hidden'
        }
      },
        // Header (always visible, clickable)
        e('button', {
          onClick: () => setExpanded(!expanded),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'flex-start',
            justifyContent: 'space-between',
            padding: '16px',
            background: 'none',
            border: 'none',
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            textAlign: 'left'
          }
        },
          e('div', { style: { flex: 1 } },
            e('div', {
              style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', letterSpacing: '-0.02em' }
            }, title),
            tags.length > 0 && e('div', {
              style: { display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '8px' }
            },
              tags.map((tag, i) => renderTag(tag, i))
            )
          ),
          e('span', {
            style: {
              fontSize: '16px',
              color: 'var(--label3)',
              marginLeft: '12px',
              marginTop: '2px',
              transform: expanded ? 'rotate(90deg)' : 'rotate(0)',
              transition: 'transform 0.2s ease'
            }
          }, 'â€º')
        ),

        // Expandable content
        e('div', {
          style: {
            maxHeight: expanded ? '2000px' : '0',
            overflow: 'hidden',
            transition: 'max-height 0.3s ease'
          }
        },
          e('div', { style: { padding: '0 16px 16px' } },
            // Description text
            children && e('div', {
              style: { fontSize: '13.5px', lineHeight: 1.6, color: 'var(--label2)', marginBottom: warning || infoPanel ? '12px' : '0' }
            }, children),

            // Warning (if provided)
            warning && e('div', {
              style: {
                display: 'flex',
                gap: '10px',
                padding: '12px 14px',
                background: 'rgba(255,69,58,0.06)',
                border: '1px solid rgba(255,69,58,0.15)',
                borderRadius: '12px',
                marginBottom: infoPanel ? '12px' : '0'
              }
            },
              e('span', { style: { fontSize: '14px', flexShrink: 0 } }, 'âš ï¸'),
              e('div', {
                style: { fontSize: '12px', lineHeight: 1.5, color: '#C41E10', fontWeight: 500 }
              }, warning)
            ),

            // InfoPanel content (if provided)
            infoPanel
          )
        )
      );
    }

    // 12b. DiagnosisHeader (non-expandable section header for diagnosis groups)
    function DiagnosisHeader({ title, tags = [], description, warning, infoPanel }) {
      return e('div', { style: { marginBottom: '6px' } },
        e('div', {
          style: {
            padding: '14px 16px',
            background: 'rgba(142,142,147,0.06)',
            borderRadius: '14px',
            border: '1px solid var(--sep)'
          }
        },
          e('div', {
            style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', letterSpacing: '-0.02em' }
          }, title),
          tags.length > 0 && e('div', {
            style: { display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '6px' }
          },
            tags.map((tag, i) => renderTag(tag, i))
          ),
          description && e('div', {
            style: { fontSize: '13px', lineHeight: 1.55, color: 'var(--label2)', marginTop: '8px' }
          }, description),
          warning && e('div', {
            style: {
              display: 'flex',
              gap: '10px',
              padding: '10px 12px',
              background: 'rgba(255,69,58,0.06)',
              border: '1px solid rgba(255,69,58,0.15)',
              borderRadius: '10px',
              marginTop: '10px'
            }
          },
            e('span', { style: { fontSize: '14px', flexShrink: 0 } }, 'âš ï¸'),
            e('div', { style: { fontSize: '12px', lineHeight: 1.5, color: '#C41E10', fontWeight: 500 } }, warning)
          ),
          infoPanel && e('div', { style: { marginTop: '10px' } }, infoPanel)
        )
      );
    }

    // 13. LearnMoreDivider
    function LearnMoreDivider() {
      return e('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          marginTop: '24px',
          marginBottom: '16px',
          gap: '12px'
        }
      },
        e('div', { style: { flex: 1, height: '1px', background: 'var(--sep)' } }),
        e('span', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label4)' } }, 'Learn more'),
        e('div', { style: { flex: 1, height: '1px', background: 'var(--sep)' } })
      );
    }

    // 14. SeverityBadge (inline below inputs)
    function SeverityBadge({ text, color }) {
      return e('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
          marginTop: '6px'
        }
      },
        e('div', {
          style: {
            width: '8px',
            height: '8px',
            borderRadius: '50%',
            background: color,
            flexShrink: 0
          }
        }),
        e('span', { style: { fontSize: '13px', fontWeight: 600, color: color } }, text)
      );
    }

    // 15. HomeButton (for NavBar)
    function HomeButton({ onClick }) {
      return e('button', {
        onClick: onClick,
        style: {
          background: 'none',
          border: 'none',
          padding: '8px',
          cursor: 'pointer',
          borderRadius: '8px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center'
        }
      },
        e('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'var(--label3)', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          e('path', { d: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z' }),
          e('polyline', { points: '9 22 9 12 15 12 15 22' })
        )
      );
    }

    // 16. BetaGate (password gate for beta modules)
    function BetaGate({ moduleName, moduleColor, onSuccess, onBack }) {
      const [pin, setPin] = useState('');
      const [shake, setShake] = useState(false);
      const CORRECT_PIN = '0000';

      const handleDigit = (digit) => {
        if (pin.length >= 4) return;
        const newPin = pin + digit;
        setPin(newPin);
        if (newPin.length === 4) {
          if (newPin === CORRECT_PIN) {
            setTimeout(() => onSuccess(), 200);
          } else {
            setShake(true);
            setTimeout(() => {
              setShake(false);
              setPin('');
            }, 500);
          }
        }
      };

      const handleDelete = () => {
        setPin(pin.slice(0, -1));
      };

      const PinDot = ({ filled }) => e('div', {
        style: {
          width: '16px',
          height: '16px',
          borderRadius: '50%',
          border: filled ? 'none' : '2px solid var(--label3)',
          background: filled ? moduleColor : 'transparent',
          transition: 'all 0.15s ease'
        }
      });

      const NumKey = ({ digit, letters }) => e('button', {
        onClick: () => handleDigit(digit),
        style: {
          width: '75px',
          height: '75px',
          borderRadius: '50%',
          background: 'var(--card)',
          border: '1px solid var(--sep)',
          cursor: 'pointer',
          display: 'flex',
          flexDirection: 'column',
          alignItems: 'center',
          justifyContent: 'center',
          fontFamily: 'var(--font)',
          transition: 'transform 0.1s ease, background 0.1s ease'
        }
      },
        e('span', { style: { fontSize: '28px', fontWeight: 300, color: 'var(--label)' } }, digit),
        letters && e('span', { style: { fontSize: '10px', fontWeight: 500, color: 'var(--label3)', letterSpacing: '2px', marginTop: '-2px' } }, letters)
      );

      return e('div', { className: 'app-container', style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: moduleName, onBack: onBack }),
        e('div', { className: 'screen-content', style: { display: 'flex', flexDirection: 'column', alignItems: 'center', paddingTop: '40px' } },
          e('div', { style: { fontSize: '60px', marginBottom: '16px' } }, 'ðŸ”’'),
          e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '6px' } }, 'Beta Module'),
          e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '32px' } }, 'Enter access code'),

          // PIN dots
          e('div', {
            style: {
              display: 'flex',
              gap: '20px',
              marginBottom: '40px',
              animation: shake ? 'shake 0.5s ease' : 'none'
            }
          },
            e(PinDot, { filled: pin.length >= 1 }),
            e(PinDot, { filled: pin.length >= 2 }),
            e(PinDot, { filled: pin.length >= 3 }),
            e(PinDot, { filled: pin.length >= 4 })
          ),

          // Numeric keypad
          e('div', { style: { display: 'flex', flexDirection: 'column', gap: '12px' } },
            e('div', { style: { display: 'flex', gap: '20px', justifyContent: 'center' } },
              e(NumKey, { digit: '1', letters: '' }),
              e(NumKey, { digit: '2', letters: 'ABC' }),
              e(NumKey, { digit: '3', letters: 'DEF' })
            ),
            e('div', { style: { display: 'flex', gap: '20px', justifyContent: 'center' } },
              e(NumKey, { digit: '4', letters: 'GHI' }),
              e(NumKey, { digit: '5', letters: 'JKL' }),
              e(NumKey, { digit: '6', letters: 'MNO' })
            ),
            e('div', { style: { display: 'flex', gap: '20px', justifyContent: 'center' } },
              e(NumKey, { digit: '7', letters: 'PQRS' }),
              e(NumKey, { digit: '8', letters: 'TUV' }),
              e(NumKey, { digit: '9', letters: 'WXYZ' })
            ),
            e('div', { style: { display: 'flex', gap: '20px', justifyContent: 'center' } },
              e('div', { style: { width: '75px', height: '75px' } }), // empty spacer
              e(NumKey, { digit: '0', letters: '' }),
              e('button', {
                onClick: handleDelete,
                style: {
                  width: '75px',
                  height: '75px',
                  borderRadius: '50%',
                  background: 'transparent',
                  border: 'none',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  fontFamily: 'var(--font)'
                }
              },
                e('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'var(--label3)', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
                  e('path', { d: 'M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z' }),
                  e('line', { x1: '18', y1: '9', x2: '12', y2: '15' }),
                  e('line', { x1: '12', y1: '9', x2: '18', y2: '15' })
                )
              )
            )
          )
        )
      );
    }

    // Na Correction Rate Calculator (collapsible, used on Hypona results screens)
    function NaCorrectionCalculator({ naEntries, setNaEntries, targetRate, setTargetRate }) {
      const [isOpen, setIsOpen] = useState(false);

      const getCurrentDateTime = () => {
        const now = new Date();
        const date = now.toISOString().split('T')[0];
        const time = now.toTimeString().slice(0, 5);
        return { date, time };
      };

      const updateEntry = (index, field, value) => {
        setNaEntries(prev => prev.map((entry, i) => i === index ? { ...entry, [field]: value } : entry));
      };

      const addEntry = () => {
        const { date, time } = getCurrentDateTime();
        setNaEntries(prev => [...prev, { na: '', date, time }]);
      };

      const removeEntry = (index) => {
        if (naEntries.length > 1) {
          setNaEntries(prev => prev.filter((_, i) => i !== index));
        }
      };

      const calculateCorrectionRate = () => {
        const validEntries = naEntries
          .filter(entry => entry.na && entry.date && entry.time)
          .map(entry => ({
            na: parseFloat(entry.na),
            timestamp: new Date(`${entry.date}T${entry.time}`).getTime()
          }))
          .filter(entry => !isNaN(entry.na) && !isNaN(entry.timestamp))
          .sort((a, b) => a.timestamp - b.timestamp);

        if (validEntries.length < 2) return null;

        const first = validEntries[0];
        const last = validEntries[validEntries.length - 1];
        const hoursElapsed = (last.timestamp - first.timestamp) / (1000 * 60 * 60);
        if (hoursElapsed <= 0) return null;

        const naChange = last.na - first.na;
        const ratePerHour = naChange / hoursElapsed;
        const ratePer24h = ratePerHour * 24;

        return {
          naChange: naChange.toFixed(1),
          hoursElapsed: hoursElapsed.toFixed(1),
          ratePerHour: ratePerHour.toFixed(2),
          ratePer24h: ratePer24h.toFixed(1),
          exceeds: Math.abs(ratePer24h) > targetRate
        };
      };

      return e('div', { style: { marginBottom: '16px' } },
        // Collapsible header
        e('button', {
          onClick: () => setIsOpen(!isOpen),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '14px 16px',
            background: 'var(--card)',
            border: '1px solid var(--sep)',
            borderRadius: '14px',
            cursor: 'pointer',
            fontFamily: 'var(--font)'
          }
        },
          e('div', { style: { display: 'flex', alignItems: 'center', gap: '10px' } },
            e('span', { style: { fontSize: '16px' } }, 'ðŸ“ˆ'),
            e('div', null,
              e('div', { style: { fontSize: '14px', fontWeight: 700, color: 'var(--label)' } }, 'Na Correction Rate'),
              e('div', { style: { fontSize: '12px', color: 'var(--label3)' } }, 'Track serial measurements')
            )
          ),
          e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, isOpen ? 'â–²' : 'â–¼')
        ),

        // Collapsible content
        isOpen && e('div', {
          style: { background: 'rgba(142,142,147,0.06)', borderRadius: '0 0 14px 14px', padding: '16px', marginTop: '-14px', paddingTop: '28px', border: '1px solid var(--sep)', borderTop: 'none' }
        },
          // Target rate selector
          e('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '12px' } },
            e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, 'Target limit:'),
            e('select', {
              value: targetRate,
              onChange: (ev) => setTargetRate(parseInt(ev.target.value)),
              style: { padding: '6px 10px', borderRadius: '8px', border: '1px solid var(--sep)', background: 'var(--card)', color: 'var(--label)', fontSize: '12px', fontFamily: 'var(--font)' }
            },
              e('option', { value: 8 }, '8 mmol/24h (severe/chronic)'),
              e('option', { value: 10 }, '10 mmol/24h (standard)'),
              e('option', { value: 12 }, '12 mmol/24h (acute)')
            )
          ),

          // Na entries
          naEntries.map((entry, index) => e('div', {
            key: index,
            style: { display: 'flex', gap: '6px', alignItems: 'flex-end', marginBottom: '8px' }
          },
            e('div', { style: { flex: '1' } },
              e('label', { style: { fontSize: '10px', color: 'var(--label3)', display: 'block', marginBottom: '2px' } }, 'Na'),
              e('input', {
                type: 'number', inputMode: 'decimal', value: entry.na,
                onChange: (ev) => updateEntry(index, 'na', ev.target.value),
                placeholder: 'mmol/L',
                style: { width: '100%', padding: '8px', borderRadius: '8px', border: '1px solid var(--sep)', background: 'var(--card)', color: 'var(--label)', fontSize: '14px', fontFamily: 'var(--font)' }
              })
            ),
            e('div', { style: { flex: '0.8' } },
              e('label', { style: { fontSize: '10px', color: 'var(--label3)', display: 'block', marginBottom: '2px' } }, 'Date'),
              e('input', {
                type: 'date', value: entry.date,
                onChange: (ev) => updateEntry(index, 'date', ev.target.value),
                style: { width: '100%', padding: '8px', borderRadius: '8px', border: '1px solid var(--sep)', background: 'var(--card)', color: 'var(--label)', fontSize: '14px', fontFamily: 'var(--font)' }
              })
            ),
            e('div', { style: { flex: '0.8' } },
              e('label', { style: { fontSize: '10px', color: 'var(--label3)', display: 'block', marginBottom: '2px' } }, 'Time'),
              e('input', {
                type: 'time', value: entry.time,
                onChange: (ev) => updateEntry(index, 'time', ev.target.value),
                style: { width: '100%', padding: '8px', borderRadius: '8px', border: '1px solid var(--sep)', background: 'var(--card)', color: 'var(--label)', fontSize: '14px', fontFamily: 'var(--font)' }
              })
            ),
            naEntries.length > 1 && e('button', {
              onClick: () => removeEntry(index),
              style: { padding: '8px 10px', background: 'none', border: 'none', color: 'var(--red)', cursor: 'pointer', fontSize: '16px', minWidth: '36px', minHeight: '36px' }
            }, 'Ã—')
          )),

          e('button', {
            onClick: addEntry,
            style: { padding: '8px 12px', background: 'var(--card)', border: '1px solid var(--sep)', borderRadius: '8px', color: 'var(--blue)', fontSize: '12px', cursor: 'pointer', fontFamily: 'var(--font)', marginBottom: '12px' }
          }, '+ Add measurement'),

          // Results display
          calculateCorrectionRate() && e('div', {
            style: {
              background: calculateCorrectionRate().exceeds ? 'rgba(255,69,58,0.08)' : 'rgba(52,199,89,0.08)',
              border: `1px solid ${calculateCorrectionRate().exceeds ? 'rgba(255,69,58,0.2)' : 'rgba(52,199,89,0.2)'}`,
              borderRadius: '10px',
              padding: '12px',
              marginTop: '8px'
            }
          },
            e('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '6px' } },
              e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, 'Na change:'),
              e('span', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label)' } }, `${calculateCorrectionRate().naChange} mmol/L`)
            ),
            e('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '6px' } },
              e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, 'Time elapsed:'),
              e('span', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label)' } }, `${calculateCorrectionRate().hoursElapsed} hours`)
            ),
            e('div', { style: { display: 'flex', justifyContent: 'space-between', marginBottom: '6px' } },
              e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, 'Rate:'),
              e('span', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label)' } }, `${calculateCorrectionRate().ratePerHour} mmol/L/hr`)
            ),
            e('div', { style: { display: 'flex', justifyContent: 'space-between' } },
              e('span', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label3)' } }, 'Projected 24h:'),
              e('span', {
                style: { fontSize: '14px', fontWeight: 700, color: calculateCorrectionRate().exceeds ? 'var(--red)' : 'var(--green)' }
              }, `${calculateCorrectionRate().ratePer24h} mmol/L/24h`)
            ),
            e('div', {
              style: { fontSize: '10px', color: 'var(--label3)', marginTop: '6px', fontStyle: 'italic' }
            }, 'Projection based on current rate â€” correction often slows as Na rises. Recheck frequently.'),
            calculateCorrectionRate().exceeds && e('div', {
              style: { marginTop: '8px', padding: '8px', background: 'rgba(255,69,58,0.1)', borderRadius: '6px', fontSize: '11px', color: 'var(--red)', fontWeight: 500 }
            }, `âš  Exceeds target of ${targetRate} mmol/24h â€” risk of ODS`)
          )
        )
      );
    }

    // ========== SCREENS ==========

    // Home Screen
    function HomeScreen({ onSelectModule }) {
      return e('div', null,
        // Header
        e('div', {
          style: {
            padding: '16px 24px',
            paddingTop: 'calc(16px + env(safe-area-inset-top))'
          }
        },
          e('div', { style: { display: 'flex', alignItems: 'center', gap: '14px' } },
            e('div', {
              style: {
                width: '52px',
                height: '52px',
                borderRadius: '14px',
                background: 'linear-gradient(145deg, #1C1C1E, #3A3A3C)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
              }
            }, e('span', { style: { fontSize: '26px' } }, 'ðŸ§¬')),
            e('div', null,
              e('div', {
                style: { fontSize: '30px', fontWeight: 800, letterSpacing: '-0.04em', color: 'var(--label)' }
              }, 'LabLogic'),
              e('div', {
                style: { fontSize: '14px', fontWeight: 500, color: 'var(--label3)' }
              }, 'Lab interpretation, step by step')
            )
          )
        ),

        // Module Cards
        e('div', { style: { padding: '0 20px' } },
          modules.map((mod, i) =>
            e(FadeIn, { key: mod.id, delay: 100 + i * 60 },
              e('button', {
                onClick: () => onSelectModule(mod.beta ? mod.id + '-gate' : mod.id),
                style: {
                  width: '100%',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '14px',
                  background: 'var(--card)',
                  borderRadius: '18px',
                  padding: '16px 18px',
                  border: '1px solid var(--sep)',
                  boxShadow: 'var(--shadow-sm)',
                  marginBottom: '10px',
                  cursor: 'pointer',
                  textAlign: 'left',
                  fontFamily: 'var(--font)',
                  transition: 'transform 0.2s ease',
                  position: 'relative'
                }
              },
                // BETA badge (if beta module)
                mod.beta && e('span', {
                  style: {
                    position: 'absolute',
                    top: '8px',
                    right: '8px',
                    background: 'rgba(100,210,255,0.15)',
                    color: 'var(--cyan)',
                    fontSize: '10px',
                    fontWeight: 700,
                    padding: '2px 8px',
                    borderRadius: '6px'
                  }
                }, 'BETA'),
                // Icon square
                e('div', {
                  style: {
                    width: '48px',
                    height: '48px',
                    borderRadius: '14px',
                    background: mod.gradient,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    boxShadow: `0 3px 10px ${mod.color}30`,
                    flexShrink: 0
                  }
                }, e('span', { style: { fontSize: '22px' } }, mod.icon)),
                // Text
                e('div', { style: { flex: 1 } },
                  e('div', {
                    style: { fontSize: '16px', fontWeight: 700, letterSpacing: '-0.02em', color: 'var(--label)' }
                  }, mod.name),
                  e('div', {
                    style: { fontSize: '13px', color: 'var(--label3)', marginTop: '2px' }
                  }, mod.desc)
                ),
                // Tag + chevron
                e('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', flexShrink: 0 } },
                  e('span', {
                    style: {
                      fontSize: '11px',
                      fontWeight: 700,
                      color: mod.color,
                      background: `${mod.color}12`,
                      padding: '3px 8px',
                      borderRadius: '6px'
                    }
                  }, mod.tag),
                  e('span', { style: { color: 'var(--label4)', fontSize: '18px' } }, 'â€º')
                )
              )
            )
          )
        ),

        // Footer
        e('div', {
          style: { textAlign: 'center', padding: '20px 0 8px', paddingBottom: 'calc(8px + env(safe-area-inset-bottom))' }
        },
          e('div', { style: { fontSize: '12px', color: 'var(--label4)' } }, 'For healthcare professionals only'),
          e('div', { style: { fontSize: '12px', color: 'var(--label4)', marginTop: '4px' } }, 'Not a medical device Â· Verify against local reference ranges')
        )
      );
    }

    // Placeholder Screen for non-TFT modules
    function PlaceholderScreen({ moduleId, onBack }) {
      const mod = modules.find(m => m.id === moduleId);
      return e('div', null,
        e(NavBar, { title: mod?.name || 'Module', onBack }),
        e('div', {
          style: {
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '80px 20px',
            textAlign: 'center'
          }
        },
          e('span', { style: { fontSize: '48px', marginBottom: '16px' } }, mod?.icon || 'ðŸ“‹'),
          e('div', { style: { fontSize: '20px', fontWeight: 700, color: 'var(--label)', marginBottom: '8px' } }, 'Coming Soon'),
          e('div', { style: { fontSize: '14px', color: 'var(--label3)' } }, mod?.desc || 'This module is under development')
        )
      );
    }

    // ========== TFT MODULE ==========

    function TFTModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const [acutelyUnwell, setAcutelyUnwell] = useState(null);
      const [tshResult, setTshResult] = useState(null);
      const [ft4Status, setFt4Status] = useState(null); // 'low', 'normal', 'high'
      const [ft3Status, setFt3Status] = useState(null); // 'low', 'normal', 'high'

      // Auto-advance for ChoiceButton-only screens
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Dynamic screen count: 5 screens if TSH low (need fT3), else 4 screens
      const getTotalScreens = () => tshResult === 'low' ? 5 : 4;
      const getResultsScreen = () => tshResult === 'low' ? 4 : 3;

      const handleBack = () => {
        clearAutoAdvance();
        if (step === 0) {
          onBack();
        } else if (step === getResultsScreen()) {
          // From results, go back to fT3 (if TSH low) or fT4
          setStep(tshResult === 'low' ? 3 : 2);
        } else {
          setStep(step - 1);
        }
      };

      const goToStep = (newStep) => {
        document.activeElement.blur();
        setStep(newStep);
        if (containerRef.current) {
          containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
        }
      };

      const resetModule = () => {
        setStep(0);
        setAcutelyUnwell(null);
        setTshResult(null);
        setFt4Status(null);
        setFt3Status(null);
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
      };

      // Get TSH display values
      const getTSHDisplay = () => {
        if (tshResult === 'low') return { value: 'Low (< 0.4)', interpretation: 'Suppressed', color: 'var(--red)' };
        if (tshResult === 'high') return { value: 'High (> 4.0)', interpretation: 'Elevated', color: 'var(--orange)' };
        return { value: 'Normal (0.4â€“4.0)', interpretation: 'Within range', color: 'var(--green)' };
      };

      const getFT4Display = () => {
        if (ft4Status === 'low') return { value: 'Low (< 12)', interp: 'Below range', color: 'var(--red)' };
        if (ft4Status === 'high') return { value: 'High (> 22)', interp: 'Above range', color: 'var(--orange)' };
        return { value: 'Normal (12â€“22)', interp: 'Within range', color: 'var(--green)' };
      };

      const getFT3Display = () => {
        if (ft3Status === 'low') return { value: 'Low (< 3.1)', interp: 'Below range', color: 'var(--red)' };
        if (ft3Status === 'high') return { value: 'High (> 6.8)', interp: 'Above range', color: 'var(--orange)' };
        return { value: 'Normal (3.1â€“6.8)', interp: 'Within range', color: 'var(--green)' };
      };

      // Main TFT flow
      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Thyroid Function', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--purple)' }),

          // SCREEN 0: Is the patient acutely unwell? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Is the patient acutely unwell?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'This changes how we interpret the results'),
            e(ChoiceButton, {
              label: 'Yes â€” acutely unwell or in ICU',
              sublabel: 'Sick euthyroid may confound results',
              selected: acutelyUnwell === true,
              onClick: () => {
                clearAutoAdvance();
                setAcutelyUnwell(true);
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'No â€” outpatient or stable',
              selected: acutelyUnwell === false,
              onClick: () => {
                clearAutoAdvance();
                setAcutelyUnwell(false);
                scheduleAdvance(() => goToStep(1), false); // 300ms delay
              },
              color: 'var(--purple)'
            }),
            acutelyUnwell === true && e(WarningBanner, { onContinue: () => goToStep(1) },
              e('strong', null, 'Non-thyroidal illness (sick euthyroid)'), ' can cause â†“fT3, â†“fT4, and â†“TSH in acute illness. Do NOT diagnose or treat thyroid disease from TFTs in acute illness unless TSH is markedly abnormal (>20 or <0.1).'
            )
          ),

          // SCREEN 1: What is the TSH? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What is the TSH?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'TSH moves before fT4/fT3 become abnormal'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 0.4 mU/L',
              sublabel: 'Suppressed â€” suggests excess thyroid hormone',
              selected: tshResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setTshResult('low');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Normal  0.4â€“4.0 mU/L',
              selected: tshResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setTshResult('normal');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 4.0 mU/L',
              sublabel: 'Elevated â€” suggests insufficient thyroid hormone',
              selected: tshResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setTshResult('high');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--orange)'
            }),
            e('div', {
              style: { fontSize: '12px', color: 'var(--label3)', marginTop: '12px', padding: '10px 12px', background: 'rgba(175,82,222,0.06)', borderRadius: '10px' }
            }, 'ðŸ’¡ In first trimester pregnancy, TSH as low as 0.1 can be physiological due to hCG cross-reactivity. Use trimester-specific reference ranges.')
          ),

          // SCREEN 2: What is the fT4? (ChoiceButtons, auto-advance)
          step === 2 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What is the fT4?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } },
              tshResult === 'low' ? 'TSH is suppressed â€” fT4 helps classify' :
              tshResult === 'high' ? 'TSH is elevated â€” fT4 distinguishes overt from subclinical' :
              'TSH normal â€” fT4 checks for rare discordance'
            ),
            e(ChoiceButton, {
              label: 'Low  â€¹ 12 pmol/L',
              selected: ft4Status === 'low',
              onClick: () => {
                clearAutoAdvance();
                setFt4Status('low');
                scheduleAdvance(() => goToStep(tshResult === 'low' ? 3 : getResultsScreen()), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Normal  12â€“22 pmol/L',
              selected: ft4Status === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setFt4Status('normal');
                scheduleAdvance(() => goToStep(tshResult === 'low' ? 3 : getResultsScreen()), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 22 pmol/L',
              selected: ft4Status === 'high',
              onClick: () => {
                clearAutoAdvance();
                setFt4Status('high');
                scheduleAdvance(() => goToStep(tshResult === 'low' ? 3 : getResultsScreen()), false);
              },
              color: 'var(--orange)'
            })
          ),

          // SCREEN 3: What is the fT3? (only if TSH low, ChoiceButtons, auto-advance)
          step === 3 && tshResult === 'low' && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What is the fT3?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } },
              ft4Status === 'high' ? 'Confirms degree of thyrotoxicosis' :
              ft4Status === 'low' ? 'Helps distinguish central hypothyroidism from sick euthyroid' :
              'Needed to detect T3 thyrotoxicosis when fT4 is normal'
            ),
            e(ChoiceButton, {
              label: 'Low  â€¹ 3.1 pmol/L',
              selected: ft3Status === 'low',
              onClick: () => {
                clearAutoAdvance();
                setFt3Status('low');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Normal  3.1â€“6.8 pmol/L',
              selected: ft3Status === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setFt3Status('normal');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 6.8 pmol/L',
              selected: ft3Status === 'high',
              onClick: () => {
                clearAutoAdvance();
                setFt3Status('high');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--orange)'
            })
          ),

          // RESULTS SCREEN (step 3 if TSH not low, step 4 if TSH low)
          step === getResultsScreen() && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Interpretation'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } },
              (() => {
                const tsh = tshResult === 'low' ? 'TSH â†“' : tshResult === 'high' ? 'TSH â†‘' : 'TSH normal';
                const ft4 = ft4Status === 'low' ? ' Â· fT4 â†“' : ft4Status === 'high' ? ' Â· fT4 â†‘' : ' Â· fT4 normal';
                const ft3 = tshResult === 'low' && ft3Status ? (ft3Status === 'high' ? ' Â· fT3 â†‘' : ft3Status === 'low' ? ' Â· fT3 â†“' : ' Â· fT3 normal') : '';
                return tsh + ft4 + ft3;
              })()
            ),

            // Compact input summary
            e(InputSummaryStrip, { items: [
              { label: 'TSH', ...getTSHDisplay() },
              ft4Status && { label: 'fT4', ...getFT4Display() },
              ft3Status && tshResult === 'low' && { label: 'fT3', ...getFT3Display() }
            ].filter(Boolean) }),

            e('div', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label3)', letterSpacing: '0.03em', marginBottom: '10px' } }, 'Consistent diagnoses'),

            // TSH LOW pathways
            tshResult === 'low' && ft4Status === 'high' && e(DiffListItem, {
              title: 'Overt Hyperthyroidism',
              tags: ['Graves\'', 'Toxic MNG', 'Toxic adenoma']
            }, 'Suppressed TSH with elevated fT4 confirms thyrotoxicosis. Most commonly Graves\' disease, toxic multinodular goitre, or toxic adenoma.'),

            tshResult === 'low' && ft4Status === 'normal' && ft3Status === 'high' && e(DiffListItem, {
              title: 'T3 Thyrotoxicosis',
              tags: ['~5% of hyperthyroidism', 'Early Graves\'', 'Toxic adenoma']
            }, 'fT4 normal but fT3 elevated â€” about 5% of hyperthyroidism presents this way. Common in early Graves\' disease or autonomous thyroid adenoma.'),

            tshResult === 'low' && ft4Status === 'normal' && (ft3Status === 'normal' || !ft3Status) && !(ft3Status === 'high') && e(DiffListItem, {
              title: 'Subclinical Hyperthyroidism',
              tags: ['Recheck 6â€“8 weeks', 'AF risk', 'Osteoporosis risk']
            }, 'TSH suppressed but hormones normal. May be transient. Recheck in 6â€“8 weeks. If persistent, increased risk of atrial fibrillation and osteoporosis.'),

            tshResult === 'low' && ft4Status === 'low' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'Central Hypothyroidism',
                tags: ['Pituitary failure', 'Check cortisol FIRST'],
                defaultOpen: true,
                warning: e(React.Fragment, null, e('strong', null, 'Check cortisol before starting thyroxine.'), ' Starting thyroxine with unrecognised adrenal insufficiency can precipitate adrenal crisis.'),
                infoPanel: e(InfoPanel, { title: 'Central Hypothyroidism â€” Why It Matters', color: 'var(--red)' },
                  e('p', { style: { marginBottom: '10px' } }, 'Low TSH + low fT4 = pituitary failure, not just thyroid disease.'),
                  e('p', { style: { marginBottom: '10px' } }, 'Pituitary adenoma (mass effect) Â· Pituitary apoplexy Â· Post-surgical/radiation Â· Sheehan\'s syndrome Â· Infiltrative disease (sarcoid, haemochromatosis)'),
                  e('p', { style: { fontWeight: 700 } }, 'If pituitary failure suspected, check cortisol BEFORE starting thyroxine.')
                )
              }, 'Low TSH with low fT4 means the pituitary is failing â€” this is NOT primary thyroid disease. Investigate for pituitary pathology urgently.'),
              e(DiffListItem, {
                title: 'Non-Thyroidal Illness (Recovery Phase)',
                tags: ['Sick euthyroid', 'Transient', 'Recheck when well']
              }, 'TSH can transiently suppress during recovery from acute illness while fT4 is still low. If the patient was recently unwell, recheck TFTs in 4â€“6 weeks before investigating for pituitary pathology.')
            ),

            // TSH HIGH pathways
            tshResult === 'high' && ft4Status === 'low' && e(DiffListItem, {
              title: 'Overt Hypothyroidism',
              tags: ['Hashimoto\'s', 'Post-thyroidectomy', 'Post-radioiodine']
            }, 'Elevated TSH with low fT4 confirms primary hypothyroidism. Most commonly autoimmune (Hashimoto\'s â€” check TPO antibodies).'),

            tshResult === 'high' && ft4Status === 'normal' && e(DiffListItem, {
              title: 'Subclinical Hypothyroidism',
              tags: ['Recheck 6â€“8 weeks', 'Check TPO antibodies', 'Treat if TSH >10'],
              infoPanel: e(InfoPanel, { title: 'When to Treat Subclinical Hypothyroidism', color: 'var(--purple)' },
                e('div', { style: { background: 'rgba(48,209,88,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '10px' } },
                  e('strong', { style: { color: 'var(--green)' } }, 'TREAT IF:'), ' TSH >10 (except consider observation in >70y) Â· TSH 4â€“10 with positive TPOAb and symptoms Â· Pregnant or planning pregnancy (target TSH <2.5)'
                ),
                e('div', { style: { background: 'rgba(255,159,10,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                  e('strong', { style: { color: 'var(--orange)' } }, 'OBSERVE IF:'), ' TSH 4â€“10 with negative TPOAb and asymptomatic Â· Elderly (>70 years) â€” even TSH >10 may not need treatment (TRUST trial) Â· Recovery from acute illness'
                )
              )
            }, 'TSH elevated but fT4 still normal. Common finding. Check TPO antibodies and recheck in 6â€“8 weeks. Treatment threshold depends on TSH level, symptoms, and antibody status.'),

            tshResult === 'high' && ft4Status === 'high' && e(DiffListItem, {
              title: 'Assay Interference or TSH-oma',
              tags: ['Biotin interference', 'Heterophile antibodies', 'Refer endocrinology']
            }, 'TSH elevated with high fT4 is discordant â€” TSH should be suppressed. Consider biotin supplement interference, heterophile antibodies, or rare TSH-secreting pituitary adenoma.'),

            // TSH NORMAL pathways
            tshResult === 'normal' && ft4Status === 'normal' && e(DiffListItem, {
              title: 'Euthyroid',
              tags: ['Normal thyroid function'],
              defaultOpen: true
            }, 'TSH and fT4 both normal. Symptoms unlikely to be thyroid-related.'),

            tshResult === 'normal' && ft4Status === 'low' && e(DiffListItem, {
              title: 'Central Hypothyroidism',
              tags: ['Pituitary failure', 'Investigate urgently'],
              defaultOpen: true,
              warning: e(React.Fragment, null, e('strong', null, 'Check cortisol before starting thyroxine.'), ' Starting thyroxine with unrecognised adrenal insufficiency can precipitate adrenal crisis.'),
              infoPanel: e(InfoPanel, { title: 'Central Hypothyroidism â€” Why It Matters', color: 'var(--red)' },
                e('p', { style: { marginBottom: '10px' } }, 'Low TSH + low fT4 = pituitary failure, not just thyroid disease.'),
                e('p', { style: { marginBottom: '10px' } }, 'Pituitary adenoma (mass effect) Â· Pituitary apoplexy Â· Post-surgical/radiation Â· Sheehan\'s syndrome Â· Infiltrative disease (sarcoid, haemochromatosis)'),
                e('p', { style: { fontWeight: 700 } }, 'If pituitary failure suspected, check cortisol BEFORE starting thyroxine.')
              )
            }, 'Normal TSH is \'inappropriately normal\' in the context of low fT4. The pituitary should be driving TSH up. Investigate for pituitary pathology.'),

            tshResult === 'normal' && ft4Status === 'high' && e(DiffListItem, {
              title: 'Assay Interference',
              tags: ['Biotin supplements', 'Heterophile antibodies', 'Recheck']
            }, 'Normal TSH with high fT4 is discordant. Most commonly caused by biotin supplement interference. Stop biotin for 48h and recheck, or request repeat on different assay platform.'),

            e('div', {
              style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center', lineHeight: '1.5' }
            }, 'If the clinical picture doesn\'t match the lab interpretation, re-examine the patient and repeat the tests.'),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', textAlign: 'center' } }, 'Reference ranges vary by laboratory. Verify against your local reference ranges.'),

            e(PrimaryButton, {
              label: 'New Analysis',
              color: 'var(--purple)',
              onClick: resetModule
            }),
            e('button', {
              onClick: onBack,
              style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
            }, 'â† All modules'),

            e(LearnMoreDivider),

            // Causes of Hyperthyroidism InfoPanel (when hyperthyroid)
            (tshResult === 'low' && (ft4Status === 'high' || (ft4Status === 'normal' && ft3Status === 'high'))) && e(InfoPanel, { title: 'Causes of Hyperthyroidism', color: 'var(--purple)' },
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'High uptake on thyroid scan (â†‘ synthesis):'),
              e('ul', { style: { marginLeft: '16px', marginBottom: '12px' } },
                e('li', null, 'Graves\' disease â€” diffuse uptake, TRAb positive'),
                e('li', null, 'Toxic multinodular goitre â€” patchy uptake'),
                e('li', null, 'Toxic adenoma â€” single hot nodule')
              ),
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'Low uptake on thyroid scan (preformed hormone release):'),
              e('ul', { style: { marginLeft: '16px', marginBottom: '12px' } },
                e('li', null, 'Thyroiditis (subacute, postpartum, silent)'),
                e('li', null, 'Exogenous thyroid hormone'),
                e('li', null, 'Iodine-induced (amiodarone, contrast)')
              ),
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'Key distinguishing features:'),
              e('ul', { style: { marginLeft: '16px' } },
                e('li', null, 'Graves\': eye signs, diffuse goitre, TRAb positive'),
                e('li', null, 'Thyroiditis: tender thyroid, self-limiting'),
                e('li', null, 'Amiodarone: Type 1 (synthesis) vs Type 2 (destructive)')
              )
            ),

            // Assay interference panel - only show when relevant
            ((tshResult === 'high' && ft4Status === 'high') || (tshResult === 'normal' && ft4Status === 'high')) && e(InfoPanel, { title: 'Assay Interference â€” the Hidden Trap', color: 'var(--purple)' },
              e('p', { style: { marginBottom: '10px' } },
                e('strong', null, 'Biotin (Vitamin B7):'), ' High-dose biotin supplements (common in "hair and nails" products, also MS treatment) interfere with streptavidin-biotin immunoassays. Can cause falsely â†‘fT4, â†‘fT3, â†“TSH â€” mimicking hyperthyroidism.'
              ),
              e('p', { style: { marginBottom: '10px' } },
                e('strong', null, 'Heterophile antibodies:'), ' Antibodies that interfere with immunoassays. Can cause falsely high or low results. Suspect if discordant with clinical picture.'
              ),
              e('p', null,
                e('strong', null, 'Hook effect:'), ' Very high analyte concentrations can saturate assay and give falsely low/normal results. Rare but relevant in pregnancy and severe thyrotoxicosis.'
              )
            ),

            e(InfoPanel, { title: 'Drug-Induced Thyroid Dysfunction', color: 'var(--purple)' },
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Amiodarone:'),
              e('p', { style: { marginBottom: '10px' } }, 'Can cause BOTH hypo- and hyperthyroidism. Hypothyroidism more common in iodine-replete populations (Australia). Type 1 thyrotoxicosis (excess synthesis) vs Type 2 (destructive thyroiditis) â€” distinction matters for treatment. TFTs should be monitored every 6 months on amiodarone.'),
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Lithium:'),
              e('p', { style: { marginBottom: '10px' } }, 'Causes hypothyroidism in up to 20% of patients. Concentrates in thyroid and inhibits hormone release. Monitor TFTs at baseline, 6 months, then annually.'),
              e('p', { style: { fontWeight: 700, marginBottom: '8px' } }, 'Other drugs:'),
              e('p', null, 'Immune checkpoint inhibitors (pembrolizumab, nivolumab) â†’ thyroiditis then hypothyroidism. Tyrosine kinase inhibitors â†’ hypothyroidism. Dopamine/glucocorticoids â†’ suppress TSH.')
            )
          )
        )
      );
    }

    // ========== HYPONATRAEMIA MODULE ==========

    function HyponatraemiaModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);

      // Auto-advance for ChoiceButton-only screens
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Serum Sodium (ValueInput)
      const [naValue, setNaValue] = useState('');

      // Screen 1: Chronicity (ChoiceButtons)
      const [chronicity, setChronicity] = useState(null);

      // Screen 2: Serum Osmolality (ChoiceButtons, branches)
      const [serumOsmResult, setSerumOsmResult] = useState(null);

      // Screen 2a: Glucose for corrected Na (if hyper-osmolar)
      const [glucose, setGlucose] = useState('');

      // Screen 3: Urine Osmolality (if hypotonic)
      const [urineOsmResult, setUrineOsmResult] = useState(null);

      // Screen 4: Urine Sodium (if hypotonic)
      const [urineNaResult, setUrineNaResult] = useState(null);

      // Na Correction Rate Calculator
      const getCurrentDateTime = () => {
        const now = new Date();
        const date = now.toISOString().split('T')[0];
        const time = now.toTimeString().slice(0, 5);
        return { date, time };
      };
      const [naEntries, setNaEntries] = useState(() => {
        const { date, time } = getCurrentDateTime();
        return [{ na: '', date, time }];
      });
      const [targetRate, setTargetRate] = useState(10);

      // Determine path based on serum osmolality
      const isShortPath = serumOsmResult === 'normal' || serumOsmResult === 'high';
      const isHyperOsmolar = serumOsmResult === 'high';
      const isIsoOsmolar = serumOsmResult === 'normal';

      // Dynamic screen count:
      // Short path (iso/hyper): 0-Na, 1-Chronicity, 2-SerumOsm, 2a-Glucose(hyper only), 3-Results
      // Long path (hypotonic): 0-Na, 1-Chronicity, 2-SerumOsm, 3-UrineOsm, 4-UrineNa, 5-Results
      const getTotalScreens = () => {
        if (isIsoOsmolar) return 4; // Na, Chronicity, SerumOsm, Results
        if (isHyperOsmolar) return 5; // Na, Chronicity, SerumOsm, Glucose, Results
        return 6; // Na, Chronicity, SerumOsm, UrineOsm, UrineNa, Results
      };

      const getResultsScreen = () => {
        if (isIsoOsmolar) return 3;
        if (isHyperOsmolar) return 4;
        return 5;
      };

      const scrollToTop = () => {
        if (containerRef.current) {
          containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
        }
      };

      const goToStep = (newStep) => {
        document.activeElement.blur();
        setStep(newStep);
        scrollToTop();
      };

      const resetModule = () => {
        setStep(0);
        setNaValue('');
        setChronicity(null);
        setSerumOsmResult(null);
        setGlucose('');
        setUrineOsmResult(null);
        setUrineNaResult(null);
        const { date, time } = getCurrentDateTime();
        setNaEntries([{ na: '', date, time }]);
        setTargetRate(10);
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
      };

      const handleBack = () => {
        clearAutoAdvance();
        if (step === 0) {
          onBack();
        } else if (step === getResultsScreen()) {
          // From results, go back to previous screen based on path
          if (isIsoOsmolar) goToStep(2);
          else if (isHyperOsmolar) goToStep(3); // glucose screen
          else goToStep(4); // urine na
        } else {
          goToStep(step - 1);
        }
      };

      // Severity assessment
      const getSeverity = () => {
        const na = parseFloat(naValue);
        if (isNaN(na)) return null;
        if (na > 130) return { color: 'var(--green)', interp: 'Mild â€” usually asymptomatic' };
        if (na >= 125) return { color: 'var(--orange)', interp: 'Moderate â€” confusion, nausea, headache likely' };
        if (na >= 120) return { color: 'var(--orange)', interp: 'Significant â€” high risk of symptoms' };
        return { color: 'var(--red)', interp: 'Severe â€” seizures, coma, cerebral oedema risk' };
      };

      // Corrected Na calculation (Katz formula)
      const getCorrectedNa = () => {
        const na = parseFloat(naValue);
        const glu = parseFloat(glucose);
        if (isNaN(na) || isNaN(glu) || glu <= 5.5) return null;
        return (na + 0.3 * (glu - 5.5)).toFixed(1);
      };

      // Na display for branch cards
      const getNaDisplay = () => {
        const severity = getSeverity();
        return {
          value: naValue ? `${naValue} mmol/L` : '',
          interpretation: severity?.interp || '',
          color: severity?.color || 'var(--blue)'
        };
      };

      const getSerumOsmDisplay = () => {
        if (serumOsmResult === 'low') return { value: 'Low (< 275)', interpretation: 'Hypotonic', color: 'var(--blue)' };
        if (serumOsmResult === 'normal') return { value: 'Normal (275â€“295)', interpretation: 'Iso-osmolar', color: 'var(--green)' };
        if (serumOsmResult === 'high') return { value: 'High (> 295)', interpretation: 'Hyper-osmolar', color: 'var(--orange)' };
        if (serumOsmResult === 'skip') return { value: 'Not available', interpretation: 'Assumed hypotonic', color: 'var(--label3)' };
        return { value: '', interpretation: '', color: 'var(--blue)' };
      };

      const getUrineOsmDisplay = () => {
        if (urineOsmResult === 'low') return { value: 'Low (< 100)', interpretation: 'Dilute â€” kidneys working', color: 'var(--green)' };
        if (urineOsmResult === 'high') return { value: 'High (> 100)', interpretation: 'Concentrated â€” ADH active', color: 'var(--orange)' };
        return { value: '', interpretation: '', color: 'var(--blue)' };
      };

      const getUrineNaDisplay = () => {
        if (urineNaResult === 'low') return { value: 'Low (< 30)', interpretation: 'Retained â€” kidneys conserving', color: 'var(--green)' };
        if (urineNaResult === 'high') return { value: 'High (> 30)', interpretation: 'Wasted â€” sodium loss', color: 'var(--orange)' };
        return { value: '', interpretation: '', color: 'var(--blue)' };
      };

      // Main flow
      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Hyponatraemia', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--blue)' }),

          // SCREEN 0: Serum sodium (ValueInput, Next button)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What is the serum sodium?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'This determines the severity'),
            e(ValueInput, {
              label: 'Serum Sodium',
              unit: 'mmol/L',
              value: naValue,
              onChange: setNaValue,
              placeholder: '135 â€“ 145',
              hint: 'Normal: 135â€“145'
            }),
            getSeverity() && e(SeverityBadge, { text: getSeverity().interp, color: getSeverity().color }),
            e(PrimaryButton, {
              label: 'Next',
              disabled: !naValue,
              color: 'var(--blue)',
              onClick: () => goToStep(1)
            })
          ),

          // SCREEN 1: How quickly did this develop? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'How quickly did this develop?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'If last known normal Na was >48h ago or unknown, treat as chronic'),
            e(ChoiceButton, {
              label: 'Acute  â€¹ 48 hours',
              sublabel: 'Brain not adapted â€” can correct faster',
              selected: chronicity === 'acute',
              onClick: () => {
                clearAutoAdvance();
                setChronicity('acute');
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Chronic  â€º 48 hours',
              sublabel: 'Brain adapted â€” rapid correction risks ODS',
              selected: chronicity === 'chronic',
              onClick: () => {
                clearAutoAdvance();
                setChronicity('chronic');
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Unknown',
              sublabel: 'Treat as chronic (safer assumption)',
              selected: chronicity === 'unknown',
              onClick: () => {
                clearAutoAdvance();
                setChronicity('unknown');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--blue)'
            }),
            chronicity === 'acute' && e(WarningBanner, { onContinue: () => goToStep(2) }, 'Higher risk of cerebral oedema. But safer to correct faster than in chronic hyponatraemia.'),
            chronicity === 'chronic' && e(WarningBanner, { onContinue: () => goToStep(2) }, 'Brain has adapted. Rapid correction risks osmotic demyelination syndrome (ODS).')
          ),

          // SCREEN 2: Serum osmolality (ChoiceButtons, auto-advance, branches)
          step === 2 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Check serum osmolality'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Determines whether this is true hyponatraemia'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 275 mOsm/kg',
              sublabel: 'True hyponatraemia â€” continue workup',
              selected: serumOsmResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('low');
                scheduleAdvance(() => goToStep(3), false); // Continue to urine osm
              },
              color: 'var(--blue)'
            }),
            e(ChoiceButton, {
              label: 'Normal  275â€“295 mOsm/kg',
              sublabel: 'Pseudohyponatraemia',
              selected: serumOsmResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('normal');
                scheduleAdvance(() => goToStep(3), false); // Go to iso-osmolar results
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 295 mOsm/kg',
              sublabel: 'Dilutional â€” check glucose',
              selected: serumOsmResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('high');
                scheduleAdvance(() => goToStep(3), false); // Go to glucose input
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Not available',
              sublabel: 'Assume hypotonic â€” but check glucose first (if >15, osm may be elevated)',
              selected: serumOsmResult === 'skip',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('skip');
                scheduleAdvance(() => goToStep(3), false); // Continue to urine osm
              },
              color: 'var(--label3)'
            })
          ),

          // SCREEN 3: Path-dependent
          // If iso-osmolar â†’ Results
          step === 3 && isIsoOsmolar && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Interpretation'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Iso-osmolar hyponatraemia'),
            e(InputSummaryStrip, { items: [
              { label: 'Na', ...getNaDisplay() },
              { label: 'Serum Osm', ...getSerumOsmDisplay() }
            ] }),
            e('div', {
              style: { fontSize: '12px', color: 'var(--label3)', marginTop: '4px', marginBottom: '12px', padding: '10px 12px', background: 'rgba(10,132,255,0.06)', borderRadius: '10px' }
            }, 'ðŸ’¡ If iso-osmolar but clinical picture doesn\'t fit pseudohyponatraemia, check cortisol to exclude adrenal insufficiency.'),
            e(DiffListItem, {
              title: 'Pseudohyponatraemia',
              tags: ['Measurement artefact', 'Check Na on VBG'],
              defaultOpen: true,
              infoPanel: e(InfoPanel, { title: 'Tonicity vs Osmolality', color: 'var(--blue)' },
                e('p', { style: { marginBottom: '10px' } }, 'Urea and ethanol contribute to measured osmolality but are ineffective osmoles (cross cell membranes freely).'),
                e('p', null, 'Tonicity = Osmolality âˆ’ Urea. If in doubt, calculate tonicity or check Na on VBG.')
              )
            }, 'Usually measurement error secondary to hyperlipidaemia or hyperproteinaemia. Check Na on VBG (direct ion-selective electrode).'),
            e('div', {
              style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center', lineHeight: '1.5' }
            }, 'If the clinical picture doesn\'t match the lab interpretation, re-examine the patient and repeat the tests.'),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', textAlign: 'center' } }, 'Reference ranges vary by laboratory. Verify against your local reference ranges.'),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--blue)', onClick: resetModule }),
            e('button', {
              onClick: onBack,
              style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
            }, 'â† All modules')
          ),

          // If hyper-osmolar â†’ Glucose input screen
          step === 3 && isHyperOsmolar && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Enter glucose'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'To calculate corrected sodium'),
            e(ValueInput, {
              label: 'Glucose',
              unit: 'mmol/L',
              value: glucose,
              onChange: setGlucose,
              placeholder: 'Enter value',
              hint: 'For corrected Na calculation'
            }),
            getCorrectedNa() && e(BranchCard, {
              label: 'Corrected Na',
              value: `${getCorrectedNa()} mmol/L`,
              interpretation: 'Predicted Na once glucose normalises',
              color: 'var(--blue)'
            }),
            e(PrimaryButton, {
              label: 'See Results',
              color: 'var(--blue)',
              onClick: () => goToStep(4)
            })
          ),

          // If hypotonic â†’ Urine Osmolality
          step === 3 && !isShortPath && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What is the urine osmolality?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Is the kidney diluting appropriately?'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 100 mOsm/kg',
              sublabel: 'Kidneys diluting â€” problem is excess water',
              selected: urineOsmResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setUrineOsmResult('low');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 100 mOsm/kg',
              sublabel: 'ADH is active â€” kidneys can\'t dilute',
              selected: urineOsmResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setUrineOsmResult('high');
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--orange)'
            }),
            urineOsmResult === 'high' && e(WarningBanner, { onContinue: () => goToStep(4) }, 'Urinary biochemistry is confounded by diuretics, vasopressin, and DDAVP. Interpret with caution.')
          ),

          // SCREEN 4: Path-dependent
          // If hyper-osmolar â†’ Results
          step === 4 && isHyperOsmolar && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Interpretation'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Hyper-osmolar hyponatraemia'),
            e(InputSummaryStrip, { items: [
              { label: 'Na', ...getNaDisplay() },
              { label: 'Serum Osm', ...getSerumOsmDisplay() },
              getCorrectedNa() && { label: 'Corrected Na', value: `${getCorrectedNa()} mmol/L`, color: 'var(--blue)' }
            ].filter(Boolean) }),
            e(DiffListItem, {
              title: 'Hyper-osmolar Hyponatraemia',
              tags: ['Hyperglycaemia', 'Mannitol', 'IVIg'],
              defaultOpen: true,
              warning: 'Risk of cerebral oedema if BSL is corrected without commensurate rise in Na.'
            }, 'Dilutional effect â€” water drawn into intravascular space by osmotically active solutes.'),

            e(NaCorrectionCalculator, { naEntries, setNaEntries, targetRate, setTargetRate }),

            e(LearnMoreDivider),

            e(InfoPanel, { title: 'Osmotic Demyelination Syndrome (ODS)', color: 'var(--orange)' },
              e('p', { style: { marginBottom: '8px' } }, 'ODS (formerly central pontine myelinolysis) occurs when chronic hyponatraemia is corrected too rapidly. The brain adapts to low sodium by losing organic osmolytes. Rapid correction causes water to shift out of brain cells.'),
              e('p', { style: { marginBottom: '8px', fontWeight: 600 } }, 'Safe correction limits:'),
              e('ul', { style: { margin: '0', paddingLeft: '16px', fontSize: '12px' } },
                e('li', null, 'Standard: â‰¤10 mmol/L in 24h'),
                e('li', null, 'High risk (chronic, malnourished, hypokalaemic): â‰¤8 mmol/L in 24h'),
                e('li', null, 'Acute (<48h): Can correct faster if symptomatic')
              ),
              e('p', { style: { marginTop: '8px', color: 'var(--red)', fontWeight: 500 } }, 'If overcorrected: Consider DDAVP + D5W to re-lower sodium.')
            ),

            e('div', {
              style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center', lineHeight: '1.5' }
            }, 'If the clinical picture doesn\'t match the lab interpretation, re-examine the patient and repeat the tests.'),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', textAlign: 'center' } }, 'Reference ranges vary by laboratory. Verify against your local reference ranges.'),

            e(PrimaryButton, { label: 'New Analysis', color: 'var(--blue)', onClick: resetModule }),
            e('button', {
              onClick: onBack,
              style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
            }, 'â† All modules')
          ),

          // If hypotonic â†’ Urine Sodium
          step === 4 && !isShortPath && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What is the urine sodium?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Is the kidney conserving sodium?'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 30 mmol/L',
              selected: urineNaResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setUrineNaResult('low');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 30 mmol/L',
              selected: urineNaResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setUrineNaResult('high');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--orange)'
            })
          ),

          // SCREEN 5: Hypotonic Results (full differential)
          step === 5 && !isShortPath && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Interpretation'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Hypotonic hyponatraemia'),

            // Compact input summary
            e(InputSummaryStrip, { items: [
              { label: 'Na', ...getNaDisplay() },
              { label: 'Serum Osm', ...getSerumOsmDisplay() },
              { label: 'Urine Osm', ...getUrineOsmDisplay() },
              { label: 'Urine Na', ...getUrineNaDisplay() }
            ] }),

            e(WarningBanner, null, e('strong', null, 'Always exclude adrenal insufficiency.'), ' Check morning cortisol (or short synacthen test) in any unexplained hyponatraemia â€” it is one of the most dangerous missed diagnoses.'),

            e('div', {
              style: { fontSize: '12px', fontWeight: 600, color: 'var(--label3)', letterSpacing: '0.03em', marginBottom: '10px' }
            }, 'Consistent diagnoses'),

            // PATH A: Low Urine Osm + Low Urine Na
            urineOsmResult === 'low' && urineNaResult === 'low' && e(React.Fragment, null,
              e(DiagnosisHeader, {
                title: 'Excess Water Intake',
                description: 'Kidneys are diluting maximally but water intake exceeds their capacity to defend tonicity.'
              }),
              e(DiffCard, { title: 'Excess IV fluid', description: 'Iatrogenic. Review fluid orders.' }),
              e(DiffCard, { title: 'Primary polydipsia', description: 'Psychiatric or medication-related. Water intake often >10L/day.' }),
              e(DiffCard, { title: 'Beer potomania', description: 'Very low solute diet limits renal free water excretion capacity.' }),
              e(DiffCard, { title: 'Reset osmostat', description: 'Rare. Osmostat set lower but regulation intact. No treatment required.' })
            ),

            // PATH B: Low Urine Osm + High Urine Na
            urineOsmResult === 'low' && urineNaResult === 'high' && e(React.Fragment, null,
              e(DiagnosisHeader, {
                title: 'Renal Salt & Water Wasting',
                description: 'Kidneys are wasting both salt and water â€” unable to concentrate or conserve sodium.'
              }),
              e(DiffCard, { title: 'AKI (GFR <15)', description: 'Severely reduced GFR impairs all tubular function.' }),
              e(DiffCard, { title: 'Post-obstructive diuresis', description: 'After relief of urinary obstruction. Can be massive.' }),
              e(DiffCard, { title: 'Polyuric phase of ATN', description: 'Recovery phase of acute tubular necrosis.' })
            ),

            // PATH C: High Urine Osm + Low Urine Na
            urineOsmResult === 'high' && urineNaResult === 'low' && e(React.Fragment, null,
              e(DiagnosisHeader, {
                title: 'Hypovolaemia or Effective Hypovolaemia',
                description: 'Actual or effective volume depletion â†’ RAAS overactivation. The body is defending volume over tonicity â€” retaining water even at the expense of worsening hyponatraemia.',
                infoPanel: e(InfoPanel, { title: 'Volume over Tonicity', color: 'var(--blue)' },
                  e('p', null, 'The baroreceptor reflex is a stronger stimulus for ADH release than the osmoreceptor reflex. When intravascular volume is low (or perceived as low â€” heart failure, liver failure), the body will retain water even at the expense of worsening hyponatraemia. This is because volume depletion kills faster than low sodium.')
                )
              }),
              e(DiffCard, { title: 'True hypovolaemia', description: 'Bleeding, GI losses, third-spacing. Look for tachycardia, orthostatic hypotension, poor skin turgor.' }),
              e(DiffCard, { title: 'Heart failure', description: 'Effective hypovolaemia despite total body fluid overload. Poor cardiac output â†’ RAAS activation.' }),
              e(DiffCard, { title: 'Liver failure / cirrhosis', description: 'Splanchnic vasodilation â†’ effective hypovolaemia. Ascites present.' }),
              e(DiffCard, { title: 'Nephrotic syndrome', description: 'Hypoalbuminaemia â†’ reduced oncotic pressure â†’ effective hypovolaemia.' })
            ),

            // PATH D: High Urine Osm + High Urine Na
            urineOsmResult === 'high' && urineNaResult === 'high' && e(React.Fragment, null,
              e(DiagnosisHeader, {
                title: 'Water Retention with Sodium Wasting',
                description: 'ADH is active (water retention) AND kidneys are wasting sodium. This is the broadest differential â€” clinical context is critical.',
                warning: 'Must exclude adrenal insufficiency before diagnosing SIADH. Check morning cortisol Â± short synacthen test.'
              }),

              e(DiffCard, { title: 'SIADH', description: 'Most common cause of euvolaemic hyponatraemia. Diagnosis of exclusion: euvolaemic, no adrenal insufficiency, no hypothyroidism, no renal failure, no diuretics. Oliguric (concentrated urine). Tip: Low serum uric acid (<4 mg/dL) is a useful supportive clue.' }),

              e(DiffCard, { title: 'Adrenal insufficiency (Addison\'s, pan-hypopit)', description: 'Aldosterone deficiency â†’ Na wasting. Cortisol deficiency â†’ impaired free water excretion.' }),

              e(DiffCard, { title: 'Hypothyroidism', description: 'Mechanism unclear but well-recognised association. Check TFTs.' }),

              e(DiffCard, { title: 'Cerebral salt wasting', description: 'Polyuric (unlike SIADH which is oliguric). Related to â†‘BNP/ANP â†’ natriuresis â†’ hypovolaemia. Appropriate ADH secretion to compensate.' }),

              e(DiffCard, { title: 'Thiazide diuretic', description: 'Common and frequently overlooked. Thiazides impair diluting capacity in the distal tubule. Loop diuretics are LESS likely to cause hyponatraemia (they impair concentrating ability).' }),

              e(DiffCard, { title: 'AKI (GFR <15)', description: 'Impaired dilution and sodium handling.' }),

              e(DiffCard, { title: 'Post-obstructive diuresis / Polyuric ATN', description: 'Recovery phase â€” kidneys wasting everything.' }),

              e(InfoPanel, { title: 'Physiology of Key Diagnoses', color: 'var(--blue)' },
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Renal salt wasting:'), ' Failure of ATP-dependent Na+/K+ ATPase. Renal ADH responsiveness variable, thus urine osmolality variable.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Hypoaldosteronism:'), ' ENaC + uninhibited ADH release â†’ Na wasting + water retention. Giveaway is hyperkalaemia.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Hypothyroidism:'), ' Mechanism unclear.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Oedematous disorders:'), ' Hypotension/intravascular hypovolaemia â†’ ADH release + overactivation of RAAS â†’ Na and water retention. Baroreceptor reflex is a stronger stimulus for ADH release than the osmoreceptor reflex. IE: body will defend volume over tonicity.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                  e('strong', null, 'Cerebral salt wasting:'), ' Poorly understood. Related to â†‘BNP/ANP â†’ natriuresis â†’ polyuria and hypovolaemia. Appropriate secretion of ADH to compensate.'
                )
              ),

              e(InfoPanel, { title: 'SIADH vs Cerebral Salt Wasting â€” the Key Distinction', color: 'var(--blue)' },
                e('p', { style: { marginBottom: '12px' } }, 'Both cause hyponatraemia with high urine osm and high urine Na. The critical difference is volume status:'),
                e('div', { style: { display: 'flex', gap: '8px', marginBottom: '12px' } },
                  e('div', { style: { flex: 1, background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                    e('strong', { style: { color: 'var(--blue)' } }, 'SIADH:'),
                    e('div', { style: { fontSize: '12px', marginTop: '4px' } }, 'Euvolaemic or mildly hypervolaemic. Oliguric. Urine osm typically >300. Treatment: fluid restriction, tolvaptan.')
                  ),
                  e('div', { style: { flex: 1, background: 'rgba(255,159,10,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                    e('strong', { style: { color: 'var(--orange)' } }, 'CSW:'),
                    e('div', { style: { fontSize: '12px', marginTop: '4px' } }, 'Hypovolaemic. Polyuric. High urine output. Treatment: isotonic or hypertonic saline (fluid restriction will worsen hypovolaemia and Na).')
                  )
                ),
                e('p', { style: { fontWeight: 600, color: 'var(--red)' } }, 'Getting this wrong matters: fluid restricting a CSW patient worsens their hypovolaemia and hyponatraemia.')
              )
            ),

            e(NaCorrectionCalculator, { naEntries, setNaEntries, targetRate, setTargetRate }),

            e(LearnMoreDivider),

            e(InfoPanel, { title: 'Osmotic Demyelination Syndrome (ODS)', color: 'var(--orange)' },
              e('p', { style: { marginBottom: '8px' } }, 'ODS (formerly central pontine myelinolysis) occurs when chronic hyponatraemia is corrected too rapidly. The brain adapts to low sodium by losing organic osmolytes. Rapid correction causes water to shift out of brain cells.'),
              e('p', { style: { marginBottom: '8px', fontWeight: 600 } }, 'Safe correction limits:'),
              e('ul', { style: { margin: '0', paddingLeft: '16px', fontSize: '12px' } },
                e('li', null, 'Standard: â‰¤10 mmol/L in 24h'),
                e('li', null, 'High risk (chronic, malnourished, hypokalaemic): â‰¤8 mmol/L in 24h'),
                e('li', null, 'Acute (<48h): Can correct faster if symptomatic')
              ),
              e('p', { style: { marginTop: '8px', color: 'var(--red)', fontWeight: 500 } }, 'If overcorrected: Consider DDAVP + D5W to re-lower sodium.')
            ),

            e('div', {
              style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center', lineHeight: '1.5' }
            }, 'If the clinical picture doesn\'t match the lab interpretation, re-examine the patient and repeat the tests.'),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', textAlign: 'center' } }, 'Reference ranges vary by laboratory. Verify against your local reference ranges.'),

            // Bottom buttons (for all result paths)
            e('div', { style: { marginTop: '20px' } },
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--blue)', onClick: resetModule }),
              e('button', {
                onClick: onBack,
                style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
              }, 'â† All modules')
            )
          )
        )
      );
    }

    // ========== IRON STUDIES MODULE ==========

    function IronModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Inflammation
      const [hasInflammation, setHasInflammation] = useState(null);
      // Screen 1: Clinical context
      const [clinicalContext, setClinicalContext] = useState(null);
      // Screen 2: Ferritin
      const [ferritinResult, setFerritinResult] = useState(null);
      // Screen 3: TSAT input
      const [serumIron, setSerumIron] = useState('');
      const [transferrin, setTransferrin] = useState('');
      const [tsat, setTsat] = useState('');
      // Screen 4: TSAT interpretation
      const [tsatResult, setTsatResult] = useState(null);
      // Progressive disclosure for TSAT calculation
      const [showCalc, setShowCalc] = useState(false);

      const scrollToTop = () => {
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
      };

      const goToStep = (s) => { document.activeElement.blur(); setStep(s); scrollToTop(); };

      const resetModule = () => {
        setStep(0);
        setHasInflammation(null);
        setClinicalContext(null);
        setFerritinResult(null);
        setSerumIron('');
        setTransferrin('');
        setTsat('');
        setTsatResult(null);
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
      };

      const handleBack = () => {
        clearAutoAdvance();
        if (step === 0) onBack();
        else if (step === 5 && autoClassifyTsat()) goToStep(3); // Skip back over auto-classified screen 4
        else goToStep(step - 1);
      };

      // Calculate TSAT from iron and transferrin
      const calcTsat = () => {
        const iron = parseFloat(serumIron);
        const tf = parseFloat(transferrin);
        if (!isNaN(iron) && !isNaN(tf) && tf > 0) {
          return ((iron / (tf * 25)) * 100).toFixed(1);
        }
        return null;
      };

      const effectiveTsat = tsat || calcTsat();

      const autoClassifyTsat = () => {
        const val = parseFloat(effectiveTsat);
        if (isNaN(val)) return null;
        if (val < 16) return 'low';
        if (val > 45) return 'high';
        return 'normal';
      };

      // Dynamic screen count: skip TSAT classification if we can auto-classify
      const getTotalScreens = () => autoClassifyTsat() ? 5 : 6;

      const getInflammationDisplay = () => ({
        value: hasInflammation ? 'Present' : 'Absent',
        interpretation: hasInflammation ? 'Adjusted thresholds apply' : 'Standard thresholds',
        color: hasInflammation ? 'var(--orange)' : 'var(--green)'
      });

      const getFerritinDisplay = () => {
        const labels = { veryLow: 'Very Low (< 15)', lowNormal: 'Low-Normal (15â€“100)', normal: 'Normal (30â€“300)', high: 'High (> 300)', veryHigh: 'Very High (> 1000)' };
        const interps = { veryLow: 'Absolute iron deficiency', lowNormal: 'Possible deficiency', normal: 'Stores adequate', high: 'Elevated', veryHigh: 'Urgent evaluation' };
        const colors = { veryLow: 'var(--red)', lowNormal: 'var(--orange)', normal: 'var(--green)', high: 'var(--orange)', veryHigh: 'var(--red)' };
        return { value: labels[ferritinResult] || '', interpretation: interps[ferritinResult] || '', color: colors[ferritinResult] || 'var(--blue)' };
      };

      const getTsatDisplay = () => {
        if (tsatResult === 'low') return { value: effectiveTsat ? `${effectiveTsat}%` : '< 16%', interpretation: 'Low â€” iron deficient erythropoiesis', color: 'var(--red)' };
        if (tsatResult === 'high') return { value: effectiveTsat ? `${effectiveTsat}%` : '> 45%', interpretation: 'High â€” iron overload', color: 'var(--orange)' };
        return { value: effectiveTsat ? `${effectiveTsat}%` : '16â€“45%', interpretation: 'Normal', color: 'var(--green)' };
      };

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Iron Studies', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--red)' }),

          // SCREEN 0: Is the patient inflamed? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Is the patient inflamed?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'CRP elevated â€” this changes ferritin interpretation'),
            e(ChoiceButton, {
              label: 'Yes â€” CRP elevated',
              sublabel: 'Ferritin may be falsely normal',
              selected: hasInflammation === true,
              onClick: () => {
                clearAutoAdvance();
                setHasInflammation(true);
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'No â€” stable outpatient',
              selected: hasInflammation === false,
              onClick: () => {
                clearAutoAdvance();
                setHasInflammation(false);
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--green)'
            }),
            hasInflammation === true && e(WarningBanner, { onContinue: () => goToStep(1) }, e('strong', null, 'Ferritin is an acute phase reactant.'), ' A "normal" ferritin does NOT exclude iron deficiency when CRP is elevated.')
          ),

          // SCREEN 1: CKD or heart failure? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Does the patient have CKD or heart failure?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Different iron deficiency thresholds apply'),
            e(ChoiceButton, {
              label: 'CKD or haemodialysis',
              sublabel: 'Ferritin <200 with TSAT <20% suggests iron deficiency',
              selected: clinicalContext === 'ckd',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('ckd');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Heart failure',
              sublabel: 'Ferritin <100, or 100â€“300 with TSAT <20%',
              selected: clinicalContext === 'heartFailure',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('heartFailure');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'None of the above',
              sublabel: 'Standard thresholds',
              selected: clinicalContext === 'none',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('none');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--blue)'
            })
          ),

          // SCREEN 2: Ferritin (ChoiceButtons, auto-advance)
          step === 2 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What is the ferritin (Âµg/L)?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'The starting point â€” interpret with context'),
            e(ChoiceButton, {
              label: 'Very low  â€¹ 15 (F) / â€¹ 30 (M)',
              sublabel: 'Absolute iron deficiency â€” diagnostic',
              selected: ferritinResult === 'veryLow',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('veryLow');
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Low-normal  15â€“100',
              sublabel: 'Iron deficiency possible',
              selected: ferritinResult === 'lowNormal',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('lowNormal');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Normal  30â€“300',
              sublabel: 'Stores adequate (may be masked by inflammation)',
              selected: ferritinResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('normal');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 300',
              sublabel: 'Iron overload OR acute phase response',
              selected: ferritinResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('high');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Very high  â€º 1000',
              sublabel: 'Iron overload, malignancy, liver necrosis, HLH',
              selected: ferritinResult === 'veryHigh',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('veryHigh');
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--red)'
            }),
            ferritinResult === 'veryLow' && e(WarningBanner, { onContinue: () => goToStep(3) }, e('strong', null, 'Diagnostic.'), ' Ferritin this low confirms iron deficiency regardless of other values.'),
            ferritinResult === 'veryHigh' && e(WarningBanner, { onContinue: () => goToStep(3) }, e('strong', null, 'Urgent evaluation.'), ' Consider HLH, Still\'s disease, hepatic necrosis, massive iron overload.')
          ),

          // SCREEN 3: Transferrin saturation (ValueInput with progressive disclosure)
          step === 3 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What is the TSAT?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Transferrin saturation â€” check the lab report'),
            e(ValueInput, { label: 'TSAT', unit: '%', value: tsat, onChange: setTsat, placeholder: '16â€“45', hint: 'Normal: 16â€“45%' }),

            // Progressive disclosure: calculate from components
            !tsat && e('div', { style: { marginTop: '8px' } },
              e('button', {
                onClick: () => setShowCalc(!showCalc),
                style: {
                  width: '100%',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '6px',
                  padding: '10px',
                  background: 'none',
                  border: '1px dashed var(--sep)',
                  borderRadius: '10px',
                  cursor: 'pointer',
                  fontFamily: 'var(--font)',
                  fontSize: '13px',
                  color: 'var(--label3)'
                }
              }, showCalc ? 'Hide calculator' : 'Don\'t have TSAT? Calculate from iron + transferrin'),

              showCalc && e('div', {
                style: { background: 'rgba(142,142,147,0.06)', borderRadius: '14px', padding: '16px', marginTop: '8px' }
              },
                e(ValueInput, { label: 'Serum Iron', unit: 'Âµmol/L', value: serumIron, onChange: setSerumIron, placeholder: '10â€“30' }),
                e(ValueInput, { label: 'Transferrin', unit: 'g/L', value: transferrin, onChange: setTransferrin, placeholder: '1.7â€“3.4' }),
                e('div', { style: { fontSize: '11px', color: 'var(--label3)', marginTop: '4px' } }, 'If your lab reports TIBC in Âµmol/L instead: TSAT = (iron Ã· TIBC) Ã— 100'),
                calcTsat() && e('div', {
                  style: { fontSize: '14px', color: 'var(--green)', fontWeight: 700, marginTop: '10px', textAlign: 'center' }
                }, `Calculated TSAT: ${calcTsat()}%`)
              )
            ),

            e(PrimaryButton, {
              label: 'Next',
              disabled: !effectiveTsat,
              color: 'var(--red)',
              onClick: () => {
                const autoResult = autoClassifyTsat();
                if (autoResult) {
                  setTsatResult(autoResult);
                  goToStep(5); // Skip classification, go to results
                } else {
                  goToStep(4); // No numeric value, need manual classification
                }
              }
            })
          ),

          // SCREEN 4: TSAT classification (ChoiceButtons, auto-advance)
          step === 4 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Classify the TSAT'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, effectiveTsat ? `Your TSAT: ${effectiveTsat}%` : 'Classify the TSAT result'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 16%',
              selected: tsatResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setTsatResult('low');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Normal  16â€“45%',
              selected: tsatResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setTsatResult('normal');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 45%',
              selected: tsatResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setTsatResult('high');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--orange)'
            })
          ),

          // SCREEN 5: Results
          step === 5 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } },
                (() => {
                  const ferr = { veryLow: 'Ferritin â†“â†“', lowNormal: 'Ferritin low-normal', normal: 'Ferritin normal', high: 'Ferritin â†‘', veryHigh: 'Ferritin â†‘â†‘' }[ferritinResult] || '';
                  const ts = { low: ' Â· TSAT â†“', normal: ' Â· TSAT normal', high: ' Â· TSAT â†‘' }[tsatResult] || '';
                  return ferr + ts;
                })()
              )
            ),
            e(InputSummaryStrip, { items: [
              { label: 'Inflammation', ...getInflammationDisplay() },
              { label: 'Ferritin', ...getFerritinDisplay() },
              { label: 'TSAT', ...getTsatDisplay() }
            ] }),

            e('div', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label3)', letterSpacing: '0.03em', marginBottom: '10px' } }, 'Consistent diagnoses'),

            // Pattern: Ferritin low/low-normal + TSAT low
            (ferritinResult === 'veryLow' || ferritinResult === 'lowNormal') && tsatResult === 'low' && e(DiffListItem, {
              title: 'Iron Deficiency Anaemia',
              tags: ['Classic pattern', 'Investigate cause'],
              warning: e(React.Fragment, null, e('strong', null, 'Iron deficiency demands investigation.'), ' All males and post-menopausal females require GI endoscopy to exclude malignancy.')
            }, 'Low ferritin + low TSAT = straightforward iron deficiency. Transferrin/TIBC will typically be elevated (body upregulating iron transport).'),

            // Pattern: Ferritin normal + TSAT low (with inflammation)
            ferritinResult === 'normal' && tsatResult === 'low' && hasInflammation && e(DiffListItem, {
              title: 'Iron Deficiency Masked by Inflammation',
              tags: ['Ferritin falsely normal', 'TSAT is the giveaway'],
              infoPanel: e(InfoPanel, { title: 'The Hardest Call in Iron Studies', color: 'var(--red)' },
                e('p', { style: { marginBottom: '10px' } }, 'The patient has both iron deficiency AND active inflammation (e.g. RA, IBD, CKD, malignancy). Ferritin is elevated by inflammation â†’ looks \'normal\' even though stores are depleted. Transferrin is suppressed â†’ TIBC doesn\'t rise as expected. TSAT becomes the most reliable discriminator: if <20% with inflammation, iron deficiency is very likely even with ferritin 100â€“300.'),
                e('p', { style: { marginBottom: '10px' } }, e('strong', null, 'Soluble transferrin receptor (sTfR):'), ' Not affected by inflammation. â†‘ sTfR suggests true iron deficiency. sTfR/log ferritin ratio >2 strongly supports iron deficiency. Not universally available but very useful.'),
                e('p', null, e('strong', null, 'Pragmatic approach:'), ' If in doubt and the patient is symptomatic, a trial of IV iron is both diagnostic and therapeutic. If Hb rises, they were iron deficient.')
              )
            }, 'This is the most common diagnostic trap in hospital medicine. Ferritin appears \'normal\' because inflammation has raised it, but low TSAT reveals inadequate iron delivery to the marrow.'),

            // Pattern: Ferritin normal + TSAT normal (with inflammation)
            ferritinResult === 'normal' && tsatResult === 'normal' && hasInflammation && e(DiffListItem, {
              title: 'Anaemia of Chronic Disease',
              tags: ['Inflammatory iron sequestration', 'Iron trapped in macrophages']
            }, 'Inflammatory cytokines + hepcidin â†’ iron sequestered in macrophages, unavailable for erythropoiesis. Iron stores are adequate (normal ferritin) and iron supply is maintained (normal TSAT). Low serum iron with low transferrin is typical.'),

            // Pattern: Ferritin high + TSAT high
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'high' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'Iron Overload',
                tags: ['Haemochromatosis', 'Transfusional', 'Check HFE genotype'],
                defaultOpen: true
              }, 'Elevated ferritin with TSAT >45% (especially >60%) strongly suggests true iron overload. Check HFE gene (C282Y homozygosity = hereditary haemochromatosis). If transfusion-dependent, consider chelation therapy.'),
              e(DiffListItem, {
                title: 'Liver Disease',
                tags: ['Hepatocyte damage', 'Ferritin leak']
              }, 'Damaged hepatocytes leak ferritin into serum. TSAT may be normal or elevated. Check LFTs. Liver disease + iron overload can coexist (e.g. haemochromatosis with cirrhosis).')
            ),

            // Pattern: Ferritin high + TSAT normal
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'normal' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'Acute Phase Response',
                tags: ['Inflammation', 'Liver disease', 'Recheck when stable']
              }, 'Elevated ferritin with normal TSAT most likely reflects an acute phase response rather than true iron overload. Recheck when inflammation has resolved.'),
              e(DiffListItem, {
                title: 'Liver Disease',
                tags: ['Ferritin leak from hepatocytes']
              })
            ),

            // Pattern: Ferritin high + TSAT low
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'low' && e(DiffListItem, {
              title: 'Anaemia of Chronic Disease (severe)',
              tags: ['Hepcidin-mediated', 'Iron trapped']
            }, 'High ferritin (inflammation) + low TSAT (no iron reaching marrow). Iron is present in stores but trapped by hepcidin-mediated sequestration.'),

            // Ferritin very high
            ferritinResult === 'veryHigh' && e(DiffListItem, {
              title: 'Urgent Evaluation Required',
              tags: ['HLH', 'Malignancy', 'Hepatic necrosis', 'Still\'s disease'],
              defaultOpen: true
            }, 'Ferritin >1000 Âµg/L narrows the differential significantly. Consider haemophagocytic lymphohistiocytosis (HLH â€” check triglycerides, fibrinogen, LDH, soluble IL-2R), adult-onset Still\'s disease (quotidian fevers, rash, arthritis), hepatic necrosis, or massive iron overload.'),

            // Investigation info for iron deficiency
            (tsatResult === 'low' || ferritinResult === 'veryLow' || ferritinResult === 'lowNormal') && e(InfoPanel, { title: 'When to Scope', color: 'var(--red)' },
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Mandatory GI investigation:'), ' All males, all post-menopausal females with unexplained iron deficiency.'),
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Pre-menopausal females:'), ' Investigate if GI symptoms, family history of GI cancer, or iron deficiency not explained by menstrual losses.'),
              e('p', null, e('strong', null, 'Coeliac serology'), ' should be checked in all cases of unexplained iron deficiency.')
            ),

            e('div', {
              style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center', lineHeight: '1.5' }
            }, 'If the clinical picture doesn\'t match the lab interpretation, re-examine the patient and repeat the tests. Reference ranges vary by laboratory.'),
            e('div', { style: { marginTop: '16px' } },
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--red)', onClick: resetModule }),
              e('button', {
                onClick: onBack,
                style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
              }, 'â† All modules')
            )
          )
        )
      );
    }

    // ========== AKI / URINE BIOCHEM MODULE ==========

    function AKIModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Diuretics?
      const [onDiuretics, setOnDiuretics] = useState(null);
      // Screen 1: FENa inputs
      const [urineNa, setUrineNa] = useState('');
      const [urineCr, setUrineCr] = useState('');
      const [serumNa, setSerumNa] = useState('');
      const [serumCr, setSerumCr] = useState('');
      const [urineUrea, setUrineUrea] = useState('');
      const [serumUrea, setSerumUrea] = useState('');
      const [urineOsm, setUrineOsm] = useState('');
      // Screen 2: Calculated + interpretation
      const [fenaResult, setFenaResult] = useState(null);

      const getTotalScreens = () => 5;

      const scrollToTop = () => { if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' }); };
      const goToStep = (s) => { document.activeElement.blur(); setStep(s); scrollToTop(); };

      const resetModule = () => {
        setStep(0);
        setOnDiuretics(null);
        setUrineNa('');
        setUrineCr('');
        setSerumNa('');
        setSerumCr('');
        setUrineUrea('');
        setSerumUrea('');
        setUrineOsm('');
        setFenaResult(null);
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
      };

      const handleBack = () => {
        clearAutoAdvance();
        if (step === 0) onBack();
        else goToStep(step - 1);
      };

      // FENa calculation: (UNa Ã— SCr) / (SNa Ã— UCr) Ã— 100
      // Note: SCr needs to be converted from Âµmol/L to mmol/L (Ã·1000)
      const calcFENa = () => {
        const una = parseFloat(urineNa);
        const ucr = parseFloat(urineCr);
        const sna = parseFloat(serumNa);
        const scr = parseFloat(serumCr) / 1000; // Convert to mmol/L
        if (!isNaN(una) && !isNaN(ucr) && !isNaN(sna) && !isNaN(scr) && ucr > 0 && sna > 0) {
          return ((una * scr) / (sna * ucr) * 100).toFixed(2);
        }
        return null;
      };

      // FEUrea calculation
      const calcFEUrea = () => {
        const uurea = parseFloat(urineUrea);
        const surea = parseFloat(serumUrea);
        const ucr = parseFloat(urineCr);
        const scr = parseFloat(serumCr) / 1000;
        if (!isNaN(uurea) && !isNaN(surea) && !isNaN(ucr) && !isNaN(scr) && ucr > 0 && surea > 0) {
          return ((uurea * scr) / (surea * ucr) * 100).toFixed(1);
        }
        return null;
      };

      const getFENaDisplay = () => {
        const fena = calcFENa();
        if (!fena) return null;
        const v = parseFloat(fena);
        if (v < 1) return { value: `${fena}%`, interpretation: 'Suggests pre-renal', color: 'var(--green)' };
        if (v <= 2) return { value: `${fena}%`, interpretation: 'Indeterminate', color: 'var(--orange)' };
        return { value: `${fena}%`, interpretation: 'Suggests intrinsic (ATN)', color: 'var(--red)' };
      };

      const getFEUreaDisplay = () => {
        const feurea = calcFEUrea();
        if (!feurea) return null;
        const v = parseFloat(feurea);
        if (v < 35) return { value: `${feurea}%`, interpretation: 'Suggests pre-renal', color: 'var(--green)' };
        if (v <= 50) return { value: `${feurea}%`, interpretation: 'Indeterminate', color: 'var(--orange)' };
        return { value: `${feurea}%`, interpretation: 'Suggests intrinsic (ATN)', color: 'var(--red)' };
      };

      const getUrineOsmDisplay = () => {
        if (!urineOsm) return null;
        const v = parseFloat(urineOsm);
        if (v > 500) return { value: `${urineOsm} mOsm/kg`, interpretation: 'Concentrated â€” consistent with pre-renal', color: 'var(--green)' };
        if (v >= 350) return { value: `${urineOsm} mOsm/kg`, interpretation: 'Intermediate', color: 'var(--orange)' };
        return { value: `${urineOsm} mOsm/kg`, interpretation: 'Dilute â€” consistent with ATN', color: 'var(--red)' };
      };

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Urine Biochem', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--cyan)' }),

          // SCREEN 0: Is the patient on diuretics? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Is the patient on diuretics?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'This changes which index is reliable'),
            e(ChoiceButton, {
              label: 'Yes â€” loop or thiazide',
              sublabel: 'Will use FEUrea instead',
              selected: onDiuretics === true,
              onClick: () => {
                clearAutoAdvance();
                setOnDiuretics(true);
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'No diuretics',
              selected: onDiuretics === false,
              onClick: () => {
                clearAutoAdvance();
                setOnDiuretics(false);
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--green)'
            }),
            onDiuretics === true && e(WarningBanner, { onContinue: () => goToStep(1) }, e('strong', null, 'FENa unreliable.'), ' Diuretics force sodium excretion, making FENa falsely elevated. Use FEUrea instead.')
          ),

          // SCREEN 1: Urine biochemistry
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Enter the urine biochemistry'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'From the spot urine sample'),
            e(ValueInput, { label: 'Urine Sodium', unit: 'mmol/L', value: urineNa, onChange: setUrineNa, placeholder: 'Enter' }),
            e(ValueInput, { label: 'Urine Creatinine', unit: 'mmol/L', value: urineCr, onChange: setUrineCr, placeholder: 'Enter', hint: 'Most labs report in mmol/L' }),
            onDiuretics && e(ValueInput, { label: 'Urine Urea', unit: 'mmol/L', value: urineUrea, onChange: setUrineUrea, placeholder: 'Enter' }),
            e(PrimaryButton, {
              label: 'Next',
              disabled: !urineNa || !urineCr || (onDiuretics && !urineUrea),
              color: 'var(--cyan)',
              onClick: () => goToStep(2)
            })
          ),

          // SCREEN 2: Serum biochemistry
          step === 2 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Enter the serum biochemistry'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'From the blood panel'),
            e(ValueInput, { label: 'Serum Sodium', unit: 'mmol/L', value: serumNa, onChange: setSerumNa, placeholder: '135â€“145' }),
            e('div', { style: { fontSize: '11px', color: 'var(--orange)', fontWeight: 600, marginBottom: '4px', marginTop: '-8px' } }, 'âš  Note: Serum creatinine is in Âµmol/L â€” not mmol/L'),
            e(ValueInput, { label: 'Serum Creatinine', unit: 'Âµmol/L', value: serumCr, onChange: setSerumCr, placeholder: '50â€“120' }),
            onDiuretics && e(ValueInput, { label: 'Serum Urea', unit: 'mmol/L', value: serumUrea, onChange: setSerumUrea, placeholder: 'Enter' }),
            e(ValueInput, { label: 'Urine Osmolality (optional)', unit: 'mOsm/kg', value: urineOsm, onChange: setUrineOsm, placeholder: 'Optional' }),
            e(PrimaryButton, {
              label: 'Next',
              disabled: !serumNa || !serumCr || (onDiuretics && !serumUrea),
              color: 'var(--cyan)',
              onClick: () => goToStep(3)
            })
          ),

          // SCREEN 3: Calculated results + interpretation (ChoiceButtons, auto-advance)
          step === 3 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Classify the AKI'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Use the calculated indices to decide'),
            calcFENa() && !onDiuretics && e(BranchCard, { label: 'FENa', value: `${calcFENa()}%`, interpretation: 'Pre-renal <1% Â· Indeterminate 1â€“2% Â· Intrinsic >2%', color: 'var(--label)' }),
            calcFENa() && onDiuretics && e('div', { style: { opacity: 0.5, marginBottom: '8px' } },
              e(BranchCard, { label: 'FENa', value: `${calcFENa()}%`, interpretation: 'âš ï¸ Unreliable on diuretics', color: 'var(--label3)' })
            ),
            onDiuretics && calcFEUrea() && e(BranchCard, { label: 'FEUrea', value: `${calcFEUrea()}%`, interpretation: 'Pre-renal <35% Â· Indeterminate 35â€“50% Â· Intrinsic >50%', color: 'var(--label)' }),
            urineOsm && e(BranchCard, { label: 'Urine Osmolality', value: `${urineOsm} mOsm/kg`, interpretation: 'Pre-renal >500 Â· Intermediate 350â€“500 Â· ATN <350', color: 'var(--label)' }),
            e(ChoiceButton, {
              label: 'Pre-renal',
              sublabel: onDiuretics ? 'FEUrea <35%' : 'FENa <1%',
              selected: fenaResult === 'preRenal',
              onClick: () => {
                clearAutoAdvance();
                setFenaResult('preRenal');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'Intrinsic (ATN)',
              sublabel: onDiuretics ? 'FEUrea >50%' : 'FENa >2%',
              selected: fenaResult === 'intrinsic',
              onClick: () => {
                clearAutoAdvance();
                setFenaResult('intrinsic');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Indeterminate',
              sublabel: 'Borderline values â€” may be transitioning',
              selected: fenaResult === 'indeterminate',
              onClick: () => {
                clearAutoAdvance();
                setFenaResult('indeterminate');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--orange)'
            })
          ),

          // SCREEN 4: Results
          step === 4 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } },
                fenaResult === 'preRenal' ? 'Pre-renal pattern' : fenaResult === 'intrinsic' ? 'Intrinsic (ATN) pattern' : 'Indeterminate'
              )
            ),
            e(InputSummaryStrip, { items: [
              !onDiuretics && calcFENa() && { label: 'FENa', ...getFENaDisplay() },
              onDiuretics && calcFEUrea() && { label: 'FEUrea', ...getFEUreaDisplay() },
              urineOsm && { label: 'Urine Osm', ...getUrineOsmDisplay() }
            ].filter(Boolean) }),

            e(WarningBanner, null, e('strong', null, 'Always exclude obstruction.'), ' Perform renal tract ultrasound before attributing AKI to pre-renal or intrinsic causes. Post-renal obstruction is the most treatable cause of AKI.'),

            e('div', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label3)', letterSpacing: '0.03em', marginBottom: '10px' } }, 'Consistent diagnoses'),

            fenaResult === 'preRenal' && e(DiffListItem, {
              title: 'Pre-renal AKI',
              tags: ['Underperfusion', 'Structurally intact', 'Reversible'],
              warning: e(React.Fragment, null, e('strong', null, 'FENa <1% does NOT always mean pre-renal.'), ' Several intrinsic diseases preserve tubular sodium handling: contrast nephropathy, rhabdomyolysis, pigment nephropathy, early sepsis, acute glomerulonephritis, early interstitial nephritis, acute urinary obstruction, calcineurin inhibitor toxicity (cyclosporin, tacrolimus).')
            }, 'Kidneys responding appropriately to hypovolaemia or poor perfusion. Avid sodium and water retention.'),

            fenaResult === 'intrinsic' && e(DiffListItem, {
              title: 'Intrinsic AKI (ATN)',
              tags: ['Tubular damage', 'Muddy brown casts', 'Supportive care'],
              warning: e(React.Fragment, null, e('strong', null, 'FENa >1% does NOT always mean intrinsic.'), ' Can be caused by: diuretic use, CKD baseline, adrenal insufficiency, cerebral salt wasting, IV saline administration, glycosuria.')
            }, 'Tubular damage â€” cannot reabsorb sodium efficiently or concentrate urine.'),

            fenaResult === 'indeterminate' && e(DiffListItem, {
              title: 'Evolving AKI',
              tags: ['May be transitioning', 'Serial measurements', 'Trend']
            }, 'Borderline values â€” may be evolving from pre-renal to intrinsic. Serial measurement over 6â€“12 hours is more useful than a single value.'),

            e(InfoPanel, { title: 'Urine Microscopy â€” the Forgotten Tool', color: 'var(--cyan)' },
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Muddy brown granular casts:'), ' ATN â€” pathognomonic'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Red cell casts:'), ' Glomerulonephritis'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'White cell casts:'), ' Interstitial nephritis or pyelonephritis'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Eosinophiluria:'), ' Allergic interstitial nephritis (low sensitivity)'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Bland sediment:'), ' Pre-renal, obstruction, or HRS'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px' } }, e('strong', null, 'Crystals:'), ' Crystal nephropathy (tumour lysis, ethylene glycol)')
            ),

            e('div', {
              style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center', lineHeight: '1.5' }
            }, 'If the clinical picture doesn\'t match the lab interpretation, re-examine the patient and repeat the tests. Reference ranges vary by laboratory.'),
            e('div', { style: { marginTop: '16px' } },
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--cyan)', onClick: resetModule }),
              e('button', {
                onClick: onBack,
                style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
              }, 'â† All modules')
            )
          )
        )
      );
    }

    // ========== COAGULATION MODULE ==========

    function CoagModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Clinical context
      const [clinicalContext, setClinicalContext] = useState(null);
      // Screen 1: Pattern
      const [pattern, setPattern] = useState(null);
      // Optional value entry on pattern screen
      const [ptEntry, setPtEntry] = useState('');
      const [apttEntry, setApttEntry] = useState('');
      // Optional lab inputs (collapsed on results)
      const [showLabs, setShowLabs] = useState(false);
      const [pt, setPt] = useState('');
      const [inr, setInr] = useState('');
      const [aptt, setAptt] = useState('');
      const [fibrinogen, setFibrinogen] = useState('');
      const [dDimer, setDDimer] = useState('');
      const [platelets, setPlatelets] = useState('');

      const getTotalScreens = () => 3;

      const scrollToTop = () => { if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' }); };
      const goToStep = (s) => { document.activeElement.blur(); setStep(s); scrollToTop(); };

      const resetModule = () => {
        setStep(0);
        setClinicalContext(null);
        setPattern(null);
        setPtEntry('');
        setApttEntry('');
        setShowLabs(false);
        setPt('');
        setInr('');
        setAptt('');
        setFibrinogen('');
        setDDimer('');
        setPlatelets('');
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'auto' });
      };

      const handleBack = () => {
        clearAutoAdvance();
        if (step === 0) onBack();
        else goToStep(step - 1);
      };

      const isPtProlonged = pt && parseFloat(pt) > 13.5;
      const isApttProlonged = aptt && parseFloat(aptt) > 38;

      // ISTH DIC Score calculation
      const calcDICScore = () => {
        if (!platelets || !dDimer || !pt || !fibrinogen) return null;
        let score = 0;
        const plt = parseFloat(platelets);
        const dd = parseFloat(dDimer);
        const ptVal = parseFloat(pt);
        const fib = parseFloat(fibrinogen);
        if (plt >= 100) score += 0; else if (plt >= 50) score += 1; else score += 2;
        if (dd <= 0.5) score += 0; else if (dd <= 5) score += 1; else score += 2;
        const ptProlongation = ptVal - 12;
        if (ptProlongation < 3) score += 0; else if (ptProlongation <= 6) score += 1; else score += 2;
        if (fib >= 1.0) score += 0; else score += 2;
        return score;
      };

      const getLabDisplay = (name, value, unit, normal) => {
        if (!value) return null;
        const v = parseFloat(value);
        let interp = 'Normal';
        let color = 'var(--green)';
        if (name === 'PT' && v > 13.5) { interp = 'Prolonged'; color = 'var(--orange)'; }
        if (name === 'APTT' && v > 38) { interp = 'Prolonged'; color = 'var(--orange)'; }
        if (name === 'Fibrinogen' && v < 2.0) { interp = 'Low'; color = 'var(--red)'; }
        if (name === 'Platelets' && v < 150) { interp = 'Low'; color = 'var(--red)'; }
        if (name === 'D-dimer' && v > 0.5) { interp = 'Elevated'; color = 'var(--orange)'; }
        return { value: `${value} ${unit}`, interpretation: interp, color };
      };

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Coagulation', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--green)' }),

          // SCREEN 0: Is the patient bleeding? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Is the patient bleeding?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'This determines urgency'),
            e(ChoiceButton, {
              label: 'Active bleeding',
              sublabel: 'Urgent â€” need to identify and correct the problem',
              selected: clinicalContext === 'bleeding',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('bleeding');
                // No auto-advance â€” warning gates progression
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Incidental finding',
              sublabel: 'Abnormal coag on routine tests',
              selected: clinicalContext === 'incidental',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('incidental');
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--blue)'
            }),
            e(ChoiceButton, {
              label: 'Pre-operative screening',
              sublabel: 'Abnormal coag before planned surgery',
              selected: clinicalContext === 'preOp',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('preOp');
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--orange)'
            }),
            clinicalContext === 'bleeding' && e(WarningBanner, { onContinue: () => goToStep(1) }, e('strong', null, 'Active bleeding.'), ' Prioritise haemostasis â€” identify and treat the cause.')
          ),

          // SCREEN 1: What pattern do you see? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Which values are prolonged?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '16px' } }, 'Check the PT and APTT on the coag panel'),

            // Optional value entry
            e('div', {
              style: { display: 'flex', gap: '10px', marginBottom: '16px' }
            },
              e('div', { style: { flex: 1 } },
                e(ValueInput, { label: 'PT', unit: 'sec', value: ptEntry, onChange: (v) => {
                  setPtEntry(v);
                  if (!pt) setPt(v); // Pre-fill DIC calculator
                }, placeholder: '11â€“13.5', hint: 'Optional' })
              ),
              e('div', { style: { flex: 1 } },
                e(ValueInput, { label: 'APTT', unit: 'sec', value: apttEntry, onChange: setApttEntry, placeholder: '25â€“38', hint: 'Optional' })
              )
            ),

            // Auto-suggest if values entered
            ptEntry && apttEntry && e('div', {
              style: { fontSize: '12px', color: 'var(--blue)', fontWeight: 600, marginBottom: '12px', padding: '8px 12px', background: 'rgba(10,132,255,0.06)', borderRadius: '10px' }
            },
              (() => {
                const ptVal = parseFloat(ptEntry);
                const apttVal = parseFloat(apttEntry);
                const ptHigh = ptVal > 13.5;
                const apttHigh = apttVal > 38;
                if (ptHigh && !apttHigh) return 'â†’ Isolated prolonged PT';
                if (!ptHigh && apttHigh) return 'â†’ Isolated prolonged APTT';
                if (ptHigh && apttHigh) return 'â†’ Both prolonged';
                return 'â†’ Both normal';
              })()
            ),

            e(ChoiceButton, {
              label: 'Isolated prolonged PT',
              sublabel: 'Extrinsic pathway',
              selected: pattern === 'A',
              onClick: () => {
                clearAutoAdvance();
                setPattern('A');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'Isolated prolonged APTT',
              sublabel: 'Intrinsic pathway',
              selected: pattern === 'B',
              onClick: () => {
                clearAutoAdvance();
                setPattern('B');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'Both PT and APTT prolonged',
              sublabel: 'Common pathway or global coagulopathy',
              selected: pattern === 'C',
              onClick: () => {
                clearAutoAdvance();
                setPattern('C');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Both normal',
              sublabel: 'Platelet or vascular cause if bleeding',
              selected: pattern === 'D',
              onClick: () => {
                clearAutoAdvance();
                setPattern('D');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--blue)'
            })
          ),

          // SCREEN 2: Results
          step === 2 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } },
                pattern === 'A' ? 'Isolated prolonged PT' : pattern === 'B' ? 'Isolated prolonged APTT' : pattern === 'C' ? 'Both PT and APTT prolonged' : 'Both normal'
              )
            ),
            e(InputSummaryStrip, { items: [
              { label: 'Context', value: clinicalContext === 'bleeding' ? 'Active bleeding' : clinicalContext === 'preOp' ? 'Pre-op' : 'Incidental', color: clinicalContext === 'bleeding' ? 'var(--red)' : 'var(--blue)' },
              { label: 'Pattern', value: pattern === 'A' ? 'PT â†‘' : pattern === 'B' ? 'APTT â†‘' : pattern === 'C' ? 'Both â†‘' : 'Both normal', color: pattern === 'C' ? 'var(--orange)' : 'var(--green)' }
            ] }),
            e('div', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label3)', letterSpacing: '0.03em', marginBottom: '10px' } }, 'Consistent diagnoses'),

            // Pattern A: Isolated prolonged PT
            pattern === 'A' && e(React.Fragment, null,
              e(DiffListItem, { title: 'Warfarin', tags: ['Most common', 'Check INR target'] },
                'Check INR â€” is it in therapeutic range for the indication? Supratherapeutic INR: hold warfarin, give vitamin K (oral if INR 5â€“9 and not bleeding, IV if active bleeding). Repeat INR in 6â€“12 hours.'),
              e(DiffListItem, { title: 'Early Liver Disease', tags: ['Factor VII shortest half-life (~6h)', 'First to fall'] },
                'Factor VII has the shortest half-life (~6 hours) â€” PT rises before APTT in hepatic synthetic failure. Check albumin, bilirubin, and other LFTs.'),
              e(DiffListItem, { title: 'Vitamin K Deficiency', tags: ['Malabsorption', 'Malnutrition', 'Antibiotics', 'Obstructive jaundice'] },
                'Fat-soluble vitamin. Common in malabsorption (coeliac, IBD, short gut), malnutrition, prolonged antibiotics (gut flora produce vitamin K), and obstructive jaundice (bile salts needed for absorption). Responds to IV/oral vitamin K within 12â€“24 hours.'),
              e(DiffListItem, { title: 'DOAC (Rivaroxaban/Apixaban)', tags: ['Anti-Xa agents', 'Standard coag unreliable', 'Check anti-Xa level'] },
                'Anti-Xa DOACs variably prolong PT (rivaroxaban more than apixaban) but standard coag is unreliable for measuring drug effect. Use calibrated anti-Xa level. If urgent reversal needed: andexanet alfa (specific) or prothrombin complex concentrate (PCC).'),
              e(DiffListItem, { title: 'Factor VII Deficiency', tags: ['Congenital', 'Only extrinsic factor'] },
                'The only factor unique to the extrinsic pathway. Congenital deficiency is rare but can present with mucocutaneous bleeding. Recombinant Factor VIIa (NovoSeven) available for severe bleeding.')
            ),

            // Pattern B: Isolated prolonged APTT
            pattern === 'B' && e(React.Fragment, null,
              e(DiffListItem, { title: 'Heparin (UFH)', tags: ['Most common in hospital', 'Check anti-Xa or APTT ratio'] },
                'Most common cause of isolated prolonged APTT in hospital. Check whether the patient is on a heparin infusion, prophylactic heparin, or has a heparin-coated line. Protamine reverses UFH.'),
              e(DiffListItem, { title: 'Haemophilia A (Factor VIII â†“)', tags: ['X-linked', 'Severity correlates with level'] },
                'X-linked recessive. Severity correlates with factor level: severe <1% (spontaneous bleeds), moderate 1â€“5%, mild 5â€“40%. Treat with Factor VIII concentrate or desmopressin (mild). Target levels depend on bleed severity and location.'),
              e(DiffListItem, { title: 'Haemophilia B (Factor IX â†“)', tags: ['X-linked', 'Clinically identical to A'] },
                'Clinically identical to Haemophilia A â€” can only distinguish by factor levels. Treat with Factor IX concentrate (not desmopressin, which has no effect on Factor IX).'),
              e(DiffListItem, { title: 'von Willebrand Disease', tags: ['Most common inherited bleeding disorder', 'vWF stabilises VIII'] },
                'Most common inherited bleeding disorder (~1% prevalence). vWF stabilises Factor VIII in circulation â€” low vWF causes secondary Factor VIII deficiency. Check vWF antigen, vWF activity (ristocetin cofactor), and Factor VIII level. Type 1 (most common) responds to desmopressin.'),
              e(DiffListItem, { title: 'Factor XI Deficiency', tags: ['Ashkenazi Jewish', 'Variable bleeding risk'] },
                'Common in Ashkenazi Jewish populations (up to 8% carrier rate). Bleeding risk does not correlate well with factor level â€” some patients with very low levels bleed minimally. Unpredictable post-surgical bleeding is the main concern.'),
              e(DiffListItem, {
                title: 'Factor XII Deficiency',
                tags: ['NO bleeding risk', 'Do NOT delay surgery'],
                warning: 'Factor XII deficiency and lupus anticoagulant prolong APTT but do NOT cause bleeding. Do NOT delay surgery for either of these.'
              }, 'Prolongs APTT but causes NO bleeding risk whatsoever. Safe for surgery.'),
              e(DiffListItem, {
                title: 'Lupus Anticoagulant',
                tags: ['Antiphospholipid', 'PROTHROMBOTIC', 'Paradoxical']
              }, 'Prolongs APTT in vitro but is PROTHROMBOTIC in vivo. Paradoxical â€” the lab looks like a bleeding risk but the clinical risk is clotting.'),
              e(DiffListItem, { title: 'Dabigatran', tags: ['Direct thrombin inhibitor', 'Check thrombin time'] },
                'Direct thrombin inhibitor. Prolongs APTT and strongly prolongs thrombin time (TT). Normal TT effectively excludes clinically significant dabigatran effect. Specific reversal: idarucizumab (Praxbind).'),
              e(DiffListItem, {
                title: 'Acquired Factor VIII Inhibitor',
                tags: ['Haematology EMERGENCY', 'Elderly', 'Does NOT correct on mixing'],
                defaultOpen: true,
                warning: 'Acquired haemophilia A â€” suspect in elderly patients with new spontaneous bruising/bleeding and dramatically prolonged APTT. ~20% mortality. Contact haematology immediately.'
              }, 'Autoantibody against Factor VIII. Characteristically presents in elderly patients or postpartum. APTT does not correct with mixing study (time-dependent inhibitor â€” Bethesda assay at 2 hours). Factor VIII level very low. Distinct from congenital haemophilia. Requires immunosuppression + bypassing agents.'),
              e(InfoPanel, { title: 'The Mixing Study', color: 'var(--green)' },
                e('p', { style: { marginBottom: '8px' } }, 'When APTT is prolonged, mix 1:1 patient plasma with normal plasma:'),
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Corrects â†’ Factor deficiency.'), ' Normal plasma provides the missing factor.'),
                e('p', null, e('strong', null, 'Does not correct â†’ Inhibitor present.'), ' Immediate: lupus anticoagulant, heparin. Time-dependent (2h): acquired Factor VIII inhibitor (serious).', e('br'), 'If patient is on heparin, the mixing study is useless.')
              )
            ),

            // Pattern C: Both prolonged
            pattern === 'C' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'DIC',
                tags: ['Consumption', 'â†“Fibrinogen', 'â†“Platelets', 'â†‘D-dimer', 'Schistocytes'],
                defaultOpen: true
              }, 'Consumption of all factors + platelets. Check blood film for schistocytes.'),
              // Collapsible DIC Score Calculator
              e('button', {
                onClick: () => setShowLabs(!showLabs),
                style: { width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 16px', background: 'var(--card)', border: '1px solid var(--sep)', borderRadius: '12px', cursor: 'pointer', fontFamily: 'var(--font)', marginBottom: '12px' }
              },
                e('span', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)' } }, 'Calculate ISTH DIC Score'),
                e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, showLabs ? 'â–²' : 'â–¼')
              ),
              showLabs && e('div', { style: { background: 'rgba(142,142,147,0.08)', borderRadius: '14px', padding: '16px', marginBottom: '16px' } },
                e(ValueInput, { label: 'Platelets', unit: 'Ã—10â¹/L', value: platelets, onChange: setPlatelets, placeholder: '150â€“400' }),
                e(ValueInput, { label: 'D-dimer', unit: 'mg/L', value: dDimer, onChange: setDDimer, placeholder: '<0.5' }),
                e(ValueInput, { label: 'PT', unit: 'sec', value: pt, onChange: setPt, placeholder: '11â€“13.5' }),
                e(ValueInput, { label: 'Fibrinogen', unit: 'g/L', value: fibrinogen, onChange: setFibrinogen, placeholder: '2.0â€“4.0' }),
                calcDICScore() !== null && e(BranchCard, { label: 'ISTH DIC Score', value: `${calcDICScore()}/8`, interpretation: calcDICScore() >= 5 ? 'Compatible with overt DIC' : 'Not suggestive â€” repeat daily', color: calcDICScore() >= 5 ? 'var(--red)' : 'var(--orange)' })
              ),
              e(DiffListItem, {
                title: 'Severe Liver Disease',
                tags: ['Impaired synthesis', 'Factor VIII normal/â†‘ (distinguishes from DIC)'],
                infoPanel: e(InfoPanel, { title: 'Liver vs DIC', color: 'var(--green)' },
                  e('p', { style: { marginBottom: '8px' } }, 'Both: prolonged PT + APTT, low fibrinogen, low platelets, elevated D-dimer.'),
                  e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Factor VIII is the key.'), ' Normal/high in liver disease (Factor VIII made by endothelium). Low in DIC (consumed).'),
                  e('p', null, 'Blood film: schistocytes = DIC. Target cells, acanthocytes = liver.')
                )
              }),
              e(DiffListItem, { title: 'Massive Transfusion / Dilution', tags: ['Dilution of factors + platelets'] },
                'Occurs after large-volume resuscitation with crystalloid, colloid, or packed red cells without adequate FFP and platelets. Follow massive transfusion protocol â€” aim for FFP:RBC ratio of at least 1:2.'),
              e(DiffListItem, {
                title: 'TTP / HUS',
                tags: ['ADAMTS13', 'Schistocytes', 'Fibrinogen NORMAL', 'Haematology emergency'],
                warning: 'If schistocytes on blood film + thrombocytopenia + AKI or neurological features â†’ suspect TTP until proven otherwise. Do NOT delay plasma exchange for ADAMTS13 result.'
              }, 'Thrombotic thrombocytopenic purpura and haemolytic uraemic syndrome cause microangiopathic haemolytic anaemia with thrombocytopenia. Key distinction from DIC: fibrinogen is typically NORMAL in TTP (minimal consumption coagulopathy). Check blood film for schistocytes, LDH, haptoglobin, ADAMTS13 activity.'),
              e(DiffListItem, { title: 'Vitamin K Deficiency (severe)', tags: ['All K-dependent factors'] },
                'Severe deficiency affects Factors II, VII, IX, and X â€” prolonging both PT (extrinsic) and APTT (intrinsic). Common causes: prolonged malnutrition, warfarin (iatrogenic). IV vitamin K produces measurable improvement in 6â€“8 hours.'),
              e(DiffListItem, { title: 'Supratherapeutic Warfarin', tags: ['Very high INR'] },
                'Very high INR with both PT and APTT prolonged. If no active bleeding: hold warfarin, oral vitamin K 1â€“2 mg. If active bleeding: IV vitamin K + prothrombin complex concentrate (PCC) for immediate reversal. FFP is second-line.'),
              e(DiffListItem, { title: 'Direct Thrombin Inhibitor (high dose)', tags: ['Dabigatran', 'Argatroban'] },
                'At high levels, direct thrombin inhibitors prolong both APTT and PT. For dabigatran: check Hemoclot assay, reverse with idarucizumab. For argatroban (IV, used in HIT): reduce infusion rate, no specific reversal.')
            ),

            // Pattern D: Both normal
            pattern === 'D' && e(React.Fragment, null,
              e(DiffListItem, {
                title: 'Antiplatelet Drug Effect',
                tags: ['Aspirin', 'Clopidogrel', 'Ticagrelor', 'Most common cause'],
                defaultOpen: true
              }, 'Antiplatelet agents cause clinically significant bleeding with completely normal PT and APTT. This is the most common cause of "normal coags but bleeding" â€” always take a thorough medication history including over-the-counter aspirin and NSAIDs.'),
              e(DiffListItem, {
                title: 'Thrombocytopenia or Platelet Dysfunction',
                tags: ['Check platelet count', 'Consider PFA-100', 'Uraemia']
              }, 'Low platelet count or dysfunctional platelets (uraemia, myelodysplasia, inherited platelet disorders). PT and APTT are normal because they only test the coagulation cascade, not primary haemostasis.'),
              e(DiffListItem, { title: 'Mild von Willebrand Disease', tags: ['May not prolong APTT', 'Check vWF antigen + activity'] },
                'Mild Type 1 vWD may have a normal APTT because Factor VIII remains above the threshold for APTT prolongation (~30%). Always check vWF antigen, vWF activity, and Factor VIII level if vWD is suspected clinically.'),
              e(DiffListItem, { title: 'Factor XIII Deficiency', tags: ['NOT detected by PT or APTT', 'Clot forms then falls apart', 'Urea clot lysis test'] },
                'Factor XIII cross-links fibrin after clot formation. Deficiency means the clot forms normally (PT/APTT normal) but is unstable and breaks down. Classic presentation: delayed bleeding 24â€“48h post-surgery, umbilical stump bleeding in neonates. Diagnose with urea clot lysis test or Factor XIII level.'),
              e(DiffListItem, { title: 'Vascular Cause', tags: ['Connective tissue disorder', 'Vasculitis', 'Scurvy'] },
                'Vascular fragility from connective tissue disorders (Ehlers-Danlos, Marfan), vasculitis (Henoch-SchÃ¶nlein purpura, other small-vessel vasculitides), or scurvy (vitamin C deficiency â€” perifollicular haemorrhage, corkscrew hairs). All have normal coagulation studies.')
            ),

            e(InfoPanel, { title: 'Is It the DOAC or a Real Problem?', color: 'var(--green)' },
              e('p', { style: { marginBottom: '10px' } }, 'DOACs confound standard coagulation tests. If the patient is on an anticoagulant and the coag is abnormal, determine whether it\'s the drug or a new problem:'),
              e('div', { style: { background: 'rgba(48,209,88,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } },
                e('strong', null, 'Dabigatran (direct thrombin inhibitor):'), ' Prolongs APTT and thrombin time. Thrombin time is very sensitive â€” if normal, dabigatran effect is excluded. For quantification: dilute thrombin time (Hemoclot).'
              ),
              e('div', { style: { background: 'rgba(48,209,88,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } },
                e('strong', null, 'Rivaroxaban / Apixaban (anti-Xa):'), ' May prolong PT (rivaroxaban > apixaban). Standard PT/APTT are unreliable for measuring effect. Use calibrated anti-Xa level.'
              ),
              e('div', { style: { background: 'rgba(48,209,88,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                e('strong', null, 'Warfarin:'), ' Prolongs PT/INR. If APTT is also very prolonged, consider supratherapeutic dosing or concomitant problem.'
              )
            ),

            e('div', {
              style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center', lineHeight: '1.5' }
            }, 'If the clinical picture doesn\'t match the lab interpretation, re-examine the patient and repeat the tests. Reference ranges vary by laboratory.'),
            e('div', { style: { marginTop: '16px' } },
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--green)', onClick: resetModule }),
              e('button', {
                onClick: onBack,
                style: { width: '100%', padding: '12px', background: 'none', border: 'none', color: 'var(--label3)', fontSize: '14px', fontWeight: 500, cursor: 'pointer', fontFamily: 'var(--font)', marginTop: '4px' }
              }, 'â† All modules')
            )
          )
        )
      );
    }

    // ========== MAIN APP ==========

    function App() {
      const [screen, setScreen] = useState('home');

      if (screen === 'home') {
        return e('div', { className: 'app-container' },
          e(HomeScreen, { onSelectModule: setScreen })
        );
      }

      if (screen === 'tft') {
        return e(TFTModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'hypona') {
        return e(HyponatraemiaModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'iron') {
        return e(IronModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'coag') {
        return e(CoagModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'aki-gate') {
        return e(BetaGate, {
          moduleName: 'Urine Biochem',
          moduleColor: 'var(--cyan)',
          onSuccess: () => setScreen('aki'),
          onBack: () => setScreen('home')
        });
      }

      if (screen === 'aki') {
        return e(AKIModule, { onBack: () => setScreen('home') });
      }

      // Placeholder for other modules
      return e('div', { className: 'app-container' },
        e(PlaceholderScreen, { moduleId: screen, onBack: () => setScreen('home') })
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(e(App));
  </script>
</body>
</html>
