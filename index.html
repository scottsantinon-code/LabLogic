<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#F2F2F7">
  <title>LabLogic</title>
  <style>
    :root {
      --bg: #F2F2F7;
      --card: #FFFFFF;
      --label: #1C1C1E;
      --label2: #3A3A3C;
      --label3: #8E8E93;
      --label4: #C7C7CC;
      --sep: rgba(60,60,67,0.08);
      --blue: #0A84FF;
      --green: #30D158;
      --orange: #FF9F0A;
      --red: #FF453A;
      --purple: #AF52DE;
      --cyan: #64D2FF;
      --yellow: #FFD60A;
      --radius: 16px;
      --radius-sm: 14px;
      --radius-xs: 10px;
      --shadow: 0 1px 3px rgba(0,0,0,0.04), 0 8px 24px rgba(0,0,0,0.06);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04), 0 2px 8px rgba(0,0,0,0.03);
      --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font); background: #E5E5EA; color: var(--label); }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .app-container {
      max-width: 430px;
      margin: 0 auto;
      min-height: 100dvh;
      background: var(--bg);
      box-shadow: 0 0 40px rgba(0,0,0,0.1);
      position: relative;
      overflow-x: hidden;
    }

    .screen-content {
      padding: 0 20px 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script>
    const { useState, useEffect, useRef } = React;
    const e = React.createElement;

    // Auto-advance hook for ChoiceButton-only screens
    function useAutoAdvance() {
      const timerRef = useRef(null);
      const clearAutoAdvance = () => {
        if (timerRef.current) {
          clearTimeout(timerRef.current);
          timerRef.current = null;
        }
      };
      const scheduleAdvance = (callback, hasWarning = false) => {
        clearAutoAdvance();
        timerRef.current = setTimeout(callback, hasWarning ? 800 : 300);
      };
      useEffect(() => () => clearAutoAdvance(), []);
      return { scheduleAdvance, clearAutoAdvance };
    }

    // Module data
    const modules = [
      { id: "hypona", name: "Hyponatraemia", icon: "ðŸ’§", color: "#0A84FF", gradient: "linear-gradient(135deg, #0A84FF 0%, #0055D4 100%)", desc: "Sodium workup algorithm", tag: "Naâº" },
      { id: "tft", name: "Thyroid Function", icon: "ðŸ¦‹", color: "#AF52DE", gradient: "linear-gradient(135deg, #AF52DE 0%, #8B3FC1 100%)", desc: "TSH-first interpretation", tag: "TFT" },
      { id: "iron", name: "Iron Studies", icon: "ðŸ©¸", color: "#FF453A", gradient: "linear-gradient(135deg, #FF453A 0%, #D42020 100%)", desc: "Pattern recognition with ferritin traps", tag: "Fe" },
      { id: "calcium", name: "Calcium & PTH", icon: "ðŸ¦´", color: "#FF9F0A", gradient: "linear-gradient(135deg, #FF9F0A 0%, #E08600 100%)", desc: "PTH-dependent branching", tag: "CaÂ²âº" },
      { id: "coag", name: "Coagulation", icon: "ðŸ”¬", color: "#30D158", gradient: "linear-gradient(135deg, #30D158 0%, #1FA840 100%)", desc: "PT / APTT pattern analysis", tag: "Coag" },
      { id: "aki", name: "Urine Biochem", icon: "âš—ï¸", color: "#64D2FF", gradient: "linear-gradient(135deg, #64D2FF 0%, #32B4E0 100%)", desc: "FENa & AKI workup", tag: "AKI" },
      { id: "csf", name: "CSF Analysis", icon: "ðŸ§ ", color: "#FFD60A", gradient: "linear-gradient(135deg, #FFD60A 0%, #E0B800 100%)", desc: "Meningitis pattern matching", tag: "CSF" }
    ];

    // Reference ranges
    const REF = {
      TSH: { low: 0.4, high: 4.0, unit: "mU/L" },
      FT4: { low: 12, high: 22, unit: "pmol/L" },
      FT3: { low: 3.1, high: 6.8, unit: "pmol/L" }
    };

    // ========== REUSABLE COMPONENTS ==========

    // 1. FadeIn Wrapper
    function FadeIn({ delay = 0, children }) {
      const [visible, setVisible] = useState(false);
      useEffect(() => {
        const timer = setTimeout(() => setVisible(true), delay);
        return () => clearTimeout(timer);
      }, [delay]);
      return e('div', {
        style: {
          opacity: visible ? 1 : 0,
          transform: visible ? 'translateY(0)' : 'translateY(8px)',
          transition: 'opacity 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)'
        }
      }, children);
    }

    // 1b. ProgressBar (replaces StepTrail for one-question-per-screen flow)
    function ProgressBar({ current, total, color = 'var(--blue)' }) {
      const progress = total > 0 ? (current / total) * 100 : 0;
      return e('div', {
        style: {
          width: '100%',
          height: '4px',
          background: 'var(--sep)',
          borderRadius: '2px',
          marginBottom: '20px',
          overflow: 'hidden'
        }
      },
        e('div', {
          style: {
            width: `${progress}%`,
            height: '100%',
            background: color,
            borderRadius: '2px',
            transition: 'width 0.3s ease'
          }
        })
      );
    }

    // 2. NavBar
    function NavBar({ title, onBack, rightAction }) {
      return e('div', {
        style: {
          position: 'sticky',
          top: 0,
          zIndex: 100,
          background: 'rgba(242,242,247,0.92)',
          backdropFilter: 'blur(20px) saturate(180%)',
          WebkitBackdropFilter: 'blur(20px) saturate(180%)',
          borderBottom: '0.5px solid rgba(60,60,67,0.1)',
          padding: '12px 16px',
          paddingTop: 'calc(12px + env(safe-area-inset-top))',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          minHeight: '44px'
        }
      },
        e('div', { style: { width: '80px' } },
          onBack && e('button', {
            onClick: onBack,
            style: {
              background: 'none',
              border: 'none',
              color: 'var(--blue)',
              fontSize: '16px',
              fontWeight: 500,
              fontFamily: 'var(--font)',
              cursor: 'pointer',
              padding: 0
            }
          }, 'â€¹ Back')
        ),
        e('div', {
          style: {
            position: 'absolute',
            left: '50%',
            transform: 'translateX(-50%)',
            fontSize: '17px',
            fontWeight: 700,
            letterSpacing: '-0.02em',
            color: 'var(--label)'
          }
        }, title),
        e('div', { style: { width: '80px', textAlign: 'right' } }, rightAction)
      );
    }

    // 3. ChoiceButton
    function ChoiceButton({ label, sublabel, selected, onClick, color = 'var(--blue)' }) {
      return e('button', {
        onClick: onClick,
        style: {
          width: '100%',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '16px 18px',
          background: selected ? `${color}10` : 'var(--card)',
          border: `2px solid ${selected ? color : 'var(--sep)'}`,
          borderRadius: '14px',
          marginBottom: '8px',
          cursor: 'pointer',
          transition: 'all 0.2s ease',
          textAlign: 'left',
          fontFamily: 'var(--font)'
        }
      },
        e('div', { style: { flex: 1 } },
          e('div', { style: { fontSize: '16px', fontWeight: 600, color: 'var(--label)' } }, label),
          sublabel && e('div', { style: { fontSize: '13px', color: 'var(--label3)', marginTop: '4px' } }, sublabel)
        ),
        e('div', {
          style: {
            width: '24px',
            height: '24px',
            borderRadius: '50%',
            border: `2px solid ${selected ? color : 'var(--label4)'}`,
            background: selected ? color : 'transparent',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            flexShrink: 0,
            marginLeft: '12px'
          }
        },
          selected && e('span', { style: { color: 'white', fontSize: '14px' } }, 'âœ“')
        )
      );
    }

    // 5. ValueInput
    function ValueInput({ label, unit, value, onChange, placeholder, hint }) {
      const hasValue = value && value.length > 0;
      return e('div', { style: { marginBottom: '16px' } },
        e('div', {
          style: {
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '8px'
          }
        },
          e('span', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)' } }, label),
          hint && e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, hint)
        ),
        e('div', {
          style: {
            display: 'flex',
            background: 'var(--card)',
            border: `1.5px solid ${hasValue ? 'var(--blue)' : 'var(--sep)'}`,
            borderRadius: '12px',
            overflow: 'hidden'
          }
        },
          e('input', {
            type: 'number',
            inputMode: 'decimal',
            value: value,
            onChange: (ev) => onChange(ev.target.value),
            placeholder: placeholder,
            style: {
              flex: 1,
              padding: '14px 16px',
              fontSize: '17px',
              fontWeight: 600,
              border: 'none',
              outline: 'none',
              background: 'transparent',
              fontFamily: 'var(--font)',
              color: 'var(--label)'
            }
          }),
          e('div', {
            style: {
              padding: '0 14px',
              fontSize: '13px',
              fontWeight: 600,
              color: 'var(--label3)',
              borderLeft: '1px solid var(--sep)',
              background: 'rgba(142,142,147,0.08)',
              display: 'flex',
              alignItems: 'center'
            }
          }, unit)
        )
      );
    }

    // 6. InfoPanel
    function InfoPanel({ title, color = 'var(--blue)', children }) {
      const [isOpen, setIsOpen] = useState(false);
      return e('div', {
        style: {
          background: isOpen ? `${color}08` : 'var(--card)',
          border: `1px solid ${isOpen ? `${color}25` : 'var(--sep)'}`,
          borderRadius: '14px',
          marginBottom: '12px',
          overflow: 'hidden'
        }
      },
        e('button', {
          onClick: () => setIsOpen(!isOpen),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            gap: '10px',
            padding: '14px 16px',
            background: 'none',
            border: 'none',
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            textAlign: 'left'
          }
        },
          e('div', {
            style: {
              width: '26px',
              height: '26px',
              borderRadius: '50%',
              background: `${color}15`,
              color: color,
              fontWeight: 700,
              fontSize: '14px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              flexShrink: 0
            }
          }, 'â“˜'),
          e('span', {
            style: { flex: 1, fontSize: '14px', fontWeight: 600, color: 'var(--label2)' }
          }, title),
          e('span', {
            style: {
              fontSize: '16px',
              color: 'var(--label3)',
              transform: isOpen ? 'rotate(90deg)' : 'rotate(0)',
              transition: 'transform 0.2s ease'
            }
          }, 'â€º')
        ),
        isOpen && e('div', {
          style: {
            borderTop: `1px solid ${color}15`,
            padding: '16px',
            fontSize: '13px',
            lineHeight: 1.65,
            color: 'var(--label2)',
            animation: 'fadeIn 0.2s ease'
          }
        }, children)
      );
    }

    // 7. Warning Banner
    function WarningBanner({ children }) {
      return e('div', {
        style: {
          display: 'flex',
          gap: '10px',
          padding: '14px 16px',
          background: 'rgba(255,69,58,0.06)',
          border: '1px solid rgba(255,69,58,0.15)',
          borderRadius: '14px',
          marginBottom: '12px'
        }
      },
        e('span', { style: { fontSize: '16px', flexShrink: 0 } }, 'âš ï¸'),
        e('div', {
          style: { fontSize: '13px', lineHeight: 1.55, color: '#C41E10', fontWeight: 500 }
        }, children)
      );
    }

    // 8. BranchCard
    function BranchCard({ label, value, interpretation, color = 'var(--blue)' }) {
      return e('div', {
        style: {
          display: 'flex',
          borderRadius: '14px',
          overflow: 'hidden',
          border: `1px solid ${color}25`,
          background: 'var(--card)',
          marginBottom: '16px'
        }
      },
        e('div', {
          style: { width: '5px', background: color, flexShrink: 0 }
        }),
        e('div', { style: { flex: 1, padding: '14px 16px' } },
          e('div', {
            style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
          },
            e('span', { style: { fontSize: '13px', fontWeight: 600, color: 'var(--label3)' } }, label),
            e('span', { style: { fontSize: '17px', fontWeight: 700, color: color } }, value)
          ),
          e('div', {
            style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)', marginTop: '4px' }
          }, interpretation)
        )
      );
    }

    // 9. ResultCard
    function ResultCard({ title, subtitle, tags = [], severity, children, onTap }) {
      const severityStyles = {
        likely: { color: '#0A84FF', bg: 'rgba(10,132,255,0.08)', border: 'rgba(10,132,255,0.2)', label: 'LIKELY' },
        dangerous: { color: '#FF453A', bg: 'rgba(255,69,58,0.08)', border: 'rgba(255,69,58,0.2)', label: 'URGENT' },
        consider: { color: '#FF9F0A', bg: 'rgba(255,159,10,0.08)', border: 'rgba(255,159,10,0.2)', label: 'CONSIDER' },
        rare: { color: '#8E8E93', bg: 'rgba(142,142,147,0.08)', border: 'rgba(142,142,147,0.2)', label: 'RARE' }
      };
      const sev = severityStyles[severity] || severityStyles.consider;

      return e('div', {
        style: {
          background: 'var(--card)',
          borderRadius: '16px',
          border: '1px solid var(--sep)',
          boxShadow: 'var(--shadow-sm)',
          padding: '18px 18px 16px',
          marginBottom: '10px'
        }
      },
        e('div', {
          style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }
        },
          e('div', { style: { flex: 1 } },
            e('div', {
              style: { fontSize: '16px', fontWeight: 700, letterSpacing: '-0.02em', color: 'var(--label)' }
            }, title),
            subtitle && e('div', {
              style: { fontSize: '13px', color: 'var(--label3)', marginTop: '3px' }
            }, subtitle)
          ),
          e('span', {
            style: {
              fontSize: '10px',
              fontWeight: 700,
              letterSpacing: '0.05em',
              color: sev.color,
              background: sev.bg,
              border: `1px solid ${sev.border}`,
              padding: '3px 8px',
              borderRadius: '6px',
              marginLeft: '10px'
            }
          }, sev.label)
        ),
        children && e('div', {
          style: { fontSize: '13.5px', lineHeight: 1.6, color: 'var(--label2)', marginTop: '6px' }
        }, children),
        tags.length > 0 && e('div', {
          style: { display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '10px' }
        },
          tags.map((tag, i) => e('span', {
            key: i,
            style: {
              fontSize: '11px',
              fontWeight: 600,
              color: 'var(--label3)',
              background: 'rgba(142,142,147,0.12)',
              padding: '3px 8px',
              borderRadius: '6px'
            }
          }, tag))
        ),
        onTap && e('button', {
          onClick: onTap,
          style: {
            background: 'none',
            border: 'none',
            color: 'var(--blue)',
            fontSize: '13px',
            fontWeight: 600,
            marginTop: '12px',
            padding: 0,
            cursor: 'pointer',
            fontFamily: 'var(--font)'
          }
        }, 'View management â†’')
      );
    }

    // 10. PrimaryButton
    function PrimaryButton({ label, onClick, disabled, color = 'var(--blue)' }) {
      return e('button', {
        onClick: disabled ? undefined : onClick,
        disabled: disabled,
        style: {
          width: '100%',
          padding: '16px',
          borderRadius: '14px',
          fontSize: '17px',
          fontWeight: 700,
          letterSpacing: '-0.02em',
          background: disabled ? 'var(--label4)' : color,
          color: 'white',
          border: 'none',
          opacity: disabled ? 0.5 : 1,
          cursor: disabled ? 'default' : 'pointer',
          marginTop: '8px',
          fontFamily: 'var(--font)',
          transition: 'all 0.2s ease'
        }
      }, label);
    }

    // 11. MgmtStep
    function MgmtStep({ number, title, color = 'var(--blue)', children }) {
      return e('div', {
        style: { display: 'flex', gap: '14px', marginBottom: '16px' }
      },
        e('div', {
          style: {
            width: '30px',
            height: '30px',
            borderRadius: '50%',
            background: color,
            color: 'white',
            fontSize: '14px',
            fontWeight: 700,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            flexShrink: 0
          }
        }, number),
        e('div', { style: { flex: 1 } },
          e('div', {
            style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '4px' }
          }, title),
          e('div', {
            style: { fontSize: '13.5px', lineHeight: 1.6, color: 'var(--label2)' }
          }, children)
        )
      );
    }

    // 12. DiffCard (Collapsible)
    function DiffCard({ title, description, color = 'var(--blue)' }) {
      const [isOpen, setIsOpen] = useState(false);
      return e('div', {
        style: {
          background: 'var(--card)',
          border: '1px solid var(--sep)',
          borderRadius: '10px',
          marginBottom: '6px',
          overflow: 'hidden'
        }
      },
        e('button', {
          onClick: () => setIsOpen(!isOpen),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '12px 14px',
            background: 'none',
            border: 'none',
            borderLeft: `4px solid ${color}`,
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            textAlign: 'left'
          }
        },
          e('span', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)' } }, title),
          e('span', {
            style: {
              fontSize: '14px',
              color: 'var(--label3)',
              transform: isOpen ? 'rotate(90deg)' : 'rotate(0)',
              transition: 'transform 0.2s ease'
            }
          }, 'â€º')
        ),
        e('div', {
          style: {
            maxHeight: isOpen ? '500px' : '0',
            overflow: 'hidden',
            transition: 'max-height 0.2s ease'
          }
        },
          e('div', {
            style: {
              borderTop: '1px solid var(--sep)',
              padding: '10px 14px',
              fontSize: '13px',
              lineHeight: 1.55,
              color: 'var(--label2)'
            }
          }, description)
        )
      );
    }

    // 13. LearnMoreDivider
    function LearnMoreDivider() {
      return e('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          marginTop: '24px',
          marginBottom: '16px',
          gap: '12px'
        }
      },
        e('div', { style: { flex: 1, height: '1px', background: 'var(--sep)' } }),
        e('span', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label4)' } }, 'Learn more'),
        e('div', { style: { flex: 1, height: '1px', background: 'var(--sep)' } })
      );
    }

    // 14. SeverityBadge (inline below inputs)
    function SeverityBadge({ text, color }) {
      return e('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
          marginTop: '6px'
        }
      },
        e('div', {
          style: {
            width: '8px',
            height: '8px',
            borderRadius: '50%',
            background: color,
            flexShrink: 0
          }
        }),
        e('span', { style: { fontSize: '13px', fontWeight: 600, color: color } }, text)
      );
    }

    // 15. HomeButton (for NavBar)
    function HomeButton({ onClick }) {
      return e('button', {
        onClick: onClick,
        style: {
          background: 'none',
          border: 'none',
          padding: '8px',
          cursor: 'pointer',
          borderRadius: '8px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center'
        }
      },
        e('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'var(--label3)', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          e('path', { d: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z' }),
          e('polyline', { points: '9 22 9 12 15 12 15 22' })
        )
      );
    }

    // ========== SCREENS ==========

    // Home Screen
    function HomeScreen({ onSelectModule }) {
      return e('div', null,
        // Header
        e('div', {
          style: {
            padding: '16px 24px',
            paddingTop: 'calc(16px + env(safe-area-inset-top))'
          }
        },
          e('div', { style: { display: 'flex', alignItems: 'center', gap: '14px' } },
            e('div', {
              style: {
                width: '52px',
                height: '52px',
                borderRadius: '14px',
                background: 'linear-gradient(145deg, #1C1C1E, #3A3A3C)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
              }
            }, e('span', { style: { fontSize: '26px' } }, 'ðŸ§¬')),
            e('div', null,
              e('div', {
                style: { fontSize: '30px', fontWeight: 800, letterSpacing: '-0.04em', color: 'var(--label)' }
              }, 'LabLogic'),
              e('div', {
                style: { fontSize: '14px', fontWeight: 500, color: 'var(--label3)' }
              }, 'Lab interpretation, step by step')
            )
          )
        ),

        // Module Cards
        e('div', { style: { padding: '0 20px' } },
          modules.map((mod, i) =>
            e(FadeIn, { key: mod.id, delay: 100 + i * 60 },
              e('button', {
                onClick: () => onSelectModule(mod.id),
                style: {
                  width: '100%',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '14px',
                  background: 'var(--card)',
                  borderRadius: '18px',
                  padding: '16px 18px',
                  border: '1px solid var(--sep)',
                  boxShadow: 'var(--shadow-sm)',
                  marginBottom: '10px',
                  cursor: 'pointer',
                  textAlign: 'left',
                  fontFamily: 'var(--font)',
                  transition: 'transform 0.2s ease'
                }
              },
                // Icon square
                e('div', {
                  style: {
                    width: '48px',
                    height: '48px',
                    borderRadius: '14px',
                    background: mod.gradient,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    boxShadow: `0 3px 10px ${mod.color}30`,
                    flexShrink: 0
                  }
                }, e('span', { style: { fontSize: '22px' } }, mod.icon)),
                // Text
                e('div', { style: { flex: 1 } },
                  e('div', {
                    style: { fontSize: '16px', fontWeight: 700, letterSpacing: '-0.02em', color: 'var(--label)' }
                  }, mod.name),
                  e('div', {
                    style: { fontSize: '13px', color: 'var(--label3)', marginTop: '2px' }
                  }, mod.desc)
                ),
                // Tag + chevron
                e('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', flexShrink: 0 } },
                  e('span', {
                    style: {
                      fontSize: '11px',
                      fontWeight: 700,
                      color: mod.color,
                      background: `${mod.color}12`,
                      padding: '3px 8px',
                      borderRadius: '6px'
                    }
                  }, mod.tag),
                  e('span', { style: { color: 'var(--label4)', fontSize: '18px' } }, 'â€º')
                )
              )
            )
          )
        ),

        // Footer
        e('div', {
          style: { textAlign: 'center', padding: '20px 0 8px', paddingBottom: 'calc(8px + env(safe-area-inset-bottom))' }
        },
          e('div', { style: { fontSize: '12px', color: 'var(--label4)' } }, 'For healthcare professionals only'),
          e('div', { style: { fontSize: '12px', color: 'var(--label4)', marginTop: '4px' } }, 'Not a medical device Â· Verify against local reference ranges')
        )
      );
    }

    // Placeholder Screen for non-TFT modules
    function PlaceholderScreen({ moduleId, onBack }) {
      const mod = modules.find(m => m.id === moduleId);
      return e('div', null,
        e(NavBar, { title: mod?.name || 'Module', onBack }),
        e('div', {
          style: {
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '80px 20px',
            textAlign: 'center'
          }
        },
          e('span', { style: { fontSize: '48px', marginBottom: '16px' } }, mod?.icon || 'ðŸ“‹'),
          e('div', { style: { fontSize: '20px', fontWeight: 700, color: 'var(--label)', marginBottom: '8px' } }, 'Coming Soon'),
          e('div', { style: { fontSize: '14px', color: 'var(--label3)' } }, mod?.desc || 'This module is under development')
        )
      );
    }

    // ========== TFT MODULE ==========

    function TFTModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const [acutelyUnwell, setAcutelyUnwell] = useState(null);
      const [tshResult, setTshResult] = useState(null);
      const [ft4, setFt4] = useState('');
      const [ft3, setFt3] = useState('');
      const [showMgmt, setShowMgmt] = useState(null); // 'hyper' or 'hypo'

      // Auto-advance for ChoiceButton-only screens
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Dynamic screen count: 5 screens if TSH low (need fT3), else 4 screens
      const getTotalScreens = () => tshResult === 'low' ? 5 : 4;
      const getResultsScreen = () => tshResult === 'low' ? 4 : 3;

      const handleBack = () => {
        clearAutoAdvance();
        if (showMgmt) {
          setShowMgmt(null);
        } else if (step === 0) {
          onBack();
        } else if (step === getResultsScreen()) {
          // From results, go back to fT3 (if TSH low) or fT4
          setStep(tshResult === 'low' ? 3 : 2);
        } else {
          setStep(step - 1);
        }
      };

      const goToStep = (newStep) => {
        setStep(newStep);
        if (containerRef.current) {
          containerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
        }
      };

      // Interpret values
      const interpretTSH = (val) => {
        const n = parseFloat(val);
        if (isNaN(n)) return null;
        if (n < 0.4) return 'low';
        if (n > 4.0) return 'high';
        return 'normal';
      };

      const interpretFT4 = (val) => {
        const n = parseFloat(val);
        if (isNaN(n)) return null;
        if (n < 12) return 'low';
        if (n > 22) return 'high';
        return 'normal';
      };

      const interpretFT3 = (val) => {
        const n = parseFloat(val);
        if (isNaN(n)) return null;
        if (n < 3.1) return 'low';
        if (n > 6.8) return 'high';
        return 'normal';
      };

      const ft4Status = interpretFT4(ft4);
      const ft3Status = interpretFT3(ft3);

      // Get TSH display values
      const getTSHDisplay = () => {
        if (tshResult === 'low') return { value: 'Low (< 0.4)', interpretation: 'Suppressed', color: 'var(--red)' };
        if (tshResult === 'high') return { value: 'High (> 4.0)', interpretation: 'Elevated', color: 'var(--orange)' };
        return { value: 'Normal (0.4â€“4.0)', interpretation: 'Within range', color: 'var(--green)' };
      };

      const getFT4Display = () => {
        if (ft4Status === 'low') return { value: `${ft4} pmol/L`, interp: 'Low', color: 'var(--red)' };
        if (ft4Status === 'high') return { value: `${ft4} pmol/L`, interp: 'High', color: 'var(--orange)' };
        return { value: `${ft4} pmol/L`, interp: 'Normal', color: 'var(--green)' };
      };

      const getFT3Display = () => {
        if (ft3Status === 'low') return { value: `${ft3} pmol/L`, interp: 'Low', color: 'var(--red)' };
        if (ft3Status === 'high') return { value: `${ft3} pmol/L`, interp: 'High', color: 'var(--orange)' };
        return { value: `${ft3} pmol/L`, interp: 'Normal', color: 'var(--green)' };
      };

      // Management screens
      if (showMgmt === 'hyper') {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(null), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', {
              onClick: () => setShowMgmt(null),
              style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' }
            }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '8px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Overt Hyperthyroidism')
            ),
            e('div', { style: { marginTop: '20px' } },
              e(MgmtStep, { number: 1, title: 'Symptom control', color: 'var(--purple)' },
                'Beta-blockade for tremor, tachycardia, anxiety. Propranolol also inhibits peripheral T4â†’T3 conversion.'
              ),
              e(MgmtStep, { number: 2, title: 'Antithyroid medication', color: 'var(--purple)' },
                'Carbimazole or propylthiouracil (PTU). Dosing per local guidelines â€” titrate to TFTs at 4â€“6 week intervals. PTU preferred in first trimester pregnancy.'
              ),
              e(MgmtStep, { number: 3, title: 'Definitive therapy', color: 'var(--purple)' },
                'Radioiodine ablation or thyroidectomy â€” decision depends on cause, patient preference, fertility plans, Graves\' eye disease. Specialist referral.'
              )
            ),
            e(WarningBanner, null,
              e('strong', null, 'Thyroid storm'), ' is a life-threatening emergency requiring ICU admission. Immediate specialist input required.'
            ),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '16px', padding: '12px', background: 'var(--card)', borderRadius: '10px', border: '1px solid var(--sep)' } },
              'Dosing should follow local formulary guidelines. This app provides interpretation guidance only.'
            )
          )
        );
      }

      if (showMgmt === 'hypo') {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(null), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', {
              onClick: () => setShowMgmt(null),
              style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' }
            }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '8px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Overt Hypothyroidism')
            ),
            e('div', { style: { marginTop: '20px' } },
              e(MgmtStep, { number: 1, title: 'Levothyroxine replacement', color: 'var(--purple)' },
                'Weight-based dosing in young healthy patients. Start low and titrate slowly in elderly or those with cardiac disease. Dosing per local formulary.'
              ),
              e(MgmtStep, { number: 2, title: 'Monitoring', color: 'var(--purple)' },
                'Recheck TSH 6â€“8 weeks after starting or any dose change. Take on empty stomach, separate from calcium, iron, PPIs by 4 hours.'
              ),
              e(MgmtStep, { number: 3, title: 'Target', color: 'var(--purple)' },
                'TSH within normal range for most patients. Lower target may be appropriate in pregnancy.'
              ),
              e('div', { style: { fontSize: '11px', color: 'var(--label4)', fontStyle: 'italic', marginTop: '16px', padding: '12px', background: 'var(--bg)', borderRadius: '8px' } },
                'Dosing should follow local formulary guidelines. This app provides interpretation guidance only.'
              )
            ),
            e(WarningBanner, null,
              'If central hypothyroidism suspected: ', e('strong', null, 'check cortisol and treat adrenal insufficiency BEFORE starting levothyroxine.'), ' Thyroxine increases cortisol metabolism â€” can precipitate adrenal crisis.'
            )
          )
        );
      }

      // Main TFT flow
      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Thyroid Function', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--purple)' }),

          // SCREEN 0: Is the patient acutely unwell? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Is the patient acutely unwell?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'This changes how we interpret the results'),
            e(ChoiceButton, {
              label: 'Yes â€” acutely unwell or in ICU',
              sublabel: 'Consider sick euthyroid before interpreting',
              selected: acutelyUnwell === true,
              onClick: () => {
                clearAutoAdvance();
                setAcutelyUnwell(true);
                scheduleAdvance(() => goToStep(1), true); // 800ms delay for warning
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'No â€” outpatient or stable',
              sublabel: 'Standard interpretation applies',
              selected: acutelyUnwell === false,
              onClick: () => {
                clearAutoAdvance();
                setAcutelyUnwell(false);
                scheduleAdvance(() => goToStep(1), false); // 300ms delay
              },
              color: 'var(--purple)'
            }),
            acutelyUnwell === true && e(WarningBanner, null,
              e('strong', null, 'Non-thyroidal illness (sick euthyroid)'), ' can cause â†“fT3, â†“fT4, and â†“TSH in acute illness. Do NOT diagnose or treat thyroid disease from TFTs in acute illness unless TSH is markedly abnormal (>20 or <0.1).'
            )
          ),

          // SCREEN 1: What is the TSH? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What is the TSH?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'TSH moves before fT4/fT3 become abnormal'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 0.4 mU/L',
              sublabel: 'Pituitary suppressed â†’ excess thyroid hormone',
              selected: tshResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setTshResult('low');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Normal  0.4â€“4.0 mU/L',
              sublabel: 'Usually euthyroid',
              selected: tshResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setTshResult('normal');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 4.0 mU/L',
              sublabel: 'Pituitary driving harder â†’ insufficient thyroid hormone',
              selected: tshResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setTshResult('high');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--orange)'
            })
          ),

          // SCREEN 2: Enter fT4 (ValueInput, Next button)
          step === 2 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Enter fT4'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } },
              tshResult === 'low' ? 'TSH is suppressed â€” fT4 helps classify' :
              tshResult === 'high' ? 'TSH is elevated â€” fT4 distinguishes overt from subclinical' :
              'TSH normal â€” fT4 checks for rare discordance'
            ),
            e(ValueInput, {
              label: 'fT4',
              unit: 'pmol/L',
              value: ft4,
              onChange: setFt4,
              placeholder: '12 â€“ 22',
              hint: 'Normal: 12â€“22'
            }),
            e(PrimaryButton, {
              label: tshResult === 'low' ? 'Next â†’ fT3' : 'Interpret â†’',
              disabled: !ft4,
              color: 'var(--purple)',
              onClick: () => goToStep(tshResult === 'low' ? 3 : getResultsScreen())
            })
          ),

          // SCREEN 3: Enter fT3 (only if TSH low, ValueInput, Next button)
          step === 3 && tshResult === 'low' && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Enter fT3'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'fT3 is needed to detect T3 thyrotoxicosis when fT4 is normal'),
            e(ValueInput, {
              label: 'fT3',
              unit: 'pmol/L',
              value: ft3,
              onChange: setFt3,
              placeholder: '3.1 â€“ 6.8',
              hint: 'Normal: 3.1â€“6.8'
            }),
            e(PrimaryButton, {
              label: 'Interpret â†’',
              disabled: !ft3,
              color: 'var(--purple)',
              onClick: () => goToStep(4)
            })
          ),

          // RESULTS SCREEN (step 3 if TSH not low, step 4 if TSH low)
          step === getResultsScreen() && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Interpretation'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Based on the algorithmic pathway'),

            // Branch cards showing path (only on Results screen)
            e(BranchCard, { label: 'TSH', ...getTSHDisplay() }),
            ft4 && e(BranchCard, { label: 'fT4', ...getFT4Display() }),
            ft3 && tshResult === 'low' && e(BranchCard, { label: 'fT3', ...getFT3Display() }),

            e('div', {
              style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' }
            }, 'DIFFERENTIAL DIAGNOSIS'),

            // TSH LOW pathways
            tshResult === 'low' && ft4Status === 'high' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Overt Hyperthyroidism',
                severity: 'likely',
                tags: ['Graves\'', 'Toxic MNG', 'Toxic adenoma'],
                onTap: () => setShowMgmt('hyper')
              }, 'Suppressed TSH with elevated fT4 confirms thyrotoxicosis. Most commonly Graves\' disease, toxic multinodular goitre, or toxic adenoma.'),
              (ft3Status === 'high' || !ft3) && e(ResultCard, {
                title: 'TSH-secreting Pituitary Adenoma',
                subtitle: 'Or thyroid hormone resistance',
                severity: 'rare',
                tags: ['TSH should be suppressed', 'Refer endocrinology']
              }, 'TSH inappropriately normal/unsuppressed with elevated thyroid hormones. Very rare â€” consider TSH-producing adenoma or thyroid hormone resistance syndrome.')
            ),

            tshResult === 'low' && ft4Status === 'normal' && ft3Status === 'high' && e(ResultCard, {
              title: 'T3 Thyrotoxicosis',
              severity: 'likely',
              tags: ['~5% of hyperthyroidism', 'Early Graves\'', 'Toxic adenoma'],
              onTap: () => setShowMgmt('hyper')
            }, 'fT4 normal but fT3 elevated â€” about 5% of hyperthyroidism presents this way. Common in early Graves\' disease or autonomous thyroid adenoma.'),

            tshResult === 'low' && ft4Status === 'normal' && (ft3Status === 'normal' || !ft3 || ft3Status === null) && !(ft3Status === 'high') && e(ResultCard, {
              title: 'Subclinical Hyperthyroidism',
              severity: 'consider',
              tags: ['Recheck 6â€“8 weeks', 'AF risk', 'Osteoporosis risk']
            }, 'TSH suppressed but hormones normal. May be transient. Recheck in 6â€“8 weeks. If persistent, increased risk of atrial fibrillation and osteoporosis.'),

            tshResult === 'low' && ft4Status === 'low' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Central Hypothyroidism',
                severity: 'dangerous',
                tags: ['Pituitary failure', 'Check cortisol FIRST']
              }, 'Low TSH with low fT4 means the pituitary is failing â€” this is NOT primary thyroid disease. Investigate for pituitary pathology urgently.'),
              e(WarningBanner, null,
                e('strong', null, 'Check cortisol before starting thyroxine.'), ' Starting thyroxine with unrecognised adrenal insufficiency can precipitate adrenal crisis (thyroxine increases cortisol metabolism).'
              ),
              e(InfoPanel, { title: 'Central Hypothyroidism â€” Why It Matters', color: 'var(--red)' },
                e('p', { style: { marginBottom: '10px' } }, 'Low TSH + low fT4 = pituitary failure, not just thyroid disease.'),
                e('p', { style: { marginBottom: '10px' } }, 'Pituitary adenoma (mass effect) Â· Pituitary apoplexy Â· Post-surgical/radiation Â· Sheehan\'s syndrome Â· Infiltrative disease (sarcoid, haemochromatosis)'),
                e('p', { style: { fontWeight: 700 } }, 'If pituitary failure suspected, check cortisol BEFORE starting thyroxine.')
              )
            ),

            // TSH HIGH pathways
            tshResult === 'high' && ft4Status === 'low' && e(ResultCard, {
              title: 'Overt Hypothyroidism',
              severity: 'likely',
              tags: ['Hashimoto\'s', 'Post-thyroidectomy', 'Post-radioiodine'],
              onTap: () => setShowMgmt('hypo')
            }, 'Elevated TSH with low fT4 confirms primary hypothyroidism. Most commonly autoimmune (Hashimoto\'s â€” check TPO antibodies).'),

            tshResult === 'high' && ft4Status === 'normal' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Subclinical Hypothyroidism',
                severity: 'consider',
                tags: ['Recheck 6â€“8 weeks', 'Check TPO antibodies', 'Treat if TSH >10']
              }, 'TSH elevated but fT4 still normal. Common finding. Check TPO antibodies and recheck in 6â€“8 weeks. Treatment threshold depends on TSH level, symptoms, and antibody status.'),
              e(InfoPanel, { title: 'When to Treat Subclinical Hypothyroidism', color: 'var(--purple)' },
                e('div', { style: { background: 'rgba(48,209,88,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '10px' } },
                  e('strong', { style: { color: 'var(--green)' } }, 'TREAT IF:'), ' TSH >10 (even if asymptomatic) Â· TSH 4â€“10 with positive TPOAb Â· Symptoms attributable to hypothyroidism Â· Pregnant or planning pregnancy (target TSH <2.5)'
                ),
                e('div', { style: { background: 'rgba(255,159,10,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                  e('strong', { style: { color: 'var(--orange)' } }, 'OBSERVE IF:'), ' TSH 4â€“10 with negative TPOAb and asymptomatic Â· Elderly (>70 years) â€” higher TSH may be physiological Â· Recovery from acute illness'
                )
              )
            ),

            tshResult === 'high' && ft4Status === 'high' && e(ResultCard, {
              title: 'Assay Interference or TSH-oma',
              severity: 'rare',
              tags: ['Biotin interference', 'Heterophile antibodies', 'Refer endocrinology']
            }, 'TSH elevated with high fT4 is discordant â€” TSH should be suppressed. Consider biotin supplement interference, heterophile antibodies, or rare TSH-secreting pituitary adenoma.'),

            // TSH NORMAL pathways
            tshResult === 'normal' && ft4Status === 'normal' && e(ResultCard, {
              title: 'Euthyroid',
              severity: 'likely',
              tags: ['Normal thyroid function']
            }, 'TSH and fT4 both normal. Symptoms unlikely to be thyroid-related.'),

            tshResult === 'normal' && ft4Status === 'low' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Central Hypothyroidism',
                severity: 'dangerous',
                tags: ['Pituitary failure', 'Investigate urgently']
              }, 'Normal TSH is \'inappropriately normal\' in the context of low fT4. The pituitary should be driving TSH up. Investigate for pituitary pathology.'),
              e(WarningBanner, null,
                e('strong', null, 'Check cortisol before starting thyroxine.'), ' Starting thyroxine with unrecognised adrenal insufficiency can precipitate adrenal crisis (thyroxine increases cortisol metabolism).'
              ),
              e(InfoPanel, { title: 'Central Hypothyroidism â€” Why It Matters', color: 'var(--red)' },
                e('p', { style: { marginBottom: '10px' } }, 'Low TSH + low fT4 = pituitary failure, not just thyroid disease.'),
                e('p', { style: { marginBottom: '10px' } }, 'Pituitary adenoma (mass effect) Â· Pituitary apoplexy Â· Post-surgical/radiation Â· Sheehan\'s syndrome Â· Infiltrative disease (sarcoid, haemochromatosis)'),
                e('p', { style: { fontWeight: 700 } }, 'If pituitary failure suspected, check cortisol BEFORE starting thyroxine.')
              )
            ),

            tshResult === 'normal' && ft4Status === 'high' && e(ResultCard, {
              title: 'Assay Interference',
              severity: 'consider',
              tags: ['Biotin supplements', 'Heterophile antibodies', 'Recheck']
            }, 'Normal TSH with high fT4 is discordant. Most commonly caused by biotin supplement interference. Stop biotin for 48h and recheck, or request repeat on different assay platform.'),

            e(PrimaryButton, {
              label: 'New Analysis',
              color: 'var(--label3)',
              onClick: onBack
            }),

            e(LearnMoreDivider),

            // Causes of Hyperthyroidism InfoPanel (when hyperthyroid)
            (tshResult === 'low' && (ft4Status === 'high' || (ft4Status === 'normal' && ft3Status === 'high'))) && e(InfoPanel, { title: 'Causes of Hyperthyroidism', color: 'var(--purple)' },
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'High uptake on thyroid scan (â†‘ synthesis):'),
              e('ul', { style: { marginLeft: '16px', marginBottom: '12px' } },
                e('li', null, 'Graves\' disease â€” diffuse uptake, TRAb positive'),
                e('li', null, 'Toxic multinodular goitre â€” patchy uptake'),
                e('li', null, 'Toxic adenoma â€” single hot nodule')
              ),
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'Low uptake on thyroid scan (preformed hormone release):'),
              e('ul', { style: { marginLeft: '16px', marginBottom: '12px' } },
                e('li', null, 'Thyroiditis (subacute, postpartum, silent)'),
                e('li', null, 'Exogenous thyroid hormone'),
                e('li', null, 'Iodine-induced (amiodarone, contrast)')
              ),
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'Key distinguishing features:'),
              e('ul', { style: { marginLeft: '16px' } },
                e('li', null, 'Graves\': eye signs, diffuse goitre, TRAb positive'),
                e('li', null, 'Thyroiditis: tender thyroid, self-limiting'),
                e('li', null, 'Amiodarone: Type 1 (synthesis) vs Type 2 (destructive)')
              )
            ),

            // Assay interference panel
            e(InfoPanel, { title: 'Assay Interference â€” the Hidden Trap', color: 'var(--purple)' },
              e('p', { style: { marginBottom: '10px' } },
                e('strong', null, 'Biotin (Vitamin B7):'), ' High-dose biotin supplements (common in "hair and nails" products, also MS treatment) interfere with streptavidin-biotin immunoassays. Can cause falsely â†‘fT4, â†‘fT3, â†“TSH â€” mimicking hyperthyroidism.'
              ),
              e('p', { style: { marginBottom: '10px' } },
                e('strong', null, 'Heterophile antibodies:'), ' Antibodies that interfere with immunoassays. Can cause falsely high or low results. Suspect if discordant with clinical picture.'
              ),
              e('p', null,
                e('strong', null, 'Hook effect:'), ' Very high analyte concentrations can saturate assay and give falsely low/normal results. Rare but relevant in pregnancy and severe thyrotoxicosis.'
              )
            )
          )
        )
      );
    }

    // ========== HYPONATRAEMIA MODULE ==========

    function HyponatraemiaModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);

      // Auto-advance for ChoiceButton-only screens
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Serum Sodium (ValueInput)
      const [naValue, setNaValue] = useState('');

      // Screen 1: Chronicity (ChoiceButtons)
      const [chronicity, setChronicity] = useState(null);

      // Screen 2: Serum Osmolality (ChoiceButtons, branches)
      const [serumOsmResult, setSerumOsmResult] = useState(null);

      // Screen 2a: Glucose for corrected Na (if hyper-osmolar)
      const [glucose, setGlucose] = useState('');

      // Screen 3: Urine Osmolality (if hypotonic)
      const [urineOsmResult, setUrineOsmResult] = useState(null);

      // Screen 4: Urine Sodium (if hypotonic)
      const [urineNaResult, setUrineNaResult] = useState(null);

      // Management
      const [showMgmt, setShowMgmt] = useState(false);

      // Na Correction Rate Calculator
      const [naEntries, setNaEntries] = useState([{ na: '', hours: '0' }]);
      const [targetRate, setTargetRate] = useState(10); // Default to 10 mmol/24h

      // Determine path based on serum osmolality
      const isShortPath = serumOsmResult === 'normal' || serumOsmResult === 'high';
      const isHyperOsmolar = serumOsmResult === 'high';
      const isIsoOsmolar = serumOsmResult === 'normal';

      // Dynamic screen count:
      // Short path (iso/hyper): 0-Na, 1-Chronicity, 2-SerumOsm, 2a-Glucose(hyper only), 3-Results
      // Long path (hypotonic): 0-Na, 1-Chronicity, 2-SerumOsm, 3-UrineOsm, 4-UrineNa, 5-Results
      const getTotalScreens = () => {
        if (isIsoOsmolar) return 4; // Na, Chronicity, SerumOsm, Results
        if (isHyperOsmolar) return 5; // Na, Chronicity, SerumOsm, Glucose, Results
        return 6; // Na, Chronicity, SerumOsm, UrineOsm, UrineNa, Results
      };

      const getResultsScreen = () => {
        if (isIsoOsmolar) return 3;
        if (isHyperOsmolar) return 4;
        return 5;
      };

      const scrollToTop = () => {
        if (containerRef.current) {
          containerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
        }
      };

      const goToStep = (newStep) => {
        setStep(newStep);
        scrollToTop();
      };

      const handleBack = () => {
        clearAutoAdvance();
        if (showMgmt) {
          setShowMgmt(false);
        } else if (step === 0) {
          onBack();
        } else if (step === getResultsScreen()) {
          // From results, go back to previous screen based on path
          if (isIsoOsmolar) goToStep(2);
          else if (isHyperOsmolar) goToStep(3); // glucose screen
          else goToStep(4); // urine na
        } else {
          goToStep(step - 1);
        }
      };

      // Severity assessment
      const getSeverity = () => {
        const na = parseFloat(naValue);
        if (isNaN(na)) return null;
        if (na > 130) return { color: 'var(--green)', interp: 'Mild â€” usually asymptomatic' };
        if (na >= 125) return { color: 'var(--orange)', interp: 'Moderate â€” confusion, nausea, headache likely' };
        if (na >= 120) return { color: 'var(--orange)', interp: 'Significant â€” high risk of symptoms' };
        return { color: 'var(--red)', interp: 'Severe â€” seizures, coma, cerebral oedema risk' };
      };

      // Corrected Na calculation
      const getCorrectedNa = () => {
        const na = parseFloat(naValue);
        const glu = parseFloat(glucose);
        if (isNaN(na) || isNaN(glu) || glu <= 10) return null;
        return (na + glu / 4).toFixed(1);
      };

      // Na display for branch cards
      const getNaDisplay = () => {
        const severity = getSeverity();
        return {
          value: naValue ? `${naValue} mmol/L` : '',
          interpretation: severity?.interp || '',
          color: severity?.color || 'var(--blue)'
        };
      };

      const getSerumOsmDisplay = () => {
        if (serumOsmResult === 'low') return { value: 'Low (< 275)', interpretation: 'Hypotonic', color: 'var(--blue)' };
        if (serumOsmResult === 'normal') return { value: 'Normal (275â€“295)', interpretation: 'Iso-osmolar', color: 'var(--green)' };
        if (serumOsmResult === 'high') return { value: 'High (> 295)', interpretation: 'Hyper-osmolar', color: 'var(--orange)' };
        if (serumOsmResult === 'skip') return { value: 'Not available', interpretation: 'Assumed hypotonic', color: 'var(--label3)' };
        return { value: '', interpretation: '', color: 'var(--blue)' };
      };

      const getUrineOsmDisplay = () => {
        if (urineOsmResult === 'low') return { value: 'Low (< 100)', interpretation: 'Dilute â€” kidneys working', color: 'var(--green)' };
        if (urineOsmResult === 'high') return { value: 'High (> 100)', interpretation: 'Concentrated â€” ADH active', color: 'var(--orange)' };
        return { value: '', interpretation: '', color: 'var(--blue)' };
      };

      const getUrineNaDisplay = () => {
        if (urineNaResult === 'low') return { value: 'Low (< 20â€“40)', interpretation: 'Retained â€” kidneys conserving', color: 'var(--green)' };
        if (urineNaResult === 'high') return { value: 'High (> 20â€“40)', interpretation: 'Wasted â€” sodium loss', color: 'var(--orange)' };
        return { value: '', interpretation: '', color: 'var(--blue)' };
      };

      // Na Correction Rate Calculator functions
      const addNaEntry = () => {
        setNaEntries([...naEntries, { na: '', hours: '' }]);
      };

      const updateNaEntry = (index, field, value) => {
        const newEntries = [...naEntries];
        newEntries[index][field] = value;
        setNaEntries(newEntries);
      };

      const removeNaEntry = (index) => {
        if (naEntries.length > 1) {
          setNaEntries(naEntries.filter((_, i) => i !== index));
        }
      };

      const calculateCorrectionRate = () => {
        // Need at least 2 valid entries with different times
        const validEntries = naEntries
          .map(e => ({ na: parseFloat(e.na), hours: parseFloat(e.hours) }))
          .filter(e => !isNaN(e.na) && !isNaN(e.hours))
          .sort((a, b) => a.hours - b.hours);

        if (validEntries.length < 2) return null;

        const first = validEntries[0];
        const last = validEntries[validEntries.length - 1];
        const timeDiff = last.hours - first.hours;

        if (timeDiff <= 0) return null;

        const naChange = last.na - first.na;
        const ratePerHour = naChange / timeDiff;
        const projected24h = ratePerHour * 24;

        // Find peak 24h increment (most rapid correction over any 24h window)
        let peak24h = Math.abs(naChange);
        if (timeDiff > 24) {
          // Check rolling 24h windows
          for (let i = 0; i < validEntries.length - 1; i++) {
            for (let j = i + 1; j < validEntries.length; j++) {
              const windowTime = validEntries[j].hours - validEntries[i].hours;
              if (windowTime <= 24) {
                const windowChange = Math.abs(validEntries[j].na - validEntries[i].na);
                if (windowChange > peak24h) peak24h = windowChange;
              }
            }
          }
        }

        // Status determination based on target rate
        let status, color;
        const absProjected = Math.abs(projected24h);
        const absPeak = peak24h;

        if (absPeak > targetRate || absProjected > targetRate * 1.2) {
          status = 'Exceeding target';
          color = 'var(--red)';
        } else if (absProjected > targetRate * 0.8) {
          status = 'Approaching target';
          color = 'var(--orange)';
        } else {
          status = 'Within target';
          color = 'var(--green)';
        }

        return {
          naChange: naChange.toFixed(1),
          timeDiff: timeDiff.toFixed(1),
          ratePerHour: ratePerHour.toFixed(2),
          projected24h: projected24h.toFixed(1),
          peak24h: peak24h.toFixed(1),
          status,
          color
        };
      };

      // Management screen
      if (showMgmt) {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', {
              onClick: () => setShowMgmt(false),
              style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' }
            }, 'â€¹ Back to results'),

            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Hyponatraemia')
            ),

            // Step 1: Seizure or Severe Symptoms
            e(MgmtStep, { number: 1, title: 'Seizure or Severe Symptoms', color: 'var(--red)' },
              e('span', null,
                e('strong', null, 'Hypertonic saline bolus'), ' â€” 3% NaCl or concentrated sodium bicarbonate over 10â€“20 minutes.',
                e('br', null),
                'Aim to increase Na by a small increment and then hold.',
                e('br', null),
                'Can repeat if ongoing seizure. Dosing per local protocol.'
              )
            ),

            // Step 2: Treat the Cause
            e(MgmtStep, { number: 2, title: 'Treat the Cause', color: 'var(--blue)' },
              e('span', null,
                'Stop drugs and fluids contributing to hyponatraemia.',
                e('br', null),
                'Treat underlying pathology:',
                e('br', null),
                'â€¢ Thyroxine for hypothyroidism',
                e('br', null),
                'â€¢ Corticosteroid for adrenal insufficiency',
                e('br', null),
                'â€¢ Tolvaptan for SIADH',
                e('br', null),
                'â€¢ Diuretics + ACEi for heart failure',
                e('br', null),
                'â€¢ Albumin + diuretics for cirrhosis'
              )
            ),

            // Step 3: Avoid Dangerous Overcorrection
            e(MgmtStep, { number: 3, title: 'Avoid Dangerous Overcorrection', color: 'var(--orange)' },
              e('span', null,
                'Allow Na to rise by ', e('strong', null, 'max 0.5 mmol/hr'), ' and ', e('strong', null, 'max 8â€“10 mmol/24hr'), '.'
              )
            ),

            e(WarningBanner, null,
              'Consider ', e('strong', null, 'DDAVP'), ' to prevent uncontrolled free water excretion. This gives you control: NaCl, nothing, or water to raise, stabilise, or lower Na respectively. Dosing per local protocol.'
            ),

            // Step 4: Fluid Strategy
            e(MgmtStep, { number: 4, title: 'Fluid Restrict vs Isotonic vs Hypertonic NaCl', color: 'var(--blue)' },
              e('div', { style: { marginTop: '8px' } },
                e('div', { style: { display: 'flex', background: 'var(--card)', borderRadius: '10px', border: '1px solid var(--sep)', overflow: 'hidden', marginBottom: '8px' } },
                  e('div', { style: { width: '4px', background: 'var(--blue)', flexShrink: 0 } }),
                  e('div', { style: { padding: '12px' } },
                    e('strong', null, 'Fluid restriction'),
                    e('div', { style: { fontSize: '13px', color: 'var(--label2)', marginTop: '4px' } }, 'If hypervolaemic or euvolaemic. UNLESS already oliguric or high urine osmolality (fluid restriction won\'t work if kidneys are already maximally concentrating).')
                  )
                ),
                e('div', { style: { display: 'flex', background: 'var(--card)', borderRadius: '10px', border: '1px solid var(--sep)', overflow: 'hidden', marginBottom: '8px' } },
                  e('div', { style: { width: '4px', background: 'var(--green)', flexShrink: 0 } }),
                  e('div', { style: { padding: '12px' } },
                    e('strong', null, 'Isotonic saline (0.9% NaCl)'),
                    e('div', { style: { fontSize: '13px', color: 'var(--label2)', marginTop: '4px' } }, 'If hypovolaemic. Replace the volume deficit.')
                  )
                ),
                e('div', { style: { display: 'flex', background: 'var(--card)', borderRadius: '10px', border: '1px solid var(--sep)', overflow: 'hidden' } },
                  e('div', { style: { width: '4px', background: 'var(--red)', flexShrink: 0 } }),
                  e('div', { style: { padding: '12px' } },
                    e('strong', null, 'Hypertonic saline (3% NaCl)'),
                    e('div', { style: { fontSize: '13px', color: 'var(--label2)', marginTop: '4px' } }, 'If Na is dangerously low or symptomatic. ICU setting. Controlled infusion with frequent Na monitoring.')
                  )
                )
              )
            ),

            // Na Correction Rate Calculator
            e('div', { style: { marginTop: '24px', padding: '16px', background: 'var(--card)', borderRadius: '12px', border: '1px solid var(--sep)' } },
              e('div', { style: { fontSize: '16px', fontWeight: 700, color: 'var(--label)', marginBottom: '4px' } }, 'Na Correction Rate Calculator'),
              e('div', { style: { fontSize: '13px', color: 'var(--label3)', marginBottom: '16px' } }, 'Track Na over time to monitor correction rate'),

              // Target rate selector
              e('div', { style: { marginBottom: '16px' } },
                e('div', { style: { fontSize: '13px', fontWeight: 600, color: 'var(--label2)', marginBottom: '8px' } }, '24h target (max acceptable rise):'),
                e('div', { style: { display: 'flex', gap: '8px', flexWrap: 'wrap' } },
                  [6, 8, 10, 12].map(rate =>
                    e('button', {
                      key: rate,
                      onClick: () => setTargetRate(rate),
                      style: {
                        padding: '8px 14px',
                        borderRadius: '8px',
                        border: targetRate === rate ? '2px solid var(--blue)' : '1px solid var(--sep)',
                        background: targetRate === rate ? 'rgba(10,132,255,0.1)' : 'var(--bg)',
                        color: targetRate === rate ? 'var(--blue)' : 'var(--label2)',
                        fontWeight: 600,
                        fontSize: '13px',
                        cursor: 'pointer',
                        fontFamily: 'var(--font)'
                      }
                    }, `${rate} mmol/24h`)
                  )
                )
              ),

              // Na entries
              e('div', { style: { marginBottom: '12px' } },
                naEntries.map((entry, index) =>
                  e('div', { key: index, style: { display: 'flex', gap: '8px', alignItems: 'center', marginBottom: '8px' } },
                    e('div', { style: { flex: 1 } },
                      e('label', { style: { fontSize: '11px', color: 'var(--label3)', display: 'block', marginBottom: '2px' } }, 'Na (mmol/L)'),
                      e('input', {
                        type: 'number',
                        value: entry.na,
                        onChange: (ev) => updateNaEntry(index, 'na', ev.target.value),
                        placeholder: '125',
                        style: {
                          width: '100%',
                          padding: '10px',
                          borderRadius: '8px',
                          border: '1px solid var(--sep)',
                          background: 'var(--bg)',
                          color: 'var(--label)',
                          fontSize: '15px',
                          fontFamily: 'var(--font)'
                        }
                      })
                    ),
                    e('div', { style: { flex: 1 } },
                      e('label', { style: { fontSize: '11px', color: 'var(--label3)', display: 'block', marginBottom: '2px' } }, 'Hours from start'),
                      e('input', {
                        type: 'number',
                        value: entry.hours,
                        onChange: (ev) => updateNaEntry(index, 'hours', ev.target.value),
                        placeholder: '0',
                        style: {
                          width: '100%',
                          padding: '10px',
                          borderRadius: '8px',
                          border: '1px solid var(--sep)',
                          background: 'var(--bg)',
                          color: 'var(--label)',
                          fontSize: '15px',
                          fontFamily: 'var(--font)'
                        }
                      })
                    ),
                    naEntries.length > 1 && e('button', {
                      onClick: () => removeNaEntry(index),
                      style: {
                        padding: '8px',
                        background: 'none',
                        border: 'none',
                        color: 'var(--red)',
                        cursor: 'pointer',
                        fontSize: '18px',
                        marginTop: '16px'
                      }
                    }, 'Ã—')
                  )
                )
              ),

              e('button', {
                onClick: addNaEntry,
                style: {
                  padding: '10px 16px',
                  borderRadius: '8px',
                  border: '1px dashed var(--sep)',
                  background: 'none',
                  color: 'var(--blue)',
                  fontWeight: 600,
                  fontSize: '13px',
                  cursor: 'pointer',
                  fontFamily: 'var(--font)',
                  width: '100%',
                  marginBottom: '16px'
                }
              }, '+ Add timepoint'),

              // Results
              calculateCorrectionRate() && e('div', { style: { padding: '12px', background: 'var(--bg)', borderRadius: '10px', border: `2px solid ${calculateCorrectionRate().color}` } },
                e('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '10px' } },
                  e('div', { style: { width: '10px', height: '10px', borderRadius: '50%', background: calculateCorrectionRate().color } }),
                  e('span', { style: { fontSize: '14px', fontWeight: 700, color: calculateCorrectionRate().color } }, calculateCorrectionRate().status)
                ),
                e('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' } },
                  e('div', null,
                    e('div', { style: { fontSize: '11px', color: 'var(--label3)' } }, 'Change'),
                    e('div', { style: { fontSize: '15px', fontWeight: 600, color: 'var(--label)' } }, `${calculateCorrectionRate().naChange} mmol`)
                  ),
                  e('div', null,
                    e('div', { style: { fontSize: '11px', color: 'var(--label3)' } }, 'Over'),
                    e('div', { style: { fontSize: '15px', fontWeight: 600, color: 'var(--label)' } }, `${calculateCorrectionRate().timeDiff} hours`)
                  ),
                  e('div', null,
                    e('div', { style: { fontSize: '11px', color: 'var(--label3)' } }, 'Rate'),
                    e('div', { style: { fontSize: '15px', fontWeight: 600, color: 'var(--label)' } }, `${calculateCorrectionRate().ratePerHour} mmol/hr`)
                  ),
                  e('div', null,
                    e('div', { style: { fontSize: '11px', color: 'var(--label3)' } }, 'Projected 24h'),
                    e('div', { style: { fontSize: '15px', fontWeight: 600, color: calculateCorrectionRate().color } }, `${calculateCorrectionRate().projected24h} mmol`)
                  )
                ),
                parseFloat(calculateCorrectionRate().timeDiff) < 24 && parseFloat(calculateCorrectionRate().projected24h) > targetRate && e('div', { style: { marginTop: '10px', padding: '8px', background: 'rgba(255,69,58,0.1)', borderRadius: '6px', fontSize: '12px', color: 'var(--red)' } },
                  'Warning: At this rate, Na will exceed target by 24h. Consider slowing correction or DDAVP.'
                )
              )
            ),

            e(LearnMoreDivider),

            // ODS Info Panel (updated evidence-based content)
            e(InfoPanel, { title: 'Osmotic Demyelination Syndrome (ODS)', color: 'var(--red)' },
              e('div', { style: { background: 'rgba(255,69,58,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'How common is it?'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Risk is approximately ', e('strong', null, '0.05%'), ' of hyponatraemia admissions (large Toronto cohort, n=22,858). However, if Na <110 mmol/L the risk rises to ', e('strong', null, '~3%'), '. Notably, many ODS cases did not have documented rapid correction â€” the cause is not fully understood.')
              ),
              e('div', { style: { background: 'rgba(255,69,58,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'High-risk features'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Na <110 mmol/L Â· Alcohol use disorder / beer potomania Â· Malnutrition Â· Advanced liver disease Â· Hypokalaemia Â· Post-transplant Â· Elderly')
              ),
              e('div', { style: { background: 'rgba(255,69,58,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'Safe rate of correction'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Evidence is slightly mixed. Some studies report ', e('strong', null, '4Ã— relative risk if rise >10â€“12 mmol/24h'), ' in severe hyponatraemia. However, a large 2025 JAMA meta-analysis found increased mortality with ', e('strong', null, 'slow'), ' correction â€” suggesting overcaution also carries risk.'),
                e('p', { style: { fontSize: '13px', marginTop: '6px' } }, 'Pragmatic target: ', e('strong', null, 'â‰¤8â€“10 mmol/L rise in any 24-hour period.'), ' Risk of ODS tracks to the fastest sodium rise (the peak 24h increment, not the average rate).')
              ),
              e('div', { style: { background: 'rgba(255,69,58,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                e('strong', null, 'If overcorrection occurs'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Re-lower Na with ', e('strong', null, 'DDAVP'), ' + D5W infusion. Aim to bring Na back to a safe correction rate. Consult nephrology.')
              )
            ),

            e(PrimaryButton, {
              label: 'New Analysis',
              color: 'var(--label3)',
              onClick: onBack
            })
          )
        );
      }

      // Main flow
      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Hyponatraemia', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--blue)' }),

          // SCREEN 0: Enter serum sodium (ValueInput, Next button)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Enter serum sodium'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'This determines the severity'),
            e(ValueInput, {
              label: 'Serum Sodium',
              unit: 'mmol/L',
              value: naValue,
              onChange: setNaValue,
              placeholder: '135 â€“ 145',
              hint: 'Normal: 135â€“145'
            }),
            getSeverity() && e(SeverityBadge, { text: getSeverity().interp, color: getSeverity().color }),
            e(PrimaryButton, {
              label: 'Next',
              disabled: !naValue,
              color: 'var(--blue)',
              onClick: () => goToStep(1)
            })
          ),

          // SCREEN 1: How quickly did this develop? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'How quickly did this develop?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'This determines safe correction rate'),
            e(ChoiceButton, {
              label: 'Acute  â€¹ 48 hours',
              sublabel: 'Higher risk of cerebral oedema. More aggressive correction tolerated.',
              selected: chronicity === 'acute',
              onClick: () => {
                clearAutoAdvance();
                setChronicity('acute');
                scheduleAdvance(() => goToStep(2), true); // 800ms - show warning
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Chronic  â€º 48 hours',
              sublabel: 'Brain has adapted. Rapid correction risks osmotic demyelination.',
              selected: chronicity === 'chronic',
              onClick: () => {
                clearAutoAdvance();
                setChronicity('chronic');
                scheduleAdvance(() => goToStep(2), true); // 800ms - show warning
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Unknown',
              sublabel: 'Treat as chronic (safer assumption)',
              selected: chronicity === 'unknown',
              onClick: () => {
                clearAutoAdvance();
                setChronicity('unknown');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--blue)'
            }),
            chronicity === 'acute' && e(WarningBanner, null, 'Higher risk of cerebral oedema. But safer to correct faster than in chronic hyponatraemia.'),
            chronicity === 'chronic' && e(WarningBanner, null, 'Brain has adapted. Rapid correction risks osmotic demyelination syndrome (ODS).')
          ),

          // SCREEN 2: Serum osmolality? (ChoiceButtons, auto-advance, branches)
          step === 2 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Serum osmolality?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'To exclude measurement error or dilutional effect'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 275 mOsm/kg',
              sublabel: 'True hypotonic hyponatraemia',
              selected: serumOsmResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('low');
                scheduleAdvance(() => goToStep(3), false); // Continue to urine osm
              },
              color: 'var(--blue)'
            }),
            e(ChoiceButton, {
              label: 'Normal  275â€“295 mOsm/kg',
              sublabel: 'Iso-osmolar â†’ pseudohyponatraemia',
              selected: serumOsmResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('normal');
                scheduleAdvance(() => goToStep(3), false); // Go to iso-osmolar results
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 295 mOsm/kg',
              sublabel: 'Hyper-osmolar â†’ dilutional effect',
              selected: serumOsmResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('high');
                scheduleAdvance(() => goToStep(3), false); // Go to glucose input
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Not available',
              sublabel: 'Assume hypotonic and proceed',
              selected: serumOsmResult === 'skip',
              onClick: () => {
                clearAutoAdvance();
                setSerumOsmResult('skip');
                scheduleAdvance(() => goToStep(3), false); // Continue to urine osm
              },
              color: 'var(--label3)'
            })
          ),

          // SCREEN 3: Path-dependent
          // If iso-osmolar â†’ Results
          step === 3 && isIsoOsmolar && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Interpretation'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Iso-osmolar hyponatraemia'),
            e(BranchCard, { label: 'Serum Sodium', ...getNaDisplay() }),
            e(BranchCard, { label: 'Serum Osm', ...getSerumOsmDisplay() }),
            e(ResultCard, {
              title: 'Pseudohyponatraemia',
              severity: 'consider',
              tags: ['Measurement artefact', 'Check Na on VBG']
            }, 'Usually measurement error secondary to hyperlipidaemia or hyperproteinaemia. Check Na on VBG (direct ion-selective electrode).'),
            e(PrimaryButton, { label: 'View Management', color: 'var(--blue)', onClick: () => setShowMgmt(true) }),
            e(LearnMoreDivider),
            e(InfoPanel, { title: 'Tonicity vs Osmolality', color: 'var(--blue)' },
              e('p', { style: { marginBottom: '10px' } }, 'Urea and ethanol contribute to measured osmolality but are ineffective osmoles (cross cell membranes freely).'),
              e('p', null, 'Tonicity = Osmolality âˆ’ Urea. If in doubt, calculate tonicity or check Na on VBG.')
            ),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          ),

          // If hyper-osmolar â†’ Glucose input screen
          step === 3 && isHyperOsmolar && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Enter glucose'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'To calculate corrected sodium'),
            e(ValueInput, {
              label: 'Glucose',
              unit: 'mmol/L',
              value: glucose,
              onChange: setGlucose,
              placeholder: 'Enter value',
              hint: 'For corrected Na calculation'
            }),
            getCorrectedNa() && e(BranchCard, {
              label: 'Corrected Na',
              value: `${getCorrectedNa()} mmol/L`,
              interpretation: 'Predicted Na once glucose normalises',
              color: 'var(--blue)'
            }),
            e(PrimaryButton, {
              label: 'See Results',
              color: 'var(--blue)',
              onClick: () => goToStep(4)
            })
          ),

          // If hypotonic â†’ Urine Osmolality
          step === 3 && !isShortPath && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Urine osmolality?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Is the kidney diluting appropriately?'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 100 mOsm/kg',
              sublabel: 'Kidneys ARE diluting â€” problem is excess water intake',
              selected: urineOsmResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setUrineOsmResult('low');
                scheduleAdvance(() => goToStep(4), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 100 mOsm/kg',
              sublabel: 'Kidneys NOT diluting â€” ADH is active',
              selected: urineOsmResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setUrineOsmResult('high');
                scheduleAdvance(() => goToStep(4), true); // 800ms - show warning
              },
              color: 'var(--orange)'
            }),
            urineOsmResult === 'high' && e(WarningBanner, null, 'Urinary biochemistry is confounded by diuretics, vasopressin, and DDAVP. Interpret with caution.')
          ),

          // SCREEN 4: Path-dependent
          // If hyper-osmolar â†’ Results
          step === 4 && isHyperOsmolar && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Interpretation'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Hyper-osmolar hyponatraemia'),
            e(BranchCard, { label: 'Serum Sodium', ...getNaDisplay() }),
            e(BranchCard, { label: 'Serum Osm', ...getSerumOsmDisplay() }),
            getCorrectedNa() && e(BranchCard, {
              label: 'Corrected Na',
              value: `${getCorrectedNa()} mmol/L`,
              interpretation: 'Predicted Na once glucose normalises',
              color: 'var(--blue)'
            }),
            e(ResultCard, {
              title: 'Hyper-osmolar Hyponatraemia',
              severity: 'likely',
              tags: ['Hyperglycaemia', 'Mannitol', 'IVIg']
            }, 'Dilutional effect â€” water drawn into intravascular space by osmotically active solutes.'),
            e(WarningBanner, null, 'Risk of cerebral oedema if BSL is corrected without commensurate rise in Na.'),
            e(PrimaryButton, { label: 'View Management', color: 'var(--blue)', onClick: () => setShowMgmt(true) }),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          ),

          // If hypotonic â†’ Urine Sodium
          step === 4 && !isShortPath && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Urine sodium?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Is the kidney conserving sodium?'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 30 mmol/L',
              sublabel: 'Kidneys retaining sodium appropriately',
              selected: urineNaResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setUrineNaResult('low');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 30 mmol/L',
              sublabel: 'Kidneys wasting sodium',
              selected: urineNaResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setUrineNaResult('high');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--orange)'
            })
          ),

          // SCREEN 5: Hypotonic Results (full differential)
          step === 5 && !isShortPath && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Interpretation'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Hypotonic hyponatraemia'),

            // Branch cards showing path (only on Results)
            e(BranchCard, { label: 'Serum Sodium', ...getNaDisplay() }),
            e(BranchCard, { label: 'Serum Osm', ...getSerumOsmDisplay() }),
            e(BranchCard, { label: 'Urine Osm', ...getUrineOsmDisplay() }),
            e(BranchCard, { label: 'Urine Na', ...getUrineNaDisplay() }),

            e('div', {
              style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' }
            }, 'DIFFERENTIAL DIAGNOSIS'),

            // PATH A: Low Urine Osm + Low Urine Na
            urineOsmResult === 'low' && urineNaResult === 'low' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Excess Water Intake',
                severity: 'likely',
                tags: ['Polydipsia', 'Excess IV fluid', 'Beer potomania']
              }, 'Huge water intake exceeding renal capacity to defend tonicity, even with maximally dilute urine.'),
              e(DiffCard, { title: 'Excess IV fluid', description: 'Iatrogenic. Review fluid orders.' }),
              e(DiffCard, { title: 'Primary polydipsia', description: 'Psychiatric or medication-related. Water intake often >10L/day.' }),
              e(DiffCard, { title: 'Beer potomania', description: 'Very low solute diet limits renal free water excretion capacity.' }),
              e(DiffCard, { title: 'Reset osmostat', description: 'Rare. Osmostat set lower but regulation intact. No treatment required.' }),
              e(WarningBanner, null, 'Rx fluid restriction â€” but beware rapid Na rise, especially if the cause of excess water intake is removed (e.g. stopping IV fluids). Monitor closely for overcorrection.')
            ),

            // PATH B: Low Urine Osm + High Urine Na
            urineOsmResult === 'low' && urineNaResult === 'high' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Renal Salt & Water Wasting',
                severity: 'consider',
                tags: ['AKI', 'Post-obstructive', 'ATN']
              }, 'Kidneys are wasting both salt and water â€” unable to concentrate or conserve sodium.'),
              e(DiffCard, { title: 'AKI (GFR <15)', description: 'Severely reduced GFR impairs all tubular function.' }),
              e(DiffCard, { title: 'Post-obstructive diuresis', description: 'After relief of urinary obstruction. Can be massive.' }),
              e(DiffCard, { title: 'Polyuric phase of ATN', description: 'Recovery phase of acute tubular necrosis.' })
            ),

            // PATH C: High Urine Osm + Low Urine Na
            urineOsmResult === 'high' && urineNaResult === 'low' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Hypovolaemia or Effective Hypovolaemia',
                severity: 'likely',
                tags: ['Volume depletion', 'Heart failure', 'Liver failure', 'Nephrotic syndrome']
              }, 'Actual or effective hypovolaemia â†’ RAAS overactivation. The body is defending volume over tonicity â†’ water retention.'),
              e(InfoPanel, { title: 'Volume over Tonicity', color: 'var(--blue)' },
                e('p', null, 'The baroreceptor reflex is a stronger stimulus for ADH release than the osmoreceptor reflex. When intravascular volume is low (or perceived as low â€” heart failure, liver failure), the body will retain water even at the expense of worsening hyponatraemia. This is because volume depletion kills faster than low sodium.')
              ),
              e(DiffCard, { title: 'True hypovolaemia', description: 'Bleeding, GI losses, third-spacing. Look for tachycardia, orthostatic hypotension, poor skin turgor.' }),
              e(DiffCard, { title: 'Heart failure', description: 'Effective hypovolaemia despite total body fluid overload. Poor cardiac output â†’ RAAS activation.' }),
              e(DiffCard, { title: 'Liver failure / cirrhosis', description: 'Splanchnic vasodilation â†’ effective hypovolaemia. Ascites present.' }),
              e(DiffCard, { title: 'Nephrotic syndrome', description: 'Hypoalbuminaemia â†’ reduced oncotic pressure â†’ effective hypovolaemia.' }),
              e('div', {
                style: {
                  background: 'rgba(48,209,88,0.08)',
                  border: '1px solid rgba(48,209,88,0.2)',
                  borderRadius: '14px',
                  padding: '14px 16px',
                  marginTop: '12px',
                  marginBottom: '12px'
                }
              },
                e('div', { style: { fontWeight: 700, color: 'var(--green)', marginBottom: '4px' } }, 'Management note'),
                e('div', { style: { fontSize: '13px', color: 'var(--label2)', lineHeight: 1.55 } }, 'Rx: ACEi + loop diuretic for heart failure/liver failure/nephrotic syndrome. IV saline for true hypovolaemia. Do NOT fluid restrict oedematous patients â€” they are intravascularly deplete.')
              )
            ),

            // PATH D: High Urine Osm + High Urine Na
            urineOsmResult === 'high' && urineNaResult === 'high' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Water Retention with Sodium Wasting',
                severity: 'likely',
                tags: ['SIADH', 'Adrenal insufficiency', 'Hypothyroidism', 'Cerebral salt wasting']
              }, 'ADH is active (water retention) AND kidneys are wasting sodium. This is the broadest differential â€” clinical context is critical.'),

              e(DiffCard, { title: 'SIADH', description: 'Most common cause of euvolaemic hyponatraemia. Diagnosis of exclusion: euvolaemic, no adrenal insufficiency, no hypothyroidism, no renal failure, no diuretics. Oliguric (concentrated urine).' }),

              e(DiffCard, { title: 'Adrenal insufficiency (Addison\'s, pan-hypopit)', description: 'Aldosterone deficiency â†’ Na wasting. Cortisol deficiency â†’ impaired free water excretion.' }),
              e('div', {
                style: {
                  background: 'rgba(255,69,58,0.06)',
                  border: '1px solid rgba(255,69,58,0.15)',
                  borderRadius: '10px',
                  padding: '10px 12px',
                  marginBottom: '6px',
                  fontSize: '12px',
                  color: '#C41E10',
                  fontWeight: 500
                }
              }, 'Must exclude adrenal insufficiency before diagnosing SIADH. Check morning cortisol Â± short synacthen test.'),

              e(DiffCard, { title: 'Hypothyroidism', description: 'Mechanism unclear but well-recognised association. Check TFTs.' }),

              e(DiffCard, { title: 'Cerebral salt wasting', description: 'Polyuric (unlike SIADH which is oliguric). Related to â†‘BNP/ANP â†’ natriuresis â†’ hypovolaemia. Appropriate ADH secretion to compensate.' }),

              e(DiffCard, { title: 'Thiazide diuretic', description: 'Common and frequently overlooked. Thiazides impair diluting capacity in the distal tubule. Loop diuretics are LESS likely to cause hyponatraemia (they impair concentrating ability).' }),

              e(DiffCard, { title: 'AKI (GFR <15)', description: 'Impaired dilution and sodium handling.' }),

              e(DiffCard, { title: 'Post-obstructive diuresis / Polyuric ATN', description: 'Recovery phase â€” kidneys wasting everything.' }),

              e(InfoPanel, { title: 'Physiology of Key Diagnoses', color: 'var(--blue)' },
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Renal salt wasting:'), ' Failure of ATP-dependent Na+/K+ ATPase. Renal ADH responsiveness variable, thus urine osmolality variable.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Hypoaldosteronism:'), ' ENaC + uninhibited ADH release â†’ Na wasting + water retention. Giveaway is hyperkalaemia.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Hypothyroidism:'), ' Mechanism unclear.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Oedematous disorders:'), ' Hypotension/intravascular hypovolaemia â†’ ADH release + overactivation of RAAS â†’ Na and water retention. Baroreceptor reflex is a stronger stimulus for ADH release than the osmoreceptor reflex. IE: body will defend volume over tonicity.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                  e('strong', null, 'Cerebral salt wasting:'), ' Poorly understood. Related to â†‘BNP/ANP â†’ natriuresis â†’ polyuria and hypovolaemia. Appropriate secretion of ADH to compensate.'
                )
              ),

              e(InfoPanel, { title: 'SIADH vs Cerebral Salt Wasting â€” the Key Distinction', color: 'var(--blue)' },
                e('p', { style: { marginBottom: '12px' } }, 'Both cause hyponatraemia with high urine osm and high urine Na. The critical difference is volume status:'),
                e('div', { style: { display: 'flex', gap: '8px', marginBottom: '12px' } },
                  e('div', { style: { flex: 1, background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                    e('strong', { style: { color: 'var(--blue)' } }, 'SIADH:'),
                    e('div', { style: { fontSize: '12px', marginTop: '4px' } }, 'Euvolaemic or mildly hypervolaemic. Oliguric. Urine osm typically >300. Treatment: fluid restriction, tolvaptan.')
                  ),
                  e('div', { style: { flex: 1, background: 'rgba(255,159,10,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                    e('strong', { style: { color: 'var(--orange)' } }, 'CSW:'),
                    e('div', { style: { fontSize: '12px', marginTop: '4px' } }, 'Hypovolaemic. Polyuric. High urine output. Treatment: isotonic or hypertonic saline (fluid restriction will worsen hypovolaemia and Na).')
                  )
                ),
                e('p', { style: { fontWeight: 600, color: 'var(--red)' } }, 'Getting this wrong matters: fluid restricting a CSW patient worsens their hypovolaemia and hyponatraemia.')
              )
            ),

            // Bottom buttons (for all result paths)
            e('div', { style: { marginTop: '20px' } },
              e(PrimaryButton, {
                label: 'View Management',
                color: 'var(--blue)',
                onClick: () => setShowMgmt(true)
              }),
              e(PrimaryButton, {
                label: 'New Analysis',
                color: 'var(--label3)',
                onClick: onBack
              })
            )
          )
        )
      );
    }

    // ========== IRON STUDIES MODULE ==========

    function IronModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Inflammation
      const [hasInflammation, setHasInflammation] = useState(null);
      // Screen 1: Clinical context
      const [clinicalContext, setClinicalContext] = useState(null);
      // Screen 2: Ferritin
      const [ferritinResult, setFerritinResult] = useState(null);
      // Screen 3: TSAT input
      const [serumIron, setSerumIron] = useState('');
      const [transferrin, setTransferrin] = useState('');
      const [tsat, setTsat] = useState('');
      // Screen 4: TSAT interpretation
      const [tsatResult, setTsatResult] = useState(null);
      // Screen 5: Results
      const [showMgmt, setShowMgmt] = useState(false);

      // 6 screens: Inflammation, Context, Ferritin, TSAT input, TSAT interp, Results
      const getTotalScreens = () => 6;

      const scrollToTop = () => {
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const goToStep = (s) => { setStep(s); scrollToTop(); };

      const handleBack = () => {
        clearAutoAdvance();
        if (showMgmt) setShowMgmt(false);
        else if (step === 0) onBack();
        else goToStep(step - 1);
      };

      // Calculate TSAT from iron and transferrin
      const calcTsat = () => {
        const iron = parseFloat(serumIron);
        const tf = parseFloat(transferrin);
        if (!isNaN(iron) && !isNaN(tf) && tf > 0) {
          return ((iron / (tf * 25)) * 100).toFixed(1);
        }
        return null;
      };

      const effectiveTsat = tsat || calcTsat();

      const getInflammationDisplay = () => ({
        value: hasInflammation ? 'Present' : 'Absent',
        interpretation: hasInflammation ? 'Adjusted thresholds apply' : 'Standard thresholds',
        color: hasInflammation ? 'var(--orange)' : 'var(--green)'
      });

      const getFerritinDisplay = () => {
        const labels = { veryLow: 'Very Low (< 15)', lowNormal: 'Low-Normal (15â€“100)', normal: 'Normal (30â€“300)', high: 'High (> 300)', veryHigh: 'Very High (> 1000)' };
        const interps = { veryLow: 'Absolute iron deficiency', lowNormal: 'Possible deficiency', normal: 'Stores adequate', high: 'Elevated', veryHigh: 'Urgent evaluation' };
        const colors = { veryLow: 'var(--red)', lowNormal: 'var(--orange)', normal: 'var(--green)', high: 'var(--orange)', veryHigh: 'var(--red)' };
        return { value: labels[ferritinResult] || '', interpretation: interps[ferritinResult] || '', color: colors[ferritinResult] || 'var(--blue)' };
      };

      const getTsatDisplay = () => {
        if (tsatResult === 'low') return { value: effectiveTsat ? `${effectiveTsat}%` : '< 16%', interpretation: 'Low â€” iron deficient erythropoiesis', color: 'var(--red)' };
        if (tsatResult === 'high') return { value: effectiveTsat ? `${effectiveTsat}%` : '> 45%', interpretation: 'High â€” iron overload', color: 'var(--orange)' };
        return { value: effectiveTsat ? `${effectiveTsat}%` : '16â€“45%', interpretation: 'Normal', color: 'var(--green)' };
      };

      // Management screen
      if (showMgmt) {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', { onClick: () => setShowMgmt(false), style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' } }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Iron Deficiency')
            ),
            e(MgmtStep, { number: 1, title: 'Oral Iron', color: 'var(--red)' },
              e('span', null, 'Ferrous salt preparations on empty stomach. ', e('strong', null, 'Alternate day dosing'), ' may improve absorption â€” hepcidin rises after a dose, reducing next-day absorption.', e('br'), 'Continue 3â€“6 months after Hb normalises to replenish stores.', e('br'), 'Side effects: nausea, constipation, black stools â€” major adherence barrier.')
            ),
            e(MgmtStep, { number: 2, title: 'IV Iron', color: 'var(--red)' },
              e('span', null, e('strong', null, 'Preferred if:'), ' oral intolerance, malabsorption, ongoing losses exceeding oral replacement, CKD, heart failure, pre-operative urgency, active IBD.', e('br'), 'Multiple IV iron formulations available (e.g. ferric carboxymaltose, iron polymaltose). Dosing per local formulary.')
            ),
            e(WarningBanner, null, e('strong', null, 'Some IV iron formulations can cause hypophosphataemia'), ' â€” check phosphate at 2 weeks, especially if repeat dosing.'),
            e(MgmtStep, { number: 3, title: 'Transfusion', color: 'var(--red)' }, 'Reserve for haemodynamic instability or active severe bleeding. Iron deficiency alone is almost never an indication for transfusion.'),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', fontStyle: 'italic', marginTop: '16px', padding: '12px', background: 'var(--bg)', borderRadius: '8px' } },
              'Dosing should follow local formulary guidelines. This app provides interpretation guidance only.'
            ),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          )
        );
      }

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Iron Studies', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--red)' }),

          // SCREEN 0: Is there active inflammation? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Is there active inflammation?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'This changes ferritin interpretation'),
            e(ChoiceButton, {
              label: 'Yes â€” CRP elevated',
              sublabel: 'Ferritin thresholds adjusted upward',
              selected: hasInflammation === true,
              onClick: () => {
                clearAutoAdvance();
                setHasInflammation(true);
                scheduleAdvance(() => goToStep(1), true); // 800ms for warning
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'No â€” stable outpatient',
              sublabel: 'Standard ferritin thresholds apply',
              selected: hasInflammation === false,
              onClick: () => {
                clearAutoAdvance();
                setHasInflammation(false);
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--green)'
            }),
            hasInflammation === true && e(WarningBanner, null, e('strong', null, 'Ferritin is an acute phase reactant.'), ' A "normal" ferritin does NOT exclude iron deficiency when CRP is elevated.')
          ),

          // SCREEN 1: Specific clinical context? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Specific clinical context?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'CKD and heart failure have different thresholds'),
            e(ChoiceButton, {
              label: 'CKD or haemodialysis',
              sublabel: 'Ferritin <200 with TSAT <20% suggests iron deficiency',
              selected: clinicalContext === 'ckd',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('ckd');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Heart failure',
              sublabel: 'Ferritin <100, or 100â€“300 with TSAT <20%',
              selected: clinicalContext === 'heartFailure',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('heartFailure');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'None of the above',
              sublabel: 'Standard thresholds',
              selected: clinicalContext === 'none',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('none');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--blue)'
            })
          ),

          // SCREEN 2: Ferritin level? (ChoiceButtons, auto-advance)
          step === 2 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Ferritin level?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'The starting point â€” interpret with context'),
            e(ChoiceButton, {
              label: 'Very low  â€¹ 15 (F) / â€¹ 30 (M)',
              sublabel: 'Absolute iron deficiency â€” diagnostic',
              selected: ferritinResult === 'veryLow',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('veryLow');
                scheduleAdvance(() => goToStep(3), true); // 800ms for warning
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Low-normal  15â€“100',
              sublabel: 'Iron deficiency possible',
              selected: ferritinResult === 'lowNormal',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('lowNormal');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Normal  30â€“300',
              sublabel: 'Stores adequate (may be masked by inflammation)',
              selected: ferritinResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('normal');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 300',
              sublabel: 'Iron overload OR acute phase response',
              selected: ferritinResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('high');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Very high  â€º 1000',
              sublabel: 'Iron overload, malignancy, liver necrosis, HLH',
              selected: ferritinResult === 'veryHigh',
              onClick: () => {
                clearAutoAdvance();
                setFerritinResult('veryHigh');
                scheduleAdvance(() => goToStep(3), true); // 800ms for warning
              },
              color: 'var(--red)'
            }),
            ferritinResult === 'veryLow' && e(WarningBanner, null, e('strong', null, 'Diagnostic.'), ' Ferritin this low confirms iron deficiency regardless of other values.'),
            ferritinResult === 'veryHigh' && e(WarningBanner, null, e('strong', null, 'Urgent evaluation.'), ' Consider HLH, Still\'s disease, hepatic necrosis, massive iron overload.')
          ),

          // SCREEN 3: Transferrin saturation (ValueInputs, Next button)
          step === 3 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Transferrin saturation'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Enter TSAT directly or calculate from iron + transferrin'),
            e('div', { style: { background: 'rgba(142,142,147,0.08)', borderRadius: '14px', padding: '16px', marginBottom: '16px' } },
              e(ValueInput, { label: 'TSAT', unit: '%', value: tsat, onChange: setTsat, placeholder: '16â€“45', hint: 'Normal: 16â€“45%' }),
              e('div', { style: { textAlign: 'center', fontSize: '12px', color: 'var(--label3)', margin: '8px 0' } }, 'â€” OR calculate â€”'),
              e(ValueInput, { label: 'Serum Iron', unit: 'Âµmol/L', value: serumIron, onChange: setSerumIron, placeholder: '10â€“30' }),
              e(ValueInput, { label: 'Transferrin', unit: 'g/L', value: transferrin, onChange: setTransferrin, placeholder: '1.7â€“3.4' }),
              calcTsat() && !tsat && e('div', { style: { fontSize: '13px', color: 'var(--green)', fontWeight: 600, marginTop: '8px' } }, `Calculated: ${calcTsat()}%`)
            ),
            e(PrimaryButton, { label: 'Next', disabled: !effectiveTsat, color: 'var(--red)', onClick: () => goToStep(4) })
          ),

          // SCREEN 4: TSAT interpretation (ChoiceButtons, auto-advance)
          step === 4 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'TSAT interpretation'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, effectiveTsat ? `Your TSAT: ${effectiveTsat}%` : 'Classify the TSAT result'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 16%',
              sublabel: 'Iron deficient erythropoiesis',
              selected: tsatResult === 'low',
              onClick: () => {
                clearAutoAdvance();
                setTsatResult('low');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Normal  16â€“45%',
              sublabel: 'Adequate iron supply',
              selected: tsatResult === 'normal',
              onClick: () => {
                clearAutoAdvance();
                setTsatResult('normal');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 45%',
              sublabel: 'Iron overload â€” excess unbound iron',
              selected: tsatResult === 'high',
              onClick: () => {
                clearAutoAdvance();
                setTsatResult('high');
                scheduleAdvance(() => goToStep(5), false);
              },
              color: 'var(--orange)'
            })
          ),

          // SCREEN 5: Results
          step === 5 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Pattern recognition')
            ),
            e(BranchCard, { label: 'Inflammation', ...getInflammationDisplay() }),
            e(BranchCard, { label: 'Ferritin', ...getFerritinDisplay() }),
            e(BranchCard, { label: 'TSAT', ...getTsatDisplay() }),
            e('div', { style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' } }, 'DIFFERENTIAL DIAGNOSIS'),

            // Pattern: Ferritin low/low-normal + TSAT low
            (ferritinResult === 'veryLow' || ferritinResult === 'lowNormal') && tsatResult === 'low' && e(React.Fragment, null,
              e(ResultCard, { title: 'Iron Deficiency Anaemia', severity: 'likely', tags: ['Classic pattern', 'Investigate cause'] }, 'Low ferritin + low TSAT = straightforward iron deficiency. Transferrin/TIBC will typically be elevated (body upregulating iron transport).'),
              e(WarningBanner, null, e('strong', null, 'Iron deficiency demands investigation.'), ' All males and post-menopausal females require upper + lower GI endoscopy to exclude malignancy. Check coeliac serology (tissue transglutaminase antibody) in all unexplained cases.')
            ),

            // Pattern: Ferritin normal + TSAT low (with inflammation)
            ferritinResult === 'normal' && tsatResult === 'low' && hasInflammation && e(React.Fragment, null,
              e(ResultCard, { title: 'Iron Deficiency Masked by Inflammation', severity: 'likely', tags: ['Ferritin falsely normal', 'TSAT is the giveaway'] }, 'This is the most common diagnostic trap in hospital medicine. Ferritin appears \'normal\' because inflammation has raised it, but low TSAT reveals inadequate iron delivery to the marrow.'),
              e(InfoPanel, { title: 'The Hardest Call in Iron Studies', color: 'var(--red)' },
                e('p', { style: { marginBottom: '10px' } }, 'The patient has both iron deficiency AND active inflammation (e.g. RA, IBD, CKD, malignancy). Ferritin is elevated by inflammation â†’ looks \'normal\' even though stores are depleted. Transferrin is suppressed â†’ TIBC doesn\'t rise as expected. TSAT becomes the most reliable discriminator: if <20% with inflammation, iron deficiency is very likely even with ferritin 100â€“300.'),
                e('p', { style: { marginBottom: '10px' } }, e('strong', null, 'Soluble transferrin receptor (sTfR):'), ' Not affected by inflammation. â†‘ sTfR suggests true iron deficiency. sTfR/log ferritin ratio >2 strongly supports iron deficiency. Not universally available but very useful.'),
                e('p', null, e('strong', null, 'Pragmatic approach:'), ' If in doubt and the patient is symptomatic, a trial of IV iron is both diagnostic and therapeutic. If Hb rises, they were iron deficient.')
              )
            ),

            // Pattern: Ferritin normal + TSAT normal (with inflammation)
            ferritinResult === 'normal' && tsatResult === 'normal' && hasInflammation && e(ResultCard, { title: 'Anaemia of Chronic Disease', severity: 'consider', tags: ['Inflammatory iron sequestration', 'Iron trapped in macrophages'] }, 'Inflammatory cytokines + hepcidin â†’ iron sequestered in macrophages, unavailable for erythropoiesis. Iron stores are adequate (normal ferritin) and iron supply is maintained (normal TSAT). Low serum iron with low transferrin is typical.'),

            // Pattern: Ferritin high + TSAT high
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'high' && e(React.Fragment, null,
              e(ResultCard, { title: 'Iron Overload', severity: 'dangerous', tags: ['Haemochromatosis', 'Transfusional', 'Check HFE genotype'] }, 'Elevated ferritin with TSAT >45% (especially >60%) strongly suggests true iron overload. Check HFE gene (C282Y homozygosity = hereditary haemochromatosis). If transfusion-dependent, consider chelation therapy.'),
              e(ResultCard, { title: 'Liver Disease', subtitle: 'Can mimic iron overload', severity: 'consider', tags: ['Hepatocyte damage', 'Ferritin leak'] }, 'Damaged hepatocytes leak ferritin into serum. TSAT may be normal or elevated. Check LFTs. Liver disease + iron overload can coexist (e.g. haemochromatosis with cirrhosis).')
            ),

            // Pattern: Ferritin high + TSAT normal
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'normal' && e(React.Fragment, null,
              e(ResultCard, { title: 'Acute Phase Response', severity: 'likely', tags: ['Inflammation', 'Liver disease', 'Recheck when stable'] }, 'Elevated ferritin with normal TSAT most likely reflects an acute phase response rather than true iron overload. Recheck when inflammation has resolved.'),
              e(ResultCard, { title: 'Liver Disease', severity: 'consider', tags: ['Ferritin leak from hepatocytes'] })
            ),

            // Pattern: Ferritin high + TSAT low
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'low' && e(ResultCard, { title: 'Anaemia of Chronic Disease (severe)', severity: 'consider', tags: ['Hepcidin-mediated', 'Iron trapped'] }, 'High ferritin (inflammation) + low TSAT (no iron reaching marrow). Iron is present in stores but trapped by hepcidin-mediated sequestration.'),

            // Ferritin very high
            ferritinResult === 'veryHigh' && e(ResultCard, { title: 'Urgent Evaluation Required', severity: 'dangerous', tags: ['HLH', 'Malignancy', 'Hepatic necrosis', 'Still\'s disease'] }, 'Ferritin >1000 Âµg/L narrows the differential significantly. Consider haemophagocytic lymphohistiocytosis (HLH â€” check triglycerides, fibrinogen, LDH, soluble IL-2R), adult-onset Still\'s disease (quotidian fevers, rash, arthritis), hepatic necrosis, or massive iron overload.'),

            // Investigation info for iron deficiency
            (tsatResult === 'low' || ferritinResult === 'veryLow' || ferritinResult === 'lowNormal') && e(InfoPanel, { title: 'When to Scope', color: 'var(--red)' },
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Mandatory GI investigation:'), ' All males, all post-menopausal females with unexplained iron deficiency.'),
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Pre-menopausal females:'), ' Investigate if GI symptoms, family history of GI cancer, or iron deficiency not explained by menstrual losses.'),
              e('p', null, e('strong', null, 'Coeliac serology'), ' should be checked in all cases of unexplained iron deficiency.')
            ),

            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory. Verify against your local laboratory\'s reference ranges.'),
            e('div', { style: { marginTop: '16px' } },
              (tsatResult === 'low' || ferritinResult === 'veryLow' || ferritinResult === 'lowNormal') && e(PrimaryButton, { label: 'View Management', color: 'var(--red)', onClick: () => setShowMgmt(true) }),
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
            )
          )
        )
      );
    }

    // ========== CALCIUM & PTH MODULE ==========

    function CalciumModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Calcium input
      const [useIonised, setUseIonised] = useState(false);
      const [totalCa, setTotalCa] = useState('');
      const [albumin, setAlbumin] = useState('');
      const [ionisedCa, setIonisedCa] = useState('');
      const [phosphate, setPhosphate] = useState('');
      const [vitD, setVitD] = useState('');
      const [magnesium, setMagnesium] = useState('');
      // Screen 1: PTH (if abnormal)
      const [calciumDirection, setCalciumDirection] = useState(null);
      const [pthResult, setPthResult] = useState(null);
      // Screen 2: Results
      const [showMgmt, setShowMgmt] = useState(false);
      const [mgmtType, setMgmtType] = useState(null);

      // Normal calcium: 2 screens (input, results). Abnormal: 3 screens (input, PTH, results)
      const getTotalScreens = () => calciumDirection === 'normal' ? 2 : 3;

      const scrollToTop = () => { if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'smooth' }); };
      const goToStep = (s) => { setStep(s); scrollToTop(); };
      const handleBack = () => {
        clearAutoAdvance();
        if (showMgmt) setShowMgmt(false);
        else if (step === 0) onBack();
        else goToStep(step - 1);
      };

      // Corrected calcium calculation
      const getCorrectedCa = () => {
        const ca = parseFloat(totalCa);
        const alb = parseFloat(albumin);
        if (!isNaN(ca) && !isNaN(alb)) return (ca + 0.02 * (40 - alb)).toFixed(2);
        return null;
      };

      // Get effective calcium value
      const getEffectiveCa = () => {
        if (useIonised) return parseFloat(ionisedCa);
        return parseFloat(getCorrectedCa());
      };

      // Classify calcium
      const classifyCa = () => {
        const ca = getEffectiveCa();
        if (isNaN(ca)) return null;
        if (useIonised) {
          if (ca < 1.12) return 'low';
          if (ca > 1.30) return 'high';
          return 'normal';
        } else {
          if (ca < 2.15) return 'low';
          if (ca > 2.55) return 'high';
          return 'normal';
        }
      };

      const getSeverity = () => {
        const ca = getEffectiveCa();
        if (isNaN(ca)) return null;
        if (useIonised) {
          if (ca > 1.50) return { color: 'var(--red)', text: 'Severe / Crisis' };
          if (ca > 1.40) return { color: 'var(--orange)', text: 'Moderate' };
          if (ca > 1.30) return { color: 'var(--orange)', text: 'Mild' };
          if (ca < 0.9) return { color: 'var(--red)', text: 'Severe' };
          if (ca < 1.12) return { color: 'var(--orange)', text: 'Low' };
          return { color: 'var(--green)', text: 'Normal' };
        } else {
          if (ca > 3.5) return { color: 'var(--red)', text: 'Severe / Crisis â€” dehydration, renal failure, coma' };
          if (ca > 3.0) return { color: 'var(--orange)', text: 'Moderate â€” nausea, polyuria, confusion' };
          if (ca > 2.55) return { color: 'var(--orange)', text: 'Mild â€” often asymptomatic' };
          if (ca < 1.8) return { color: 'var(--red)', text: 'Severe' };
          if (ca < 2.15) return { color: 'var(--orange)', text: 'Low' };
          return { color: 'var(--green)', text: 'Normal' };
        }
      };

      const getCaDisplay = () => {
        const ca = getEffectiveCa();
        const sev = getSeverity();
        return { value: useIonised ? `${ionisedCa} mmol/L (ionised)` : `${getCorrectedCa()} mmol/L (corrected)`, interpretation: sev?.text || '', color: sev?.color || 'var(--blue)' };
      };

      const getPthDisplay = () => {
        if (calciumDirection === 'high') {
          if (pthResult === 'high') return { value: 'High / inappropriately normal', interpretation: 'PTH-mediated', color: 'var(--orange)' };
          return { value: 'Low (suppressed)', interpretation: 'PTH-independent', color: 'var(--blue)' };
        } else {
          if (pthResult === 'low') return { value: 'Low / inappropriately normal', interpretation: 'Hypoparathyroidism', color: 'var(--red)' };
          return { value: 'High (appropriate)', interpretation: 'Secondary hyperparathyroidism', color: 'var(--orange)' };
        }
      };

      // Management screens
      if (showMgmt) {
        const isHyperCa = mgmtType === 'hyperCa';
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', { onClick: () => setShowMgmt(false), style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' } }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, isHyperCa ? 'Hypercalcaemia' : 'Hypocalcaemia')
            ),
            isHyperCa ? e(React.Fragment, null,
              e(MgmtStep, { number: 1, title: 'IV Normal Saline', color: 'var(--orange)' }, 'Aggressive volume resuscitation. Most patients are profoundly dehydrated from polyuria.'),
              e(MgmtStep, { number: 2, title: 'Bisphosphonate', color: 'var(--orange)' }, 'Zoledronic acid IV. Onset 2â€“4 days, peak 4â€“7 days. Most effective for malignant hypercalcaemia. Requires renal function assessment and dose adjustment.'),
              e(MgmtStep, { number: 3, title: 'Calcitonin', color: 'var(--orange)' }, 'SC/IM. Rapid onset (hours) but tachyphylaxis within 48h. Bridge until bisphosphonate works.'),
              e(MgmtStep, { number: 4, title: 'Other Options', color: 'var(--orange)' },
                e('span', null, e('strong', null, 'Denosumab'), ' â€” if refractory to bisphosphonates or renal impairment.', e('br'),
                  e('strong', null, 'Corticosteroids'), ' â€” for granulomatous disease, lymphoma, vitamin D toxicity, myeloma.', e('br'),
                  e('strong', null, 'Dialysis'), ' â€” for life-threatening hypercalcaemia refractory to above.')
              ),
              e(WarningBanner, null, e('strong', null, 'Avoid thiazide diuretics'), ' (worsen hypercalcaemia). Loop diuretics ONLY after adequate volume resuscitation.')
            ) : e(React.Fragment, null,
              e(MgmtStep, { number: 1, title: 'Acute IV Calcium', color: 'var(--orange)' }, 'Calcium gluconate IV bolus. Can repeat. Dosing per local protocol.'),
              e(MgmtStep, { number: 2, title: 'Continuous Infusion', color: 'var(--orange)' }, 'Calcium gluconate infusion, titrate to ionised calcium.'),
              e(WarningBanner, null, e('strong', null, 'Do NOT give calcium through the same line as bicarbonate'), ' â€” precipitates.'),
              e(MgmtStep, { number: 3, title: 'Correct Magnesium', color: 'var(--orange)' }, 'IV magnesium replacement if low. Calcium will not correct until Mg is replaced.'),
              e(MgmtStep, { number: 4, title: 'Cardiac Monitoring', color: 'var(--orange)' }, 'If ionised Ca severely low â€” risk of arrhythmia. Continuous monitoring advised.'),
              e(MgmtStep, { number: 5, title: 'Chronic Replacement', color: 'var(--orange)' },
                e('span', null, e('strong', null, 'Calcium supplements'), ' with food.', e('br'),
                  e('strong', null, 'Vitamin D'), ' â€” calcitriol preferred if renal impairment or hypoparathyroidism.')
              )
            ),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', fontStyle: 'italic', marginTop: '16px', padding: '12px', background: 'var(--bg)', borderRadius: '8px' } },
              'Dosing should follow local formulary guidelines. This app provides interpretation guidance only.'
            ),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          )
        );
      }

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Calcium & PTH', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--orange)' }),

          // SCREEN 0: Enter calcium (ValueInputs, Next button)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Enter calcium'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Total + albumin for correction, or ionised directly'),
            // Tab selector
            e('div', { style: { display: 'flex', background: 'var(--sep)', borderRadius: '10px', padding: '3px', marginBottom: '20px' } },
              e('button', { onClick: () => setUseIonised(false), style: { flex: 1, padding: '10px', borderRadius: '8px', border: 'none', background: !useIonised ? 'var(--card)' : 'transparent', fontWeight: 600, fontSize: '14px', cursor: 'pointer', fontFamily: 'var(--font)', color: !useIonised ? 'var(--label)' : 'var(--label3)' } }, 'Total Ca + Albumin'),
              e('button', { onClick: () => setUseIonised(true), style: { flex: 1, padding: '10px', borderRadius: '8px', border: 'none', background: useIonised ? 'var(--card)' : 'transparent', fontWeight: 600, fontSize: '14px', cursor: 'pointer', fontFamily: 'var(--font)', color: useIonised ? 'var(--label)' : 'var(--label3)' } }, 'Ionised Ca')
            ),
            !useIonised ? e(React.Fragment, null,
              e(ValueInput, { label: 'Total Calcium', unit: 'mmol/L', value: totalCa, onChange: setTotalCa, placeholder: '2.15â€“2.55', hint: 'Normal: 2.15â€“2.55' }),
              e(ValueInput, { label: 'Albumin', unit: 'g/L', value: albumin, onChange: setAlbumin, placeholder: '35â€“50', hint: 'Normal: 35â€“50' }),
              getCorrectedCa() && e(BranchCard, { label: 'Corrected Calcium', value: `${getCorrectedCa()} mmol/L`, interpretation: getSeverity()?.text || '', color: getSeverity()?.color || 'var(--blue)' })
            ) : e(React.Fragment, null,
              e(ValueInput, { label: 'Ionised Calcium', unit: 'mmol/L', value: ionisedCa, onChange: setIonisedCa, placeholder: '1.12â€“1.30', hint: 'Normal: 1.12â€“1.30' }),
              ionisedCa && e(BranchCard, { label: 'Ionised Calcium', value: `${ionisedCa} mmol/L`, interpretation: getSeverity()?.text || '', color: getSeverity()?.color || 'var(--blue)' })
            ),
            e('div', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label3)', marginTop: '16px', marginBottom: '8px' } }, 'Supporting labs (optional)'),
            e(ValueInput, { label: 'Phosphate', unit: 'mmol/L', value: phosphate, onChange: setPhosphate, placeholder: '0.75â€“1.50', hint: 'Normal: 0.75â€“1.50' }),
            e(ValueInput, { label: '25(OH) Vitamin D', unit: 'nmol/L', value: vitD, onChange: setVitD, placeholder: '>50 adequate', hint: 'Adequate: >50' }),
            e(ValueInput, { label: 'Magnesium', unit: 'mmol/L', value: magnesium, onChange: setMagnesium, placeholder: '0.70â€“1.10', hint: 'Normal: 0.70â€“1.10' }),
            e(PrimaryButton, { label: 'Next', disabled: useIonised ? !ionisedCa : (!totalCa || !albumin), color: 'var(--orange)', onClick: () => { const dir = classifyCa(); setCalciumDirection(dir); goToStep(dir === 'normal' ? 2 : 1); } })
          ),

          // SCREEN 1: What is the PTH? (ChoiceButtons, auto-advance) - only for abnormal calcium
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What is the PTH?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, calciumDirection === 'high' ? 'PTH is THE key branch point' : 'PTH tells us whether parathyroids are responding'),
            calciumDirection === 'high' && getEffectiveCa() > 3.0 && e(WarningBanner, null, e('strong', null, 'Urgent.'), ' Calcium >3.0 mmol/L requires immediate IV saline.'),
            calciumDirection === 'low' && e(WarningBanner, null, e('strong', null, 'Check magnesium.'), ' Hypomagnesaemia causes functional hypoparathyroidism. Calcium won\'t correct until Mg replaced.'),
            calciumDirection === 'high' ? e(React.Fragment, null,
              e(ChoiceButton, {
                label: 'High or inappropriately normal',
                sublabel: 'PTH-mediated â€” parathyroids driving this',
                selected: pthResult === 'high',
                onClick: () => {
                  clearAutoAdvance();
                  setPthResult('high');
                  scheduleAdvance(() => goToStep(2), false);
                },
                color: 'var(--orange)'
              }),
              e(ChoiceButton, {
                label: 'Low (appropriately suppressed)',
                sublabel: 'PTH-independent â€” something else causing high Ca',
                selected: pthResult === 'low',
                onClick: () => {
                  clearAutoAdvance();
                  setPthResult('low');
                  scheduleAdvance(() => goToStep(2), false);
                },
                color: 'var(--blue)'
              })
            ) : e(React.Fragment, null,
              e(ChoiceButton, {
                label: 'Low or inappropriately normal',
                sublabel: 'Hypoparathyroidism â€” parathyroids not responding',
                selected: pthResult === 'low',
                onClick: () => {
                  clearAutoAdvance();
                  setPthResult('low');
                  scheduleAdvance(() => goToStep(2), false);
                },
                color: 'var(--red)'
              }),
              e(ChoiceButton, {
                label: 'High (appropriate response)',
                sublabel: 'Secondary hyperparathyroidism â€” compensating',
                selected: pthResult === 'high',
                onClick: () => {
                  clearAutoAdvance();
                  setPthResult('high');
                  scheduleAdvance(() => goToStep(2), false);
                },
                color: 'var(--orange)'
              })
            )
          ),

          // SCREEN 2: Results
          step === 2 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation')
            ),
            e(BranchCard, { label: 'Calcium', ...getCaDisplay() }),
            calciumDirection !== 'normal' && e(BranchCard, { label: 'PTH', ...getPthDisplay() }),

            // Normal calcium result
            calciumDirection === 'normal' && e(ResultCard, { title: 'Normal Calcium', severity: 'likely', tags: ['No further workup needed'] }, 'Calcium is within normal range â€” no further algorithmic interpretation needed.'),
            e('div', { style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' } }, 'DIFFERENTIAL DIAGNOSIS'),

            // HYPERCALCAEMIA + PTH HIGH
            calciumDirection === 'high' && pthResult === 'high' && e(React.Fragment, null,
              e(ResultCard, { title: 'Primary Hyperparathyroidism (PHPT)', severity: 'likely', tags: ['Single adenoma ~85%', 'Hyperplasia ~15%', 'Outpatient #1 cause'], onTap: () => { setMgmtType('hyperCa'); setShowMgmt(true); } }, 'Most common cause of hypercalcaemia in outpatients. Classic: â†‘Ca, â†‘PTH, â†“POâ‚„. Often incidental finding.'),
              e(ResultCard, { title: 'Familial Hypocalciuric Hypercalcaemia (FHH)', severity: 'consider', tags: ['Benign', 'Does NOT need surgery', 'Check CCCR'] }, 'Ca-sensing receptor mutation â†’ higher calcium set point. Distinguished from PHPT by low urinary calcium excretion (CCCR <0.01). Important: surgery does NOT fix FHH.'),
              e(InfoPanel, { title: 'PHPT vs FHH â€” CCCR Calculator', color: 'var(--orange)' }, e('p', null, 'CCCR = (Urine Ca Ã— Serum Cr) / (Serum Ca Ã— Urine Cr)', e('br'), 'CCCR > 0.02 â†’ PHPT. CCCR < 0.01 â†’ FHH. 0.01â€“0.02 â†’ indeterminate.')),
              e(ResultCard, { title: 'Tertiary Hyperparathyroidism', subtitle: 'Post-CKD or post-transplant', severity: 'consider', tags: ['Autonomous PTH'] }),
              e(ResultCard, { title: 'Lithium Therapy', severity: 'consider', tags: ['Shifts Ca set point'] })
            ),

            // HYPERCALCAEMIA + PTH LOW
            calciumDirection === 'high' && pthResult === 'low' && e(React.Fragment, null,
              e(ResultCard, { title: 'Malignancy', severity: 'dangerous', tags: ['Hospital #1 cause', 'PTHrP', 'Osteolytic mets', 'Lymphoma'], onTap: () => { setMgmtType('hyperCa'); setShowMgmt(true); } }, 'Most common cause in hospitalised patients. Check PTHrP level. Three mechanisms: humoral (PTHrP), osteolytic metastases, calcitriol-mediated (lymphoma).'),
              e(InfoPanel, { title: 'Malignancy-Associated Hypercalcaemia', color: 'var(--orange)' },
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Humoral (PTHrP):'), ' ~80%. Tumour secretes PTH-related peptide. NOT detected by standard PTH assay. Common: squamous cell, renal cell, breast.'),
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Osteolytic:'), ' Direct bone destruction. Breast, myeloma, lung. Expect â†‘ALP.'),
                e('p', null, e('strong', null, 'Calcitriol-mediated:'), ' Lymphoma produces 1,25(OH)â‚‚D.')
              ),
              e(ResultCard, { title: 'Granulomatous Disease', severity: 'consider', tags: ['Sarcoidosis', 'TB', 'Fungal', 'Check 1,25(OH)â‚‚D'] }, 'Macrophages produce 1,25(OH)â‚‚D autonomously.'),
              e(ResultCard, { title: 'Vitamin D Toxicity', severity: 'consider', tags: ['Exogenous intake', '25(OH)D >250 nmol/L'] }),
              e(ResultCard, { title: 'Other', severity: 'rare', tags: ['Thyrotoxicosis', 'Thiazides', 'Immobilisation', 'Milk-alkali'] })
            ),

            // HYPOCALCAEMIA + PTH LOW
            calciumDirection === 'low' && pthResult === 'low' && e(React.Fragment, null,
              e(ResultCard, { title: 'Hypoparathyroidism', severity: 'likely', tags: ['Post-surgical (#1)', 'Autoimmune', 'Infiltrative'], onTap: () => { setMgmtType('hypoCa'); setShowMgmt(true); } }, 'Most commonly post-thyroidectomy or parathyroidectomy. May be transient or permanent.'),
              magnesium && parseFloat(magnesium) < 0.70 && e(React.Fragment, null,
                e(WarningBanner, null, e('strong', null, 'Magnesium is low.'), ' Hypomagnesaemia impairs PTH secretion AND end-organ response. Replace magnesium FIRST.'),
                e(ResultCard, { title: 'Functional Hypoparathyroidism (Mg depletion)', severity: 'dangerous', tags: ['Replace Mg first', 'PTH will not work'] })
              )
            ),

            // HYPOCALCAEMIA + PTH HIGH
            calciumDirection === 'low' && pthResult === 'high' && e(React.Fragment, null,
              e(ResultCard, { title: 'Vitamin D Deficiency', severity: 'likely', tags: ['Most common globally', 'Check 25(OH)D'], onTap: () => { setMgmtType('hypoCa'); setShowMgmt(true); } }, 'PTH appropriately elevated in response to low calcium. Phosphate typically low (PTH promoting phosphaturia).'),
              phosphate && e(InfoPanel, { title: 'Phosphate as Discriminator', color: 'var(--orange)' },
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Low phosphate + high PTH'), ' = PTH is working on kidneys. Problem is lack of calcium input (vitamin D deficiency, malabsorption).'),
                e('p', null, e('strong', null, 'High phosphate + high PTH'), ' = PTH is NOT working on kidneys (renal failure, PTH resistance) OR phosphate load.')
              ),
              e(ResultCard, { title: 'CKD', severity: 'consider', tags: ['Impaired 1Î±-hydroxylation', 'High phosphate', 'Check eGFR'] }, 'Kidneys can\'t convert 25(OH)D to active 1,25(OH)â‚‚D. Need calcitriol, not cholecalciferol.'),
              e(ResultCard, { title: 'Malabsorption', severity: 'consider', tags: ['Coeliac', 'Crohn\'s', 'Post-bariatric'] }),
              e(ResultCard, { title: 'Hungry Bone Syndrome', subtitle: 'Post-parathyroidectomy', severity: 'consider', tags: ['Rapid Ca + POâ‚„ uptake'] }),
              e(ResultCard, { title: 'Pseudohypoparathyroidism', severity: 'rare', tags: ['PTH resistance', 'Albright hereditary osteodystrophy'] }, 'High PTH but no response â€” end-organ resistance.')
            ),

            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e('div', { style: { marginTop: '16px' } },
              e(PrimaryButton, { label: 'View Management', color: 'var(--orange)', onClick: () => { setMgmtType(calciumDirection === 'high' ? 'hyperCa' : 'hypoCa'); setShowMgmt(true); } }),
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
            )
          )
        )
      );
    }

    // ========== CSF ANALYSIS MODULE ==========

    function CSFModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: CSF appearance
      const [appearance, setAppearance] = useState(null);
      // Screen 1: Immunocompromised?
      const [isImmunocompromised, setIsImmunocompromised] = useState(null);
      // Screen 2: CSF results
      const [openingPressure, setOpeningPressure] = useState('');
      const [csfWcc, setCsfWcc] = useState('');
      const [csfRcc, setCsfRcc] = useState('');
      const [csfDiff, setCsfDiff] = useState(null);
      const [csfProtein, setCsfProtein] = useState('');
      const [csfGlucose, setCsfGlucose] = useState('');
      const [serumGlucose, setSerumGlucose] = useState('');
      // Screen 3: Results
      const [showMgmt, setShowMgmt] = useState(false);

      const getTotalScreens = () => 4;

      const scrollToTop = () => { if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'smooth' }); };
      const goToStep = (s) => { setStep(s); scrollToTop(); };
      const handleBack = () => {
        clearAutoAdvance();
        if (showMgmt) setShowMgmt(false);
        else if (step === 0) onBack();
        else goToStep(step - 1);
      };

      // Traumatic tap correction
      const getCorrectedWcc = () => {
        const wcc = parseFloat(csfWcc);
        const rcc = parseFloat(csfRcc);
        if (!isNaN(wcc) && !isNaN(rcc) && rcc > 0) {
          return Math.max(0, wcc - (rcc / 700)).toFixed(0);
        }
        return null;
      };

      const getCorrectedProtein = () => {
        const prot = parseFloat(csfProtein);
        const rcc = parseFloat(csfRcc);
        if (!isNaN(prot) && !isNaN(rcc) && rcc > 0) {
          return Math.max(0, prot - (rcc * 0.00001)).toFixed(3);
        }
        return null;
      };

      // CSF:Serum glucose ratio
      const getGlucoseRatio = () => {
        const csf = parseFloat(csfGlucose);
        const serum = parseFloat(serumGlucose);
        if (!isNaN(csf) && !isNaN(serum) && serum > 0) {
          return (csf / serum).toFixed(2);
        }
        return null;
      };

      const getGlucoseRatioDisplay = () => {
        const ratio = getGlucoseRatio();
        if (!ratio) return null;
        const r = parseFloat(ratio);
        if (r > 0.6) return { value: ratio, interpretation: 'Normal â€” effectively excludes bacterial meningitis', color: 'var(--green)' };
        if (r >= 0.3) return { value: ratio, interpretation: 'Low â€” consider bacterial, TB, fungal, malignant', color: 'var(--orange)' };
        return { value: ratio, interpretation: 'Very low â€” strongly suggests bacterial or TB meningitis', color: 'var(--red)' };
      };

      const getOPDisplay = () => {
        if (!openingPressure) return null;
        const op = parseFloat(openingPressure);
        if (op < 6) return { value: `${openingPressure} cmHâ‚‚O`, interpretation: 'Low â€” CSF leak, dehydration', color: 'var(--blue)' };
        if (op <= 20) return { value: `${openingPressure} cmHâ‚‚O`, interpretation: 'Normal', color: 'var(--green)' };
        if (op <= 25) return { value: `${openingPressure} cmHâ‚‚O`, interpretation: 'Borderline elevated', color: 'var(--orange)' };
        if (op <= 40) return { value: `${openingPressure} cmHâ‚‚O`, interpretation: 'Elevated', color: 'var(--red)' };
        return { value: `${openingPressure} cmHâ‚‚O`, interpretation: 'Markedly elevated â€” herniation risk', color: 'var(--red)' };
      };

      // Determine likely pattern
      const getLikelyPattern = () => {
        const lowGlucose = getGlucoseRatio() && parseFloat(getGlucoseRatio()) < 0.6;
        const highProtein = csfProtein && parseFloat(csfProtein) > 0.45;
        const highWcc = csfWcc && parseFloat(csfWcc) > 5;

        if (csfDiff === 'polys' && lowGlucose) return 'bacterial';
        if (csfDiff === 'lymphs' && !lowGlucose) return 'viral';
        if (csfDiff === 'lymphs' && lowGlucose) return 'tb';
        if (csfDiff === 'lymphs' && lowGlucose && isImmunocompromised) return 'crypto';
        return null;
      };

      // Management screen
      if (showMgmt) {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', { onClick: () => setShowMgmt(false), style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' } }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Meningitis / Encephalitis')
            ),
            e(WarningBanner, null, e('strong', null, 'If LP cannot be done immediately:'), ' blood cultures THEN empiric antibiotics IMMEDIATELY.'),
            e(MgmtStep, { number: 1, title: 'Empiric Antibiotics', color: 'var(--yellow)' },
              e('span', null, e('strong', null, 'Adult (community-acquired):'), ' 3rd-gen cephalosporin + dexamethasone.', e('br'),
                e('strong', null, 'If Listeria risk (>50 years, immunosuppressed, pregnant):'), ' ADD ampicillin or benzylpenicillin.', e('br'),
                e('strong', null, 'Post-neurosurgical / VP shunt:'), ' Broader gram-positive and gram-negative cover required.')
            ),
            e(MgmtStep, { number: 2, title: 'Dexamethasone', color: 'var(--yellow)' }, 'Must be given WITH or BEFORE first antibiotic dose. No benefit if started later.'),
            e(WarningBanner, null, e('strong', null, 'Do NOT give dexamethasone if:'), ' immunosuppressed, post-neurosurgical, or suspected viral/TB meningitis.'),
            e(MgmtStep, { number: 3, title: 'HSV Encephalitis', color: 'var(--yellow)' },
              'IV aciclovir â€” start empirically if ANY suspicion of encephalitis (confusion, focal neurology, seizures, temporal lobe changes). Do NOT wait for PCR.'
            ),
            e(MgmtStep, { number: 4, title: 'TB Meningitis', color: 'var(--yellow)' }, '4-drug anti-TB therapy (induction) then 2-drug continuation phase (total 12 months). Corticosteroids â€” evidence supports steroids in TB meningitis.'),
            e(MgmtStep, { number: 5, title: 'Cryptococcal', color: 'var(--yellow)' },
              e('span', null, 'Amphotericin-based induction, then azole maintenance. ', e('strong', null, 'Therapeutic LP'), ' for raised pressure â€” serial LPs to reduce opening pressure.')
            ),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', fontStyle: 'italic', marginTop: '16px', padding: '12px', background: 'var(--bg)', borderRadius: '8px' } },
              'Dosing should follow local formulary/antimicrobial guidelines. This app provides interpretation guidance only.'
            ),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          )
        );
      }

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'CSF Analysis', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--yellow)' }),

          // SCREEN 0: CSF appearance? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'CSF appearance?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'First impression at the bedside'),
            e(ChoiceButton, {
              label: 'Crystal clear',
              sublabel: 'Normal or early/mild infection',
              selected: appearance === 'clear',
              onClick: () => {
                clearAutoAdvance();
                setAppearance('clear');
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'Turbid / cloudy',
              sublabel: 'High WCC or protein â€” bacterial until proven otherwise',
              selected: appearance === 'turbid',
              onClick: () => {
                clearAutoAdvance();
                setAppearance('turbid');
                scheduleAdvance(() => goToStep(1), true); // 800ms for warning
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Xanthochromic (yellow)',
              sublabel: 'SAH (if >12h) or very high protein',
              selected: appearance === 'xanthochromic',
              onClick: () => {
                clearAutoAdvance();
                setAppearance('xanthochromic');
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Bloody',
              sublabel: 'Traumatic tap or subarachnoid haemorrhage',
              selected: appearance === 'bloody',
              onClick: () => {
                clearAutoAdvance();
                setAppearance('bloody');
                scheduleAdvance(() => goToStep(1), true); // 800ms for warning
              },
              color: 'var(--red)'
            }),
            appearance === 'turbid' && e(WarningBanner, null, e('strong', null, 'Turbid CSF.'), ' Treat as bacterial meningitis until proven otherwise. Start empiric antibiotics.'),
            appearance === 'bloody' && e(WarningBanner, null, e('strong', null, 'Bloody CSF.'), ' Distinguish traumatic tap (blood clears in successive tubes) from SAH (uniform, xanthochromia after 12h).')
          ),

          // SCREEN 1: Immunocompromised? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Immunocompromised?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'This changes the differential significantly'),
            e(ChoiceButton, {
              label: 'Yes',
              sublabel: 'HIV, transplant, chemotherapy, immunosuppressive drugs',
              selected: isImmunocompromised === true,
              onClick: () => {
                clearAutoAdvance();
                setIsImmunocompromised(true);
                scheduleAdvance(() => goToStep(2), true); // 800ms for warning
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'No',
              sublabel: 'Immunocompetent',
              selected: isImmunocompromised === false,
              onClick: () => {
                clearAutoAdvance();
                setIsImmunocompromised(false);
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--green)'
            }),
            isImmunocompromised === true && e(WarningBanner, null, e('strong', null, 'Cryptococcal meningitis'), ' must be excluded. Check serum and CSF CrAg. Often presents with markedly elevated opening pressure.')
          ),

          // SCREEN 2: Enter CSF results (ValueInputs + cell type, Next button)
          step === 2 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Enter CSF results'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Cell counts, chemistry, and differential'),
            e(ValueInput, { label: 'Opening Pressure', unit: 'cmHâ‚‚O', value: openingPressure, onChange: setOpeningPressure, placeholder: '6â€“20', hint: 'Normal: 6â€“20' }),
            openingPressure && e(BranchCard, { label: 'Opening Pressure', ...getOPDisplay() }),
            e(ValueInput, { label: 'CSF White Cell Count', unit: 'cells/ÂµL', value: csfWcc, onChange: setCsfWcc, placeholder: 'Normal: 0â€“5' }),
            e(ValueInput, { label: 'CSF Red Cell Count', unit: 'cells/ÂµL', value: csfRcc, onChange: setCsfRcc, placeholder: 'Normal: 0', hint: 'For traumatic tap correction' }),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginTop: '16px', marginBottom: '12px' } }, 'Predominant cell type'),
            e(ChoiceButton, { label: 'Polymorphs (neutrophils)', sublabel: 'Suggests bacterial', selected: csfDiff === 'polys', onClick: () => setCsfDiff('polys'), color: 'var(--red)' }),
            e(ChoiceButton, { label: 'Lymphocytes', sublabel: 'Viral, TB, fungal, or partially treated bacterial', selected: csfDiff === 'lymphs', onClick: () => setCsfDiff('lymphs'), color: 'var(--blue)' }),
            e(ChoiceButton, { label: 'Mixed', sublabel: 'Early bacterial, or overlap pattern', selected: csfDiff === 'mixed', onClick: () => setCsfDiff('mixed'), color: 'var(--orange)' }),
            e(ValueInput, { label: 'CSF Protein', unit: 'g/L', value: csfProtein, onChange: setCsfProtein, placeholder: '0.15â€“0.45', hint: 'Normal: 0.15â€“0.45' }),
            e(ValueInput, { label: 'CSF Glucose', unit: 'mmol/L', value: csfGlucose, onChange: setCsfGlucose, placeholder: '2.8â€“4.4', hint: 'Normal: 2.8â€“4.4' }),
            e(ValueInput, { label: 'Paired Serum Glucose', unit: 'mmol/L', value: serumGlucose, onChange: setSerumGlucose, placeholder: 'For ratio', hint: 'Essential for interpretation' }),
            csfRcc && parseFloat(csfRcc) > 0 && getCorrectedWcc() && e(React.Fragment, null,
              e('div', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label3)', marginTop: '16px', marginBottom: '8px' } }, 'Traumatic tap correction'),
              e(BranchCard, { label: 'Corrected WCC', value: `${getCorrectedWcc()} cells/ÂµL`, interpretation: 'After subtracting RBC contribution', color: 'var(--blue)' }),
              getCorrectedProtein() && e(BranchCard, { label: 'Corrected Protein', value: `${getCorrectedProtein()} g/L`, interpretation: 'After subtracting RBC contribution', color: 'var(--blue)' })
            ),
            getGlucoseRatio() && e(BranchCard, { label: 'CSF:Serum Glucose Ratio', ...getGlucoseRatioDisplay() }),
            e(PrimaryButton, { label: 'Next', disabled: !csfWcc || !csfDiff, color: 'var(--yellow)', onClick: () => goToStep(3) })
          ),

          // SCREEN 3: Results
          step === 3 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Pattern Recognition')
            ),
            appearance && e(BranchCard, { label: 'Appearance', value: appearance.charAt(0).toUpperCase() + appearance.slice(1), interpretation: '', color: appearance === 'turbid' || appearance === 'bloody' ? 'var(--red)' : 'var(--green)' }),
            csfWcc && e(BranchCard, { label: 'CSF WCC', value: `${getCorrectedWcc() || csfWcc} cells/ÂµL`, interpretation: csfDiff === 'polys' ? 'Polymorphs predominant' : csfDiff === 'lymphs' ? 'Lymphocytes predominant' : 'Mixed', color: csfDiff === 'polys' ? 'var(--red)' : 'var(--blue)' }),
            getGlucoseRatio() && e(BranchCard, { label: 'CSF:Serum Glucose', ...getGlucoseRatioDisplay() }),
            e('div', { style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' } }, 'DIFFERENTIAL DIAGNOSIS'),

            // Bacterial
            e(ResultCard, { title: 'Bacterial Meningitis', severity: csfDiff === 'polys' && getGlucoseRatio() && parseFloat(getGlucoseRatio()) < 0.6 ? 'dangerous' : 'consider', tags: ['Empiric antibiotics BEFORE LP', 'Gram stain', 'Blood cultures', 'Dexamethasone'], onTap: () => setShowMgmt(true) }, 'Classic: turbid CSF, polymorphs, very high WCC, high protein, low glucose. However, early bacterial meningitis can mimic viral (lymphocyte predominance in first 24h).'),

            // Viral
            e(ResultCard, { title: 'Viral Meningitis', severity: csfDiff === 'lymphs' && (!getGlucoseRatio() || parseFloat(getGlucoseRatio()) > 0.6) ? 'likely' : 'consider', tags: ['Enterovirus most common', 'HSV PCR', 'Self-limiting'] }, 'Clear CSF, lymphocyte predominance, mildly elevated protein, NORMAL glucose. Usually self-limiting. Key concern: rule out HSV encephalitis if confusion/focal neurology/seizures.'),

            // TB
            (csfDiff === 'lymphs' || csfDiff === 'mixed') && e(ResultCard, { title: 'TB Meningitis', severity: getGlucoseRatio() && parseFloat(getGlucoseRatio()) < 0.6 ? 'dangerous' : 'consider', tags: ['Subacute onset', 'Cranial nerve palsies', 'SIADH', 'Treat empirically if suspected'], onTap: () => setShowMgmt(true) }, 'Lymphocytes, low glucose, high protein. Notoriously difficult to diagnose (AFB smear only 10â€“20% sensitive). GeneXpert ~60â€“80% in CSF.'),
            (csfDiff === 'lymphs' && getGlucoseRatio() && parseFloat(getGlucoseRatio()) < 0.6) && e(InfoPanel, { title: 'TB Meningitis â€” the Great Mimicker', color: 'var(--yellow)' },
              e('p', { style: { marginBottom: '8px' } }, 'Clinical clues: subacute onset (days-weeks), cranial nerve palsies (especially VI), basal meningeal enhancement on MRI, hyponatraemia (SIADH), risk factors.'),
              e('p', { style: { fontWeight: 700 } }, 'If clinical suspicion is moderate-high, start empiric treatment while awaiting results. Mortality of untreated TB meningitis approaches 100%.')
            ),

            // Cryptococcal
            isImmunocompromised && e(ResultCard, { title: 'Cryptococcal Meningitis', severity: 'dangerous', tags: ['Immunosuppressed', 'High opening pressure', 'CrAg', 'Therapeutic LP'], onTap: () => setShowMgmt(true) }, 'Lymphocytes, low glucose, elevated protein, often markedly raised opening pressure. Check serum and CSF cryptococcal antigen (CrAg). Raised pressure is the major cause of morbidity.'),

            // Partially treated
            e(ResultCard, { title: 'Partially Treated Bacterial', severity: 'consider', tags: ['Prior antibiotics', 'Modified pattern', 'May look viral'] }, 'Prior antibiotics can modify the CSF pattern: lymphocyte shift, less dramatic glucose drop. Treat as bacterial if clinical suspicion high.'),

            // Malignant
            (csfDiff === 'lymphs' && getGlucoseRatio() && parseFloat(getGlucoseRatio()) < 0.6) && e(ResultCard, { title: 'Malignant Meningitis', severity: 'consider', tags: ['Lymphocytic', 'Low glucose', 'Known malignancy', 'Cytology'] }, 'Carcinomatous or lymphomatous meningitis. Lymphocytes, low glucose, very high protein. Send CSF cytology â€” may need repeat LPs.'),

            // GBS
            csfProtein && parseFloat(csfProtein) > 1.0 && csfWcc && parseFloat(csfWcc) < 10 && e(ResultCard, { title: 'Guillain-BarrÃ© Syndrome', severity: 'consider', tags: ['High protein', 'Few cells', 'Albuminocytological dissociation'] }, 'Very high protein with few or no cells â€” \'albuminocytological dissociation\'. Usually presents with ascending weakness, areflexia.'),

            // IIH
            openingPressure && parseFloat(openingPressure) > 25 && csfWcc && parseFloat(csfWcc) <= 5 && (!getGlucoseRatio() || parseFloat(getGlucoseRatio()) > 0.6) && e(ResultCard, { title: 'Idiopathic Intracranial Hypertension', severity: 'consider', tags: ['Elevated pressure', 'Normal composition', 'Diagnosis of exclusion'] }, 'Elevated opening pressure with completely normal CSF composition. Typical patient: young woman, obesity, headache, papilloedema.'),

            // Investigations
            e(InfoPanel, { title: 'Specific Investigations to Request', color: 'var(--yellow)' },
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Gram stain'), ' â€” always. Sensitivity ~60â€“90%. Negative does NOT exclude bacterial.'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Bacterial culture'), ' â€” always. Gold standard. 24â€“48h. Also blood cultures.'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'PCR (multiplex)'), ' â€” bacterial + viral (HSV, VZV, enterovirus). Higher sensitivity than culture after antibiotics.'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Cryptococcal antigen'), ' â€” if immunosuppressed, HIV, or lymphocytic with low glucose.'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'TB PCR (GeneXpert)'), ' â€” if subacute, lymphocytic, low glucose, risk factors. Large volume (>6ml).'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Cytology'), ' â€” if malignancy suspected. Large volume. May need repeat LPs.'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px' } }, e('strong', null, 'Oligoclonal bands'), ' â€” if MS suspected. Paired with serum.')
            ),

            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e('div', { style: { marginTop: '16px' } },
              e(PrimaryButton, { label: 'View Management', color: 'var(--yellow)', onClick: () => setShowMgmt(true) }),
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
            )
          )
        )
      );
    }

    // ========== AKI / URINE BIOCHEM MODULE ==========

    function AKIModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Diuretics?
      const [onDiuretics, setOnDiuretics] = useState(null);
      // Screen 1: FENa inputs
      const [urineNa, setUrineNa] = useState('');
      const [urineCr, setUrineCr] = useState('');
      const [serumNa, setSerumNa] = useState('');
      const [serumCr, setSerumCr] = useState('');
      const [urineUrea, setUrineUrea] = useState('');
      const [serumUrea, setSerumUrea] = useState('');
      const [urineOsm, setUrineOsm] = useState('');
      // Screen 2: Calculated + interpretation
      const [fenaResult, setFenaResult] = useState(null);
      // Screen 3: Results
      const [showMgmt, setShowMgmt] = useState(false);
      const [mgmtType, setMgmtType] = useState(null);

      const getTotalScreens = () => 4;

      const scrollToTop = () => { if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'smooth' }); };
      const goToStep = (s) => { setStep(s); scrollToTop(); };
      const handleBack = () => {
        clearAutoAdvance();
        if (showMgmt) setShowMgmt(false);
        else if (step === 0) onBack();
        else goToStep(step - 1);
      };

      // FENa calculation: (UNa Ã— SCr) / (SNa Ã— UCr) Ã— 100
      // Note: SCr needs to be converted from Âµmol/L to mmol/L (Ã·1000)
      const calcFENa = () => {
        const una = parseFloat(urineNa);
        const ucr = parseFloat(urineCr);
        const sna = parseFloat(serumNa);
        const scr = parseFloat(serumCr) / 1000; // Convert to mmol/L
        if (!isNaN(una) && !isNaN(ucr) && !isNaN(sna) && !isNaN(scr) && ucr > 0 && sna > 0) {
          return ((una * scr) / (sna * ucr) * 100).toFixed(2);
        }
        return null;
      };

      // FEUrea calculation
      const calcFEUrea = () => {
        const uurea = parseFloat(urineUrea);
        const surea = parseFloat(serumUrea);
        const ucr = parseFloat(urineCr);
        const scr = parseFloat(serumCr) / 1000;
        if (!isNaN(uurea) && !isNaN(surea) && !isNaN(ucr) && !isNaN(scr) && ucr > 0 && surea > 0) {
          return ((uurea * scr) / (surea * ucr) * 100).toFixed(1);
        }
        return null;
      };

      const getFENaDisplay = () => {
        const fena = calcFENa();
        if (!fena) return null;
        const v = parseFloat(fena);
        if (v < 1) return { value: `${fena}%`, interpretation: 'Suggests pre-renal', color: 'var(--green)' };
        if (v <= 2) return { value: `${fena}%`, interpretation: 'Indeterminate', color: 'var(--orange)' };
        return { value: `${fena}%`, interpretation: 'Suggests intrinsic (ATN)', color: 'var(--red)' };
      };

      const getFEUreaDisplay = () => {
        const feurea = calcFEUrea();
        if (!feurea) return null;
        const v = parseFloat(feurea);
        if (v < 35) return { value: `${feurea}%`, interpretation: 'Suggests pre-renal', color: 'var(--green)' };
        if (v <= 50) return { value: `${feurea}%`, interpretation: 'Indeterminate', color: 'var(--orange)' };
        return { value: `${feurea}%`, interpretation: 'Suggests intrinsic (ATN)', color: 'var(--red)' };
      };

      const getUrineOsmDisplay = () => {
        if (!urineOsm) return null;
        const v = parseFloat(urineOsm);
        if (v > 500) return { value: `${urineOsm} mOsm/kg`, interpretation: 'Concentrated â€” consistent with pre-renal', color: 'var(--green)' };
        if (v >= 350) return { value: `${urineOsm} mOsm/kg`, interpretation: 'Intermediate', color: 'var(--orange)' };
        return { value: `${urineOsm} mOsm/kg`, interpretation: 'Dilute â€” consistent with ATN', color: 'var(--red)' };
      };

      if (showMgmt) {
        const isPreRenal = mgmtType === 'preRenal';
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', { onClick: () => setShowMgmt(false), style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' } }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, isPreRenal ? 'Pre-renal AKI' : 'Intrinsic AKI (ATN)')
            ),
            isPreRenal ? e(React.Fragment, null,
              e(MgmtStep, { number: 1, title: 'Volume Resuscitation', color: 'var(--cyan)' }, 'Crystalloid boluses 250â€“500 ml, reassess after each.'),
              e(MgmtStep, { number: 2, title: 'Treat Underlying Cause', color: 'var(--cyan)' }, 'Sepsis, bleeding, heart failure, liver failure.'),
              e(MgmtStep, { number: 3, title: 'Hold Nephrotoxins', color: 'var(--cyan)' }, 'NSAIDs, ACEi/ARB, aminoglycosides.'),
              e(MgmtStep, { number: 4, title: 'Monitor', color: 'var(--cyan)' }, 'UO target >0.5 ml/kg/hr. Serial creatinine.')
            ) : e(React.Fragment, null,
              e(MgmtStep, { number: 1, title: 'Supportive', color: 'var(--cyan)' }, 'No specific treatment for established ATN.'),
              e(MgmtStep, { number: 2, title: 'Avoid Further Insults', color: 'var(--cyan)' }, 'Nephrotoxins, hypotension, contrast.'),
              e(MgmtStep, { number: 3, title: 'Manage Complications', color: 'var(--cyan)' }, 'Hyperkalaemia, acidosis, fluid overload.'),
              e(MgmtStep, { number: 4, title: 'RRT Criteria', color: 'var(--cyan)' }, 'Refractory hyperkalaemia, severe acidosis, fluid overload unresponsive to diuretics, uraemic encephalopathy or pericarditis.')
            ),
            e(InfoPanel, { title: 'Post-renal AKI', color: 'var(--cyan)' },
              e('p', null, 'Relieve obstruction â€” catheterise (lower tract), nephrostomy/stent (upper tract). Monitor for post-obstructive diuresis â€” can be massive and cause electrolyte shifts.')
            ),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          )
        );
      }

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Urine Biochem', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--cyan)' }),

          // SCREEN 0: Is the patient on diuretics? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Is the patient on diuretics?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'This changes which index is reliable'),
            e(ChoiceButton, {
              label: 'Yes â€” loop or thiazide',
              sublabel: 'FENa unreliable, will use FEUrea',
              selected: onDiuretics === true,
              onClick: () => {
                clearAutoAdvance();
                setOnDiuretics(true);
                scheduleAdvance(() => goToStep(1), true); // 800ms for warning
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'No diuretics',
              sublabel: 'FENa is reliable',
              selected: onDiuretics === false,
              onClick: () => {
                clearAutoAdvance();
                setOnDiuretics(false);
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--green)'
            }),
            onDiuretics === true && e(WarningBanner, null, e('strong', null, 'FENa unreliable.'), ' Diuretics force sodium excretion, making FENa falsely elevated. Use FEUrea instead.')
          ),

          // SCREEN 1: Enter values for FENa (ValueInputs, Next button)
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, onDiuretics ? 'Enter values for FEUrea' : 'Enter values for FENa'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Urine and serum biochemistry'),
            e(ValueInput, { label: 'Urine Sodium', unit: 'mmol/L', value: urineNa, onChange: setUrineNa, placeholder: 'Enter' }),
            e(ValueInput, { label: 'Urine Creatinine', unit: 'mmol/L', value: urineCr, onChange: setUrineCr, placeholder: 'Enter' }),
            e(ValueInput, { label: 'Serum Sodium', unit: 'mmol/L', value: serumNa, onChange: setSerumNa, placeholder: '135â€“145' }),
            e(ValueInput, { label: 'Serum Creatinine', unit: 'Âµmol/L', value: serumCr, onChange: setSerumCr, placeholder: 'Enter' }),
            onDiuretics && e(React.Fragment, null,
              e('div', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label3)', marginTop: '16px', marginBottom: '8px' } }, 'FEUrea inputs'),
              e(ValueInput, { label: 'Urine Urea', unit: 'mmol/L', value: urineUrea, onChange: setUrineUrea, placeholder: 'Enter' }),
              e(ValueInput, { label: 'Serum Urea', unit: 'mmol/L', value: serumUrea, onChange: setSerumUrea, placeholder: 'Enter' })
            ),
            e(ValueInput, { label: 'Urine Osmolality (optional)', unit: 'mOsm/kg', value: urineOsm, onChange: setUrineOsm, placeholder: 'Optional' }),
            e(PrimaryButton, { label: 'Next', disabled: !urineNa || !urineCr || !serumNa || !serumCr || (onDiuretics && (!urineUrea || !serumUrea)), color: 'var(--cyan)', onClick: () => goToStep(2) })
          ),

          // SCREEN 2: Calculated results + interpretation (ChoiceButtons, auto-advance)
          step === 2 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What does this suggest?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Based on calculated indices'),
            calcFENa() && !onDiuretics && e(BranchCard, { label: 'FENa', ...getFENaDisplay() }),
            calcFENa() && onDiuretics && e('div', { style: { opacity: 0.5, marginBottom: '8px' } },
              e(BranchCard, { label: 'FENa', value: `${calcFENa()}%`, interpretation: 'âš ï¸ Unreliable on diuretics', color: 'var(--label3)' })
            ),
            onDiuretics && calcFEUrea() && e(BranchCard, { label: 'FEUrea', ...getFEUreaDisplay() }),
            urineOsm && e(BranchCard, { label: 'Urine Osmolality', ...getUrineOsmDisplay() }),
            e(ChoiceButton, {
              label: 'Pre-renal',
              sublabel: onDiuretics ? 'FEUrea <35%' : 'FENa <1%',
              selected: fenaResult === 'preRenal',
              onClick: () => {
                clearAutoAdvance();
                setFenaResult('preRenal');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'Intrinsic (ATN)',
              sublabel: onDiuretics ? 'FEUrea >50%' : 'FENa >2%',
              selected: fenaResult === 'intrinsic',
              onClick: () => {
                clearAutoAdvance();
                setFenaResult('intrinsic');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Indeterminate',
              sublabel: 'Borderline values â€” may be transitioning',
              selected: fenaResult === 'indeterminate',
              onClick: () => {
                clearAutoAdvance();
                setFenaResult('indeterminate');
                scheduleAdvance(() => goToStep(3), false);
              },
              color: 'var(--orange)'
            })
          ),

          // SCREEN 3: Results
          step === 3 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation')
            ),
            !onDiuretics && calcFENa() && e(BranchCard, { label: 'FENa', ...getFENaDisplay() }),
            onDiuretics && calcFEUrea() && e(BranchCard, { label: 'FEUrea', ...getFEUreaDisplay() }),
            urineOsm && e(BranchCard, { label: 'Urine Osmolality', ...getUrineOsmDisplay() }),
            e('div', { style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' } }, 'INTERPRETATION'),

            fenaResult === 'preRenal' && e(React.Fragment, null,
              e(ResultCard, { title: 'Pre-renal AKI', severity: 'likely', tags: ['Underperfusion', 'Structurally intact', 'Reversible'], onTap: () => { setMgmtType('preRenal'); setShowMgmt(true); } }, 'Kidneys responding appropriately to hypovolaemia or poor perfusion. Avid sodium and water retention.'),
              e(WarningBanner, null, e('strong', null, 'FENa <1% does NOT always mean pre-renal.'), ' Several intrinsic diseases preserve tubular sodium handling:'),
              e('div', { style: { background: 'var(--card)', border: '1px solid var(--sep)', borderRadius: '10px', padding: '12px', marginBottom: '12px', fontSize: '13px', color: 'var(--label2)' } },
                'â€¢ Contrast nephropathy (vasoconstriction)', e('br'),
                'â€¢ Rhabdomyolysis (early)', e('br'),
                'â€¢ Early sepsis (renal vasoconstriction)', e('br'),
                'â€¢ Acute glomerulonephritis (glomerular injury, tubules intact)', e('br'),
                'â€¢ Early interstitial nephritis', e('br'),
                'â€¢ Acute urinary obstruction (early)'
              )
            ),

            fenaResult === 'intrinsic' && e(React.Fragment, null,
              e(ResultCard, { title: 'Intrinsic AKI (ATN)', severity: 'likely', tags: ['Tubular damage', 'Muddy brown casts', 'Supportive care'], onTap: () => { setMgmtType('intrinsic'); setShowMgmt(true); } }, 'Tubular damage â€” cannot reabsorb sodium efficiently or concentrate urine.'),
              e(WarningBanner, null, e('strong', null, 'FENa >1% does NOT always mean intrinsic:')),
              e('div', { style: { background: 'var(--card)', border: '1px solid var(--sep)', borderRadius: '10px', padding: '12px', marginBottom: '12px', fontSize: '13px', color: 'var(--label2)' } },
                'â€¢ Diuretic use (falsely elevated)', e('br'),
                'â€¢ CKD baseline (chronic nephron loss)', e('br'),
                'â€¢ Adrenal insufficiency (lack of aldosterone)', e('br'),
                'â€¢ Cerebral salt wasting', e('br'),
                'â€¢ IV saline administration', e('br'),
                'â€¢ Glycosuria (osmotic diuresis)'
              )
            ),

            fenaResult === 'indeterminate' && e(ResultCard, { title: 'Evolving AKI', severity: 'consider', tags: ['May be transitioning', 'Serial measurements', 'Trend'] }, 'Borderline values â€” may be evolving from pre-renal to intrinsic. Serial measurement over 6â€“12 hours is more useful than a single value.'),

            e(InfoPanel, { title: 'Urine Microscopy â€” the Forgotten Tool', color: 'var(--cyan)' },
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Muddy brown granular casts:'), ' ATN â€” pathognomonic'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Red cell casts:'), ' Glomerulonephritis'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'White cell casts:'), ' Interstitial nephritis or pyelonephritis'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Eosinophiluria:'), ' Allergic interstitial nephritis (low sensitivity)'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Bland sediment:'), ' Pre-renal, obstruction, or HRS'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px' } }, e('strong', null, 'Crystals:'), ' Crystal nephropathy (tumour lysis, ethylene glycol)')
            ),

            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e('div', { style: { marginTop: '16px' } },
              e(PrimaryButton, { label: 'View Management', color: 'var(--cyan)', onClick: () => { setMgmtType(fenaResult === 'preRenal' ? 'preRenal' : 'intrinsic'); setShowMgmt(true); } }),
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
            )
          )
        )
      );
    }

    // ========== COAGULATION MODULE ==========

    function CoagModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const { scheduleAdvance, clearAutoAdvance } = useAutoAdvance();

      // Screen 0: Clinical context
      const [clinicalContext, setClinicalContext] = useState(null);
      // Screen 1: Pattern
      const [pattern, setPattern] = useState(null);
      // Screen 2: Results
      const [showMgmt, setShowMgmt] = useState(false);
      // Optional lab inputs (collapsed on results)
      const [showLabs, setShowLabs] = useState(false);
      const [pt, setPt] = useState('');
      const [inr, setInr] = useState('');
      const [aptt, setAptt] = useState('');
      const [fibrinogen, setFibrinogen] = useState('');
      const [dDimer, setDDimer] = useState('');
      const [platelets, setPlatelets] = useState('');

      const getTotalScreens = () => 3;

      const scrollToTop = () => { if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'smooth' }); };
      const goToStep = (s) => { setStep(s); scrollToTop(); };
      const handleBack = () => {
        clearAutoAdvance();
        if (showMgmt) setShowMgmt(false);
        else if (step === 0) onBack();
        else goToStep(step - 1);
      };

      const isPtProlonged = pt && parseFloat(pt) > 13.5;
      const isApttProlonged = aptt && parseFloat(aptt) > 38;

      // ISTH DIC Score calculation
      const calcDICScore = () => {
        if (!platelets || !dDimer || !pt || !fibrinogen) return null;
        let score = 0;
        const plt = parseFloat(platelets);
        const dd = parseFloat(dDimer);
        const ptVal = parseFloat(pt);
        const fib = parseFloat(fibrinogen);
        if (plt >= 100) score += 0; else if (plt >= 50) score += 1; else score += 2;
        if (dd <= 0.5) score += 0; else if (dd <= 5) score += 1; else score += 2;
        const ptProlongation = ptVal - 13;
        if (ptProlongation < 3) score += 0; else if (ptProlongation <= 6) score += 1; else score += 2;
        if (fib >= 1.0) score += 0; else score += 2;
        return score;
      };

      const getLabDisplay = (name, value, unit, normal) => {
        if (!value) return null;
        const v = parseFloat(value);
        let interp = 'Normal';
        let color = 'var(--green)';
        if (name === 'PT' && v > 13.5) { interp = 'Prolonged'; color = 'var(--orange)'; }
        if (name === 'APTT' && v > 38) { interp = 'Prolonged'; color = 'var(--orange)'; }
        if (name === 'Fibrinogen' && v < 2.0) { interp = 'Low'; color = 'var(--red)'; }
        if (name === 'Platelets' && v < 150) { interp = 'Low'; color = 'var(--red)'; }
        if (name === 'D-dimer' && v > 0.5) { interp = 'Elevated'; color = 'var(--orange)'; }
        return { value: `${value} ${unit}`, interpretation: interp, color };
      };

      if (showMgmt) {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', { onClick: () => setShowMgmt(false), style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' } }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Coagulopathy')
            ),
            e(MgmtStep, { number: 1, title: 'Stop the Cause', color: 'var(--green)' }, 'Stop anticoagulants. Treat sepsis. Control bleeding source.'),
            e(MgmtStep, { number: 2, title: 'Replace What\'s Missing', color: 'var(--green)' },
              e('span', null, e('strong', null, 'FFP'), ' if PT/APTT prolonged.', e('br'),
                e('strong', null, 'Cryoprecipitate'), ' if fibrinogen low (rich in fibrinogen, Factor VIII, vWF, Factor XIII).', e('br'),
                e('strong', null, 'Platelets'), ' if low and actively bleeding (higher threshold for neurosurgical/ophthalmic).', e('br'),
                e('strong', null, 'Vitamin K IV'), ' if vitamin K deficiency or warfarin.')
            ),
            e(MgmtStep, { number: 3, title: 'Specific Reversal Agents', color: 'var(--green)' },
              e('span', null, e('strong', null, 'Warfarin:'), ' Prothrombin complex concentrate + Vitamin K.', e('br'),
                e('strong', null, 'Dabigatran:'), ' Idarucizumab.', e('br'),
                e('strong', null, 'Rivaroxaban/Apixaban:'), ' Andexanet alfa (if available) or PCC (off-label).', e('br'),
                e('strong', null, 'Heparin:'), ' Protamine.')
            ),
            clinicalContext === 'preOp' && e(InfoPanel, { title: 'Pre-operative Abnormal Coag', color: 'var(--green)' },
              e('p', null, 'Isolated mildly prolonged APTT in an asymptomatic patient: consider lupus anticoagulant or Factor XII deficiency â€” ', e('strong', null, 'neither causes bleeding. Do NOT delay surgery.'), e('br'), 'Personal/family history of bleeding is more important than the screening coag result.')
            ),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', fontStyle: 'italic', marginTop: '16px', padding: '12px', background: 'var(--bg)', borderRadius: '8px' } },
              'Dosing should follow local formulary/massive transfusion protocol. This app provides interpretation guidance only.'
            ),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          )
        );
      }

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Coagulation', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(ProgressBar, { current: step, total: getTotalScreens(), color: 'var(--green)' }),

          // SCREEN 0: Clinical context? (ChoiceButtons, auto-advance)
          step === 0 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'Clinical context?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'This determines urgency and approach'),
            e(ChoiceButton, {
              label: 'Active bleeding',
              sublabel: 'Urgent â€” need to identify and correct the problem',
              selected: clinicalContext === 'bleeding',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('bleeding');
                scheduleAdvance(() => goToStep(1), true); // 800ms for urgent
              },
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Incidental finding',
              sublabel: 'Abnormal coag on routine tests',
              selected: clinicalContext === 'incidental',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('incidental');
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--blue)'
            }),
            e(ChoiceButton, {
              label: 'Pre-operative screening',
              sublabel: 'Abnormal coag before planned surgery',
              selected: clinicalContext === 'preOp',
              onClick: () => {
                clearAutoAdvance();
                setClinicalContext('preOp');
                scheduleAdvance(() => goToStep(1), false);
              },
              color: 'var(--orange)'
            }),
            clinicalContext === 'bleeding' && e(WarningBanner, null, e('strong', null, 'Active bleeding.'), ' Prioritise haemostasis â€” identify and treat the cause.')
          ),

          // SCREEN 1: What pattern do you see? (ChoiceButtons, auto-advance)
          step === 1 && e(FadeIn, null,
            e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)', marginBottom: '8px' } }, 'What pattern do you see?'),
            e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginBottom: '20px' } }, 'Which coagulation pathway is affected?'),
            e(ChoiceButton, {
              label: 'Isolated prolonged PT',
              sublabel: 'APTT normal â€” extrinsic pathway problem',
              selected: pattern === 'A',
              onClick: () => {
                clearAutoAdvance();
                setPattern('A');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'Isolated prolonged APTT',
              sublabel: 'PT normal â€” intrinsic pathway problem',
              selected: pattern === 'B',
              onClick: () => {
                clearAutoAdvance();
                setPattern('B');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'Both PT and APTT prolonged',
              sublabel: 'Common pathway OR global coagulopathy',
              selected: pattern === 'C',
              onClick: () => {
                clearAutoAdvance();
                setPattern('C');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Both normal',
              sublabel: 'Consider platelet or vascular cause if bleeding',
              selected: pattern === 'D',
              onClick: () => {
                clearAutoAdvance();
                setPattern('D');
                scheduleAdvance(() => goToStep(2), false);
              },
              color: 'var(--blue)'
            })
          ),

          // SCREEN 2: Results
          step === 2 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation')
            ),
            e(BranchCard, { label: 'Context', value: clinicalContext === 'bleeding' ? 'Active bleeding' : clinicalContext === 'preOp' ? 'Pre-operative' : 'Incidental', interpretation: clinicalContext === 'bleeding' ? 'Urgent' : 'Non-urgent', color: clinicalContext === 'bleeding' ? 'var(--red)' : 'var(--blue)' }),
            e(BranchCard, { label: 'Pattern', value: pattern === 'A' ? 'PT prolonged only' : pattern === 'B' ? 'APTT prolonged only' : pattern === 'C' ? 'Both prolonged' : 'Both normal', interpretation: pattern === 'A' ? 'Extrinsic pathway' : pattern === 'B' ? 'Intrinsic pathway' : pattern === 'C' ? 'Common/global' : 'Platelet/vascular', color: pattern === 'C' ? 'var(--orange)' : 'var(--green)' }),
            e('div', { style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' } }, 'DIFFERENTIAL DIAGNOSIS'),

            // Pattern A: Isolated prolonged PT
            pattern === 'A' && e(React.Fragment, null,
              e(ResultCard, { title: 'Warfarin', severity: 'likely', tags: ['Most common', 'Check INR target'] }),
              e(ResultCard, { title: 'Early Liver Disease', severity: 'consider', tags: ['Factor VII shortest half-life (~6h)', 'First to fall'] }),
              e(ResultCard, { title: 'Vitamin K Deficiency', severity: 'consider', tags: ['Malabsorption', 'Malnutrition', 'Antibiotics', 'Obstructive jaundice'] }),
              e(ResultCard, { title: 'DOAC (Rivaroxaban/Apixaban)', severity: 'consider', tags: ['Anti-Xa agents', 'Standard coag unreliable', 'Check anti-Xa level'] }),
              e(ResultCard, { title: 'Factor VII Deficiency', severity: 'rare', tags: ['Congenital', 'Only extrinsic factor'] })
            ),

            // Pattern B: Isolated prolonged APTT
            pattern === 'B' && e(React.Fragment, null,
              e(ResultCard, { title: 'Heparin (UFH)', severity: 'likely', tags: ['Most common in hospital', 'Check anti-Xa or APTT ratio'] }),
              e(ResultCard, { title: 'Haemophilia A (Factor VIII â†“)', severity: 'consider', tags: ['X-linked', 'Severity correlates with level'] }),
              e(ResultCard, { title: 'Haemophilia B (Factor IX â†“)', severity: 'consider', tags: ['X-linked', 'Clinically identical to A'] }),
              e(ResultCard, { title: 'von Willebrand Disease', severity: 'consider', tags: ['Most common inherited bleeding disorder', 'vWF stabilises VIII'] }),
              e(ResultCard, { title: 'Factor XI Deficiency', severity: 'consider', tags: ['Ashkenazi Jewish', 'Variable bleeding risk'] }),
              e(ResultCard, { title: 'Factor XII Deficiency', severity: 'rare', tags: ['NO bleeding risk', 'Do NOT delay surgery'] }, 'Prolongs APTT but causes NO bleeding risk whatsoever. Safe for surgery.'),
              e(WarningBanner, null, e('strong', null, 'Factor XII deficiency and lupus anticoagulant prolong APTT but do NOT cause bleeding.'), ' Do NOT delay surgery for either of these.'),
              e(ResultCard, { title: 'Lupus Anticoagulant', severity: 'consider', tags: ['Antiphospholipid', 'PROTHROMBOTIC', 'Paradoxical'] }, 'Prolongs APTT in vitro but is PROTHROMBOTIC in vivo. Paradoxical â€” the lab looks like a bleeding risk but the clinical risk is clotting.'),
              e(ResultCard, { title: 'Dabigatran', severity: 'consider', tags: ['Direct thrombin inhibitor', 'Check thrombin time'] }),
              e(InfoPanel, { title: 'The Mixing Study', color: 'var(--green)' },
                e('p', { style: { marginBottom: '8px' } }, 'When APTT is prolonged, mix 1:1 patient plasma with normal plasma:'),
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Corrects â†’ Factor deficiency.'), ' Normal plasma provides the missing factor.'),
                e('p', null, e('strong', null, 'Does not correct â†’ Inhibitor present.'), ' Immediate: lupus anticoagulant, heparin. Time-dependent (2h): acquired Factor VIII inhibitor (serious).', e('br'), 'If patient is on heparin, the mixing study is useless.')
              )
            ),

            // Pattern C: Both prolonged
            pattern === 'C' && e(React.Fragment, null,
              e(ResultCard, { title: 'DIC', severity: 'dangerous', tags: ['Consumption', 'â†“Fibrinogen', 'â†“Platelets', 'â†‘D-dimer', 'Schistocytes'] }, 'Consumption of all factors + platelets. Check blood film for schistocytes.'),
              // Collapsible DIC Score Calculator
              e('button', {
                onClick: () => setShowLabs(!showLabs),
                style: { width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '12px 16px', background: 'var(--card)', border: '1px solid var(--sep)', borderRadius: '12px', cursor: 'pointer', fontFamily: 'var(--font)', marginBottom: '12px' }
              },
                e('span', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)' } }, 'Calculate ISTH DIC Score'),
                e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, showLabs ? 'â–²' : 'â–¼')
              ),
              showLabs && e('div', { style: { background: 'rgba(142,142,147,0.08)', borderRadius: '14px', padding: '16px', marginBottom: '16px' } },
                e(ValueInput, { label: 'Platelets', unit: 'Ã—10â¹/L', value: platelets, onChange: setPlatelets, placeholder: '150â€“400' }),
                e(ValueInput, { label: 'D-dimer', unit: 'mg/L', value: dDimer, onChange: setDDimer, placeholder: '<0.5' }),
                e(ValueInput, { label: 'PT', unit: 'sec', value: pt, onChange: setPt, placeholder: '11â€“13.5' }),
                e(ValueInput, { label: 'Fibrinogen', unit: 'g/L', value: fibrinogen, onChange: setFibrinogen, placeholder: '2.0â€“4.0' }),
                calcDICScore() !== null && e(BranchCard, { label: 'ISTH DIC Score', value: `${calcDICScore()}/8`, interpretation: calcDICScore() >= 5 ? 'Compatible with overt DIC' : 'Not suggestive â€” repeat daily', color: calcDICScore() >= 5 ? 'var(--red)' : 'var(--orange)' })
              ),
              e(ResultCard, { title: 'Severe Liver Disease', severity: 'likely', tags: ['Impaired synthesis', 'Factor VIII normal/â†‘ (distinguishes from DIC)'] }),
              e(InfoPanel, { title: 'Liver vs DIC', color: 'var(--green)' },
                e('p', { style: { marginBottom: '8px' } }, 'Both: prolonged PT + APTT, low fibrinogen, low platelets, elevated D-dimer.'),
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Factor VIII is the key.'), ' Normal/high in liver disease (Factor VIII made by endothelium). Low in DIC (consumed).'),
                e('p', null, 'Blood film: schistocytes = DIC. Target cells, acanthocytes = liver.')
              ),
              e(ResultCard, { title: 'Massive Transfusion / Dilution', severity: 'consider', tags: ['Dilution of factors + platelets'] }),
              e(ResultCard, { title: 'Vitamin K Deficiency (severe)', severity: 'consider', tags: ['All K-dependent factors'] }),
              e(ResultCard, { title: 'Supratherapeutic Warfarin', severity: 'consider', tags: ['Very high INR'] }),
              e(ResultCard, { title: 'Direct Thrombin Inhibitor (high dose)', severity: 'consider', tags: ['Dabigatran', 'Argatroban'] })
            ),

            // Pattern D: Both normal
            pattern === 'D' && e(React.Fragment, null,
              e(ResultCard, { title: 'Platelet Disorder', severity: 'likely', tags: ['Thrombocytopenia', 'Platelet dysfunction', 'Aspirin', 'Uraemia'] }),
              e(ResultCard, { title: 'Mild von Willebrand Disease', severity: 'consider', tags: ['May not prolong APTT', 'Check vWF antigen + activity'] }),
              e(ResultCard, { title: 'Factor XIII Deficiency', severity: 'rare', tags: ['NOT detected by PT or APTT', 'Clot forms then falls apart', 'Urea clot lysis test'] }),
              e(ResultCard, { title: 'Vascular Cause', severity: 'rare', tags: ['Connective tissue disorder', 'Vasculitis', 'Scurvy'] })
            ),

            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e('div', { style: { marginTop: '16px' } },
              e(PrimaryButton, { label: 'View Management', color: 'var(--green)', onClick: () => setShowMgmt(true) }),
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
            )
          )
        )
      );
    }

    // ========== MAIN APP ==========

    function App() {
      const [screen, setScreen] = useState('home');

      if (screen === 'home') {
        return e('div', { className: 'app-container' },
          e(HomeScreen, { onSelectModule: setScreen })
        );
      }

      if (screen === 'tft') {
        return e(TFTModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'hypona') {
        return e(HyponatraemiaModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'iron') {
        return e(IronModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'calcium') {
        return e(CalciumModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'coag') {
        return e(CoagModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'aki') {
        return e(AKIModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'csf') {
        return e(CSFModule, { onBack: () => setScreen('home') });
      }

      // Placeholder for other modules
      return e('div', { className: 'app-container' },
        e(PlaceholderScreen, { moduleId: screen, onBack: () => setScreen('home') })
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(e(App));
  </script>
</body>
</html>
