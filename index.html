<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#F2F2F7">
  <title>LabLogic</title>
  <style>
    :root {
      --bg: #F2F2F7;
      --card: #FFFFFF;
      --label: #1C1C1E;
      --label2: #3A3A3C;
      --label3: #8E8E93;
      --label4: #C7C7CC;
      --sep: rgba(60,60,67,0.08);
      --blue: #0A84FF;
      --green: #30D158;
      --orange: #FF9F0A;
      --red: #FF453A;
      --purple: #AF52DE;
      --cyan: #64D2FF;
      --yellow: #FFD60A;
      --radius: 16px;
      --radius-sm: 14px;
      --radius-xs: 10px;
      --shadow: 0 1px 3px rgba(0,0,0,0.04), 0 8px 24px rgba(0,0,0,0.06);
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.04), 0 2px 8px rgba(0,0,0,0.03);
      --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; -webkit-tap-highlight-color: transparent; }
    body { font-family: var(--font); background: #E5E5EA; color: var(--label); }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .app-container {
      max-width: 430px;
      margin: 0 auto;
      min-height: 100dvh;
      background: var(--bg);
      box-shadow: 0 0 40px rgba(0,0,0,0.1);
      position: relative;
      overflow-x: hidden;
    }

    .screen-content {
      padding: 0 20px 20px;
      padding-bottom: calc(20px + env(safe-area-inset-bottom));
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script>
    const { useState, useEffect, useRef } = React;
    const e = React.createElement;

    // Module data
    const modules = [
      { id: "hypona", name: "Hyponatraemia", icon: "ðŸ’§", color: "#0A84FF", gradient: "linear-gradient(135deg, #0A84FF 0%, #0055D4 100%)", desc: "Sodium workup algorithm", tag: "Naâº" },
      { id: "tft", name: "Thyroid Function", icon: "ðŸ¦‹", color: "#AF52DE", gradient: "linear-gradient(135deg, #AF52DE 0%, #8B3FC1 100%)", desc: "TSH-first interpretation", tag: "TFT" },
      { id: "iron", name: "Iron Studies", icon: "ðŸ©¸", color: "#FF453A", gradient: "linear-gradient(135deg, #FF453A 0%, #D42020 100%)", desc: "Pattern recognition with ferritin traps", tag: "Fe" },
      { id: "calcium", name: "Calcium & PTH", icon: "ðŸ¦´", color: "#FF9F0A", gradient: "linear-gradient(135deg, #FF9F0A 0%, #E08600 100%)", desc: "PTH-dependent branching", tag: "CaÂ²âº" },
      { id: "coag", name: "Coagulation", icon: "ðŸ”¬", color: "#30D158", gradient: "linear-gradient(135deg, #30D158 0%, #1FA840 100%)", desc: "PT / APTT pattern analysis", tag: "Coag" },
      { id: "aki", name: "Urine Biochem", icon: "âš—ï¸", color: "#64D2FF", gradient: "linear-gradient(135deg, #64D2FF 0%, #32B4E0 100%)", desc: "FENa & AKI workup", tag: "AKI" },
      { id: "csf", name: "CSF Analysis", icon: "ðŸ§ ", color: "#FFD60A", gradient: "linear-gradient(135deg, #FFD60A 0%, #E0B800 100%)", desc: "Meningitis pattern matching", tag: "CSF" }
    ];

    // Reference ranges
    const REF = {
      TSH: { low: 0.4, high: 4.0, unit: "mU/L" },
      FT4: { low: 12, high: 22, unit: "pmol/L" },
      FT3: { low: 3.1, high: 6.8, unit: "pmol/L" }
    };

    // ========== REUSABLE COMPONENTS ==========

    // 1. FadeIn Wrapper
    function FadeIn({ delay = 0, children }) {
      const [visible, setVisible] = useState(false);
      useEffect(() => {
        const timer = setTimeout(() => setVisible(true), delay);
        return () => clearTimeout(timer);
      }, [delay]);
      return e('div', {
        style: {
          opacity: visible ? 1 : 0,
          transform: visible ? 'translateY(0)' : 'translateY(8px)',
          transition: 'opacity 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)'
        }
      }, children);
    }

    // 2. NavBar
    function NavBar({ title, onBack, rightAction }) {
      return e('div', {
        style: {
          position: 'sticky',
          top: 0,
          zIndex: 100,
          background: 'rgba(242,242,247,0.92)',
          backdropFilter: 'blur(20px) saturate(180%)',
          WebkitBackdropFilter: 'blur(20px) saturate(180%)',
          borderBottom: '0.5px solid rgba(60,60,67,0.1)',
          padding: '12px 16px',
          paddingTop: 'calc(12px + env(safe-area-inset-top))',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          minHeight: '44px'
        }
      },
        e('div', { style: { width: '80px' } },
          onBack && e('button', {
            onClick: onBack,
            style: {
              background: 'none',
              border: 'none',
              color: 'var(--blue)',
              fontSize: '16px',
              fontWeight: 500,
              fontFamily: 'var(--font)',
              cursor: 'pointer',
              padding: 0
            }
          }, 'â€¹ Back')
        ),
        e('div', {
          style: {
            position: 'absolute',
            left: '50%',
            transform: 'translateX(-50%)',
            fontSize: '17px',
            fontWeight: 700,
            letterSpacing: '-0.02em',
            color: 'var(--label)'
          }
        }, title),
        e('div', { style: { width: '80px', textAlign: 'right' } }, rightAction)
      );
    }

    // 3. StepTrail
    function StepTrail({ steps, current }) {
      return e('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          overflowX: 'auto',
          padding: '16px 0',
          gap: '0'
        }
      },
        steps.map((step, i) => {
          const isCompleted = i < current;
          const isCurrent = i === current;
          const isFuture = i > current;
          const stepColor = step.color || 'var(--blue)';

          return e(React.Fragment, { key: i },
            e('div', {
              style: {
                display: 'flex',
                alignItems: 'center',
                gap: '6px',
                padding: isCurrent ? '6px 10px' : '6px 0',
                background: isCurrent ? `${stepColor}12` : 'transparent',
                borderRadius: 20,
                flexShrink: 0
              }
            },
              e('div', {
                style: {
                  width: '22px',
                  height: '22px',
                  borderRadius: '50%',
                  background: isFuture ? 'var(--label4)' : stepColor,
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  color: 'white',
                  fontSize: '12px',
                  fontWeight: 700
                }
              }, isCompleted ? 'âœ“' : (i + 1)),
              e('span', {
                style: {
                  fontSize: '13px',
                  fontWeight: isCurrent ? 700 : 500,
                  color: isCurrent ? 'var(--label)' : (isCompleted ? 'var(--label3)' : 'var(--label4)')
                }
              }, step.label)
            ),
            i < steps.length - 1 && e('div', {
              style: {
                width: '16px',
                height: '1.5px',
                background: isCompleted ? stepColor : 'var(--label4)',
                flexShrink: 0,
                margin: '0 4px'
              }
            })
          );
        })
      );
    }

    // 4. ChoiceButton
    function ChoiceButton({ label, sublabel, selected, onClick, color = 'var(--blue)' }) {
      return e('button', {
        onClick: onClick,
        style: {
          width: '100%',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'space-between',
          padding: '16px 18px',
          background: selected ? `${color}10` : 'var(--card)',
          border: `2px solid ${selected ? color : 'var(--sep)'}`,
          borderRadius: '14px',
          marginBottom: '8px',
          cursor: 'pointer',
          transition: 'all 0.2s ease',
          textAlign: 'left',
          fontFamily: 'var(--font)'
        }
      },
        e('div', { style: { flex: 1 } },
          e('div', { style: { fontSize: '16px', fontWeight: 600, color: 'var(--label)' } }, label),
          sublabel && e('div', { style: { fontSize: '13px', color: 'var(--label3)', marginTop: '4px' } }, sublabel)
        ),
        e('div', {
          style: {
            width: '24px',
            height: '24px',
            borderRadius: '50%',
            border: `2px solid ${selected ? color : 'var(--label4)'}`,
            background: selected ? color : 'transparent',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            flexShrink: 0,
            marginLeft: '12px'
          }
        },
          selected && e('span', { style: { color: 'white', fontSize: '14px' } }, 'âœ“')
        )
      );
    }

    // 5. ValueInput
    function ValueInput({ label, unit, value, onChange, placeholder, hint }) {
      const hasValue = value && value.length > 0;
      return e('div', { style: { marginBottom: '16px' } },
        e('div', {
          style: {
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            marginBottom: '8px'
          }
        },
          e('span', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)' } }, label),
          hint && e('span', { style: { fontSize: '12px', color: 'var(--label3)' } }, hint)
        ),
        e('div', {
          style: {
            display: 'flex',
            background: 'var(--card)',
            border: `1.5px solid ${hasValue ? 'var(--blue)' : 'var(--sep)'}`,
            borderRadius: '12px',
            overflow: 'hidden'
          }
        },
          e('input', {
            type: 'number',
            inputMode: 'decimal',
            value: value,
            onChange: (ev) => onChange(ev.target.value),
            placeholder: placeholder,
            style: {
              flex: 1,
              padding: '14px 16px',
              fontSize: '17px',
              fontWeight: 600,
              border: 'none',
              outline: 'none',
              background: 'transparent',
              fontFamily: 'var(--font)',
              color: 'var(--label)'
            }
          }),
          e('div', {
            style: {
              padding: '0 14px',
              fontSize: '13px',
              fontWeight: 600,
              color: 'var(--label3)',
              borderLeft: '1px solid var(--sep)',
              background: 'rgba(142,142,147,0.08)',
              display: 'flex',
              alignItems: 'center'
            }
          }, unit)
        )
      );
    }

    // 6. InfoPanel
    function InfoPanel({ title, color = 'var(--blue)', children }) {
      const [isOpen, setIsOpen] = useState(false);
      return e('div', {
        style: {
          background: isOpen ? `${color}08` : 'var(--card)',
          border: `1px solid ${isOpen ? `${color}25` : 'var(--sep)'}`,
          borderRadius: '14px',
          marginBottom: '12px',
          overflow: 'hidden'
        }
      },
        e('button', {
          onClick: () => setIsOpen(!isOpen),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            gap: '10px',
            padding: '14px 16px',
            background: 'none',
            border: 'none',
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            textAlign: 'left'
          }
        },
          e('div', {
            style: {
              width: '26px',
              height: '26px',
              borderRadius: '50%',
              background: `${color}15`,
              color: color,
              fontWeight: 700,
              fontSize: '14px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              flexShrink: 0
            }
          }, 'â“˜'),
          e('span', {
            style: { flex: 1, fontSize: '14px', fontWeight: 600, color: 'var(--label2)' }
          }, title),
          e('span', {
            style: {
              fontSize: '16px',
              color: 'var(--label3)',
              transform: isOpen ? 'rotate(90deg)' : 'rotate(0)',
              transition: 'transform 0.2s ease'
            }
          }, 'â€º')
        ),
        isOpen && e('div', {
          style: {
            borderTop: `1px solid ${color}15`,
            padding: '16px',
            fontSize: '13px',
            lineHeight: 1.65,
            color: 'var(--label2)',
            animation: 'fadeIn 0.2s ease'
          }
        }, children)
      );
    }

    // 7. Warning Banner
    function WarningBanner({ children }) {
      return e('div', {
        style: {
          display: 'flex',
          gap: '10px',
          padding: '14px 16px',
          background: 'rgba(255,69,58,0.06)',
          border: '1px solid rgba(255,69,58,0.15)',
          borderRadius: '14px',
          marginBottom: '12px'
        }
      },
        e('span', { style: { fontSize: '16px', flexShrink: 0 } }, 'âš ï¸'),
        e('div', {
          style: { fontSize: '13px', lineHeight: 1.55, color: '#C41E10', fontWeight: 500 }
        }, children)
      );
    }

    // 8. BranchCard
    function BranchCard({ label, value, interpretation, color = 'var(--blue)' }) {
      return e('div', {
        style: {
          display: 'flex',
          borderRadius: '14px',
          overflow: 'hidden',
          border: `1px solid ${color}25`,
          background: 'var(--card)',
          marginBottom: '16px'
        }
      },
        e('div', {
          style: { width: '5px', background: color, flexShrink: 0 }
        }),
        e('div', { style: { flex: 1, padding: '14px 16px' } },
          e('div', {
            style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center' }
          },
            e('span', { style: { fontSize: '13px', fontWeight: 600, color: 'var(--label3)' } }, label),
            e('span', { style: { fontSize: '17px', fontWeight: 700, color: color } }, value)
          ),
          e('div', {
            style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)', marginTop: '4px' }
          }, interpretation)
        )
      );
    }

    // 9. ResultCard
    function ResultCard({ title, subtitle, tags = [], severity, children, onTap }) {
      const severityStyles = {
        likely: { color: '#0A84FF', bg: 'rgba(10,132,255,0.08)', border: 'rgba(10,132,255,0.2)', label: 'LIKELY' },
        dangerous: { color: '#FF453A', bg: 'rgba(255,69,58,0.08)', border: 'rgba(255,69,58,0.2)', label: 'URGENT' },
        consider: { color: '#FF9F0A', bg: 'rgba(255,159,10,0.08)', border: 'rgba(255,159,10,0.2)', label: 'CONSIDER' },
        rare: { color: '#8E8E93', bg: 'rgba(142,142,147,0.08)', border: 'rgba(142,142,147,0.2)', label: 'RARE' }
      };
      const sev = severityStyles[severity] || severityStyles.consider;

      return e('div', {
        style: {
          background: 'var(--card)',
          borderRadius: '16px',
          border: '1px solid var(--sep)',
          boxShadow: 'var(--shadow-sm)',
          padding: '18px 18px 16px',
          marginBottom: '10px'
        }
      },
        e('div', {
          style: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }
        },
          e('div', { style: { flex: 1 } },
            e('div', {
              style: { fontSize: '16px', fontWeight: 700, letterSpacing: '-0.02em', color: 'var(--label)' }
            }, title),
            subtitle && e('div', {
              style: { fontSize: '13px', color: 'var(--label3)', marginTop: '3px' }
            }, subtitle)
          ),
          e('span', {
            style: {
              fontSize: '10px',
              fontWeight: 700,
              letterSpacing: '0.05em',
              color: sev.color,
              background: sev.bg,
              border: `1px solid ${sev.border}`,
              padding: '3px 8px',
              borderRadius: '6px',
              marginLeft: '10px'
            }
          }, sev.label)
        ),
        children && e('div', {
          style: { fontSize: '13.5px', lineHeight: 1.6, color: 'var(--label2)', marginTop: '6px' }
        }, children),
        tags.length > 0 && e('div', {
          style: { display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '10px' }
        },
          tags.map((tag, i) => e('span', {
            key: i,
            style: {
              fontSize: '11px',
              fontWeight: 600,
              color: 'var(--label3)',
              background: 'rgba(142,142,147,0.12)',
              padding: '3px 8px',
              borderRadius: '6px'
            }
          }, tag))
        ),
        onTap && e('button', {
          onClick: onTap,
          style: {
            background: 'none',
            border: 'none',
            color: 'var(--blue)',
            fontSize: '13px',
            fontWeight: 600,
            marginTop: '12px',
            padding: 0,
            cursor: 'pointer',
            fontFamily: 'var(--font)'
          }
        }, 'View management â†’')
      );
    }

    // 10. PrimaryButton
    function PrimaryButton({ label, onClick, disabled, color = 'var(--blue)' }) {
      return e('button', {
        onClick: disabled ? undefined : onClick,
        disabled: disabled,
        style: {
          width: '100%',
          padding: '16px',
          borderRadius: '14px',
          fontSize: '17px',
          fontWeight: 700,
          letterSpacing: '-0.02em',
          background: disabled ? 'var(--label4)' : color,
          color: 'white',
          border: 'none',
          opacity: disabled ? 0.5 : 1,
          cursor: disabled ? 'default' : 'pointer',
          marginTop: '8px',
          fontFamily: 'var(--font)',
          transition: 'all 0.2s ease'
        }
      }, label);
    }

    // 11. MgmtStep
    function MgmtStep({ number, title, color = 'var(--blue)', children }) {
      return e('div', {
        style: { display: 'flex', gap: '14px', marginBottom: '16px' }
      },
        e('div', {
          style: {
            width: '30px',
            height: '30px',
            borderRadius: '50%',
            background: color,
            color: 'white',
            fontSize: '14px',
            fontWeight: 700,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            flexShrink: 0
          }
        }, number),
        e('div', { style: { flex: 1 } },
          e('div', {
            style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '4px' }
          }, title),
          e('div', {
            style: { fontSize: '13.5px', lineHeight: 1.6, color: 'var(--label2)' }
          }, children)
        )
      );
    }

    // 12. DiffCard (Collapsible)
    function DiffCard({ title, description, color = 'var(--blue)' }) {
      const [isOpen, setIsOpen] = useState(false);
      return e('div', {
        style: {
          background: 'var(--card)',
          border: '1px solid var(--sep)',
          borderRadius: '10px',
          marginBottom: '6px',
          overflow: 'hidden'
        }
      },
        e('button', {
          onClick: () => setIsOpen(!isOpen),
          style: {
            width: '100%',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'space-between',
            padding: '12px 14px',
            background: 'none',
            border: 'none',
            borderLeft: `4px solid ${color}`,
            cursor: 'pointer',
            fontFamily: 'var(--font)',
            textAlign: 'left'
          }
        },
          e('span', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label)' } }, title),
          e('span', {
            style: {
              fontSize: '14px',
              color: 'var(--label3)',
              transform: isOpen ? 'rotate(90deg)' : 'rotate(0)',
              transition: 'transform 0.2s ease'
            }
          }, 'â€º')
        ),
        e('div', {
          style: {
            maxHeight: isOpen ? '500px' : '0',
            overflow: 'hidden',
            transition: 'max-height 0.2s ease'
          }
        },
          e('div', {
            style: {
              borderTop: '1px solid var(--sep)',
              padding: '10px 14px',
              fontSize: '13px',
              lineHeight: 1.55,
              color: 'var(--label2)'
            }
          }, description)
        )
      );
    }

    // 13. LearnMoreDivider
    function LearnMoreDivider() {
      return e('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          marginTop: '24px',
          marginBottom: '16px',
          gap: '12px'
        }
      },
        e('div', { style: { flex: 1, height: '1px', background: 'var(--sep)' } }),
        e('span', { style: { fontSize: '12px', fontWeight: 600, color: 'var(--label4)' } }, 'Learn more'),
        e('div', { style: { flex: 1, height: '1px', background: 'var(--sep)' } })
      );
    }

    // 14. SeverityBadge (inline below inputs)
    function SeverityBadge({ text, color }) {
      return e('div', {
        style: {
          display: 'flex',
          alignItems: 'center',
          gap: '6px',
          marginTop: '6px'
        }
      },
        e('div', {
          style: {
            width: '8px',
            height: '8px',
            borderRadius: '50%',
            background: color,
            flexShrink: 0
          }
        }),
        e('span', { style: { fontSize: '13px', fontWeight: 600, color: color } }, text)
      );
    }

    // 15. HomeButton (for NavBar)
    function HomeButton({ onClick }) {
      return e('button', {
        onClick: onClick,
        style: {
          background: 'none',
          border: 'none',
          padding: '8px',
          cursor: 'pointer',
          borderRadius: '8px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center'
        }
      },
        e('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'var(--label3)', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          e('path', { d: 'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z' }),
          e('polyline', { points: '9 22 9 12 15 12 15 22' })
        )
      );
    }

    // ========== SCREENS ==========

    // Home Screen
    function HomeScreen({ onSelectModule }) {
      return e('div', null,
        // Header
        e('div', {
          style: {
            padding: '16px 24px',
            paddingTop: 'calc(16px + env(safe-area-inset-top))'
          }
        },
          e('div', { style: { display: 'flex', alignItems: 'center', gap: '14px' } },
            e('div', {
              style: {
                width: '52px',
                height: '52px',
                borderRadius: '14px',
                background: 'linear-gradient(145deg, #1C1C1E, #3A3A3C)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                boxShadow: '0 4px 12px rgba(0,0,0,0.15)'
              }
            }, e('span', { style: { fontSize: '26px' } }, 'ðŸ§¬')),
            e('div', null,
              e('div', {
                style: { fontSize: '30px', fontWeight: 800, letterSpacing: '-0.04em', color: 'var(--label)' }
              }, 'LabLogic'),
              e('div', {
                style: { fontSize: '14px', fontWeight: 500, color: 'var(--label3)' }
              }, 'Lab interpretation, step by step')
            )
          )
        ),

        // Module Cards
        e('div', { style: { padding: '0 20px' } },
          modules.map((mod, i) =>
            e(FadeIn, { key: mod.id, delay: 100 + i * 60 },
              e('button', {
                onClick: () => onSelectModule(mod.id),
                style: {
                  width: '100%',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '14px',
                  background: 'var(--card)',
                  borderRadius: '18px',
                  padding: '16px 18px',
                  border: '1px solid var(--sep)',
                  boxShadow: 'var(--shadow-sm)',
                  marginBottom: '10px',
                  cursor: 'pointer',
                  textAlign: 'left',
                  fontFamily: 'var(--font)',
                  transition: 'transform 0.2s ease'
                }
              },
                // Icon square
                e('div', {
                  style: {
                    width: '48px',
                    height: '48px',
                    borderRadius: '14px',
                    background: mod.gradient,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    boxShadow: `0 3px 10px ${mod.color}30`,
                    flexShrink: 0
                  }
                }, e('span', { style: { fontSize: '22px' } }, mod.icon)),
                // Text
                e('div', { style: { flex: 1 } },
                  e('div', {
                    style: { fontSize: '16px', fontWeight: 700, letterSpacing: '-0.02em', color: 'var(--label)' }
                  }, mod.name),
                  e('div', {
                    style: { fontSize: '13px', color: 'var(--label3)', marginTop: '2px' }
                  }, mod.desc)
                ),
                // Tag + chevron
                e('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', flexShrink: 0 } },
                  e('span', {
                    style: {
                      fontSize: '11px',
                      fontWeight: 700,
                      color: mod.color,
                      background: `${mod.color}12`,
                      padding: '3px 8px',
                      borderRadius: '6px'
                    }
                  }, mod.tag),
                  e('span', { style: { color: 'var(--label4)', fontSize: '18px' } }, 'â€º')
                )
              )
            )
          )
        ),

        // Footer
        e('div', {
          style: { textAlign: 'center', padding: '20px 0 8px', paddingBottom: 'calc(8px + env(safe-area-inset-bottom))' }
        },
          e('div', { style: { fontSize: '12px', color: 'var(--label4)' } }, 'For healthcare professionals only'),
          e('div', { style: { fontSize: '12px', color: 'var(--label4)', marginTop: '4px' } }, 'Not a medical device Â· Verify against local reference ranges')
        )
      );
    }

    // Placeholder Screen for non-TFT modules
    function PlaceholderScreen({ moduleId, onBack }) {
      const mod = modules.find(m => m.id === moduleId);
      return e('div', null,
        e(NavBar, { title: mod?.name || 'Module', onBack }),
        e('div', {
          style: {
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '80px 20px',
            textAlign: 'center'
          }
        },
          e('span', { style: { fontSize: '48px', marginBottom: '16px' } }, mod?.icon || 'ðŸ“‹'),
          e('div', { style: { fontSize: '20px', fontWeight: 700, color: 'var(--label)', marginBottom: '8px' } }, 'Coming Soon'),
          e('div', { style: { fontSize: '14px', color: 'var(--label3)' } }, mod?.desc || 'This module is under development')
        )
      );
    }

    // ========== TFT MODULE ==========

    function TFTModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const [acutelyUnwell, setAcutelyUnwell] = useState(null);
      const [tshResult, setTshResult] = useState(null);
      const [ft4, setFt4] = useState('');
      const [ft3, setFt3] = useState('');
      const [showMgmt, setShowMgmt] = useState(null); // 'hyper' or 'hypo'

      const steps = [
        { label: 'Context', color: 'var(--purple)' },
        { label: 'TSH', color: 'var(--purple)' },
        { label: 'fT4 / fT3', color: 'var(--purple)' },
        { label: 'Result', color: 'var(--purple)' }
      ];

      const handleBack = () => {
        if (showMgmt) {
          setShowMgmt(null);
        } else if (step === 0) {
          onBack();
        } else {
          setStep(step - 1);
        }
      };

      const goToStep = (newStep) => {
        setStep(newStep);
        if (containerRef.current) {
          containerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
        }
      };

      // Interpret values
      const interpretTSH = (val) => {
        const n = parseFloat(val);
        if (isNaN(n)) return null;
        if (n < 0.4) return 'low';
        if (n > 4.0) return 'high';
        return 'normal';
      };

      const interpretFT4 = (val) => {
        const n = parseFloat(val);
        if (isNaN(n)) return null;
        if (n < 12) return 'low';
        if (n > 22) return 'high';
        return 'normal';
      };

      const interpretFT3 = (val) => {
        const n = parseFloat(val);
        if (isNaN(n)) return null;
        if (n < 3.1) return 'low';
        if (n > 6.8) return 'high';
        return 'normal';
      };

      const ft4Status = interpretFT4(ft4);
      const ft3Status = interpretFT3(ft3);

      // Get TSH display values
      const getTSHDisplay = () => {
        if (tshResult === 'low') return { value: 'Low (< 0.4)', interpretation: 'Suppressed', color: 'var(--red)' };
        if (tshResult === 'high') return { value: 'High (> 4.0)', interpretation: 'Elevated', color: 'var(--orange)' };
        return { value: 'Normal (0.4â€“4.0)', interpretation: 'Within range', color: 'var(--green)' };
      };

      const getFT4Display = () => {
        if (ft4Status === 'low') return { value: `${ft4} pmol/L`, interp: 'Low', color: 'var(--red)' };
        if (ft4Status === 'high') return { value: `${ft4} pmol/L`, interp: 'High', color: 'var(--orange)' };
        return { value: `${ft4} pmol/L`, interp: 'Normal', color: 'var(--green)' };
      };

      const getFT3Display = () => {
        if (ft3Status === 'low') return { value: `${ft3} pmol/L`, interp: 'Low', color: 'var(--red)' };
        if (ft3Status === 'high') return { value: `${ft3} pmol/L`, interp: 'High', color: 'var(--orange)' };
        return { value: `${ft3} pmol/L`, interp: 'Normal', color: 'var(--green)' };
      };

      // Management screens
      if (showMgmt === 'hyper') {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(null), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', {
              onClick: () => setShowMgmt(null),
              style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' }
            }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '8px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Overt Hyperthyroidism')
            ),
            e('div', { style: { marginTop: '20px' } },
              e(MgmtStep, { number: 1, title: 'Beta-blocker for symptoms', color: 'var(--purple)' },
                e('span', null, e('strong', null, 'Propranolol 20â€“40 mg TDS'), ' â€” also inhibits peripheral T4â†’T3 conversion. Use for tremor, tachycardia, anxiety. Atenolol 25â€“50 mg daily if propranolol contraindicated.')
              ),
              e(MgmtStep, { number: 2, title: 'Antithyroid drug', color: 'var(--purple)' },
                e('span', null, e('strong', null, 'Carbimazole 20â€“40 mg daily'), ' â€” titrate to TFTs at 4â€“6 week intervals. OR ', e('strong', null, 'Propylthiouracil (PTU)'), ' if first trimester pregnancy or carbimazole intolerance/allergy.')
              ),
              e(MgmtStep, { number: 3, title: 'Definitive therapy', color: 'var(--purple)' },
                'Radioiodine ablation or thyroidectomy â€” decision depends on cause, patient preference, fertility plans, Graves\' eye disease.'
              )
            ),
            e(WarningBanner, null,
              e('strong', null, 'Thyroid storm'), ' is a life-threatening emergency: high-dose PTU + iodine (after PTU) + beta-blocker + hydrocortisone 100 mg IV q8h + ICU admission.'
            ),
            e(InfoPanel, { title: 'Amiodarone-Induced Thyroid Disease', color: 'var(--purple)' },
              e('div', { style: { background: 'rgba(175,82,222,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '10px' } },
                e('strong', null, 'Type 1:'), ' Excess iodine-induced synthesis in predisposed gland. Usually pre-existing thyroid disease. Treat: Carbimazole Â± perchlorate.'
              ),
              e('div', { style: { background: 'rgba(175,82,222,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '10px' } },
                e('strong', null, 'Type 2:'), ' Destructive thyroiditis releasing stored hormone. Usually normal thyroid. Treat: Prednisolone.'
              ),
              e('p', { style: { marginTop: '8px' } }, 'Often mixed picture â†’ trial of both treatments. Thyroid scan may help differentiate.')
            )
          )
        );
      }

      if (showMgmt === 'hypo') {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(null), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', {
              onClick: () => setShowMgmt(null),
              style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' }
            }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '8px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Overt Hypothyroidism')
            ),
            e('div', { style: { marginTop: '20px' } },
              e(MgmtStep, { number: 1, title: 'Levothyroxine (T4)', color: 'var(--purple)' },
                e('span', null, e('strong', null, 'Start 1.6 mcg/kg/day'), ' in young, otherwise healthy patients. In elderly or cardiac disease: ', e('strong', null, 'start 25â€“50 mcg/day'), ', titrate slowly (increase by 25 mcg every 4â€“6 weeks).')
              ),
              e(MgmtStep, { number: 2, title: 'Monitoring', color: 'var(--purple)' },
                e('span', null, e('strong', null, 'Recheck TSH 6â€“8 weeks'), ' after starting or any dose change. Take levothyroxine on empty stomach, 30â€“60 min before food. Separate from calcium, iron, PPIs by 4 hours.')
              ),
              e(MgmtStep, { number: 3, title: 'Target', color: 'var(--purple)' },
                'TSH in normal range (0.4â€“4.0 mU/L) for most patients. TSH <2.5 mU/L in pregnancy.'
              )
            ),
            e(WarningBanner, null,
              'If central hypothyroidism suspected: ', e('strong', null, 'check cortisol and treat adrenal insufficiency BEFORE starting levothyroxine.'), ' Thyroxine increases cortisol metabolism â€” can precipitate adrenal crisis.'
            )
          )
        );
      }

      // Main TFT flow
      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Thyroid Function', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(StepTrail, { steps, current: step }),

          // STEP 0: Clinical Context
          step === 0 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Clinical Context'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'This changes how we interpret the results')
            ),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'Is the patient acutely unwell?'),
            e(ChoiceButton, {
              label: 'Yes â€” acutely unwell or in ICU',
              sublabel: 'Consider sick euthyroid before interpreting',
              selected: acutelyUnwell === true,
              onClick: () => setAcutelyUnwell(true),
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'No â€” outpatient or stable',
              sublabel: 'Standard interpretation applies',
              selected: acutelyUnwell === false,
              onClick: () => setAcutelyUnwell(false),
              color: 'var(--purple)'
            }),
            acutelyUnwell === true && e(WarningBanner, null,
              e('strong', null, 'Non-thyroidal illness (sick euthyroid)'), ' can cause â†“fT3, â†“fT4, and â†“TSH in acute illness. Do NOT diagnose or treat thyroid disease from TFTs in acute illness unless TSH is markedly abnormal (>20 or <0.1).'
            ),
            e(PrimaryButton, {
              label: 'Next â†’ TSH',
              disabled: acutelyUnwell === null,
              color: 'var(--purple)',
              onClick: () => goToStep(1)
            }),
            e(LearnMoreDivider),
            e(InfoPanel, { title: 'Non-Thyroidal Illness Syndrome', color: 'var(--purple)' },
              e('p', { style: { marginBottom: '12px' } }, 'Acute illness suppresses the HPT axis. The pattern evolves with severity:'),
              e('div', { style: { background: 'rgba(175,82,222,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'Mild illness:'), ' â†“fT3 only. TSH and fT4 normal.'
              ),
              e('div', { style: { background: 'rgba(175,82,222,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'Moderate:'), ' â†“fT3, â†“fT4. TSH low-normal.'
              ),
              e('div', { style: { background: 'rgba(175,82,222,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'Severe / prolonged:'), ' â†“fT3, â†“fT4, â†“TSH. Mimics central hypothyroidism.'
              ),
              e('div', { style: { background: 'rgba(175,82,222,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '12px' } },
                e('strong', null, 'Recovery:'), ' TSH may transiently rise >10 mU/L before normalising.'
              ),
              e('p', { style: { fontWeight: 700 } }, 'Recheck TFTs 6â€“8 weeks after recovery.')
            )
          ),

          // STEP 1: TSH
          step === 1 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'TSH Result'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'The pituitary is exquisitely sensitive â€” TSH moves before fT4/fT3 become abnormal')
            ),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'What is the TSH?'),
            e(ChoiceButton, {
              label: 'Low  â€¹ 0.4',
              sublabel: 'Pituitary suppressed â†’ excess thyroid hormone (or pituitary failure)',
              selected: tshResult === 'low',
              onClick: () => setTshResult('low'),
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Normal  0.4 â€“ 4.0',
              sublabel: 'Usually euthyroid',
              selected: tshResult === 'normal',
              onClick: () => setTshResult('normal'),
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 4.0',
              sublabel: 'Pituitary driving harder â†’ insufficient thyroid hormone',
              selected: tshResult === 'high',
              onClick: () => setTshResult('high'),
              color: 'var(--orange)'
            }),
            e(PrimaryButton, {
              label: tshResult === 'low' ? 'Next â†’ Check fT4 & fT3' : 'Next â†’ Check fT4',
              disabled: tshResult === null,
              color: 'var(--purple)',
              onClick: () => goToStep(2)
            })
          ),

          // STEP 2: fT4 / fT3
          step === 2 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Thyroid Hormones'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } },
                tshResult === 'low' ? 'TSH is suppressed â€” check both fT4 and fT3 to classify' :
                tshResult === 'high' ? 'TSH is elevated â€” fT4 distinguishes overt from subclinical' :
                'TSH normal â€” fT4 checks for rare discordance (e.g. central hypothyroidism)'
              )
            ),
            e(BranchCard, {
              label: 'TSH',
              ...getTSHDisplay()
            }),
            e(ValueInput, {
              label: 'fT4',
              unit: 'pmol/L',
              value: ft4,
              onChange: setFt4,
              placeholder: '12 â€“ 22',
              hint: 'Normal: 12â€“22'
            }),
            tshResult === 'low' && e(ValueInput, {
              label: 'fT3',
              unit: 'pmol/L',
              value: ft3,
              onChange: setFt3,
              placeholder: '3.1 â€“ 6.8',
              hint: 'Normal: 3.1â€“6.8'
            }),
            e(PrimaryButton, {
              label: 'Interpret â†’',
              disabled: !ft4,
              color: 'var(--purple)',
              onClick: () => goToStep(3)
            })
          ),

          // STEP 3: Results
          step === 3 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Based on the algorithmic pathway')
            ),

            // Branch cards showing path
            e(BranchCard, { label: 'TSH', ...getTSHDisplay() }),
            ft4 && e(BranchCard, { label: 'fT4', ...getFT4Display() }),
            ft3 && tshResult === 'low' && e(BranchCard, { label: 'fT3', ...getFT3Display() }),

            e('div', {
              style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' }
            }, 'DIFFERENTIAL DIAGNOSIS'),

            // TSH LOW pathways
            tshResult === 'low' && ft4Status === 'high' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Overt Hyperthyroidism',
                severity: 'likely',
                tags: ['Graves\'', 'Toxic MNG', 'Toxic adenoma'],
                onTap: () => setShowMgmt('hyper')
              }, 'Suppressed TSH with elevated fT4 confirms thyrotoxicosis. Most commonly Graves\' disease, toxic multinodular goitre, or toxic adenoma.'),
              (ft3Status === 'high' || !ft3) && e(ResultCard, {
                title: 'TSH-secreting Pituitary Adenoma',
                subtitle: 'Or thyroid hormone resistance',
                severity: 'rare',
                tags: ['TSH should be suppressed', 'Refer endocrinology']
              }, 'TSH inappropriately normal/unsuppressed with elevated thyroid hormones. Very rare â€” consider TSH-producing adenoma or thyroid hormone resistance syndrome.')
            ),

            tshResult === 'low' && ft4Status === 'normal' && ft3Status === 'high' && e(ResultCard, {
              title: 'T3 Thyrotoxicosis',
              severity: 'likely',
              tags: ['~5% of hyperthyroidism', 'Early Graves\'', 'Toxic adenoma'],
              onTap: () => setShowMgmt('hyper')
            }, 'fT4 normal but fT3 elevated â€” about 5% of hyperthyroidism presents this way. Common in early Graves\' disease or autonomous thyroid adenoma.'),

            tshResult === 'low' && ft4Status === 'normal' && (ft3Status === 'normal' || !ft3 || ft3Status === null) && !(ft3Status === 'high') && e(ResultCard, {
              title: 'Subclinical Hyperthyroidism',
              severity: 'consider',
              tags: ['Recheck 6â€“8 weeks', 'AF risk', 'Osteoporosis risk']
            }, 'TSH suppressed but hormones normal. May be transient. Recheck in 6â€“8 weeks. If persistent, increased risk of atrial fibrillation and osteoporosis.'),

            tshResult === 'low' && ft4Status === 'low' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Central Hypothyroidism',
                severity: 'dangerous',
                tags: ['Pituitary failure', 'Check cortisol FIRST']
              }, 'Low TSH with low fT4 means the pituitary is failing â€” this is NOT primary thyroid disease. Investigate for pituitary pathology urgently.'),
              e(WarningBanner, null,
                e('strong', null, 'Check cortisol before starting thyroxine.'), ' Starting thyroxine with unrecognised adrenal insufficiency can precipitate adrenal crisis (thyroxine increases cortisol metabolism).'
              ),
              e(InfoPanel, { title: 'Central Hypothyroidism â€” Why It Matters', color: 'var(--red)' },
                e('p', { style: { marginBottom: '10px' } }, 'Low TSH + low fT4 = pituitary failure, not just thyroid disease.'),
                e('p', { style: { marginBottom: '10px' } }, 'Pituitary adenoma (mass effect) Â· Pituitary apoplexy Â· Post-surgical/radiation Â· Sheehan\'s syndrome Â· Infiltrative disease (sarcoid, haemochromatosis)'),
                e('p', { style: { fontWeight: 700 } }, 'If pituitary failure suspected, check cortisol BEFORE starting thyroxine.')
              )
            ),

            // TSH HIGH pathways
            tshResult === 'high' && ft4Status === 'low' && e(ResultCard, {
              title: 'Overt Hypothyroidism',
              severity: 'likely',
              tags: ['Hashimoto\'s', 'Post-thyroidectomy', 'Post-radioiodine'],
              onTap: () => setShowMgmt('hypo')
            }, 'Elevated TSH with low fT4 confirms primary hypothyroidism. Most commonly autoimmune (Hashimoto\'s â€” check TPO antibodies).'),

            tshResult === 'high' && ft4Status === 'normal' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Subclinical Hypothyroidism',
                severity: 'consider',
                tags: ['Recheck 6â€“8 weeks', 'Check TPO antibodies', 'Treat if TSH >10']
              }, 'TSH elevated but fT4 still normal. Common finding. Check TPO antibodies and recheck in 6â€“8 weeks. Treatment threshold depends on TSH level, symptoms, and antibody status.'),
              e(InfoPanel, { title: 'When to Treat Subclinical Hypothyroidism', color: 'var(--purple)' },
                e('div', { style: { background: 'rgba(48,209,88,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '10px' } },
                  e('strong', { style: { color: 'var(--green)' } }, 'TREAT IF:'), ' TSH >10 (even if asymptomatic) Â· TSH 4â€“10 with positive TPOAb Â· Symptoms attributable to hypothyroidism Â· Pregnant or planning pregnancy (target TSH <2.5)'
                ),
                e('div', { style: { background: 'rgba(255,159,10,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                  e('strong', { style: { color: 'var(--orange)' } }, 'OBSERVE IF:'), ' TSH 4â€“10 with negative TPOAb and asymptomatic Â· Elderly (>70 years) â€” higher TSH may be physiological Â· Recovery from acute illness'
                )
              )
            ),

            tshResult === 'high' && ft4Status === 'high' && e(ResultCard, {
              title: 'Assay Interference or TSH-oma',
              severity: 'rare',
              tags: ['Biotin interference', 'Heterophile antibodies', 'Refer endocrinology']
            }, 'TSH elevated with high fT4 is discordant â€” TSH should be suppressed. Consider biotin supplement interference, heterophile antibodies, or rare TSH-secreting pituitary adenoma.'),

            // TSH NORMAL pathways
            tshResult === 'normal' && ft4Status === 'normal' && e(ResultCard, {
              title: 'Euthyroid',
              severity: 'likely',
              tags: ['Normal thyroid function']
            }, 'TSH and fT4 both normal. Symptoms unlikely to be thyroid-related.'),

            tshResult === 'normal' && ft4Status === 'low' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Central Hypothyroidism',
                severity: 'dangerous',
                tags: ['Pituitary failure', 'Investigate urgently']
              }, 'Normal TSH is \'inappropriately normal\' in the context of low fT4. The pituitary should be driving TSH up. Investigate for pituitary pathology.'),
              e(WarningBanner, null,
                e('strong', null, 'Check cortisol before starting thyroxine.'), ' Starting thyroxine with unrecognised adrenal insufficiency can precipitate adrenal crisis (thyroxine increases cortisol metabolism).'
              ),
              e(InfoPanel, { title: 'Central Hypothyroidism â€” Why It Matters', color: 'var(--red)' },
                e('p', { style: { marginBottom: '10px' } }, 'Low TSH + low fT4 = pituitary failure, not just thyroid disease.'),
                e('p', { style: { marginBottom: '10px' } }, 'Pituitary adenoma (mass effect) Â· Pituitary apoplexy Â· Post-surgical/radiation Â· Sheehan\'s syndrome Â· Infiltrative disease (sarcoid, haemochromatosis)'),
                e('p', { style: { fontWeight: 700 } }, 'If pituitary failure suspected, check cortisol BEFORE starting thyroxine.')
              )
            ),

            tshResult === 'normal' && ft4Status === 'high' && e(ResultCard, {
              title: 'Assay Interference',
              severity: 'consider',
              tags: ['Biotin supplements', 'Heterophile antibodies', 'Recheck']
            }, 'Normal TSH with high fT4 is discordant. Most commonly caused by biotin supplement interference. Stop biotin for 48h and recheck, or request repeat on different assay platform.'),

            e(PrimaryButton, {
              label: 'New Analysis',
              color: 'var(--label3)',
              onClick: onBack
            }),

            e(LearnMoreDivider),

            // Causes of Hyperthyroidism InfoPanel (when hyperthyroid)
            (tshResult === 'low' && (ft4Status === 'high' || (ft4Status === 'normal' && ft3Status === 'high'))) && e(InfoPanel, { title: 'Causes of Hyperthyroidism', color: 'var(--purple)' },
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'High uptake on thyroid scan (â†‘ synthesis):'),
              e('ul', { style: { marginLeft: '16px', marginBottom: '12px' } },
                e('li', null, 'Graves\' disease â€” diffuse uptake, TRAb positive'),
                e('li', null, 'Toxic multinodular goitre â€” patchy uptake'),
                e('li', null, 'Toxic adenoma â€” single hot nodule')
              ),
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'Low uptake on thyroid scan (preformed hormone release):'),
              e('ul', { style: { marginLeft: '16px', marginBottom: '12px' } },
                e('li', null, 'Thyroiditis (subacute, postpartum, silent)'),
                e('li', null, 'Exogenous thyroid hormone'),
                e('li', null, 'Iodine-induced (amiodarone, contrast)')
              ),
              e('p', { style: { fontWeight: 700, marginBottom: '10px' } }, 'Key distinguishing features:'),
              e('ul', { style: { marginLeft: '16px' } },
                e('li', null, 'Graves\': eye signs, diffuse goitre, TRAb positive'),
                e('li', null, 'Thyroiditis: tender thyroid, self-limiting'),
                e('li', null, 'Amiodarone: Type 1 (synthesis) vs Type 2 (destructive)')
              )
            ),

            // Assay interference panel
            e(InfoPanel, { title: 'Assay Interference â€” the Hidden Trap', color: 'var(--purple)' },
              e('p', { style: { marginBottom: '10px' } },
                e('strong', null, 'Biotin (Vitamin B7):'), ' High-dose biotin supplements (common in "hair and nails" products, also MS treatment) interfere with streptavidin-biotin immunoassays. Can cause falsely â†‘fT4, â†‘fT3, â†“TSH â€” mimicking hyperthyroidism.'
              ),
              e('p', { style: { marginBottom: '10px' } },
                e('strong', null, 'Heterophile antibodies:'), ' Antibodies that interfere with immunoassays. Can cause falsely high or low results. Suspect if discordant with clinical picture.'
              ),
              e('p', null,
                e('strong', null, 'Hook effect:'), ' Very high analyte concentrations can saturate assay and give falsely low/normal results. Rare but relevant in pregnancy and severe thyrotoxicosis.'
              )
            )
          )
        )
      );
    }

    // ========== HYPONATRAEMIA MODULE ==========

    function HyponatraemiaModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);

      // Step 0: Severity & Chronicity
      const [naValue, setNaValue] = useState('');
      const [chronicity, setChronicity] = useState(null);
      const [glucose, setGlucose] = useState('');

      // Step 1: Serum Osmolality
      const [serumOsmResult, setSerumOsmResult] = useState(null);

      // Step 2: Urine Osmolality
      const [urineOsmResult, setUrineOsmResult] = useState(null);

      // Step 3: Urine Sodium
      const [urineNaResult, setUrineNaResult] = useState(null);

      // Management
      const [showMgmt, setShowMgmt] = useState(false);

      // Determine if we're on short path (iso/hyper-osmolar skips urine steps)
      const isShortPath = serumOsmResult === 'normal' || serumOsmResult === 'high';

      // Build dynamic step trail based on path
      const getSteps = () => {
        if (isShortPath) {
          return [
            { label: 'Severity', color: 'var(--blue)' },
            { label: 'Serum Osm', color: 'var(--blue)' },
            { label: 'Result', color: 'var(--blue)' }
          ];
        }
        return [
          { label: 'Severity', color: 'var(--blue)' },
          { label: 'Serum Osm', color: 'var(--blue)' },
          { label: 'Urine Osm', color: 'var(--blue)' },
          { label: 'Urine Na', color: 'var(--blue)' },
          { label: 'Result', color: 'var(--blue)' }
        ];
      };

      // Map internal step to display step for trail
      const getDisplayStep = () => {
        if (isShortPath) {
          if (step === 0) return 0;
          if (step === 1) return 1;
          if (step === 4) return 2;
        }
        return step;
      };

      const scrollToTop = () => {
        if (containerRef.current) {
          containerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
        }
      };

      const goToStep = (newStep) => {
        setStep(newStep);
        scrollToTop();
      };

      const handleBack = () => {
        if (showMgmt) {
          setShowMgmt(false);
        } else if (step === 0) {
          onBack();
        } else if (step === 4) {
          // Results step - go back based on path
          if (isShortPath) {
            goToStep(1);
          } else {
            goToStep(3);
          }
        } else {
          goToStep(step - 1);
        }
      };

      // Severity assessment
      const getSeverity = () => {
        const na = parseFloat(naValue);
        if (isNaN(na)) return null;
        if (na > 130) return { color: 'var(--green)', interp: 'Mild â€” usually asymptomatic' };
        if (na >= 125) return { color: 'var(--orange)', interp: 'Moderate â€” confusion, nausea, headache likely' };
        if (na >= 120) return { color: 'var(--orange)', interp: 'Significant â€” high risk of symptoms' };
        return { color: 'var(--red)', interp: 'Severe â€” seizures, coma, cerebral oedema risk' };
      };

      // Corrected Na calculation
      const getCorrectedNa = () => {
        const na = parseFloat(naValue);
        const glu = parseFloat(glucose);
        if (isNaN(na) || isNaN(glu) || glu <= 10) return null;
        return (na + glu / 4).toFixed(1);
      };

      // Na display for branch cards
      const getNaDisplay = () => {
        const severity = getSeverity();
        return {
          value: naValue ? `${naValue} mmol/L` : '',
          interpretation: severity?.interp || '',
          color: severity?.color || 'var(--blue)'
        };
      };

      const getSerumOsmDisplay = () => {
        if (serumOsmResult === 'low') return { value: 'Low (< 275)', interpretation: 'Hypotonic', color: 'var(--blue)' };
        if (serumOsmResult === 'normal') return { value: 'Normal (275â€“295)', interpretation: 'Iso-osmolar', color: 'var(--green)' };
        if (serumOsmResult === 'high') return { value: 'High (> 295)', interpretation: 'Hyper-osmolar', color: 'var(--orange)' };
        if (serumOsmResult === 'skip') return { value: 'Not available', interpretation: 'Assumed hypotonic', color: 'var(--label3)' };
        return { value: '', interpretation: '', color: 'var(--blue)' };
      };

      const getUrineOsmDisplay = () => {
        if (urineOsmResult === 'low') return { value: 'Low (< 100)', interpretation: 'Dilute â€” kidneys working', color: 'var(--green)' };
        if (urineOsmResult === 'high') return { value: 'High (> 100)', interpretation: 'Concentrated â€” ADH active', color: 'var(--orange)' };
        return { value: '', interpretation: '', color: 'var(--blue)' };
      };

      const getUrineNaDisplay = () => {
        if (urineNaResult === 'low') return { value: 'Low (< 20â€“40)', interpretation: 'Retained â€” kidneys conserving', color: 'var(--green)' };
        if (urineNaResult === 'high') return { value: 'High (> 20â€“40)', interpretation: 'Wasted â€” sodium loss', color: 'var(--orange)' };
        return { value: '', interpretation: '', color: 'var(--blue)' };
      };

      // Management screen
      if (showMgmt) {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', {
              onClick: () => setShowMgmt(false),
              style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' }
            }, 'â€¹ Back to results'),

            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Hyponatraemia')
            ),

            // Step 1: Seizure or Severe Symptoms
            e(MgmtStep, { number: 1, title: 'Seizure or Severe Symptoms', color: 'var(--red)' },
              e('span', null,
                e('strong', null, '150 ml 3% NaCl'), ' OR ', e('strong', null, '75 ml 8.4% NaHCOâ‚ƒ'), ' over 10 minutes.',
                e('br', null),
                'Aim to increase Na by ', e('strong', null, '2.5â€“5 mmol'), ' and then hold.',
                e('br', null),
                'Can repeat once if ongoing seizure.'
              )
            ),

            // Step 2: Treat the Cause
            e(MgmtStep, { number: 2, title: 'Treat the Cause', color: 'var(--blue)' },
              e('span', null,
                'Stop drugs and fluids contributing to hyponatraemia.',
                e('br', null),
                'Treat underlying pathology:',
                e('br', null),
                'â€¢ Thyroxine for hypothyroidism',
                e('br', null),
                'â€¢ Corticosteroid for adrenal insufficiency',
                e('br', null),
                'â€¢ Tolvaptan for SIADH',
                e('br', null),
                'â€¢ Diuretics + ACEi for heart failure',
                e('br', null),
                'â€¢ Albumin + diuretics for cirrhosis'
              )
            ),

            // Step 3: Avoid Dangerous Overcorrection
            e(MgmtStep, { number: 3, title: 'Avoid Dangerous Overcorrection', color: 'var(--orange)' },
              e('span', null,
                'Allow Na to rise by ', e('strong', null, 'max 0.5 mmol/hr'), ' and ', e('strong', null, 'max 8â€“10 mmol/24hr'), '.'
              )
            ),

            e(WarningBanner, null,
              'Consider ', e('strong', null, 'DDAVP 2 mcg IV q8h'), ' to prevent uncontrolled free water excretion. This gives you control: Rx NaCl, nothing, or water to raise, stabilise, or lower Na respectively.'
            ),

            // Step 4: Fluid Strategy
            e(MgmtStep, { number: 4, title: 'Fluid Restrict vs Isotonic vs Hypertonic NaCl', color: 'var(--blue)' },
              e('div', { style: { marginTop: '8px' } },
                e('div', { style: { display: 'flex', background: 'var(--card)', borderRadius: '10px', border: '1px solid var(--sep)', overflow: 'hidden', marginBottom: '8px' } },
                  e('div', { style: { width: '4px', background: 'var(--blue)', flexShrink: 0 } }),
                  e('div', { style: { padding: '12px' } },
                    e('strong', null, 'Fluid restriction'),
                    e('div', { style: { fontSize: '13px', color: 'var(--label2)', marginTop: '4px' } }, 'If hypervolaemic or euvolaemic. UNLESS already oliguric or high urine osmolality (fluid restriction won\'t work if kidneys are already maximally concentrating).')
                  )
                ),
                e('div', { style: { display: 'flex', background: 'var(--card)', borderRadius: '10px', border: '1px solid var(--sep)', overflow: 'hidden', marginBottom: '8px' } },
                  e('div', { style: { width: '4px', background: 'var(--green)', flexShrink: 0 } }),
                  e('div', { style: { padding: '12px' } },
                    e('strong', null, 'Isotonic saline (0.9% NaCl)'),
                    e('div', { style: { fontSize: '13px', color: 'var(--label2)', marginTop: '4px' } }, 'If hypovolaemic. Replace the volume deficit.')
                  )
                ),
                e('div', { style: { display: 'flex', background: 'var(--card)', borderRadius: '10px', border: '1px solid var(--sep)', overflow: 'hidden' } },
                  e('div', { style: { width: '4px', background: 'var(--red)', flexShrink: 0 } }),
                  e('div', { style: { padding: '12px' } },
                    e('strong', null, 'Hypertonic saline (3% NaCl)'),
                    e('div', { style: { fontSize: '13px', color: 'var(--label2)', marginTop: '4px' } }, 'If Na is dangerously low or symptomatic. ICU setting. Controlled infusion with frequent Na monitoring.')
                  )
                )
              )
            ),

            e(LearnMoreDivider),

            // ODS Info Panel (updated evidence-based content)
            e(InfoPanel, { title: 'Osmotic Demyelination Syndrome (ODS)', color: 'var(--red)' },
              e('div', { style: { background: 'rgba(255,69,58,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'How common is it?'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Risk is approximately ', e('strong', null, '0.05%'), ' of hyponatraemia admissions (large Toronto cohort, n=22,858). However, if Na <110 mmol/L the risk rises to ', e('strong', null, '~3%'), '. Notably, many ODS cases did not have documented rapid correction â€” the cause is not fully understood.')
              ),
              e('div', { style: { background: 'rgba(255,69,58,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'High-risk features'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Na <110 mmol/L Â· Alcohol use disorder / beer potomania Â· Malnutrition Â· Advanced liver disease Â· Hypokalaemia Â· Post-transplant Â· Elderly')
              ),
              e('div', { style: { background: 'rgba(255,69,58,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'Safe rate of correction'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Evidence is slightly mixed. Some studies report ', e('strong', null, '4Ã— relative risk if rise >10â€“12 mmol/24h'), ' in severe hyponatraemia. However, a large 2025 JAMA meta-analysis found increased mortality with ', e('strong', null, 'slow'), ' correction â€” suggesting overcaution also carries risk.'),
                e('p', { style: { fontSize: '13px', marginTop: '6px' } }, 'Pragmatic target: ', e('strong', null, 'â‰¤8â€“10 mmol/L rise in any 24-hour period.'), ' Risk of ODS tracks to the fastest sodium rise (the peak 24h increment, not the average rate).')
              ),
              e('div', { style: { background: 'rgba(255,69,58,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                e('strong', null, 'If overcorrection occurs'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Re-lower Na with ', e('strong', null, 'DDAVP 2 mcg IV'), ' + D5W infusion. Aim to bring Na back to a safe correction rate. Consult nephrology.')
              )
            ),

            e(PrimaryButton, {
              label: 'New Analysis',
              color: 'var(--label3)',
              onClick: onBack
            })
          )
        );
      }

      // Main flow
      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Hyponatraemia', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(StepTrail, { steps: getSteps(), current: getDisplayStep() }),

          // STEP 0: Severity & Chronicity
          step === 0 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Assess Severity & Chronicity'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'How dangerous is this, and how quickly did it develop?')
            ),

            e(ValueInput, {
              label: 'Serum Sodium',
              unit: 'mmol/L',
              value: naValue,
              onChange: setNaValue,
              placeholder: '135 â€“ 145',
              hint: 'Normal: 135â€“145'
            }),

            // Inline severity indicator
            getSeverity() && e(SeverityBadge, { text: getSeverity().interp, color: getSeverity().color }),

            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginTop: '20px', marginBottom: '12px' } }, 'How quickly did this develop?'),

            e(ChoiceButton, {
              label: 'Acute  â€¹ 48 hours',
              sublabel: 'Higher risk of cerebral oedema. More aggressive correction tolerated.',
              selected: chronicity === 'acute',
              onClick: () => setChronicity('acute'),
              color: 'var(--red)'
            }),
            e(ChoiceButton, {
              label: 'Chronic  â€º 48 hours',
              sublabel: 'Brain has adapted. Rapid correction risks osmotic demyelination.',
              selected: chronicity === 'chronic',
              onClick: () => setChronicity('chronic'),
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Unknown',
              sublabel: 'Treat as chronic (safer assumption)',
              selected: chronicity === 'unknown',
              onClick: () => setChronicity('unknown'),
              color: 'var(--blue)'
            }),

            e(ValueInput, {
              label: 'Glucose',
              unit: 'mmol/L',
              value: glucose,
              onChange: setGlucose,
              placeholder: 'Optional',
              hint: 'For corrected Na'
            }),

            // Corrected Na calculation
            getCorrectedNa() && e(BranchCard, {
              label: 'Corrected Na',
              value: `${getCorrectedNa()} mmol/L`,
              interpretation: 'Predicted Na once glucose normalises',
              color: 'var(--blue)'
            }),

            e(PrimaryButton, {
              label: 'Next â†’ Serum Osmolality',
              disabled: !naValue || !chronicity,
              color: 'var(--blue)',
              onClick: () => goToStep(1)
            }),

            e(LearnMoreDivider),

            // ODS Info Panel (updated evidence-based content)
            e(InfoPanel, { title: 'Osmotic Demyelination Syndrome (ODS)', color: 'var(--blue)' },
              e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'How common is it?'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Risk is approximately ', e('strong', null, '0.05%'), ' of hyponatraemia admissions. However, if Na <110 mmol/L the risk rises to ', e('strong', null, '~3%'), '.')
              ),
              e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'High-risk features'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Na <110 mmol/L Â· Alcohol use disorder Â· Malnutrition Â· Advanced liver disease Â· Hypokalaemia Â· Post-transplant Â· Elderly')
              ),
              e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                e('strong', null, 'Safe rate of correction'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Pragmatic target: ', e('strong', null, 'â‰¤8â€“10 mmol/L rise in any 24-hour period.'), ' Risk tracks to the peak 24h increment.')
              ),
              e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                e('strong', null, 'If overcorrection occurs'),
                e('p', { style: { fontSize: '13px', marginTop: '4px' } }, 'Re-lower Na with ', e('strong', null, 'DDAVP 2 mcg IV'), ' + D5W infusion. Consult nephrology.')
              )
            )
          ),

          // STEP 1: Serum Osmolality
          step === 1 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Serum Osmolality'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'To exclude measurement error or dilutional effect. Normal: 275â€“295 mOsm/kg.')
            ),

            e(BranchCard, { label: 'Serum Sodium', ...getNaDisplay() }),

            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'What is the serum osmolality?'),

            e(ChoiceButton, {
              label: 'Low  â€¹ 275',
              sublabel: 'True hypotonic hyponatraemia â†’ proceed to urine osmolality',
              selected: serumOsmResult === 'low',
              onClick: () => setSerumOsmResult('low'),
              color: 'var(--blue)'
            }),
            e(ChoiceButton, {
              label: 'Normal  275 â€“ 295',
              sublabel: 'Iso-osmolar â†’ likely pseudohyponatraemia',
              selected: serumOsmResult === 'normal',
              onClick: () => setSerumOsmResult('normal'),
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 295',
              sublabel: 'Hyper-osmolar â†’ dilutional effect (glucose, mannitol)',
              selected: serumOsmResult === 'high',
              onClick: () => setSerumOsmResult('high'),
              color: 'var(--orange)'
            }),
            e(ChoiceButton, {
              label: 'Not available',
              sublabel: 'Assume hypotonic and proceed with urine osmolality',
              selected: serumOsmResult === 'skip',
              onClick: () => setSerumOsmResult('skip'),
              color: 'var(--label3)'
            }),

            // If Normal (iso-osmolar) - show result immediately
            serumOsmResult === 'normal' && e('div', { style: { marginTop: '16px' } },
              e(ResultCard, {
                title: 'Iso-osmolar Hyponatraemia (Pseudohyponatraemia)',
                severity: 'consider',
                tags: ['Measurement artefact', 'Check Na on VBG']
              }, 'Usually measurement error secondary to hyperlipidaemia or hyperproteinaemia. Overcome by measuring Na on VBG (direct ion-selective electrode).'),
              e(InfoPanel, { title: 'Tonicity vs Osmolality', color: 'var(--blue)' },
                e('p', { style: { marginBottom: '10px' } }, 'Very high urea or ethanol levels contribute to measured osmolality, making hypo-osmolar hyponatraemia look iso-osmolar.'),
                e('p', { style: { marginBottom: '10px' } }, 'Tonicity = Osmolality âˆ’ Urea (urea is an ineffective osmole â€” crosses cell membranes freely).'),
                e('p', null, 'If in doubt, calculate tonicity or check Na on VBG.')
              ),
              e(PrimaryButton, {
                label: 'New Analysis',
                color: 'var(--label3)',
                onClick: onBack
              })
            ),

            // If High (hyper-osmolar) - show result immediately
            serumOsmResult === 'high' && e('div', { style: { marginTop: '16px' } },
              e(ResultCard, {
                title: 'Hyper-osmolar Hyponatraemia',
                severity: 'likely',
                tags: ['Mannitol', 'Hyperglycaemia', 'IVIg']
              }, '"Dilutional" effect â€” water drawn into intravascular space by osmotically active solutes. The measured Na IS correct. The corrected Na predicts what Na will be once the osmotic load clears.'),
              getCorrectedNa() && e(BranchCard, {
                label: 'Corrected Na',
                value: `${getCorrectedNa()} mmol/L`,
                interpretation: 'Predicted Na once glucose normalises',
                color: 'var(--blue)'
              }),
              e(WarningBanner, null, 'Risk of cerebral oedema if BSL is corrected without commensurate rise in Na.'),
              e(PrimaryButton, {
                label: 'New Analysis',
                color: 'var(--label3)',
                onClick: onBack
              })
            ),

            // If Low or Skip - continue
            (serumOsmResult === 'low' || serumOsmResult === 'skip') && e(PrimaryButton, {
              label: 'Next â†’ Urine Osmolality',
              color: 'var(--blue)',
              onClick: () => goToStep(2)
            })
          ),

          // STEP 2: Urine Osmolality
          step === 2 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Urine Osmolality'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'To identify water retention. Should be maximally dilute (<100 mOsm/kg) to defend serum tonicity.')
            ),

            e(BranchCard, { label: 'Serum Sodium', ...getNaDisplay() }),
            e(BranchCard, { label: 'Serum Osm', ...getSerumOsmDisplay() }),

            e(WarningBanner, null, 'Urinary biochemistry is confounded by diuretics, vasopressin, and DDAVP. Interpret with caution if any of these are in use.'),

            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'Is the kidney diluting appropriately?'),

            e(ChoiceButton, {
              label: 'Low  â€¹ 100',
              sublabel: 'Kidneys ARE diluting appropriately â€” problem is excess water intake',
              selected: urineOsmResult === 'low',
              onClick: () => setUrineOsmResult('low'),
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 100',
              sublabel: 'Kidneys are NOT diluting â€” ADH is active (appropriately or inappropriately)',
              selected: urineOsmResult === 'high',
              onClick: () => setUrineOsmResult('high'),
              color: 'var(--orange)'
            }),

            e(PrimaryButton, {
              label: 'Next â†’ Urine Sodium',
              disabled: !urineOsmResult,
              color: 'var(--blue)',
              onClick: () => goToStep(3)
            })
          ),

          // STEP 3: Urine Sodium
          step === 3 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Urine Sodium'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'To identify salt wasting. Should be low in order to defend serum tonicity.')
            ),

            e(BranchCard, { label: 'Serum Sodium', ...getNaDisplay() }),
            e(BranchCard, { label: 'Serum Osm', ...getSerumOsmDisplay() }),
            e(BranchCard, { label: 'Urine Osm', ...getUrineOsmDisplay() }),

            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'What is the urine sodium?'),

            e(ChoiceButton, {
              label: 'Low  â€¹ 20â€“40',
              sublabel: 'Kidneys retaining sodium appropriately',
              selected: urineNaResult === 'low',
              onClick: () => setUrineNaResult('low'),
              color: 'var(--green)'
            }),
            e(ChoiceButton, {
              label: 'High  â€º 20â€“40',
              sublabel: 'Kidneys wasting sodium',
              selected: urineNaResult === 'high',
              onClick: () => setUrineNaResult('high'),
              color: 'var(--orange)'
            }),

            e(PrimaryButton, {
              label: 'Interpret â†’',
              disabled: !urineNaResult,
              color: 'var(--blue)',
              onClick: () => goToStep(4)
            })
          ),

          // STEP 4: Results
          step === 4 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Based on the algorithmic pathway')
            ),

            // Branch cards showing path
            e(BranchCard, { label: 'Serum Sodium', ...getNaDisplay() }),
            e(BranchCard, { label: 'Serum Osm', ...getSerumOsmDisplay() }),
            !isShortPath && e(BranchCard, { label: 'Urine Osm', ...getUrineOsmDisplay() }),
            !isShortPath && e(BranchCard, { label: 'Urine Na', ...getUrineNaDisplay() }),

            e('div', {
              style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' }
            }, 'DIFFERENTIAL DIAGNOSIS'),

            // PATH A: Low Urine Osm + Low Urine Na
            urineOsmResult === 'low' && urineNaResult === 'low' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Excess Water Intake',
                severity: 'likely',
                tags: ['Polydipsia', 'Excess IV fluid', 'Beer potomania']
              }, 'Huge water intake exceeding renal capacity to defend tonicity, even with maximally dilute urine.'),
              e(DiffCard, { title: 'Excess IV fluid', description: 'Iatrogenic. Review fluid orders.' }),
              e(DiffCard, { title: 'Primary polydipsia', description: 'Psychiatric or medication-related. Water intake often >10L/day.' }),
              e(DiffCard, { title: 'Beer potomania', description: 'Very low solute diet limits renal free water excretion capacity.' }),
              e(DiffCard, { title: 'Reset osmostat', description: 'Rare. Osmostat set lower but regulation intact. No treatment required.' }),
              e(WarningBanner, null, 'Rx fluid restriction â€” but beware rapid Na rise, especially if the cause of excess water intake is removed (e.g. stopping IV fluids). Monitor closely for overcorrection.')
            ),

            // PATH B: Low Urine Osm + High Urine Na
            urineOsmResult === 'low' && urineNaResult === 'high' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Renal Salt & Water Wasting',
                severity: 'consider',
                tags: ['AKI', 'Post-obstructive', 'ATN']
              }, 'Kidneys are wasting both salt and water â€” unable to concentrate or conserve sodium.'),
              e(DiffCard, { title: 'AKI (GFR <15)', description: 'Severely reduced GFR impairs all tubular function.' }),
              e(DiffCard, { title: 'Post-obstructive diuresis', description: 'After relief of urinary obstruction. Can be massive.' }),
              e(DiffCard, { title: 'Polyuric phase of ATN', description: 'Recovery phase of acute tubular necrosis.' })
            ),

            // PATH C: High Urine Osm + Low Urine Na
            urineOsmResult === 'high' && urineNaResult === 'low' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Hypovolaemia or Effective Hypovolaemia',
                severity: 'likely',
                tags: ['Volume depletion', 'Heart failure', 'Liver failure', 'Nephrotic syndrome']
              }, 'Actual or effective hypovolaemia â†’ RAAS overactivation. The body is defending volume over tonicity â†’ water retention.'),
              e(InfoPanel, { title: 'Volume over Tonicity', color: 'var(--blue)' },
                e('p', null, 'The baroreceptor reflex is a stronger stimulus for ADH release than the osmoreceptor reflex. When intravascular volume is low (or perceived as low â€” heart failure, liver failure), the body will retain water even at the expense of worsening hyponatraemia. This is because volume depletion kills faster than low sodium.')
              ),
              e(DiffCard, { title: 'True hypovolaemia', description: 'Bleeding, GI losses, third-spacing. Look for tachycardia, orthostatic hypotension, poor skin turgor.' }),
              e(DiffCard, { title: 'Heart failure', description: 'Effective hypovolaemia despite total body fluid overload. Poor cardiac output â†’ RAAS activation.' }),
              e(DiffCard, { title: 'Liver failure / cirrhosis', description: 'Splanchnic vasodilation â†’ effective hypovolaemia. Ascites present.' }),
              e(DiffCard, { title: 'Nephrotic syndrome', description: 'Hypoalbuminaemia â†’ reduced oncotic pressure â†’ effective hypovolaemia.' }),
              e('div', {
                style: {
                  background: 'rgba(48,209,88,0.08)',
                  border: '1px solid rgba(48,209,88,0.2)',
                  borderRadius: '14px',
                  padding: '14px 16px',
                  marginTop: '12px',
                  marginBottom: '12px'
                }
              },
                e('div', { style: { fontWeight: 700, color: 'var(--green)', marginBottom: '4px' } }, 'Management note'),
                e('div', { style: { fontSize: '13px', color: 'var(--label2)', lineHeight: 1.55 } }, 'Rx: ACEi + loop diuretic for heart failure/liver failure/nephrotic syndrome. IV saline for true hypovolaemia. Do NOT fluid restrict oedematous patients â€” they are intravascularly deplete.')
              )
            ),

            // PATH D: High Urine Osm + High Urine Na
            urineOsmResult === 'high' && urineNaResult === 'high' && e(React.Fragment, null,
              e(ResultCard, {
                title: 'Water Retention with Sodium Wasting',
                severity: 'likely',
                tags: ['SIADH', 'Adrenal insufficiency', 'Hypothyroidism', 'Cerebral salt wasting']
              }, 'ADH is active (water retention) AND kidneys are wasting sodium. This is the broadest differential â€” clinical context is critical.'),

              e(DiffCard, { title: 'SIADH', description: 'Most common cause of euvolaemic hyponatraemia. Diagnosis of exclusion: euvolaemic, no adrenal insufficiency, no hypothyroidism, no renal failure, no diuretics. Oliguric (concentrated urine).' }),

              e(DiffCard, { title: 'Adrenal insufficiency (Addison\'s, pan-hypopit)', description: 'Aldosterone deficiency â†’ Na wasting. Cortisol deficiency â†’ impaired free water excretion.' }),
              e('div', {
                style: {
                  background: 'rgba(255,69,58,0.06)',
                  border: '1px solid rgba(255,69,58,0.15)',
                  borderRadius: '10px',
                  padding: '10px 12px',
                  marginBottom: '6px',
                  fontSize: '12px',
                  color: '#C41E10',
                  fontWeight: 500
                }
              }, 'Must exclude adrenal insufficiency before diagnosing SIADH. Check morning cortisol Â± short synacthen test.'),

              e(DiffCard, { title: 'Hypothyroidism', description: 'Mechanism unclear but well-recognised association. Check TFTs.' }),

              e(DiffCard, { title: 'Cerebral salt wasting', description: 'Polyuric (unlike SIADH which is oliguric). Related to â†‘BNP/ANP â†’ natriuresis â†’ hypovolaemia. Appropriate ADH secretion to compensate.' }),

              e(DiffCard, { title: 'Thiazide diuretic', description: 'Common and frequently overlooked. Thiazides impair diluting capacity in the distal tubule. Loop diuretics are LESS likely to cause hyponatraemia (they impair concentrating ability).' }),

              e(DiffCard, { title: 'AKI (GFR <15)', description: 'Impaired dilution and sodium handling.' }),

              e(DiffCard, { title: 'Post-obstructive diuresis / Polyuric ATN', description: 'Recovery phase â€” kidneys wasting everything.' }),

              e(InfoPanel, { title: 'Physiology of Key Diagnoses', color: 'var(--blue)' },
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Renal salt wasting:'), ' Failure of ATP-dependent Na+/K+ ATPase. Renal ADH responsiveness variable, thus urine osmolality variable.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Hypoaldosteronism:'), ' ENaC + uninhibited ADH release â†’ Na wasting + water retention. Giveaway is hyperkalaemia.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Hypothyroidism:'), ' Mechanism unclear.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '8px' } },
                  e('strong', null, 'Oedematous disorders:'), ' Hypotension/intravascular hypovolaemia â†’ ADH release + overactivation of RAAS â†’ Na and water retention. Baroreceptor reflex is a stronger stimulus for ADH release than the osmoreceptor reflex. IE: body will defend volume over tonicity.'
                ),
                e('div', { style: { background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                  e('strong', null, 'Cerebral salt wasting:'), ' Poorly understood. Related to â†‘BNP/ANP â†’ natriuresis â†’ polyuria and hypovolaemia. Appropriate secretion of ADH to compensate.'
                )
              ),

              e(InfoPanel, { title: 'SIADH vs Cerebral Salt Wasting â€” the Key Distinction', color: 'var(--blue)' },
                e('p', { style: { marginBottom: '12px' } }, 'Both cause hyponatraemia with high urine osm and high urine Na. The critical difference is volume status:'),
                e('div', { style: { display: 'flex', gap: '8px', marginBottom: '12px' } },
                  e('div', { style: { flex: 1, background: 'rgba(10,132,255,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                    e('strong', { style: { color: 'var(--blue)' } }, 'SIADH:'),
                    e('div', { style: { fontSize: '12px', marginTop: '4px' } }, 'Euvolaemic or mildly hypervolaemic. Oliguric. Urine osm typically >300. Treatment: fluid restriction, tolvaptan.')
                  ),
                  e('div', { style: { flex: 1, background: 'rgba(255,159,10,0.08)', borderRadius: '10px', padding: '10px 12px' } },
                    e('strong', { style: { color: 'var(--orange)' } }, 'CSW:'),
                    e('div', { style: { fontSize: '12px', marginTop: '4px' } }, 'Hypovolaemic. Polyuric. High urine output. Treatment: isotonic or hypertonic saline (fluid restriction will worsen hypovolaemia and Na).')
                  )
                ),
                e('p', { style: { fontWeight: 600, color: 'var(--red)' } }, 'Getting this wrong matters: fluid restricting a CSW patient worsens their hypovolaemia and hyponatraemia.')
              )
            ),

            // Bottom buttons (for all result paths)
            e('div', { style: { marginTop: '20px' } },
              e(PrimaryButton, {
                label: 'View Management',
                color: 'var(--blue)',
                onClick: () => setShowMgmt(true)
              }),
              e(PrimaryButton, {
                label: 'New Analysis',
                color: 'var(--label3)',
                onClick: onBack
              })
            )
          )
        )
      );
    }

    // ========== IRON STUDIES MODULE ==========

    function IronModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const [hasInflammation, setHasInflammation] = useState(null);
      const [clinicalContext, setClinicalContext] = useState(null);
      const [ferritinResult, setFerritinResult] = useState(null);
      const [serumIron, setSerumIron] = useState('');
      const [transferrin, setTransferrin] = useState('');
      const [tsat, setTsat] = useState('');
      const [tsatResult, setTsatResult] = useState(null);
      const [showMgmt, setShowMgmt] = useState(false);

      const steps = [
        { label: 'Context', color: 'var(--red)' },
        { label: 'Ferritin', color: 'var(--red)' },
        { label: 'TSAT', color: 'var(--red)' },
        { label: 'Result', color: 'var(--red)' }
      ];

      const scrollToTop = () => {
        if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const goToStep = (s) => { setStep(s); scrollToTop(); };

      const handleBack = () => {
        if (showMgmt) setShowMgmt(false);
        else if (step === 0) onBack();
        else goToStep(step - 1);
      };

      // Calculate TSAT from iron and transferrin
      const calcTsat = () => {
        const iron = parseFloat(serumIron);
        const tf = parseFloat(transferrin);
        if (!isNaN(iron) && !isNaN(tf) && tf > 0) {
          return ((iron / (tf * 25)) * 100).toFixed(1);
        }
        return null;
      };

      const effectiveTsat = tsat || calcTsat();

      const getInflammationDisplay = () => ({
        value: hasInflammation ? 'Present' : 'Absent',
        interpretation: hasInflammation ? 'Adjusted thresholds apply' : 'Standard thresholds',
        color: hasInflammation ? 'var(--orange)' : 'var(--green)'
      });

      const getFerritinDisplay = () => {
        const labels = { veryLow: 'Very Low (< 15)', lowNormal: 'Low-Normal (15â€“100)', normal: 'Normal (30â€“300)', high: 'High (> 300)', veryHigh: 'Very High (> 1000)' };
        const interps = { veryLow: 'Absolute iron deficiency', lowNormal: 'Possible deficiency', normal: 'Stores adequate', high: 'Elevated', veryHigh: 'Urgent evaluation' };
        const colors = { veryLow: 'var(--red)', lowNormal: 'var(--orange)', normal: 'var(--green)', high: 'var(--orange)', veryHigh: 'var(--red)' };
        return { value: labels[ferritinResult] || '', interpretation: interps[ferritinResult] || '', color: colors[ferritinResult] || 'var(--blue)' };
      };

      const getTsatDisplay = () => {
        if (tsatResult === 'low') return { value: effectiveTsat ? `${effectiveTsat}%` : '< 16%', interpretation: 'Low â€” iron deficient erythropoiesis', color: 'var(--red)' };
        if (tsatResult === 'high') return { value: effectiveTsat ? `${effectiveTsat}%` : '> 45%', interpretation: 'High â€” iron overload', color: 'var(--orange)' };
        return { value: effectiveTsat ? `${effectiveTsat}%` : '16â€“45%', interpretation: 'Normal', color: 'var(--green)' };
      };

      // Management screen
      if (showMgmt) {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', { onClick: () => setShowMgmt(false), style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' } }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Iron Deficiency')
            ),
            e(MgmtStep, { number: 1, title: 'Oral Iron', color: 'var(--red)' },
              e('span', null, e('strong', null, 'Ferrous sulfate 325mg daily'), ' (65mg elemental iron) on empty stomach. ', e('strong', null, 'Alternate day dosing'), ' may improve absorption â€” hepcidin rises after a dose, reducing next-day absorption.', e('br'), 'Expect Hb rise of ~10 g/L per week if responding. Continue 3â€“6 months after Hb normalises to replenish stores.', e('br'), 'Side effects: nausea, constipation, black stools â€” major adherence barrier.')
            ),
            e(MgmtStep, { number: 2, title: 'IV Iron', color: 'var(--red)' },
              e('span', null, e('strong', null, 'Preferred if:'), ' oral intolerance, malabsorption, ongoing losses exceeding oral replacement, CKD, heart failure, pre-operative urgency, active IBD.', e('br'), e('strong', null, 'Ferric carboxymaltose (Ferinject):'), ' 15â€“20 mg/kg (max 1000 mg per infusion), can repeat at 1 week.', e('br'), e('strong', null, 'Iron polymaltose (Ferrum H):'), ' slower infusion, lower risk of hypophosphataemia.')
            ),
            e(WarningBanner, null, e('strong', null, 'Ferric carboxymaltose can cause hypophosphataemia'), ' â€” check phosphate at 2 weeks, especially if repeat dosing.'),
            e(MgmtStep, { number: 3, title: 'Transfusion', color: 'var(--red)' }, 'Reserve for haemodynamic instability or active severe bleeding. Iron deficiency alone is almost never an indication for transfusion.'),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory. Verify against your local laboratory\'s reference ranges.'),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          )
        );
      }

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Iron Studies', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(StepTrail, { steps, current: step }),

          // STEP 0: Clinical Context
          step === 0 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Clinical Context'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Inflammation fundamentally changes iron study interpretation')
            ),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'Is there active inflammation?'),
            e(ChoiceButton, { label: 'Yes â€” CRP elevated, active infection/inflammation', sublabel: 'Ferritin thresholds adjusted upward', selected: hasInflammation === true, onClick: () => setHasInflammation(true), color: 'var(--orange)' }),
            e(ChoiceButton, { label: 'No â€” stable outpatient', sublabel: 'Standard ferritin thresholds apply', selected: hasInflammation === false, onClick: () => setHasInflammation(false), color: 'var(--green)' }),
            hasInflammation === true && e(WarningBanner, null, e('strong', null, 'Ferritin is an acute phase reactant.'), ' It rises with inflammation independently of iron stores. A "normal" ferritin does NOT exclude iron deficiency when CRP is elevated. Higher thresholds apply.'),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginTop: '20px', marginBottom: '12px' } }, 'Specific clinical context?'),
            e(ChoiceButton, { label: 'CKD or haemodialysis', sublabel: 'Ferritin <200 with TSAT <20% suggests iron deficiency', selected: clinicalContext === 'ckd', onClick: () => setClinicalContext('ckd'), color: 'var(--red)' }),
            e(ChoiceButton, { label: 'Heart failure', sublabel: 'Ferritin <100, or 100â€“300 with TSAT <20%', selected: clinicalContext === 'heartFailure', onClick: () => setClinicalContext('heartFailure'), color: 'var(--red)' }),
            e(ChoiceButton, { label: 'None of the above', sublabel: 'Standard thresholds', selected: clinicalContext === 'none', onClick: () => setClinicalContext('none'), color: 'var(--blue)' }),
            e(PrimaryButton, { label: 'Next â†’ Ferritin', disabled: hasInflammation === null || clinicalContext === null, color: 'var(--red)', onClick: () => goToStep(1) }),
            e(LearnMoreDivider),
            e(InfoPanel, { title: 'Why Ferritin Is Unreliable in Inflammation', color: 'var(--red)' },
              e('p', { style: { marginBottom: '10px' } }, 'Ferritin synthesis is upregulated by inflammatory cytokines (IL-1, IL-6, TNF-Î±) independently of iron status. This is part of the innate immune response â€” the body sequesters iron to deprive bacteria of this essential nutrient (\'nutritional immunity\').'),
              e('p', { style: { marginBottom: '10px' } }, 'Hepcidin â€” the master iron regulatory hormone â€” is also upregulated by inflammation, blocking intestinal iron absorption and trapping iron in macrophages.'),
              e('p', null, 'Result: serum iron â†“, ferritin â†‘, transferrin â†“ â€” even if total body iron stores are depleted.')
            )
          ),

          // STEP 1: Ferritin
          step === 1 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Ferritin'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'The starting point â€” but interpret with context')
            ),
            e(BranchCard, { label: 'Inflammation', ...getInflammationDisplay() }),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'What is the ferritin level?'),
            e(ChoiceButton, { label: 'Very low  â€¹ 15 (F) / â€¹ 30 (M)', sublabel: 'Absolute iron deficiency â€” diagnostic regardless of other values', selected: ferritinResult === 'veryLow', onClick: () => setFerritinResult('veryLow'), color: 'var(--red)' }),
            e(ChoiceButton, { label: 'Low-normal  15â€“100', sublabel: 'Iron deficiency possible, especially with inflammation', selected: ferritinResult === 'lowNormal', onClick: () => setFerritinResult('lowNormal'), color: 'var(--orange)' }),
            e(ChoiceButton, { label: 'Normal  30â€“300', sublabel: 'Stores probably adequate BUT may be masked by inflammation', selected: ferritinResult === 'normal', onClick: () => setFerritinResult('normal'), color: 'var(--green)' }),
            e(ChoiceButton, { label: 'High  â€º 300', sublabel: 'Iron overload OR acute phase response OR liver disease', selected: ferritinResult === 'high', onClick: () => setFerritinResult('high'), color: 'var(--orange)' }),
            e(ChoiceButton, { label: 'Very high  â€º 1000', sublabel: 'Iron overload, malignancy, liver necrosis, HLH, Still\'s disease', selected: ferritinResult === 'veryHigh', onClick: () => setFerritinResult('veryHigh'), color: 'var(--red)' }),
            ferritinResult === 'veryLow' && e('div', { style: { marginTop: '16px' } },
              e(ResultCard, { title: 'Absolute Iron Deficiency', severity: 'likely', tags: ['Diagnostic', 'Investigate cause'] }, 'Ferritin this low is diagnostic of iron deficiency regardless of other iron study values or inflammatory markers.'),
              e(WarningBanner, null, 'Iron deficiency is a diagnosis that demands an explanation, not an endpoint. All males and post-menopausal females require GI investigation (upper + lower endoscopy). Check coeliac serology in all cases.'),
              e(PrimaryButton, { label: 'View Management', color: 'var(--red)', onClick: () => { goToStep(3); setShowMgmt(true); } }),
              e(PrimaryButton, { label: 'Check TSAT anyway', color: 'var(--label3)', onClick: () => goToStep(2) })
            ),
            ferritinResult === 'veryHigh' && e(WarningBanner, null, 'Ferritin >1000 Âµg/L requires urgent evaluation. Consider: massive iron overload (haemochromatosis, transfusional), hepatic necrosis, haemophagocytic lymphohistiocytosis (HLH), adult-onset Still\'s disease, malignancy.'),
            ferritinResult && ferritinResult !== 'veryLow' && e(PrimaryButton, { label: 'Next â†’ TSAT', color: 'var(--red)', onClick: () => goToStep(2) })
          ),

          // STEP 2: TSAT
          step === 2 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Transferrin Saturation'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'TSAT is the most reliable discriminator when ferritin is unreliable')
            ),
            e(BranchCard, { label: 'Inflammation', ...getInflammationDisplay() }),
            e(BranchCard, { label: 'Ferritin', ...getFerritinDisplay() }),
            e('div', { style: { background: 'rgba(142,142,147,0.08)', borderRadius: '14px', padding: '16px', marginBottom: '16px' } },
              e('div', { style: { fontSize: '13px', color: 'var(--label3)', marginBottom: '12px' } }, 'Enter TSAT directly, OR calculate from iron + transferrin:'),
              e(ValueInput, { label: 'TSAT', unit: '%', value: tsat, onChange: setTsat, placeholder: '16â€“45', hint: 'Normal: 16â€“45%' }),
              e('div', { style: { textAlign: 'center', fontSize: '12px', color: 'var(--label3)', margin: '8px 0' } }, 'â€” OR calculate â€”'),
              e(ValueInput, { label: 'Serum Iron', unit: 'Âµmol/L', value: serumIron, onChange: setSerumIron, placeholder: '10â€“30' }),
              e(ValueInput, { label: 'Transferrin', unit: 'g/L', value: transferrin, onChange: setTransferrin, placeholder: '1.7â€“3.4' }),
              calcTsat() && !tsat && e('div', { style: { fontSize: '13px', color: 'var(--green)', fontWeight: 600 } }, `Calculated: ${calcTsat()}%`)
            ),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'TSAT interpretation'),
            e(ChoiceButton, { label: 'Low  â€¹ 16%', sublabel: 'Iron deficient erythropoiesis â€” insufficient iron delivery to marrow', selected: tsatResult === 'low', onClick: () => setTsatResult('low'), color: 'var(--red)' }),
            e(ChoiceButton, { label: 'Normal  16â€“45%', sublabel: 'Adequate iron supply', selected: tsatResult === 'normal', onClick: () => setTsatResult('normal'), color: 'var(--green)' }),
            e(ChoiceButton, { label: 'High  â€º 45%', sublabel: 'Iron overload â€” excess unbound iron causing tissue damage', selected: tsatResult === 'high', onClick: () => setTsatResult('high'), color: 'var(--orange)' }),
            e(PrimaryButton, { label: 'Interpret â†’', disabled: !tsatResult, color: 'var(--red)', onClick: () => goToStep(3) })
          ),

          // STEP 3: Results
          step === 3 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Pattern recognition')
            ),
            e(BranchCard, { label: 'Inflammation', ...getInflammationDisplay() }),
            e(BranchCard, { label: 'Ferritin', ...getFerritinDisplay() }),
            e(BranchCard, { label: 'TSAT', ...getTsatDisplay() }),
            e('div', { style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' } }, 'DIFFERENTIAL DIAGNOSIS'),

            // Pattern: Ferritin low/low-normal + TSAT low
            (ferritinResult === 'veryLow' || ferritinResult === 'lowNormal') && tsatResult === 'low' && e(React.Fragment, null,
              e(ResultCard, { title: 'Iron Deficiency Anaemia', severity: 'likely', tags: ['Classic pattern', 'Investigate cause'] }, 'Low ferritin + low TSAT = straightforward iron deficiency. Transferrin/TIBC will typically be elevated (body upregulating iron transport).'),
              e(WarningBanner, null, e('strong', null, 'Iron deficiency demands investigation.'), ' All males and post-menopausal females require upper + lower GI endoscopy to exclude malignancy. Check coeliac serology (tissue transglutaminase antibody) in all unexplained cases.')
            ),

            // Pattern: Ferritin normal + TSAT low (with inflammation)
            ferritinResult === 'normal' && tsatResult === 'low' && hasInflammation && e(React.Fragment, null,
              e(ResultCard, { title: 'Iron Deficiency Masked by Inflammation', severity: 'likely', tags: ['Ferritin falsely normal', 'TSAT is the giveaway'] }, 'This is the most common diagnostic trap in hospital medicine. Ferritin appears \'normal\' because inflammation has raised it, but low TSAT reveals inadequate iron delivery to the marrow.'),
              e(InfoPanel, { title: 'The Hardest Call in Iron Studies', color: 'var(--red)' },
                e('p', { style: { marginBottom: '10px' } }, 'The patient has both iron deficiency AND active inflammation (e.g. RA, IBD, CKD, malignancy). Ferritin is elevated by inflammation â†’ looks \'normal\' even though stores are depleted. Transferrin is suppressed â†’ TIBC doesn\'t rise as expected. TSAT becomes the most reliable discriminator: if <20% with inflammation, iron deficiency is very likely even with ferritin 100â€“300.'),
                e('p', { style: { marginBottom: '10px' } }, e('strong', null, 'Soluble transferrin receptor (sTfR):'), ' Not affected by inflammation. â†‘ sTfR suggests true iron deficiency. sTfR/log ferritin ratio >2 strongly supports iron deficiency. Not universally available but very useful.'),
                e('p', null, e('strong', null, 'Pragmatic approach:'), ' If in doubt and the patient is symptomatic, a trial of IV iron is both diagnostic and therapeutic. If Hb rises, they were iron deficient.')
              )
            ),

            // Pattern: Ferritin normal + TSAT normal (with inflammation)
            ferritinResult === 'normal' && tsatResult === 'normal' && hasInflammation && e(ResultCard, { title: 'Anaemia of Chronic Disease', severity: 'consider', tags: ['Inflammatory iron sequestration', 'Iron trapped in macrophages'] }, 'Inflammatory cytokines + hepcidin â†’ iron sequestered in macrophages, unavailable for erythropoiesis. Iron stores are adequate (normal ferritin) and iron supply is maintained (normal TSAT). Low serum iron with low transferrin is typical.'),

            // Pattern: Ferritin high + TSAT high
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'high' && e(React.Fragment, null,
              e(ResultCard, { title: 'Iron Overload', severity: 'dangerous', tags: ['Haemochromatosis', 'Transfusional', 'Check HFE genotype'] }, 'Elevated ferritin with TSAT >45% (especially >60%) strongly suggests true iron overload. Check HFE gene (C282Y homozygosity = hereditary haemochromatosis). If transfusion-dependent, consider chelation therapy.'),
              e(ResultCard, { title: 'Liver Disease', subtitle: 'Can mimic iron overload', severity: 'consider', tags: ['Hepatocyte damage', 'Ferritin leak'] }, 'Damaged hepatocytes leak ferritin into serum. TSAT may be normal or elevated. Check LFTs. Liver disease + iron overload can coexist (e.g. haemochromatosis with cirrhosis).')
            ),

            // Pattern: Ferritin high + TSAT normal
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'normal' && e(React.Fragment, null,
              e(ResultCard, { title: 'Acute Phase Response', severity: 'likely', tags: ['Inflammation', 'Liver disease', 'Recheck when stable'] }, 'Elevated ferritin with normal TSAT most likely reflects an acute phase response rather than true iron overload. Recheck when inflammation has resolved.'),
              e(ResultCard, { title: 'Liver Disease', severity: 'consider', tags: ['Ferritin leak from hepatocytes'] })
            ),

            // Pattern: Ferritin high + TSAT low
            (ferritinResult === 'high' || ferritinResult === 'veryHigh') && tsatResult === 'low' && e(ResultCard, { title: 'Anaemia of Chronic Disease (severe)', severity: 'consider', tags: ['Hepcidin-mediated', 'Iron trapped'] }, 'High ferritin (inflammation) + low TSAT (no iron reaching marrow). Iron is present in stores but trapped by hepcidin-mediated sequestration.'),

            // Ferritin very high
            ferritinResult === 'veryHigh' && e(ResultCard, { title: 'Urgent Evaluation Required', severity: 'dangerous', tags: ['HLH', 'Malignancy', 'Hepatic necrosis', 'Still\'s disease'] }, 'Ferritin >1000 Âµg/L narrows the differential significantly. Consider haemophagocytic lymphohistiocytosis (HLH â€” check triglycerides, fibrinogen, LDH, soluble IL-2R), adult-onset Still\'s disease (quotidian fevers, rash, arthritis), hepatic necrosis, or massive iron overload.'),

            // Investigation info for iron deficiency
            (tsatResult === 'low' || ferritinResult === 'veryLow' || ferritinResult === 'lowNormal') && e(InfoPanel, { title: 'When to Scope', color: 'var(--red)' },
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Mandatory GI investigation:'), ' All males, all post-menopausal females with unexplained iron deficiency.'),
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Pre-menopausal females:'), ' Investigate if GI symptoms, family history of GI cancer, or iron deficiency not explained by menstrual losses.'),
              e('p', null, e('strong', null, 'Coeliac serology'), ' should be checked in all cases of unexplained iron deficiency.')
            ),

            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory. Verify against your local laboratory\'s reference ranges.'),
            e('div', { style: { marginTop: '16px' } },
              (tsatResult === 'low' || ferritinResult === 'veryLow' || ferritinResult === 'lowNormal') && e(PrimaryButton, { label: 'View Management', color: 'var(--red)', onClick: () => setShowMgmt(true) }),
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
            )
          )
        )
      );
    }

    // ========== CALCIUM & PTH MODULE ==========

    function CalciumModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const [useIonised, setUseIonised] = useState(false);
      const [totalCa, setTotalCa] = useState('');
      const [albumin, setAlbumin] = useState('');
      const [ionisedCa, setIonisedCa] = useState('');
      const [calciumDirection, setCalciumDirection] = useState(null);
      const [pthResult, setPthResult] = useState(null);
      const [phosphate, setPhosphate] = useState('');
      const [vitD, setVitD] = useState('');
      const [magnesium, setMagnesium] = useState('');
      const [showMgmt, setShowMgmt] = useState(false);
      const [mgmtType, setMgmtType] = useState(null);

      const steps = [
        { label: 'Calcium', color: 'var(--orange)' },
        { label: 'Direction', color: 'var(--orange)' },
        { label: 'PTH', color: 'var(--orange)' },
        { label: 'Result', color: 'var(--orange)' }
      ];

      const scrollToTop = () => { if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'smooth' }); };
      const goToStep = (s) => { setStep(s); scrollToTop(); };
      const handleBack = () => {
        if (showMgmt) setShowMgmt(false);
        else if (step === 0) onBack();
        else goToStep(step - 1);
      };

      // Corrected calcium calculation
      const getCorrectedCa = () => {
        const ca = parseFloat(totalCa);
        const alb = parseFloat(albumin);
        if (!isNaN(ca) && !isNaN(alb)) return (ca + 0.02 * (40 - alb)).toFixed(2);
        return null;
      };

      // Get effective calcium value
      const getEffectiveCa = () => {
        if (useIonised) return parseFloat(ionisedCa);
        return parseFloat(getCorrectedCa());
      };

      // Classify calcium
      const classifyCa = () => {
        const ca = getEffectiveCa();
        if (isNaN(ca)) return null;
        if (useIonised) {
          if (ca < 1.12) return 'low';
          if (ca > 1.30) return 'high';
          return 'normal';
        } else {
          if (ca < 2.15) return 'low';
          if (ca > 2.55) return 'high';
          return 'normal';
        }
      };

      const getSeverity = () => {
        const ca = getEffectiveCa();
        if (isNaN(ca)) return null;
        if (useIonised) {
          if (ca > 1.50) return { color: 'var(--red)', text: 'Severe / Crisis' };
          if (ca > 1.40) return { color: 'var(--orange)', text: 'Moderate' };
          if (ca > 1.30) return { color: 'var(--orange)', text: 'Mild' };
          if (ca < 0.9) return { color: 'var(--red)', text: 'Severe' };
          if (ca < 1.12) return { color: 'var(--orange)', text: 'Low' };
          return { color: 'var(--green)', text: 'Normal' };
        } else {
          if (ca > 3.5) return { color: 'var(--red)', text: 'Severe / Crisis â€” dehydration, renal failure, coma' };
          if (ca > 3.0) return { color: 'var(--orange)', text: 'Moderate â€” nausea, polyuria, confusion' };
          if (ca > 2.55) return { color: 'var(--orange)', text: 'Mild â€” often asymptomatic' };
          if (ca < 1.8) return { color: 'var(--red)', text: 'Severe' };
          if (ca < 2.15) return { color: 'var(--orange)', text: 'Low' };
          return { color: 'var(--green)', text: 'Normal' };
        }
      };

      const getCaDisplay = () => {
        const ca = getEffectiveCa();
        const sev = getSeverity();
        return { value: useIonised ? `${ionisedCa} mmol/L (ionised)` : `${getCorrectedCa()} mmol/L (corrected)`, interpretation: sev?.text || '', color: sev?.color || 'var(--blue)' };
      };

      const getPthDisplay = () => {
        if (calciumDirection === 'high') {
          if (pthResult === 'high') return { value: 'High / inappropriately normal', interpretation: 'PTH-mediated', color: 'var(--orange)' };
          return { value: 'Low (suppressed)', interpretation: 'PTH-independent', color: 'var(--blue)' };
        } else {
          if (pthResult === 'low') return { value: 'Low / inappropriately normal', interpretation: 'Hypoparathyroidism', color: 'var(--red)' };
          return { value: 'High (appropriate)', interpretation: 'Secondary hyperparathyroidism', color: 'var(--orange)' };
        }
      };

      // Management screens
      if (showMgmt) {
        const isHyperCa = mgmtType === 'hyperCa';
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', { onClick: () => setShowMgmt(false), style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' } }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, isHyperCa ? 'Hypercalcaemia' : 'Hypocalcaemia')
            ),
            isHyperCa ? e(React.Fragment, null,
              e(MgmtStep, { number: 1, title: 'IV Normal Saline', color: 'var(--orange)' }, e('strong', null, '200â€“300 ml/hr initially.'), ' Most patients are profoundly dehydrated from polyuria. Aim UO 100â€“150 ml/hr.'),
              e(MgmtStep, { number: 2, title: 'Zoledronic Acid', color: 'var(--orange)' }, e('span', null, e('strong', null, '4 mg IV over 15 min.'), ' Onset 2â€“4 days, peak 4â€“7 days. Most effective for malignant hypercalcaemia.')),
              e(WarningBanner, null, 'Check renal function. Dose reduce if eGFR 30â€“60. Avoid if eGFR <30.'),
              e(MgmtStep, { number: 3, title: 'Calcitonin', color: 'var(--orange)' }, e('strong', null, '4 IU/kg SC/IM q12h.'), ' Rapid onset (hours) but tachyphylaxis within 48h. Bridge until bisphosphonate works.'),
              e(MgmtStep, { number: 4, title: 'Other Options', color: 'var(--orange)' },
                e('span', null, e('strong', null, 'Denosumab 120 mg SC'), ' â€” if refractory to bisphosphonates or renal impairment.', e('br'),
                  e('strong', null, 'Corticosteroids'), ' (hydrocortisone 200 mg IV then prednisolone 40 mg daily) â€” for granulomatous disease, lymphoma, vitamin D toxicity, myeloma.', e('br'),
                  e('strong', null, 'Dialysis'), ' â€” for life-threatening hypercalcaemia refractory to above.')
              ),
              e(WarningBanner, null, e('strong', null, 'Avoid thiazide diuretics'), ' (worsen hypercalcaemia). Loop diuretics (frusemide) ONLY after adequate volume resuscitation.')
            ) : e(React.Fragment, null,
              e(MgmtStep, { number: 1, title: 'Acute IV Calcium', color: 'var(--orange)' }, e('strong', null, '10 ml 10% calcium gluconate IV over 10 min'), ' (2.2 mmol Ca per ampoule). Can repeat.'),
              e(MgmtStep, { number: 2, title: 'Continuous Infusion', color: 'var(--orange)' }, e('strong', null, '100 ml 10% calcium gluconate in 1000 ml 5% dextrose or NaCl 0.9%'), ' at 50 ml/hr. Titrate to ionised calcium.'),
              e(WarningBanner, null, e('strong', null, 'Do NOT give calcium through the same line as bicarbonate'), ' â€” precipitates.'),
              e(MgmtStep, { number: 3, title: 'Correct Magnesium', color: 'var(--orange)' }, e('strong', null, '10â€“20 mmol MgSOâ‚„ IV over 20 min'), ' then infusion. Calcium will not correct until Mg is replaced.'),
              e(MgmtStep, { number: 4, title: 'Cardiac Monitoring', color: 'var(--orange)' }, 'If ionised Ca <0.8 mmol/L â€” risk of arrhythmia.'),
              e(MgmtStep, { number: 5, title: 'Chronic Replacement', color: 'var(--orange)' },
                e('span', null, e('strong', null, 'Calcium supplements:'), ' calcium carbonate 500â€“1000 mg elemental BDâ€“TDS with food.', e('br'),
                  e('strong', null, 'Vitamin D:'), ' cholecalciferol 1000â€“4000 IU daily. Calcitriol 0.25â€“0.5 mcg BD if renal impairment or hypoparathyroidism.')
              )
            ),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          )
        );
      }

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Calcium & PTH', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(StepTrail, { steps, current: step }),

          // STEP 0: Calcium Input
          step === 0 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Calcium'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Enter total calcium + albumin for correction, OR ionised calcium directly')
            ),
            // Tab selector
            e('div', { style: { display: 'flex', background: 'var(--sep)', borderRadius: '10px', padding: '3px', marginBottom: '20px' } },
              e('button', { onClick: () => setUseIonised(false), style: { flex: 1, padding: '10px', borderRadius: '8px', border: 'none', background: !useIonised ? 'var(--card)' : 'transparent', fontWeight: 600, fontSize: '14px', cursor: 'pointer', fontFamily: 'var(--font)', color: !useIonised ? 'var(--label)' : 'var(--label3)' } }, 'Total Ca + Albumin'),
              e('button', { onClick: () => setUseIonised(true), style: { flex: 1, padding: '10px', borderRadius: '8px', border: 'none', background: useIonised ? 'var(--card)' : 'transparent', fontWeight: 600, fontSize: '14px', cursor: 'pointer', fontFamily: 'var(--font)', color: useIonised ? 'var(--label)' : 'var(--label3)' } }, 'Ionised Ca')
            ),
            !useIonised ? e(React.Fragment, null,
              e(ValueInput, { label: 'Total Calcium', unit: 'mmol/L', value: totalCa, onChange: setTotalCa, placeholder: '2.15â€“2.55', hint: 'Normal: 2.15â€“2.55' }),
              e(ValueInput, { label: 'Albumin', unit: 'g/L', value: albumin, onChange: setAlbumin, placeholder: '35â€“50', hint: 'Normal: 35â€“50' }),
              getCorrectedCa() && e(BranchCard, { label: 'Corrected Calcium', value: `${getCorrectedCa()} mmol/L`, interpretation: getSeverity()?.text || '', color: getSeverity()?.color || 'var(--blue)' }),
              e(InfoPanel, { title: 'Why Correct for Albumin?', color: 'var(--orange)' },
                e('p', null, '~40% of total serum calcium is bound to albumin. In hypoalbuminaemia (common in hospital patients), total calcium is artificially low even if ionised (free) calcium is normal. The correction estimates what total calcium would be if albumin were normal. It\'s imperfect â€” ionised calcium is always more reliable.')
              )
            ) : e(React.Fragment, null,
              e(ValueInput, { label: 'Ionised Calcium', unit: 'mmol/L', value: ionisedCa, onChange: setIonisedCa, placeholder: '1.12â€“1.30', hint: 'Normal: 1.12â€“1.30' }),
              e('div', { style: { fontSize: '13px', color: 'var(--label3)', marginBottom: '16px' } }, 'Ionised calcium is the physiologically active fraction. Not affected by albumin.'),
              ionisedCa && e(BranchCard, { label: 'Ionised Calcium', value: `${ionisedCa} mmol/L`, interpretation: getSeverity()?.text || '', color: getSeverity()?.color || 'var(--blue)' })
            ),
            e(PrimaryButton, { label: 'Next â†’', disabled: useIonised ? !ionisedCa : (!totalCa || !albumin), color: 'var(--orange)', onClick: () => { const dir = classifyCa(); setCalciumDirection(dir); goToStep(dir === 'normal' ? 1 : 2); } })
          ),

          // STEP 1: Direction (for normal calcium)
          step === 1 && calciumDirection === 'normal' && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Calcium Normal')
            ),
            e(BranchCard, { label: 'Calcium', ...getCaDisplay() }),
            e(ResultCard, { title: 'Normal Calcium', severity: 'likely', tags: ['No further workup needed'] }, 'Calcium is within normal range â€” no further algorithmic interpretation needed.'),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          ),

          // STEP 2: PTH
          step === 2 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, calciumDirection === 'high' ? 'Hypercalcaemia' : 'Hypocalcaemia'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, calciumDirection === 'high' ? 'PTH is THE key branch point' : 'PTH tells us whether parathyroids are responding')
            ),
            e(BranchCard, { label: 'Calcium', ...getCaDisplay() }),
            calciumDirection === 'high' && getEffectiveCa() > 3.0 && e(WarningBanner, null, 'Calcium >3.0 mmol/L requires urgent treatment. Start IV saline immediately.'),
            calciumDirection === 'low' && e(WarningBanner, null, e('strong', null, 'Always check magnesium.'), ' Hypomagnesaemia causes functional hypoparathyroidism AND end-organ resistance to PTH. Calcium will not correct until magnesium is replaced.'),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'What is the PTH?'),
            calciumDirection === 'high' ? e(React.Fragment, null,
              e(ChoiceButton, { label: 'High or inappropriately normal', sublabel: 'PTH-mediated â€” parathyroids are driving this', selected: pthResult === 'high', onClick: () => setPthResult('high'), color: 'var(--orange)' }),
              e(ChoiceButton, { label: 'Low (appropriately suppressed)', sublabel: 'PTH-independent â€” something else is causing high calcium', selected: pthResult === 'low', onClick: () => setPthResult('low'), color: 'var(--blue)' })
            ) : e(React.Fragment, null,
              e(ChoiceButton, { label: 'Low or inappropriately normal', sublabel: 'Hypoparathyroidism â€” parathyroids not responding', selected: pthResult === 'low', onClick: () => setPthResult('low'), color: 'var(--red)' }),
              e(ChoiceButton, { label: 'High (appropriate response)', sublabel: 'Secondary hyperparathyroidism â€” parathyroids trying to compensate', selected: pthResult === 'high', onClick: () => setPthResult('high'), color: 'var(--orange)' })
            ),
            e('div', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label3)', marginTop: '16px', marginBottom: '8px' } }, 'Supporting labs (optional)'),
            e(ValueInput, { label: 'Phosphate', unit: 'mmol/L', value: phosphate, onChange: setPhosphate, placeholder: '0.75â€“1.50', hint: 'Normal: 0.75â€“1.50' }),
            e(ValueInput, { label: '25(OH) Vitamin D', unit: 'nmol/L', value: vitD, onChange: setVitD, placeholder: '>50 adequate', hint: 'Adequate: >50' }),
            e(ValueInput, { label: 'Magnesium', unit: 'mmol/L', value: magnesium, onChange: setMagnesium, placeholder: '0.70â€“1.10', hint: 'Normal: 0.70â€“1.10' }),
            e(PrimaryButton, { label: 'Interpret â†’', disabled: !pthResult, color: 'var(--orange)', onClick: () => goToStep(3) })
          ),

          // STEP 3: Results
          step === 3 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation')
            ),
            e(BranchCard, { label: 'Calcium', ...getCaDisplay() }),
            e(BranchCard, { label: 'PTH', ...getPthDisplay() }),
            e('div', { style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' } }, 'DIFFERENTIAL DIAGNOSIS'),

            // HYPERCALCAEMIA + PTH HIGH
            calciumDirection === 'high' && pthResult === 'high' && e(React.Fragment, null,
              e(ResultCard, { title: 'Primary Hyperparathyroidism (PHPT)', severity: 'likely', tags: ['Single adenoma ~85%', 'Hyperplasia ~15%', 'Outpatient #1 cause'], onTap: () => { setMgmtType('hyperCa'); setShowMgmt(true); } }, 'Most common cause of hypercalcaemia in outpatients. Classic: â†‘Ca, â†‘PTH, â†“POâ‚„. Often incidental finding.'),
              e(ResultCard, { title: 'Familial Hypocalciuric Hypercalcaemia (FHH)', severity: 'consider', tags: ['Benign', 'Does NOT need surgery', 'Check CCCR'] }, 'Ca-sensing receptor mutation â†’ higher calcium set point. Distinguished from PHPT by low urinary calcium excretion (CCCR <0.01). Important: surgery does NOT fix FHH.'),
              e(InfoPanel, { title: 'PHPT vs FHH â€” CCCR Calculator', color: 'var(--orange)' }, e('p', null, 'CCCR = (Urine Ca Ã— Serum Cr) / (Serum Ca Ã— Urine Cr)', e('br'), 'CCCR > 0.02 â†’ PHPT. CCCR < 0.01 â†’ FHH. 0.01â€“0.02 â†’ indeterminate.')),
              e(ResultCard, { title: 'Tertiary Hyperparathyroidism', subtitle: 'Post-CKD or post-transplant', severity: 'consider', tags: ['Autonomous PTH'] }),
              e(ResultCard, { title: 'Lithium Therapy', severity: 'consider', tags: ['Shifts Ca set point'] })
            ),

            // HYPERCALCAEMIA + PTH LOW
            calciumDirection === 'high' && pthResult === 'low' && e(React.Fragment, null,
              e(ResultCard, { title: 'Malignancy', severity: 'dangerous', tags: ['Hospital #1 cause', 'PTHrP', 'Osteolytic mets', 'Lymphoma'], onTap: () => { setMgmtType('hyperCa'); setShowMgmt(true); } }, 'Most common cause in hospitalised patients. Check PTHrP level. Three mechanisms: humoral (PTHrP), osteolytic metastases, calcitriol-mediated (lymphoma).'),
              e(InfoPanel, { title: 'Malignancy-Associated Hypercalcaemia', color: 'var(--orange)' },
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Humoral (PTHrP):'), ' ~80%. Tumour secretes PTH-related peptide. NOT detected by standard PTH assay. Common: squamous cell, renal cell, breast.'),
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Osteolytic:'), ' Direct bone destruction. Breast, myeloma, lung. Expect â†‘ALP.'),
                e('p', null, e('strong', null, 'Calcitriol-mediated:'), ' Lymphoma produces 1,25(OH)â‚‚D.')
              ),
              e(ResultCard, { title: 'Granulomatous Disease', severity: 'consider', tags: ['Sarcoidosis', 'TB', 'Fungal', 'Check 1,25(OH)â‚‚D'] }, 'Macrophages produce 1,25(OH)â‚‚D autonomously.'),
              e(ResultCard, { title: 'Vitamin D Toxicity', severity: 'consider', tags: ['Exogenous intake', '25(OH)D >250 nmol/L'] }),
              e(ResultCard, { title: 'Other', severity: 'rare', tags: ['Thyrotoxicosis', 'Thiazides', 'Immobilisation', 'Milk-alkali'] })
            ),

            // HYPOCALCAEMIA + PTH LOW
            calciumDirection === 'low' && pthResult === 'low' && e(React.Fragment, null,
              e(ResultCard, { title: 'Hypoparathyroidism', severity: 'likely', tags: ['Post-surgical (#1)', 'Autoimmune', 'Infiltrative'], onTap: () => { setMgmtType('hypoCa'); setShowMgmt(true); } }, 'Most commonly post-thyroidectomy or parathyroidectomy. May be transient or permanent.'),
              magnesium && parseFloat(magnesium) < 0.70 && e(React.Fragment, null,
                e(WarningBanner, null, e('strong', null, 'Magnesium is low.'), ' Hypomagnesaemia impairs PTH secretion AND end-organ response. Replace magnesium FIRST.'),
                e(ResultCard, { title: 'Functional Hypoparathyroidism (Mg depletion)', severity: 'dangerous', tags: ['Replace Mg first', 'PTH will not work'] })
              )
            ),

            // HYPOCALCAEMIA + PTH HIGH
            calciumDirection === 'low' && pthResult === 'high' && e(React.Fragment, null,
              e(ResultCard, { title: 'Vitamin D Deficiency', severity: 'likely', tags: ['Most common globally', 'Check 25(OH)D'], onTap: () => { setMgmtType('hypoCa'); setShowMgmt(true); } }, 'PTH appropriately elevated in response to low calcium. Phosphate typically low (PTH promoting phosphaturia).'),
              phosphate && e(InfoPanel, { title: 'Phosphate as Discriminator', color: 'var(--orange)' },
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Low phosphate + high PTH'), ' = PTH is working on kidneys. Problem is lack of calcium input (vitamin D deficiency, malabsorption).'),
                e('p', null, e('strong', null, 'High phosphate + high PTH'), ' = PTH is NOT working on kidneys (renal failure, PTH resistance) OR phosphate load.')
              ),
              e(ResultCard, { title: 'CKD', severity: 'consider', tags: ['Impaired 1Î±-hydroxylation', 'High phosphate', 'Check eGFR'] }, 'Kidneys can\'t convert 25(OH)D to active 1,25(OH)â‚‚D. Need calcitriol, not cholecalciferol.'),
              e(ResultCard, { title: 'Malabsorption', severity: 'consider', tags: ['Coeliac', 'Crohn\'s', 'Post-bariatric'] }),
              e(ResultCard, { title: 'Hungry Bone Syndrome', subtitle: 'Post-parathyroidectomy', severity: 'consider', tags: ['Rapid Ca + POâ‚„ uptake'] }),
              e(ResultCard, { title: 'Pseudohypoparathyroidism', severity: 'rare', tags: ['PTH resistance', 'Albright hereditary osteodystrophy'] }, 'High PTH but no response â€” end-organ resistance.')
            ),

            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e('div', { style: { marginTop: '16px' } },
              e(PrimaryButton, { label: 'View Management', color: 'var(--orange)', onClick: () => { setMgmtType(calciumDirection === 'high' ? 'hyperCa' : 'hypoCa'); setShowMgmt(true); } }),
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
            )
          )
        )
      );
    }

    // ========== CSF ANALYSIS MODULE ==========

    function CSFModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const [appearance, setAppearance] = useState(null);
      const [openingPressure, setOpeningPressure] = useState('');
      const [isImmunocompromised, setIsImmunocompromised] = useState(null);
      const [csfWcc, setCsfWcc] = useState('');
      const [csfRcc, setCsfRcc] = useState('');
      const [csfDiff, setCsfDiff] = useState(null);
      const [csfProtein, setCsfProtein] = useState('');
      const [csfGlucose, setCsfGlucose] = useState('');
      const [serumGlucose, setSerumGlucose] = useState('');
      const [showMgmt, setShowMgmt] = useState(false);

      const steps = [
        { label: 'Appearance', color: '#1C1C1E' },
        { label: 'Chemistry', color: '#1C1C1E' },
        { label: 'Pattern', color: '#1C1C1E' },
        { label: 'Result', color: '#1C1C1E' }
      ];

      const scrollToTop = () => { if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'smooth' }); };
      const goToStep = (s) => { setStep(s); scrollToTop(); };
      const handleBack = () => {
        if (showMgmt) setShowMgmt(false);
        else if (step === 0) onBack();
        else goToStep(step - 1);
      };

      // Traumatic tap correction
      const getCorrectedWcc = () => {
        const wcc = parseFloat(csfWcc);
        const rcc = parseFloat(csfRcc);
        if (!isNaN(wcc) && !isNaN(rcc) && rcc > 0) {
          return Math.max(0, wcc - (rcc / 700)).toFixed(0);
        }
        return null;
      };

      const getCorrectedProtein = () => {
        const prot = parseFloat(csfProtein);
        const rcc = parseFloat(csfRcc);
        if (!isNaN(prot) && !isNaN(rcc) && rcc > 0) {
          return Math.max(0, prot - (rcc * 0.00001)).toFixed(3);
        }
        return null;
      };

      // CSF:Serum glucose ratio
      const getGlucoseRatio = () => {
        const csf = parseFloat(csfGlucose);
        const serum = parseFloat(serumGlucose);
        if (!isNaN(csf) && !isNaN(serum) && serum > 0) {
          return (csf / serum).toFixed(2);
        }
        return null;
      };

      const getGlucoseRatioDisplay = () => {
        const ratio = getGlucoseRatio();
        if (!ratio) return null;
        const r = parseFloat(ratio);
        if (r > 0.6) return { value: ratio, interpretation: 'Normal â€” effectively excludes bacterial meningitis', color: 'var(--green)' };
        if (r >= 0.3) return { value: ratio, interpretation: 'Low â€” consider bacterial, TB, fungal, malignant', color: 'var(--orange)' };
        return { value: ratio, interpretation: 'Very low â€” strongly suggests bacterial or TB meningitis', color: 'var(--red)' };
      };

      const getOPDisplay = () => {
        if (!openingPressure) return null;
        const op = parseFloat(openingPressure);
        if (op < 6) return { value: `${openingPressure} cmHâ‚‚O`, interpretation: 'Low â€” CSF leak, dehydration', color: 'var(--blue)' };
        if (op <= 20) return { value: `${openingPressure} cmHâ‚‚O`, interpretation: 'Normal', color: 'var(--green)' };
        if (op <= 25) return { value: `${openingPressure} cmHâ‚‚O`, interpretation: 'Borderline elevated', color: 'var(--orange)' };
        if (op <= 40) return { value: `${openingPressure} cmHâ‚‚O`, interpretation: 'Elevated', color: 'var(--red)' };
        return { value: `${openingPressure} cmHâ‚‚O`, interpretation: 'Markedly elevated â€” herniation risk', color: 'var(--red)' };
      };

      // Determine likely pattern
      const getLikelyPattern = () => {
        const lowGlucose = getGlucoseRatio() && parseFloat(getGlucoseRatio()) < 0.6;
        const highProtein = csfProtein && parseFloat(csfProtein) > 0.45;
        const highWcc = csfWcc && parseFloat(csfWcc) > 5;

        if (csfDiff === 'polys' && lowGlucose) return 'bacterial';
        if (csfDiff === 'lymphs' && !lowGlucose) return 'viral';
        if (csfDiff === 'lymphs' && lowGlucose) return 'tb';
        if (csfDiff === 'lymphs' && lowGlucose && isImmunocompromised) return 'crypto';
        return null;
      };

      // Management screen
      if (showMgmt) {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', { onClick: () => setShowMgmt(false), style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' } }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Meningitis / Encephalitis')
            ),
            e(WarningBanner, null, e('strong', null, 'If LP cannot be done immediately:'), ' blood cultures THEN empiric antibiotics IMMEDIATELY.'),
            e(MgmtStep, { number: 1, title: 'Empiric Antibiotics', color: 'var(--yellow)' },
              e('span', null, e('strong', null, 'Adult (community-acquired):'), ' Ceftriaxone 2g IV BD + Dexamethasone 10 mg IV QID Ã— 4 days.', e('br'),
                e('strong', null, 'If Listeria risk (>50 years, immunosuppressed, pregnant):'), ' ADD Benzylpenicillin 2.4g IV 4-hourly.', e('br'),
                e('strong', null, 'Post-neurosurgical / VP shunt:'), ' Vancomycin + Meropenem.')
            ),
            e(MgmtStep, { number: 2, title: 'Dexamethasone', color: 'var(--yellow)' }, 'Must be given WITH or BEFORE first antibiotic dose. No benefit if started later.'),
            e(WarningBanner, null, e('strong', null, 'Do NOT give dexamethasone if:'), ' immunosuppressed, post-neurosurgical, or suspected viral/TB meningitis.'),
            e(MgmtStep, { number: 3, title: 'HSV Encephalitis', color: 'var(--yellow)' },
              e('span', null, e('strong', null, 'Aciclovir 10 mg/kg IV TDS'), ' â€” start empirically if ANY suspicion of encephalitis (confusion, focal neurology, seizures, temporal lobe changes). Do NOT wait for PCR.')
            ),
            e(MgmtStep, { number: 4, title: 'TB Meningitis', color: 'var(--yellow)' }, '4-drug anti-TB therapy Ã— 2 months, then rifampicin + isoniazid Ã— 10 months (total 12 months). Dexamethasone â€” evidence supports steroids in TB meningitis.'),
            e(MgmtStep, { number: 5, title: 'Cryptococcal', color: 'var(--yellow)' },
              e('span', null, 'Amphotericin B + flucytosine (induction) â†’ fluconazole (maintenance). ', e('strong', null, 'Therapeutic LP'), ' for raised pressure â€” serial LPs to maintain OP <20 cmHâ‚‚O.')
            ),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          )
        );
      }

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'CSF Analysis', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(StepTrail, { steps, current: step }),

          // STEP 0: Appearance & Pressure
          step === 0 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'CSF Appearance & Pressure'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'First impressions before the lab results')
            ),
            e(WarningBanner, null, e('strong', null, 'Do NOT delay antibiotics to perform LP.'), ' If bacterial meningitis is suspected and LP cannot be done immediately, take blood cultures then give empiric antibiotics. LP can follow later.'),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'CSF Appearance'),
            e(ChoiceButton, { label: 'Crystal clear', sublabel: 'Normal or early/mild infection. Does NOT exclude meningitis.', selected: appearance === 'clear', onClick: () => setAppearance('clear'), color: 'var(--green)' }),
            e(ChoiceButton, { label: 'Turbid / cloudy', sublabel: 'High WCC or protein. Suggests bacterial until proven otherwise.', selected: appearance === 'turbid', onClick: () => setAppearance('turbid'), color: 'var(--red)' }),
            e(ChoiceButton, { label: 'Xanthochromic (yellow)', sublabel: 'Haemoglobin breakdown â†’ SAH (if >12h) or very high protein', selected: appearance === 'xanthochromic', onClick: () => setAppearance('xanthochromic'), color: 'var(--orange)' }),
            e(ChoiceButton, { label: 'Bloody', sublabel: 'Traumatic tap (common) or subarachnoid haemorrhage', selected: appearance === 'bloody', onClick: () => setAppearance('bloody'), color: 'var(--red)' }),
            appearance === 'bloody' && e(InfoPanel, { title: 'Traumatic Tap vs SAH', color: 'var(--yellow)' },
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Traumatic tap:'), ' Blood clears in successive tubes (â†“ RCC tube 1 â†’ tube 4). No xanthochromia. Clear supernatant.'),
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'SAH:'), ' Blood does NOT clear. Uniform RCC. Xanthochromia present (>12h from onset). Yellow supernatant.'),
              e('p', null, e('strong', null, 'Corrections:'), ' Subtract 1 WCC per 700 RBCs. Subtract ~0.01 g/L protein per 1000 RBCs.')
            ),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginTop: '16px', marginBottom: '12px' } }, 'Opening Pressure'),
            e(ValueInput, { label: 'Opening Pressure', unit: 'cmHâ‚‚O', value: openingPressure, onChange: setOpeningPressure, placeholder: '6â€“20', hint: 'Normal: 6â€“20' }),
            openingPressure && e(BranchCard, { label: 'Opening Pressure', ...getOPDisplay() }),
            parseFloat(openingPressure) > 25 && e(InfoPanel, { title: 'Causes of Elevated Opening Pressure', color: 'var(--yellow)' },
              e('p', null, 'Bacterial meningitis, cryptococcal meningitis (often markedly elevated), TB meningitis, idiopathic intracranial hypertension, cerebral venous sinus thrombosis.')
            ),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginTop: '16px', marginBottom: '12px' } }, 'Is the patient immunocompromised?'),
            e(ChoiceButton, { label: 'Yes', sublabel: 'HIV, transplant, chemotherapy, immunosuppressive drugs', selected: isImmunocompromised === true, onClick: () => setIsImmunocompromised(true), color: 'var(--red)' }),
            e(ChoiceButton, { label: 'No', sublabel: 'Immunocompetent', selected: isImmunocompromised === false, onClick: () => setIsImmunocompromised(false), color: 'var(--green)' }),
            e(PrimaryButton, { label: 'Next â†’ CSF Chemistry', disabled: appearance === null || isImmunocompromised === null, color: 'var(--yellow)', onClick: () => goToStep(1) })
          ),

          // STEP 1: Cells & Chemistry
          step === 1 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'CSF Analysis'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Enter available CSF results')
            ),
            appearance && e(BranchCard, { label: 'Appearance', value: appearance.charAt(0).toUpperCase() + appearance.slice(1), interpretation: appearance === 'turbid' ? 'High WCC/protein' : appearance === 'clear' ? 'May still have infection' : '', color: appearance === 'turbid' || appearance === 'bloody' ? 'var(--red)' : 'var(--green)' }),
            openingPressure && e(BranchCard, { label: 'Opening Pressure', ...getOPDisplay() }),
            e(ValueInput, { label: 'CSF White Cell Count', unit: 'cells/ÂµL', value: csfWcc, onChange: setCsfWcc, placeholder: 'Normal: 0â€“5' }),
            e(ValueInput, { label: 'CSF Red Cell Count', unit: 'cells/ÂµL', value: csfRcc, onChange: setCsfRcc, placeholder: 'Normal: 0', hint: 'For traumatic tap correction' }),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'Predominant cell type'),
            e(ChoiceButton, { label: 'Polymorphs (neutrophils)', sublabel: 'Suggests bacterial', selected: csfDiff === 'polys', onClick: () => setCsfDiff('polys'), color: 'var(--red)' }),
            e(ChoiceButton, { label: 'Lymphocytes', sublabel: 'Viral, TB, fungal, or partially treated bacterial', selected: csfDiff === 'lymphs', onClick: () => setCsfDiff('lymphs'), color: 'var(--blue)' }),
            e(ChoiceButton, { label: 'Mixed', sublabel: 'Early bacterial, or overlap pattern', selected: csfDiff === 'mixed', onClick: () => setCsfDiff('mixed'), color: 'var(--orange)' }),
            e(ValueInput, { label: 'CSF Protein', unit: 'g/L', value: csfProtein, onChange: setCsfProtein, placeholder: '0.15â€“0.45', hint: 'Normal: 0.15â€“0.45' }),
            e(ValueInput, { label: 'CSF Glucose', unit: 'mmol/L', value: csfGlucose, onChange: setCsfGlucose, placeholder: '2.8â€“4.4', hint: 'Normal: 2.8â€“4.4' }),
            e(ValueInput, { label: 'Paired Serum Glucose', unit: 'mmol/L', value: serumGlucose, onChange: setSerumGlucose, placeholder: 'For ratio', hint: 'Essential for interpretation' }),
            csfRcc && parseFloat(csfRcc) > 0 && getCorrectedWcc() && e(React.Fragment, null,
              e('div', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label3)', marginTop: '16px', marginBottom: '8px' } }, 'Traumatic tap correction'),
              e(BranchCard, { label: 'Corrected WCC', value: `${getCorrectedWcc()} cells/ÂµL`, interpretation: 'After subtracting RBC contribution', color: 'var(--blue)' }),
              getCorrectedProtein() && e(BranchCard, { label: 'Corrected Protein', value: `${getCorrectedProtein()} g/L`, interpretation: 'After subtracting RBC contribution', color: 'var(--blue)' })
            ),
            getGlucoseRatio() && e(BranchCard, { label: 'CSF:Serum Glucose Ratio', ...getGlucoseRatioDisplay() }),
            e(PrimaryButton, { label: 'Match Pattern â†’', disabled: !csfWcc || !csfDiff, color: 'var(--yellow)', onClick: () => goToStep(2) }),
            e(LearnMoreDivider),
            e(InfoPanel, { title: 'The Glucose Rule', color: 'var(--yellow)' },
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Low CSF glucose'), ' (ratio <0.6) = organisms or cells consuming glucose. Narrows differential to: bacterial, TB, fungal, malignant meningitis, neurosarcoidosis.'),
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Normal CSF glucose'), ' effectively excludes bacterial meningitis (high negative predictive value). Viral meningitis has NORMAL glucose.'),
              e('p', null, e('strong', null, 'Critical:'), ' Always measure paired serum glucose. Absolute CSF glucose of 3.0 looks normal but is low if serum is 20 (ratio 0.15).')
            )
          ),

          // STEP 2: Pattern matching / Results
          step === 2 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Pattern Recognition')
            ),
            appearance && e(BranchCard, { label: 'Appearance', value: appearance.charAt(0).toUpperCase() + appearance.slice(1), interpretation: '', color: appearance === 'turbid' || appearance === 'bloody' ? 'var(--red)' : 'var(--green)' }),
            csfWcc && e(BranchCard, { label: 'CSF WCC', value: `${getCorrectedWcc() || csfWcc} cells/ÂµL`, interpretation: csfDiff === 'polys' ? 'Polymorphs predominant' : csfDiff === 'lymphs' ? 'Lymphocytes predominant' : 'Mixed', color: csfDiff === 'polys' ? 'var(--red)' : 'var(--blue)' }),
            getGlucoseRatio() && e(BranchCard, { label: 'CSF:Serum Glucose', ...getGlucoseRatioDisplay() }),
            e('div', { style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' } }, 'DIFFERENTIAL DIAGNOSIS'),

            // Bacterial
            e(ResultCard, { title: 'Bacterial Meningitis', severity: csfDiff === 'polys' && getGlucoseRatio() && parseFloat(getGlucoseRatio()) < 0.6 ? 'dangerous' : 'consider', tags: ['Empiric antibiotics BEFORE LP', 'Gram stain', 'Blood cultures', 'Dexamethasone'], onTap: () => setShowMgmt(true) }, 'Classic: turbid CSF, polymorphs, very high WCC, high protein, low glucose. However, early bacterial meningitis can mimic viral (lymphocyte predominance in first 24h).'),

            // Viral
            e(ResultCard, { title: 'Viral Meningitis', severity: csfDiff === 'lymphs' && (!getGlucoseRatio() || parseFloat(getGlucoseRatio()) > 0.6) ? 'likely' : 'consider', tags: ['Enterovirus most common', 'HSV PCR', 'Self-limiting'] }, 'Clear CSF, lymphocyte predominance, mildly elevated protein, NORMAL glucose. Usually self-limiting. Key concern: rule out HSV encephalitis if confusion/focal neurology/seizures.'),

            // TB
            (csfDiff === 'lymphs' || csfDiff === 'mixed') && e(ResultCard, { title: 'TB Meningitis', severity: getGlucoseRatio() && parseFloat(getGlucoseRatio()) < 0.6 ? 'dangerous' : 'consider', tags: ['Subacute onset', 'Cranial nerve palsies', 'SIADH', 'Treat empirically if suspected'], onTap: () => setShowMgmt(true) }, 'Lymphocytes, low glucose, high protein. Notoriously difficult to diagnose (AFB smear only 10â€“20% sensitive). GeneXpert ~60â€“80% in CSF.'),
            (csfDiff === 'lymphs' && getGlucoseRatio() && parseFloat(getGlucoseRatio()) < 0.6) && e(InfoPanel, { title: 'TB Meningitis â€” the Great Mimicker', color: 'var(--yellow)' },
              e('p', { style: { marginBottom: '8px' } }, 'Clinical clues: subacute onset (days-weeks), cranial nerve palsies (especially VI), basal meningeal enhancement on MRI, hyponatraemia (SIADH), risk factors.'),
              e('p', { style: { fontWeight: 700 } }, 'If clinical suspicion is moderate-high, start empiric treatment while awaiting results. Mortality of untreated TB meningitis approaches 100%.')
            ),

            // Cryptococcal
            isImmunocompromised && e(ResultCard, { title: 'Cryptococcal Meningitis', severity: 'dangerous', tags: ['Immunosuppressed', 'High opening pressure', 'CrAg', 'Therapeutic LP'], onTap: () => setShowMgmt(true) }, 'Lymphocytes, low glucose, elevated protein, often markedly raised opening pressure. Check serum and CSF cryptococcal antigen (CrAg). Raised pressure is the major cause of morbidity.'),

            // Partially treated
            e(ResultCard, { title: 'Partially Treated Bacterial', severity: 'consider', tags: ['Prior antibiotics', 'Modified pattern', 'May look viral'] }, 'Prior antibiotics can modify the CSF pattern: lymphocyte shift, less dramatic glucose drop. Treat as bacterial if clinical suspicion high.'),

            // Malignant
            (csfDiff === 'lymphs' && getGlucoseRatio() && parseFloat(getGlucoseRatio()) < 0.6) && e(ResultCard, { title: 'Malignant Meningitis', severity: 'consider', tags: ['Lymphocytic', 'Low glucose', 'Known malignancy', 'Cytology'] }, 'Carcinomatous or lymphomatous meningitis. Lymphocytes, low glucose, very high protein. Send CSF cytology â€” may need repeat LPs.'),

            // GBS
            csfProtein && parseFloat(csfProtein) > 1.0 && csfWcc && parseFloat(csfWcc) < 10 && e(ResultCard, { title: 'Guillain-BarrÃ© Syndrome', severity: 'consider', tags: ['High protein', 'Few cells', 'Albuminocytological dissociation'] }, 'Very high protein with few or no cells â€” \'albuminocytological dissociation\'. Usually presents with ascending weakness, areflexia.'),

            // IIH
            openingPressure && parseFloat(openingPressure) > 25 && csfWcc && parseFloat(csfWcc) <= 5 && (!getGlucoseRatio() || parseFloat(getGlucoseRatio()) > 0.6) && e(ResultCard, { title: 'Idiopathic Intracranial Hypertension', severity: 'consider', tags: ['Elevated pressure', 'Normal composition', 'Diagnosis of exclusion'] }, 'Elevated opening pressure with completely normal CSF composition. Typical patient: young woman, obesity, headache, papilloedema.'),

            // Investigations
            e(InfoPanel, { title: 'Specific Investigations to Request', color: 'var(--yellow)' },
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Gram stain'), ' â€” always. Sensitivity ~60â€“90%. Negative does NOT exclude bacterial.'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Bacterial culture'), ' â€” always. Gold standard. 24â€“48h. Also blood cultures.'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'PCR (multiplex)'), ' â€” bacterial + viral (HSV, VZV, enterovirus). Higher sensitivity than culture after antibiotics.'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Cryptococcal antigen'), ' â€” if immunosuppressed, HIV, or lymphocytic with low glucose.'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'TB PCR (GeneXpert)'), ' â€” if subacute, lymphocytic, low glucose, risk factors. Large volume (>6ml).'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Cytology'), ' â€” if malignancy suspected. Large volume. May need repeat LPs.'),
              e('div', { style: { background: 'rgba(255,214,10,0.15)', borderRadius: '10px', padding: '10px 12px' } }, e('strong', null, 'Oligoclonal bands'), ' â€” if MS suspected. Paired with serum.')
            ),

            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e('div', { style: { marginTop: '16px' } },
              e(PrimaryButton, { label: 'View Management', color: 'var(--yellow)', onClick: () => setShowMgmt(true) }),
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
            )
          )
        )
      );
    }

    // ========== AKI / URINE BIOCHEM MODULE ==========

    function AKIModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const [urineNa, setUrineNa] = useState('');
      const [urineCr, setUrineCr] = useState('');
      const [serumNa, setSerumNa] = useState('');
      const [serumCr, setSerumCr] = useState('');
      const [onDiuretics, setOnDiuretics] = useState(null);
      const [urineUrea, setUrineUrea] = useState('');
      const [serumUrea, setSerumUrea] = useState('');
      const [urineOsm, setUrineOsm] = useState('');
      const [fenaResult, setFenaResult] = useState(null);
      const [showMgmt, setShowMgmt] = useState(false);
      const [mgmtType, setMgmtType] = useState(null);

      const steps = [
        { label: 'Labs', color: 'var(--cyan)' },
        { label: 'FENa', color: 'var(--cyan)' },
        { label: 'Result', color: 'var(--cyan)' }
      ];

      const scrollToTop = () => { if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'smooth' }); };
      const goToStep = (s) => { setStep(s); scrollToTop(); };
      const handleBack = () => {
        if (showMgmt) setShowMgmt(false);
        else if (step === 0) onBack();
        else goToStep(step - 1);
      };

      // FENa calculation: (UNa Ã— SCr) / (SNa Ã— UCr) Ã— 100
      // Note: SCr needs to be converted from Âµmol/L to mmol/L (Ã·1000)
      const calcFENa = () => {
        const una = parseFloat(urineNa);
        const ucr = parseFloat(urineCr);
        const sna = parseFloat(serumNa);
        const scr = parseFloat(serumCr) / 1000; // Convert to mmol/L
        if (!isNaN(una) && !isNaN(ucr) && !isNaN(sna) && !isNaN(scr) && ucr > 0 && sna > 0) {
          return ((una * scr) / (sna * ucr) * 100).toFixed(2);
        }
        return null;
      };

      // FEUrea calculation
      const calcFEUrea = () => {
        const uurea = parseFloat(urineUrea);
        const surea = parseFloat(serumUrea);
        const ucr = parseFloat(urineCr);
        const scr = parseFloat(serumCr) / 1000;
        if (!isNaN(uurea) && !isNaN(surea) && !isNaN(ucr) && !isNaN(scr) && ucr > 0 && surea > 0) {
          return ((uurea * scr) / (surea * ucr) * 100).toFixed(1);
        }
        return null;
      };

      const getFENaDisplay = () => {
        const fena = calcFENa();
        if (!fena) return null;
        const v = parseFloat(fena);
        if (v < 1) return { value: `${fena}%`, interpretation: 'Suggests pre-renal', color: 'var(--green)' };
        if (v <= 2) return { value: `${fena}%`, interpretation: 'Indeterminate', color: 'var(--orange)' };
        return { value: `${fena}%`, interpretation: 'Suggests intrinsic (ATN)', color: 'var(--red)' };
      };

      const getFEUreaDisplay = () => {
        const feurea = calcFEUrea();
        if (!feurea) return null;
        const v = parseFloat(feurea);
        if (v < 35) return { value: `${feurea}%`, interpretation: 'Suggests pre-renal', color: 'var(--green)' };
        if (v <= 50) return { value: `${feurea}%`, interpretation: 'Indeterminate', color: 'var(--orange)' };
        return { value: `${feurea}%`, interpretation: 'Suggests intrinsic (ATN)', color: 'var(--red)' };
      };

      const getUrineOsmDisplay = () => {
        if (!urineOsm) return null;
        const v = parseFloat(urineOsm);
        if (v > 500) return { value: `${urineOsm} mOsm/kg`, interpretation: 'Concentrated â€” consistent with pre-renal', color: 'var(--green)' };
        if (v >= 350) return { value: `${urineOsm} mOsm/kg`, interpretation: 'Intermediate', color: 'var(--orange)' };
        return { value: `${urineOsm} mOsm/kg`, interpretation: 'Dilute â€” consistent with ATN', color: 'var(--red)' };
      };

      if (showMgmt) {
        const isPreRenal = mgmtType === 'preRenal';
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', { onClick: () => setShowMgmt(false), style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' } }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, isPreRenal ? 'Pre-renal AKI' : 'Intrinsic AKI (ATN)')
            ),
            isPreRenal ? e(React.Fragment, null,
              e(MgmtStep, { number: 1, title: 'Volume Resuscitation', color: 'var(--cyan)' }, 'Crystalloid boluses 250â€“500 ml, reassess after each.'),
              e(MgmtStep, { number: 2, title: 'Treat Underlying Cause', color: 'var(--cyan)' }, 'Sepsis, bleeding, heart failure, liver failure.'),
              e(MgmtStep, { number: 3, title: 'Hold Nephrotoxins', color: 'var(--cyan)' }, 'NSAIDs, ACEi/ARB, aminoglycosides.'),
              e(MgmtStep, { number: 4, title: 'Monitor', color: 'var(--cyan)' }, 'UO target >0.5 ml/kg/hr. Serial creatinine.')
            ) : e(React.Fragment, null,
              e(MgmtStep, { number: 1, title: 'Supportive', color: 'var(--cyan)' }, 'No specific treatment for established ATN.'),
              e(MgmtStep, { number: 2, title: 'Avoid Further Insults', color: 'var(--cyan)' }, 'Nephrotoxins, hypotension, contrast.'),
              e(MgmtStep, { number: 3, title: 'Manage Complications', color: 'var(--cyan)' }, 'Hyperkalaemia, acidosis, fluid overload.'),
              e(MgmtStep, { number: 4, title: 'RRT Criteria', color: 'var(--cyan)' }, 'Refractory hyperkalaemia, severe acidosis, fluid overload unresponsive to diuretics, uraemic encephalopathy or pericarditis.')
            ),
            e(InfoPanel, { title: 'Post-renal AKI', color: 'var(--cyan)' },
              e('p', null, 'Relieve obstruction â€” catheterise (lower tract), nephrostomy/stent (upper tract). Monitor for post-obstructive diuresis â€” can be massive and cause electrolyte shifts.')
            ),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          )
        );
      }

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Urine Biochem', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(StepTrail, { steps, current: step }),

          // STEP 0: Inputs
          step === 0 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Urine & Serum Biochemistry'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'For FENa calculation and AKI workup')
            ),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'Is the patient on diuretics?'),
            e(ChoiceButton, { label: 'Yes â€” on loop or thiazide diuretics', sublabel: 'Use FEUrea instead of FENa', selected: onDiuretics === true, onClick: () => setOnDiuretics(true), color: 'var(--orange)' }),
            e(ChoiceButton, { label: 'No diuretics', sublabel: 'FENa is reliable', selected: onDiuretics === false, onClick: () => setOnDiuretics(false), color: 'var(--green)' }),
            onDiuretics === true && e(WarningBanner, null, e('strong', null, 'FENa is unreliable on diuretics.'), ' Diuretics force sodium excretion, making FENa falsely elevated (mimicking intrinsic AKI). Use FEUrea instead.'),
            e('div', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label3)', marginTop: '16px', marginBottom: '8px' } }, 'FENa inputs'),
            e(ValueInput, { label: 'Urine Sodium', unit: 'mmol/L', value: urineNa, onChange: setUrineNa, placeholder: 'Enter' }),
            e(ValueInput, { label: 'Urine Creatinine', unit: 'mmol/L', value: urineCr, onChange: setUrineCr, placeholder: 'Enter' }),
            e(ValueInput, { label: 'Serum Sodium', unit: 'mmol/L', value: serumNa, onChange: setSerumNa, placeholder: '135â€“145' }),
            e(ValueInput, { label: 'Serum Creatinine', unit: 'Âµmol/L', value: serumCr, onChange: setSerumCr, placeholder: 'Enter' }),
            onDiuretics && e(React.Fragment, null,
              e('div', { style: { fontSize: '14px', fontWeight: 600, color: 'var(--label3)', marginTop: '16px', marginBottom: '8px' } }, 'FEUrea inputs'),
              e(ValueInput, { label: 'Urine Urea', unit: 'mmol/L', value: urineUrea, onChange: setUrineUrea, placeholder: 'Enter' }),
              e(ValueInput, { label: 'Serum Urea', unit: 'mmol/L', value: serumUrea, onChange: setSerumUrea, placeholder: 'Enter' })
            ),
            e(ValueInput, { label: 'Urine Osmolality (optional)', unit: 'mOsm/kg', value: urineOsm, onChange: setUrineOsm, placeholder: 'Optional' }),
            e(PrimaryButton, { label: 'Calculate â†’', disabled: onDiuretics === null || !urineNa || !urineCr || !serumNa || !serumCr, color: 'var(--cyan)', onClick: () => goToStep(1) }),
            e(LearnMoreDivider),
            e(InfoPanel, { title: 'Why FENa Works', color: 'var(--cyan)' },
              e('p', { style: { marginBottom: '8px' } }, 'In pre-renal AKI, kidneys are underperfused but structurally intact â†’ maximally reabsorb sodium (low FENa, <1%) and concentrate urine (high urine osm).'),
              e('p', null, 'In intrinsic AKI (ATN), tubules are damaged â†’ sodium \'leaks\' into urine (high FENa, >2%) and urine osmolality approaches serum (~300).')
            )
          ),

          // STEP 1: Calculated Results
          step === 1 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Calculated Indices')
            ),
            calcFENa() && !onDiuretics && e(BranchCard, { label: 'FENa', ...getFENaDisplay() }),
            calcFENa() && onDiuretics && e('div', { style: { opacity: 0.5, marginBottom: '16px' } },
              e(BranchCard, { label: 'FENa', value: `${calcFENa()}%`, interpretation: 'âš ï¸ Unreliable on diuretics', color: 'var(--label3)' })
            ),
            onDiuretics && calcFEUrea() && e(BranchCard, { label: 'FEUrea', ...getFEUreaDisplay() }),
            urineOsm && e(BranchCard, { label: 'Urine Osmolality', ...getUrineOsmDisplay() }),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'Select interpretation'),
            e(ChoiceButton, { label: 'Pre-renal', sublabel: onDiuretics ? 'FEUrea <35%' : 'FENa <1%', selected: fenaResult === 'preRenal', onClick: () => setFenaResult('preRenal'), color: 'var(--green)' }),
            e(ChoiceButton, { label: 'Intrinsic (ATN)', sublabel: onDiuretics ? 'FEUrea >50%' : 'FENa >2%', selected: fenaResult === 'intrinsic', onClick: () => setFenaResult('intrinsic'), color: 'var(--red)' }),
            e(ChoiceButton, { label: 'Indeterminate', sublabel: 'Borderline values â€” may be transitioning', selected: fenaResult === 'indeterminate', onClick: () => setFenaResult('indeterminate'), color: 'var(--orange)' }),
            e(PrimaryButton, { label: 'Interpret â†’', disabled: !fenaResult, color: 'var(--cyan)', onClick: () => goToStep(2) })
          ),

          // STEP 2: Results
          step === 2 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation')
            ),
            !onDiuretics && calcFENa() && e(BranchCard, { label: 'FENa', ...getFENaDisplay() }),
            onDiuretics && calcFEUrea() && e(BranchCard, { label: 'FEUrea', ...getFEUreaDisplay() }),
            urineOsm && e(BranchCard, { label: 'Urine Osmolality', ...getUrineOsmDisplay() }),
            e('div', { style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' } }, 'INTERPRETATION'),

            fenaResult === 'preRenal' && e(React.Fragment, null,
              e(ResultCard, { title: 'Pre-renal AKI', severity: 'likely', tags: ['Underperfusion', 'Structurally intact', 'Reversible'], onTap: () => { setMgmtType('preRenal'); setShowMgmt(true); } }, 'Kidneys responding appropriately to hypovolaemia or poor perfusion. Avid sodium and water retention.'),
              e(WarningBanner, null, e('strong', null, 'FENa <1% does NOT always mean pre-renal.'), ' Several intrinsic diseases preserve tubular sodium handling:'),
              e('div', { style: { background: 'var(--card)', border: '1px solid var(--sep)', borderRadius: '10px', padding: '12px', marginBottom: '12px', fontSize: '13px', color: 'var(--label2)' } },
                'â€¢ Contrast nephropathy (vasoconstriction)', e('br'),
                'â€¢ Rhabdomyolysis (early)', e('br'),
                'â€¢ Early sepsis (renal vasoconstriction)', e('br'),
                'â€¢ Acute glomerulonephritis (glomerular injury, tubules intact)', e('br'),
                'â€¢ Early interstitial nephritis', e('br'),
                'â€¢ Acute urinary obstruction (early)'
              )
            ),

            fenaResult === 'intrinsic' && e(React.Fragment, null,
              e(ResultCard, { title: 'Intrinsic AKI (ATN)', severity: 'likely', tags: ['Tubular damage', 'Muddy brown casts', 'Supportive care'], onTap: () => { setMgmtType('intrinsic'); setShowMgmt(true); } }, 'Tubular damage â€” cannot reabsorb sodium efficiently or concentrate urine.'),
              e(WarningBanner, null, e('strong', null, 'FENa >1% does NOT always mean intrinsic:')),
              e('div', { style: { background: 'var(--card)', border: '1px solid var(--sep)', borderRadius: '10px', padding: '12px', marginBottom: '12px', fontSize: '13px', color: 'var(--label2)' } },
                'â€¢ Diuretic use (falsely elevated)', e('br'),
                'â€¢ CKD baseline (chronic nephron loss)', e('br'),
                'â€¢ Adrenal insufficiency (lack of aldosterone)', e('br'),
                'â€¢ Cerebral salt wasting', e('br'),
                'â€¢ IV saline administration', e('br'),
                'â€¢ Glycosuria (osmotic diuresis)'
              )
            ),

            fenaResult === 'indeterminate' && e(ResultCard, { title: 'Evolving AKI', severity: 'consider', tags: ['May be transitioning', 'Serial measurements', 'Trend'] }, 'Borderline values â€” may be evolving from pre-renal to intrinsic. Serial measurement over 6â€“12 hours is more useful than a single value.'),

            e(InfoPanel, { title: 'Urine Microscopy â€” the Forgotten Tool', color: 'var(--cyan)' },
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Muddy brown granular casts:'), ' ATN â€” pathognomonic'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Red cell casts:'), ' Glomerulonephritis'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'White cell casts:'), ' Interstitial nephritis or pyelonephritis'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Eosinophiluria:'), ' Allergic interstitial nephritis (low sensitivity)'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px', marginBottom: '6px' } }, e('strong', null, 'Bland sediment:'), ' Pre-renal, obstruction, or HRS'),
              e('div', { style: { background: 'rgba(100,210,255,0.08)', borderRadius: '10px', padding: '10px 12px' } }, e('strong', null, 'Crystals:'), ' Crystal nephropathy (tumour lysis, ethylene glycol)')
            ),

            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e('div', { style: { marginTop: '16px' } },
              e(PrimaryButton, { label: 'View Management', color: 'var(--cyan)', onClick: () => { setMgmtType(fenaResult === 'preRenal' ? 'preRenal' : 'intrinsic'); setShowMgmt(true); } }),
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
            )
          )
        )
      );
    }

    // ========== COAGULATION MODULE ==========

    function CoagModule({ onBack }) {
      const containerRef = useRef(null);
      const [step, setStep] = useState(0);
      const [pt, setPt] = useState('');
      const [inr, setInr] = useState('');
      const [aptt, setAptt] = useState('');
      const [fibrinogen, setFibrinogen] = useState('');
      const [dDimer, setDDimer] = useState('');
      const [platelets, setPlatelets] = useState('');
      const [clinicalContext, setClinicalContext] = useState(null);
      const [pattern, setPattern] = useState(null);
      const [showMgmt, setShowMgmt] = useState(false);

      const steps = [
        { label: 'Labs', color: 'var(--green)' },
        { label: 'Pattern', color: 'var(--green)' },
        { label: 'Result', color: 'var(--green)' }
      ];

      const scrollToTop = () => { if (containerRef.current) containerRef.current.scrollTo({ top: 0, behavior: 'smooth' }); };
      const goToStep = (s) => { setStep(s); scrollToTop(); };
      const handleBack = () => {
        if (showMgmt) setShowMgmt(false);
        else if (step === 0) onBack();
        else goToStep(step - 1);
      };

      const isPtProlonged = pt && parseFloat(pt) > 13.5;
      const isApttProlonged = aptt && parseFloat(aptt) > 38;

      // ISTH DIC Score calculation
      const calcDICScore = () => {
        if (!platelets || !dDimer || !pt || !fibrinogen) return null;
        let score = 0;
        const plt = parseFloat(platelets);
        const dd = parseFloat(dDimer);
        const ptVal = parseFloat(pt);
        const fib = parseFloat(fibrinogen);
        if (plt >= 100) score += 0; else if (plt >= 50) score += 1; else score += 2;
        if (dd <= 0.5) score += 0; else if (dd <= 5) score += 1; else score += 2;
        const ptProlongation = ptVal - 13;
        if (ptProlongation < 3) score += 0; else if (ptProlongation <= 6) score += 1; else score += 2;
        if (fib >= 1.0) score += 0; else score += 2;
        return score;
      };

      const getLabDisplay = (name, value, unit, normal) => {
        if (!value) return null;
        const v = parseFloat(value);
        let interp = 'Normal';
        let color = 'var(--green)';
        if (name === 'PT' && v > 13.5) { interp = 'Prolonged'; color = 'var(--orange)'; }
        if (name === 'APTT' && v > 38) { interp = 'Prolonged'; color = 'var(--orange)'; }
        if (name === 'Fibrinogen' && v < 2.0) { interp = 'Low'; color = 'var(--red)'; }
        if (name === 'Platelets' && v < 150) { interp = 'Low'; color = 'var(--red)'; }
        if (name === 'D-dimer' && v > 0.5) { interp = 'Elevated'; color = 'var(--orange)'; }
        return { value: `${value} ${unit}`, interpretation: interp, color };
      };

      if (showMgmt) {
        return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
          e(NavBar, { title: 'Management', onBack: () => setShowMgmt(false), rightAction: e(HomeButton, { onClick: onBack }) }),
          e('div', { className: 'screen-content' },
            e('button', { onClick: () => setShowMgmt(false), style: { background: 'none', border: 'none', color: 'var(--blue)', fontSize: '15px', fontWeight: 600, padding: '16px 0', cursor: 'pointer', fontFamily: 'var(--font)' } }, 'â€¹ Back to results'),
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Management'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Coagulopathy')
            ),
            e(MgmtStep, { number: 1, title: 'Stop the Cause', color: 'var(--green)' }, 'Stop anticoagulants. Treat sepsis. Control bleeding source.'),
            e(MgmtStep, { number: 2, title: 'Replace What\'s Missing', color: 'var(--green)' },
              e('span', null, e('strong', null, 'FFP 15 ml/kg'), ' if PT/APTT prolonged.', e('br'),
                e('strong', null, 'Cryoprecipitate 5â€“10 units'), ' if fibrinogen <1.5 g/L (rich in fibrinogen, Factor VIII, vWF, Factor XIII).', e('br'),
                e('strong', null, 'Platelets'), ' if <50 and actively bleeding (or <100 if neurosurgical/ophthalmic).', e('br'),
                e('strong', null, 'Vitamin K 10 mg IV slow'), ' if vitamin K deficiency or warfarin.')
            ),
            e(MgmtStep, { number: 3, title: 'Specific Reversal Agents', color: 'var(--green)' },
              e('span', null, e('strong', null, 'Warfarin:'), ' Prothrombinex (3-factor PCC) + Vitamin K.', e('br'),
                e('strong', null, 'Dabigatran:'), ' Idarucizumab (Praxbind).', e('br'),
                e('strong', null, 'Rivaroxaban/Apixaban:'), ' Andexanet alfa (if available) or Prothrombinex (off-label).', e('br'),
                e('strong', null, 'Heparin:'), ' Protamine sulphate.')
            ),
            clinicalContext === 'preOp' && e(InfoPanel, { title: 'Pre-operative Abnormal Coag', color: 'var(--green)' },
              e('p', null, 'Isolated mildly prolonged APTT in an asymptomatic patient: consider lupus anticoagulant or Factor XII deficiency â€” ', e('strong', null, 'neither causes bleeding. Do NOT delay surgery.'), e('br'), 'Personal/family history of bleeding is more important than the screening coag result.')
            ),
            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
          )
        );
      }

      return e('div', { className: 'app-container', ref: containerRef, style: { overflowY: 'auto', height: '100dvh' } },
        e(NavBar, { title: 'Coagulation', onBack: handleBack, rightAction: e(HomeButton, { onClick: onBack }) }),
        e('div', { className: 'screen-content' },
          e(StepTrail, { steps, current: step }),

          // STEP 0: Inputs
          step === 0 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Coagulation Studies'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Enter available results')
            ),
            e(ValueInput, { label: 'PT', unit: 'sec', value: pt, onChange: setPt, placeholder: '11â€“13.5', hint: 'Normal: 11â€“13.5' }),
            e(ValueInput, { label: 'INR', unit: '', value: inr, onChange: setInr, placeholder: '0.9â€“1.1', hint: 'Normal: 0.9â€“1.1' }),
            e(ValueInput, { label: 'APTT', unit: 'sec', value: aptt, onChange: setAptt, placeholder: '25â€“38', hint: 'Normal: 25â€“38' }),
            e(ValueInput, { label: 'Fibrinogen', unit: 'g/L', value: fibrinogen, onChange: setFibrinogen, placeholder: '2.0â€“4.0', hint: 'Normal: 2.0â€“4.0' }),
            e(ValueInput, { label: 'D-dimer', unit: 'mg/L', value: dDimer, onChange: setDDimer, placeholder: '<0.5', hint: 'Normal: <0.5' }),
            e(ValueInput, { label: 'Platelets', unit: 'Ã—10â¹/L', value: platelets, onChange: setPlatelets, placeholder: '150â€“400', hint: 'Normal: 150â€“400' }),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginTop: '16px', marginBottom: '12px' } }, 'Clinical context'),
            e(ChoiceButton, { label: 'Active bleeding', sublabel: 'Urgent â€” need to identify and correct the problem', selected: clinicalContext === 'bleeding', onClick: () => setClinicalContext('bleeding'), color: 'var(--red)' }),
            e(ChoiceButton, { label: 'Incidental finding', sublabel: 'Abnormal coag on routine tests', selected: clinicalContext === 'incidental', onClick: () => setClinicalContext('incidental'), color: 'var(--blue)' }),
            e(ChoiceButton, { label: 'Pre-operative screening', sublabel: 'Abnormal coag before planned surgery', selected: clinicalContext === 'preOp', onClick: () => setClinicalContext('preOp'), color: 'var(--orange)' }),
            e(PrimaryButton, { label: 'Identify Pattern â†’', disabled: !clinicalContext || (!pt && !aptt), color: 'var(--green)', onClick: () => goToStep(1) }),
            e(LearnMoreDivider),
            e(InfoPanel, { title: 'Which Test Maps to Which Pathway?', color: 'var(--green)' },
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'PT/INR'), ' = Extrinsic + Common pathway. Factor VII is unique. Warfarin affects this.'),
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'APTT'), ' = Intrinsic + Common pathway. Factors VIII, IX, XI, XII are unique. Heparin affects this.'),
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Common pathway'), ' = X â†’ V â†’ II â†’ fibrinogen â†’ fibrin. Abnormalities prolong BOTH.'),
              e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Fibrinogen'), ' = final substrate. Consumed in DIC, massive bleeding.'),
              e('p', null, e('strong', null, 'D-dimer'), ' = fibrin degradation product. Elevated when clot is forming AND breaking down.')
            )
          ),

          // STEP 1: Pattern
          step === 1 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Pattern'),
              e('div', { style: { fontSize: '14px', color: 'var(--label3)', marginTop: '4px' } }, 'Which pathway is affected?')
            ),
            pt && e(BranchCard, { label: 'PT', ...getLabDisplay('PT', pt, 'sec', '11â€“13.5') }),
            aptt && e(BranchCard, { label: 'APTT', ...getLabDisplay('APTT', aptt, 'sec', '25â€“38') }),
            e('div', { style: { fontSize: '15px', fontWeight: 700, color: 'var(--label)', marginBottom: '12px' } }, 'Select the pattern'),
            e(ChoiceButton, { label: 'A â€” Isolated prolonged PT', sublabel: 'APTT normal. Extrinsic pathway problem.', selected: pattern === 'A', onClick: () => setPattern('A'), color: 'var(--green)' }),
            e(ChoiceButton, { label: 'B â€” Isolated prolonged APTT', sublabel: 'PT normal. Intrinsic pathway problem.', selected: pattern === 'B', onClick: () => setPattern('B'), color: 'var(--green)' }),
            e(ChoiceButton, { label: 'C â€” Both PT and APTT prolonged', sublabel: 'Common pathway OR global coagulopathy', selected: pattern === 'C', onClick: () => setPattern('C'), color: 'var(--orange)' }),
            e(ChoiceButton, { label: 'D â€” Both normal', sublabel: 'Consider platelet or vascular cause if bleeding', selected: pattern === 'D', onClick: () => setPattern('D'), color: 'var(--blue)' }),
            e(PrimaryButton, { label: 'Interpret â†’', disabled: !pattern, color: 'var(--green)', onClick: () => goToStep(2) })
          ),

          // STEP 2: Results
          step === 2 && e(FadeIn, null,
            e('div', { style: { marginBottom: '20px' } },
              e('div', { style: { fontSize: '22px', fontWeight: 800, letterSpacing: '-0.03em', color: 'var(--label)' } }, 'Interpretation')
            ),
            pt && e(BranchCard, { label: 'PT', ...getLabDisplay('PT', pt, 'sec', '11â€“13.5') }),
            aptt && e(BranchCard, { label: 'APTT', ...getLabDisplay('APTT', aptt, 'sec', '25â€“38') }),
            fibrinogen && e(BranchCard, { label: 'Fibrinogen', ...getLabDisplay('Fibrinogen', fibrinogen, 'g/L', '2.0â€“4.0') }),
            e('div', { style: { fontSize: '12px', fontWeight: 700, color: 'var(--label3)', letterSpacing: '0.05em', marginTop: '20px', marginBottom: '12px' } }, 'DIFFERENTIAL DIAGNOSIS'),

            // Pattern A: Isolated prolonged PT
            pattern === 'A' && e(React.Fragment, null,
              e(ResultCard, { title: 'Warfarin', severity: 'likely', tags: ['Most common', 'Check INR target'] }),
              e(ResultCard, { title: 'Early Liver Disease', severity: 'consider', tags: ['Factor VII shortest half-life (~6h)', 'First to fall'] }),
              e(ResultCard, { title: 'Vitamin K Deficiency', severity: 'consider', tags: ['Malabsorption', 'Malnutrition', 'Antibiotics', 'Obstructive jaundice'] }),
              e(ResultCard, { title: 'DOAC (Rivaroxaban/Apixaban)', severity: 'consider', tags: ['Anti-Xa agents', 'Standard coag unreliable', 'Check anti-Xa level'] }),
              e(ResultCard, { title: 'Factor VII Deficiency', severity: 'rare', tags: ['Congenital', 'Only extrinsic factor'] })
            ),

            // Pattern B: Isolated prolonged APTT
            pattern === 'B' && e(React.Fragment, null,
              e(ResultCard, { title: 'Heparin (UFH)', severity: 'likely', tags: ['Most common in hospital', 'Check anti-Xa or APTT ratio'] }),
              e(ResultCard, { title: 'Haemophilia A (Factor VIII â†“)', severity: 'consider', tags: ['X-linked', 'Severity correlates with level'] }),
              e(ResultCard, { title: 'Haemophilia B (Factor IX â†“)', severity: 'consider', tags: ['X-linked', 'Clinically identical to A'] }),
              e(ResultCard, { title: 'von Willebrand Disease', severity: 'consider', tags: ['Most common inherited bleeding disorder', 'vWF stabilises VIII'] }),
              e(ResultCard, { title: 'Factor XI Deficiency', severity: 'consider', tags: ['Ashkenazi Jewish', 'Variable bleeding risk'] }),
              e(ResultCard, { title: 'Factor XII Deficiency', severity: 'rare', tags: ['NO bleeding risk', 'Do NOT delay surgery'] }, 'Prolongs APTT but causes NO bleeding risk whatsoever. Safe for surgery.'),
              e(WarningBanner, null, e('strong', null, 'Factor XII deficiency and lupus anticoagulant prolong APTT but do NOT cause bleeding.'), ' Do NOT delay surgery for either of these.'),
              e(ResultCard, { title: 'Lupus Anticoagulant', severity: 'consider', tags: ['Antiphospholipid', 'PROTHROMBOTIC', 'Paradoxical'] }, 'Prolongs APTT in vitro but is PROTHROMBOTIC in vivo. Paradoxical â€” the lab looks like a bleeding risk but the clinical risk is clotting.'),
              e(ResultCard, { title: 'Dabigatran', severity: 'consider', tags: ['Direct thrombin inhibitor', 'Check thrombin time'] }),
              e(InfoPanel, { title: 'The Mixing Study', color: 'var(--green)' },
                e('p', { style: { marginBottom: '8px' } }, 'When APTT is prolonged, mix 1:1 patient plasma with normal plasma:'),
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Corrects â†’ Factor deficiency.'), ' Normal plasma provides the missing factor.'),
                e('p', null, e('strong', null, 'Does not correct â†’ Inhibitor present.'), ' Immediate: lupus anticoagulant, heparin. Time-dependent (2h): acquired Factor VIII inhibitor (serious).', e('br'), 'If patient is on heparin, the mixing study is useless.')
              )
            ),

            // Pattern C: Both prolonged
            pattern === 'C' && e(React.Fragment, null,
              e(ResultCard, { title: 'DIC', severity: 'dangerous', tags: ['Consumption', 'â†“Fibrinogen', 'â†“Platelets', 'â†‘D-dimer', 'Schistocytes'] }, 'Consumption of all factors + platelets. Check blood film for schistocytes.'),
              calcDICScore() !== null && e(BranchCard, { label: 'ISTH DIC Score', value: `${calcDICScore()}/8`, interpretation: calcDICScore() >= 5 ? 'Compatible with overt DIC' : 'Not suggestive of overt DIC â€” repeat daily', color: calcDICScore() >= 5 ? 'var(--red)' : 'var(--orange)' }),
              e(ResultCard, { title: 'Severe Liver Disease', severity: 'likely', tags: ['Impaired synthesis', 'Factor VIII normal/â†‘ (distinguishes from DIC)'] }),
              e(InfoPanel, { title: 'Liver vs DIC', color: 'var(--green)' },
                e('p', { style: { marginBottom: '8px' } }, 'Both: prolonged PT + APTT, low fibrinogen, low platelets, elevated D-dimer.'),
                e('p', { style: { marginBottom: '8px' } }, e('strong', null, 'Factor VIII is the key.'), ' Normal/high in liver disease (Factor VIII made by endothelium). Low in DIC (consumed).'),
                e('p', null, 'Blood film: schistocytes = DIC. Target cells, acanthocytes = liver.')
              ),
              e(ResultCard, { title: 'Massive Transfusion / Dilution', severity: 'consider', tags: ['Dilution of factors + platelets'] }),
              e(ResultCard, { title: 'Vitamin K Deficiency (severe)', severity: 'consider', tags: ['All K-dependent factors'] }),
              e(ResultCard, { title: 'Supratherapeutic Warfarin', severity: 'consider', tags: ['Very high INR'] }),
              e(ResultCard, { title: 'Direct Thrombin Inhibitor (high dose)', severity: 'consider', tags: ['Dabigatran', 'Argatroban'] })
            ),

            // Pattern D: Both normal
            pattern === 'D' && e(React.Fragment, null,
              e(ResultCard, { title: 'Platelet Disorder', severity: 'likely', tags: ['Thrombocytopenia', 'Platelet dysfunction', 'Aspirin', 'Uraemia'] }),
              e(ResultCard, { title: 'Mild von Willebrand Disease', severity: 'consider', tags: ['May not prolong APTT', 'Check vWF antigen + activity'] }),
              e(ResultCard, { title: 'Factor XIII Deficiency', severity: 'rare', tags: ['NOT detected by PT or APTT', 'Clot forms then falls apart', 'Urea clot lysis test'] }),
              e(ResultCard, { title: 'Vascular Cause', severity: 'rare', tags: ['Connective tissue disorder', 'Vasculitis', 'Scurvy'] })
            ),

            e('div', { style: { fontSize: '11px', color: 'var(--label4)', marginTop: '20px', textAlign: 'center' } }, 'Reference ranges vary by laboratory.'),
            e('div', { style: { marginTop: '16px' } },
              e(PrimaryButton, { label: 'View Management', color: 'var(--green)', onClick: () => setShowMgmt(true) }),
              e(PrimaryButton, { label: 'New Analysis', color: 'var(--label3)', onClick: onBack })
            )
          )
        )
      );
    }

    // ========== MAIN APP ==========

    function App() {
      const [screen, setScreen] = useState('home');

      if (screen === 'home') {
        return e('div', { className: 'app-container' },
          e(HomeScreen, { onSelectModule: setScreen })
        );
      }

      if (screen === 'tft') {
        return e(TFTModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'hypona') {
        return e(HyponatraemiaModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'iron') {
        return e(IronModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'calcium') {
        return e(CalciumModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'coag') {
        return e(CoagModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'aki') {
        return e(AKIModule, { onBack: () => setScreen('home') });
      }

      if (screen === 'csf') {
        return e(CSFModule, { onBack: () => setScreen('home') });
      }

      // Placeholder for other modules
      return e('div', { className: 'app-container' },
        e(PlaceholderScreen, { moduleId: screen, onBack: () => setScreen('home') })
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(e(App));
  </script>
</body>
</html>
